<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Peak Athlete - Performance Lab</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* "" DARK THEME (default): Midnight Athlete "" */
        :root, [data-theme="dark"] {
            --bg-primary: #0B0E14;
            --bg-secondary: #141820;
            --bg-card: #141820;
            --bg-card-hover: #1A1F2B;
            --bg-surface: #0F1219;
            --bg-input: #1A1F2B;
            --accent-blue: #00C2FF;
            --accent-cyan: #00C2FF;
            --accent-green: #00E68A;
            --accent-orange: #F5A623;
            --accent-red: #FF6B6B;
            --accent-purple: #A78BFA;
            --accent-pink: #FF6B9D;
            --text-primary: #E2E8F0;
            --text-secondary: #8B95A8;
            --text-muted: #555E72;
            --border-color: #1E2433;
            --border-hover: #2A3248;
            --gradient-1: linear-gradient(135deg, #00C2FF, #A78BFA);
            --gradient-2: linear-gradient(135deg, #A78BFA, #FF6B9D);
            --shadow-glow: 0 0 40px rgba(0, 194, 255, 0.10);
            --shadow-card: 0 2px 12px rgba(0,0,0,0.4);
            --shadow-card-lg: 0 8px 32px rgba(0,0,0,0.5);
            --tag-bg: rgba(0,194,255,0.10);
            --tag-text: #00C2FF;
            --tag-border: rgba(0,194,255,0.20);
            --nav-bg: #0B0E14;
            --nav-border: #1A1F2B;
            --color-freestyle: #00C2FF;
            --color-backstroke: #A78BFA;
            --color-breaststroke: #06D6A0;
            --color-butterfly: #F5A623;
            --color-im: #FF6B9D;
            --positive-glow: rgba(0,230,138,0.10);
            --negative-glow: rgba(255,107,107,0.10);
            --accent-glow: rgba(0,194,255,0.12);
            --accent-subtle: rgba(0,194,255,0.08);
        }

        /* "" LIGHT THEME: Clean Deck "" */
        [data-theme="light"] {
            --bg-primary: #F3F5F9;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-card-hover: #F8FAFC;
            --bg-surface: #EDF0F5;
            --bg-input: #F3F5F9;
            --accent-blue: #0097CC;
            --accent-cyan: #0097CC;
            --accent-green: #00B86B;
            --accent-orange: #D98E10;
            --accent-red: #E54545;
            --accent-purple: #7C5FD3;
            --accent-pink: #D94373;
            --text-primary: #0F1219;
            --text-secondary: #5A6478;
            --text-muted: #8B95A8;
            --border-color: #E2E7EF;
            --border-hover: #CBD2DE;
            --gradient-1: linear-gradient(135deg, #0097CC, #7C5FD3);
            --gradient-2: linear-gradient(135deg, #7C5FD3, #D94373);
            --shadow-glow: 0 0 40px rgba(0, 151, 204, 0.06);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-card-lg: 0 8px 24px rgba(0,0,0,0.08);
            --tag-bg: rgba(0,151,204,0.08);
            --tag-text: #0097CC;
            --tag-border: rgba(0,151,204,0.16);
            --nav-bg: #FFFFFF;
            --nav-border: #E2E7EF;
            --color-freestyle: #0097CC;
            --color-backstroke: #7C5FD3;
            --color-breaststroke: #059669;
            --color-butterfly: #D98E10;
            --color-im: #D94373;
            --positive-glow: rgba(0,184,107,0.08);
            --negative-glow: rgba(229,69,69,0.08);
            --accent-glow: rgba(0,151,204,0.08);
            --accent-subtle: rgba(0,151,204,0.05);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.35s ease, color 0.35s ease;
        }

        /* Background Pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(0, 194, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 194, 255, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(167, 139, 250, 0.04) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }
        [data-theme="light"] body::before,
        [data-theme="light"]::before {
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(0, 151, 204, 0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 151, 204, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(124, 95, 211, 0.02) 0%, transparent 70%);
        }

        /* Theme transition for key elements */
        .sidebar, .main-content, .kpi-card, .pb-card, .module-panel,
        .race-card-pick, .event-record-card, .welcome-bar,
        .attention-card, .collapsible-section, .rfb-bar,
        select, input, button, .nav-item, .user-info,
        .last-session-chip, .quick-action-btn, .alert-item {
            transition: background 0.35s ease, border-color 0.35s ease, color 0.35s ease, box-shadow 0.35s ease;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 48px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-card-lg);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo img, .login-logo svg {
            width: 64px;
            height: auto;
            margin-bottom: 12px;
        }

        .login-logo h1 {
            font-size: 26px;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 14px;
            letter-spacing: 0.5px;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 194, 255, 0.2);
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 194, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            color: var(--accent-red);
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .login-toggle, .login-links {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        .login-links { display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: wrap; }
        .login-links-sep { color: var(--text-muted); }
        .forgot-link { font-size: 12px; }

        .login-toggle a, .login-links a {
            color: var(--accent-blue);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
        }

        .login-toggle a:hover, .login-links a:hover {
            text-decoration: underline;
        }

        .form-section-label {
            display: flex; align-items: center; gap: 8px;
            font-size: 16px; font-weight: 700; color: var(--text-primary);
            margin-bottom: 6px;
        }
        .form-section-label svg { color: var(--accent-blue); }
        .form-helper-text {
            font-size: 12px; color: var(--text-muted); margin-bottom: 20px; line-height: 1.5;
        }

        .login-success {
            display: none;
            background: rgba(0, 230, 138, 0.08);
            border: 1px solid rgba(0, 230, 138, 0.25);
            color: var(--accent-green);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 13px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .login-success.show {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .password-requirements {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            line-height: 1.4;
        }

        .pending-banner {
            background: rgba(245, 166, 35, 0.08);
            border: 1px solid rgba(245, 166, 35, 0.25);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pending-banner svg {
            width: 24px;
            height: 24px;
            color: var(--accent-orange);
            flex-shrink: 0;
        }

        .pending-banner-text h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-orange);
            margin-bottom: 2px;
        }

        .pending-banner-text p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .member-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .member-name {
            font-weight: 600;
            font-size: 14px;
        }

        .member-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .member-actions {
            display: flex;
            gap: 6px;
        }

        .member-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .member-btn.approve {
            background: rgba(0, 230, 138, 0.12);
            color: var(--accent-green);
        }

        .member-btn.approve:hover {
            background: rgba(0, 230, 138, 0.25);
        }

        .member-btn.reject {
            background: rgba(255, 107, 107, 0.12);
            color: var(--accent-red);
        }

        .member-btn.reject:hover {
            background: rgba(255, 107, 107, 0.25);
        }

        .member-btn.leave {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
        }

        .member-btn.leave:hover {
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
        }

        .member-btn.remove {
            background: rgba(255, 107, 107, 0.10);
            color: var(--accent-red);
            border: 1px solid rgba(255, 107, 107, 0.18);
        }

        .member-btn.remove:hover {
            background: rgba(255, 107, 107, 0.22);
        }

        .pending-count-badge {
            background: var(--accent-orange);
            color: #000;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            margin-left: auto;
            line-height: 1;
        }

        .approval-alert {
            background: rgba(245, 166, 35, 0.08);
            border: 1px solid rgba(245, 166, 35, 0.25);
            border-radius: 10px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .approval-alert:hover {
            background: rgba(245, 166, 35, 0.14);
            border-color: rgba(245, 166, 35, 0.4);
        }
        .approval-alert svg {
            width: 22px;
            height: 22px;
            color: var(--accent-orange);
            flex-shrink: 0;
        }
        .approval-alert-text h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 2px 0;
        }
        .approval-alert-text p {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0;
        }

        .status-badge {
            padding: 3px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.active { background: rgba(0, 230, 138, 0.12); color: var(--accent-green); }
        .status-badge.pending { background: rgba(245, 166, 35, 0.12); color: var(--accent-orange); }
        .status-badge.inactive { background: rgba(148, 163, 184, 0.12); color: var(--text-muted); }

        .team-info-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .team-info-bar .team-name {
            font-weight: 700;
            font-size: 16px;
        }

        .team-info-bar .team-code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--bg-hover);
            padding: 4px 10px;
            border-radius: 6px;
            color: var(--accent-cyan);
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .dashboard.active {
            display: block;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 24px 16px;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar-logo {
            padding: 0 12px 24px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo svg {
            width: 32px;
            height: auto;
            flex-shrink: 0;
        }

        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo h2 {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.2;
        }

        .sidebar-logo span {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0 12px;
            margin-bottom: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(0, 194, 255, 0.15);
            color: var(--accent-blue);
        }

        .nav-item svg {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

        .nav-item.active svg {
            opacity: 1;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .theme-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            margin-bottom: 10px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        .theme-toggle-label {
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; font-weight: 600; color: var(--text-secondary);
        }
        .theme-toggle-label svg { color: var(--accent-blue); }
        .theme-toggle-btn {
            width: 44px; height: 24px;
            border-radius: 12px;
            background: var(--border-color);
            border: 1px solid var(--border-hover);
            cursor: pointer;
            position: relative;
            padding: 0;
            transition: background 0.3s;
        }
        [data-theme="dark"] .theme-toggle-btn { background: var(--accent-blue); border-color: var(--accent-blue); }
        .theme-toggle-knob {
            width: 18px; height: 18px;
            border-radius: 50%;
            background: #fff;
            position: absolute; top: 2px;
            left: 2px;
            transition: left 0.3s cubic-bezier(0.68,-0.55,0.27,1.55);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .theme-toggle-knob { left: 22px; }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
        }

        .user-details h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-details span {
            font-size: 12px;
            color: var(--text-muted);
        }

        .role-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-badge.athlete {
            background: rgba(0, 230, 138, 0.15);
            color: var(--accent-green);
        }

        .role-badge.coach {
            background: rgba(167, 139, 250, 0.15);
            color: var(--accent-purple);
        }

        /* Main Content */
        .main-content {
            margin-left: 260px;
            padding: 32px;
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: var(--shadow-card);
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-card-lg);
            border-color: var(--border-hover);
            border-color: var(--accent-blue);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
        }

        .kpi-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .kpi-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kpi-icon.blue { background: rgba(0, 194, 255, 0.15); color: var(--accent-blue); }
        .kpi-icon.cyan { background: rgba(0, 194, 255, 0.15); color: var(--accent-cyan); }
        .kpi-icon.green { background: rgba(0, 230, 138, 0.15); color: var(--accent-green); }
        .kpi-icon.orange { background: rgba(245, 166, 35, 0.15); color: var(--accent-orange); }
        .kpi-icon.purple { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }

        .kpi-icon svg {
            width: 22px;
            height: 22px;
        }

        .kpi-trend {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .kpi-trend.up {
            background: rgba(0, 230, 138, 0.15);
            color: var(--accent-green);
        }

        .kpi-trend.down {
            background: rgba(255, 107, 107, 0.15);
            color: var(--accent-red);
        }

        .kpi-value {
            font-size: 34px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 2px;
            line-height: 1.1;
        }

        .kpi-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .kpi-subtext {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Performance Pulse Grid */
        .pulse-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
            margin-bottom: 24px;
        }
        @media (max-width: 900px) {
            .pulse-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .pulse-grid { grid-template-columns: 1fr; }
        }

        .pulse-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 18px;
            position: relative;
            overflow: hidden;
            transition: border-color 0.2s, transform 0.15s;
        }
        .pulse-card:hover {
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-2px);
        }
        .pulse-card .pulse-accent {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            border-radius: 14px 14px 0 0;
        }
        .pulse-card .pulse-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .pulse-card .pulse-value {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.1;
        }
        .pulse-card .pulse-row {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-top: 4px;
        }
        .pulse-card .pulse-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 6px;
        }
        .pulse-trend.improving {
            background: rgba(0, 230, 138, 0.12);
            color: var(--accent-green);
        }
        .pulse-trend.declining {
            background: rgba(255, 107, 107, 0.12);
            color: var(--accent-red);
        }
        .pulse-trend.stable {
            background: rgba(148, 163, 184, 0.12);
            color: var(--text-muted);
        }
        .pulse-trend.new-data {
            background: rgba(0, 194, 255, 0.12);
            color: var(--accent-blue);
        }
        .pulse-card .pulse-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }
        .pulse-card .pulse-sparkline {
            margin-top: 10px;
            height: 32px;
            display: flex;
            align-items: flex-end;
            gap: 2px;
        }
        .pulse-sparkline .spark-bar {
            flex: 1;
            min-width: 4px;
            border-radius: 2px 2px 0 0;
            transition: opacity 0.15s;
            opacity: 0.5;
        }
        .pulse-sparkline .spark-bar:last-child {
            opacity: 1;
        }
        .pulse-sparkline .spark-bar:hover {
            opacity: 1;
        }

        /* Last Session - Compact Clickable Card */
        .last-session-compact {
            margin-bottom: 20px;
        }
        .last-session-inner {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .last-session-chip {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 200px;
        }
        .last-session-chip:hover {
            border-color: rgba(255,255,255,0.15);
            background: var(--bg-hover);
            transform: translateY(-1px);
        }
        .last-session-chip .chip-icon {
            width: 34px;
            height: 34px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .last-session-chip .chip-icon svg {
            width: 16px;
            height: 16px;
        }
        .last-session-chip .chip-icon.start-icon { background: rgba(245,166,35,0.12); color: var(--accent-orange); }
        .last-session-chip .chip-icon.turn-icon { background: rgba(0,194,255,0.12); color: var(--accent-cyan); }
        .last-session-chip .chip-icon.race-icon { background: rgba(0,230,138,0.12); color: var(--accent-green); }
        .last-session-chip .chip-text {
            flex: 1;
            min-width: 0;
        }
        .last-session-chip .chip-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .last-session-chip .chip-title .chip-date {
            font-weight: 400;
            opacity: 0.7;
        }
        .last-session-chip .chip-values {
            display: flex;
            align-items: baseline;
            gap: 12px;
            flex-wrap: wrap;
        }
        .last-session-chip .chip-val {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        .last-session-chip .chip-val-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
        }
        .last-session-chip .chip-val-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .last-session-chip .chip-arrow {
            color: var(--text-muted);
            flex-shrink: 0;
            opacity: 0.4;
            transition: opacity 0.2s, transform 0.2s;
        }
        .last-session-chip:hover .chip-arrow {
            opacity: 0.8;
            transform: translateX(2px);
        }
        @media (max-width: 640px) {
            .last-session-chip { min-width: 100%; }
        }

        /* Data Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        .card-body {
            padding: 24px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
        }

        .data-table tr:hover td {
            background: var(--bg-card-hover);
        }

        .data-table td {
            font-size: 14px;
            color: var(--text-primary);
        }

        .data-table .mono {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: rgba(0, 230, 138, 0.1);
            color: var(--accent-green);
        }

        .connection-status.disconnected {
            background: rgba(255, 107, 107, 0.1);
            color: var(--accent-red);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* ===== VERSION TAG ===== */
        .version-tag {
            font-size: 9px;
            font-weight: 700;
            color: var(--tag-text);
            font-family: 'JetBrains Mono', monospace;
            padding: 2px 6px;
            background: var(--tag-bg);
            border: 1px solid var(--tag-border);
            border-radius: 4px;
            margin-left: 6px;
            letter-spacing: 0.5px;
        }

        /* ===== WELCOME HEADER (Slim Accent Strip) ===== */
        .welcome-strip {
            height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple), var(--accent-pink, #FF6B9D));
            border-radius: 3px;
            margin-bottom: 16px;
        }
        .welcome-bar {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 2px;
        }
        .welcome-bar h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; margin: 0; }
        .welcome-bar .wb-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .welcome-bar .wb-right { display: flex; gap: 8px; align-items: center; }
        .welcome-bar .wb-badge {
            font-size: 9px; font-weight: 700; padding: 4px 8px; border-radius: 6px;
            background: var(--tag-bg); color: var(--tag-text); border: 1px solid var(--tag-border);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        @media (max-width: 768px) {
            .welcome-bar { flex-direction: column; align-items: flex-start; gap: 8px; }
            .welcome-bar h1 { font-size: 18px; }
        }

        /* ===== INFO TIPS (hover tooltips for charts/KPIs) ===== */
        .info-tip {
            display: inline-flex; align-items: center; justify-content: center;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--accent-subtle);
            border: 1px solid var(--tag-border);
            color: var(--text-muted);
            font-size: 10px; font-weight: 700; font-family: 'Montserrat', sans-serif;
            cursor: help; position: relative;
            vertical-align: middle; margin-left: 6px; flex-shrink: 0;
            transition: color 0.2s, border-color 0.2s, background 0.2s;
        }
        .info-tip::before { content: '?'; }
        .info-tip:hover { color: var(--accent-blue); border-color: var(--accent-blue); background: var(--accent-glow); }
        .info-tip .tip-content {
            display: none; position: absolute; z-index: 500;
            bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%);
            width: 260px; padding: 12px 14px;
            background: var(--bg-card); border: 1px solid var(--border-hover);
            border-radius: 10px; box-shadow: var(--shadow-card-lg);
            font-size: 11px; font-weight: 400; line-height: 1.55;
            color: var(--text-secondary); text-align: left;
            pointer-events: none;
        }
        .info-tip .tip-content::after {
            content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            border: 6px solid transparent; border-top-color: var(--border-hover);
        }
        .info-tip .tip-content strong { color: var(--text-primary); font-weight: 600; }
        .info-tip .tip-content .tip-good { color: var(--accent-green); font-weight: 600; }
        .info-tip .tip-content .tip-watch { color: var(--accent-orange); font-weight: 600; }
        .info-tip:hover .tip-content { display: block; pointer-events: auto; }
        /* Tip content alignment adjustments for edge cases */
        .info-tip.tip-left .tip-content { left: 0; transform: none; }
        .info-tip.tip-left .tip-content::after { left: 12px; transform: none; }
        .info-tip.tip-right .tip-content { left: auto; right: 0; transform: none; }
        .info-tip.tip-right .tip-content::after { left: auto; right: 12px; transform: none; }
        @media (max-width: 768px) {
            .info-tip .tip-content { width: 220px; font-size: 10px; }
        }

        /* ===== SAMPLE DATA BANNER ===== */
        .sample-banner {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 18px; border-radius: 12px;
            background: rgba(245,166,35,0.06); border: 1px dashed rgba(245,166,35,0.35);
            margin-bottom: 16px;
        }
        .sample-banner svg { width: 20px; height: 20px; color: var(--accent-orange); flex-shrink: 0; }
        .sample-banner-text { flex: 1; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
        .sample-banner-text strong { color: var(--accent-orange); font-weight: 700; }
        .sample-banner .btn-sample {
            padding: 7px 16px; border-radius: 8px; border: none; cursor: pointer;
            font-size: 12px; font-weight: 700; font-family: 'Montserrat', sans-serif;
            background: var(--accent-orange); color: #0B0E14; transition: opacity 0.2s;
        }
        .sample-banner .btn-sample:hover { opacity: 0.85; }
        .sample-badge {
            display: inline-flex; align-items: center; gap: 4px;
            font-size: 9px; font-weight: 700; text-transform: uppercase;
            padding: 3px 8px; border-radius: 5px;
            background: rgba(245,166,35,0.12); color: var(--accent-orange);
            border: 1px solid rgba(245,166,35,0.25); letter-spacing: 0.5px;
            margin-left: 8px; vertical-align: middle;
        }
        .sample-badge svg { width: 10px; height: 10px; }
        .btn-exit-sample {
            padding: 5px 12px; border-radius: 6px; border: 1px solid rgba(245,166,35,0.35);
            background: transparent; color: var(--accent-orange); cursor: pointer;
            font-size: 11px; font-weight: 600; font-family: 'Montserrat', sans-serif;
            transition: background 0.2s;
        }
        .btn-exit-sample:hover { background: rgba(245,166,35,0.1); }

        /* ===== QUICK ACTIONS ===== */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        .quick-action {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 22px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-action:hover {
            transform: translateY(-3px);
            border-color: var(--accent-blue);
            box-shadow: 0 8px 24px rgba(0, 194, 255, 0.15);
        }
        .quick-action-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .quick-action-icon.starts { background: rgba(0, 194, 255, 0.15); color: var(--accent-blue); }
        .quick-action-icon.turns { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
        .quick-action-icon.races { background: rgba(0, 230, 138, 0.15); color: var(--accent-green); }
        .quick-action-icon svg { width: 24px; height: 24px; }
        .quick-action-text h3 { font-size: 15px; font-weight: 600; margin-bottom: 3px; }
        .quick-action-text p { font-size: 12px; color: var(--text-secondary); }

        /* ===== SECTION HEADER ===== */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .section-header h2 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .section-header h2 svg { width: 20px; height: 20px; }
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            font-family: inherit;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-small:hover { background: var(--bg-card-hover); color: var(--text-primary); }

        /* ===== PERSONAL BESTS GRID ===== */
        .pb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .pb-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .pb-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        }
        .pb-card .event-name { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; }
        .pb-card .pb-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 26px; font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        .pb-card .pb-date { font-size: 11px; color: var(--text-muted); }
        .pb-card .trend-indicator {
            position: absolute; top: 16px; right: 14px;
            font-size: 11px; padding: 3px 8px;
            border-radius: 6px; font-weight: 600;
            display: flex; align-items: center; gap: 3px;
        }
        .trend-indicator.improving { background: rgba(0, 230, 138, 0.15); color: var(--accent-green); }
        .trend-indicator.declining { background: rgba(255, 107, 107, 0.15); color: var(--accent-red); }
        .trend-indicator.stable { background: rgba(148, 163, 184, 0.1); color: var(--text-muted); }

        /* ===== GOALS GRID ===== */
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .goal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 20px;
        }
        .goal-card-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 14px;
        }
        .goal-type-badge {
            font-size: 10px; padding: 3px 8px;
            border-radius: 6px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .goal-type-badge.athlete-set { background: rgba(0, 230, 138, 0.15); color: var(--accent-green); }
        .goal-type-badge.coach-set { background: rgba(167, 139, 250, 0.15); color: var(--accent-purple); }
        .goal-event-name { font-size: 15px; font-weight: 600; margin-bottom: 12px; }
        .goal-values { display: flex; gap: 24px; margin-bottom: 14px; }
        .goal-val label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 3px; letter-spacing: 0.5px; }
        .goal-val span {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px; font-weight: 600;
        }
        .goal-val span.target { color: var(--accent-cyan); }
        .goal-val span.current { color: var(--text-secondary); }
        .goal-progress { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; margin-bottom: 6px; }
        .goal-progress-bar { height: 100%; background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); border-radius: 3px; transition: width 0.4s ease; }
        .goal-progress-text { font-size: 11px; color: var(--text-muted); text-align: right; }
        .goal-notes { font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic; }
        .goal-actions { display: flex; gap: 8px; margin-top: 12px; }
        .goal-btn {
            padding: 6px 12px; font-size: 11px; font-weight: 600;
            border: 1px solid var(--border-color); border-radius: 6px;
            background: transparent; color: var(--text-secondary);
            cursor: pointer; font-family: inherit;
        }
        .goal-btn:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .goal-btn.achieved { border-color: rgba(0, 230, 138, 0.4); color: var(--accent-green); }
        .goal-btn.delete { border-color: rgba(255, 107, 107, 0.3); color: var(--accent-red); }

        .add-goal-card {
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 14px;
            padding: 40px 20px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
            color: var(--text-muted); min-height: 160px;
        }
        .add-goal-card:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
        .add-goal-card svg { width: 28px; height: 28px; margin-bottom: 8px; }
        .add-goal-card span { font-size: 13px; font-weight: 500; }

        /* ===== ALERTS ===== */
        .alerts-section { margin-bottom: 28px; }
        .alert-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-blue);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex; align-items: center; gap: 14px;
        }
        .alert-item.success { border-left-color: var(--accent-green); }
        .alert-item.warning { border-left-color: var(--accent-orange); }
        .alert-item.info { border-left-color: var(--accent-blue); }
        .alert-icon {
            width: 36px; height: 36px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .alert-icon.success { background: rgba(0, 230, 138, 0.12); color: var(--accent-green); }
        .alert-icon.warning { background: rgba(245, 166, 35, 0.12); color: var(--accent-orange); }
        .alert-icon.info { background: rgba(0, 194, 255, 0.12); color: var(--accent-blue); }
        .alert-icon svg { width: 18px; height: 18px; }
        .alert-content h4 { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
        .alert-content p { font-size: 12px; color: var(--text-secondary); }
        .alert-time { font-size: 11px; color: var(--text-muted); margin-left: auto; white-space: nowrap; }
        .alert-dismiss {
            width: 24px; height: 24px;
            border: none; background: transparent;
            color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px; font-size: 14px;
            flex-shrink: 0; margin-left: 8px;
            transition: all 0.15s;
        }
        .alert-dismiss:hover { background: rgba(148, 163, 184, 0.15); color: var(--text-primary); }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center; justify-content: center;
            z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 28px;
            width: 100%;
            max-width: 440px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { font-size: 18px; font-weight: 600; }
        .modal-close {
            width: 30px; height: 30px;
            border: none; background: var(--bg-secondary);
            border-radius: 8px; color: var(--text-secondary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-family: inherit;
        }
        .modal-close:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .modal-body .form-group { margin-bottom: 16px; }
        .modal-body .form-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 500; }
        .modal-body .form-group select,
        .modal-body .form-group input {
            width: 100%; padding: 10px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px; font-family: inherit;
        }
        .modal-body .form-group select:focus,
        .modal-body .form-group input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 194, 255, 0.12);
        }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-modal {
            padding: 10px 20px; font-size: 13px; font-weight: 600;
            font-family: inherit; border: none; border-radius: 10px;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-modal.cancel { background: var(--bg-secondary); color: var(--text-secondary); }
        .btn-modal.cancel:hover { background: var(--bg-card-hover); }
        .btn-modal.save { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; }
        .btn-modal.save:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 194, 255, 0.3); }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .welcome-bar h1 { font-size: 18px; }
            .pb-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
            .goals-grid { grid-template-columns: 1fr; }
        }

        /* Athlete Selector (Coach View) */
        .athlete-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .athlete-selector select {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
            min-width: 200px;
        }

        .athlete-selector select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Session Cards */
        .session-card {
            background: var(--bg-card-hover);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .session-card:hover {
            background: var(--bg-card);
            border: 1px solid var(--accent-blue);
        }

        .session-date {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .session-name {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .session-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .session-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        /* =============================================
           RACE ANALYSIS MODULE - v01.21
           ============================================= */
        .race-controls {
            display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px; align-items: center;
        }
        .race-controls select, .race-controls input {
            padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 10px; color: var(--text-primary); font-size: 13px; font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
            min-width: 160px;
        }
        .race-controls select:focus, .race-controls input:focus {
            outline: none; border-color: var(--accent-blue);
        }
        .race-controls label { font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-right: 4px; }

        /* Race Selector (clickable race cards) */
        .race-selector-wrap { margin-bottom: 24px; }
        .race-selector-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .race-selector-header h3 { font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0; }
        .race-selector-hint { font-size: 12px; color: var(--text-muted); }
        .race-selector-list {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px;
            scrollbar-width: thin; scrollbar-color: var(--border-color) transparent;
        }
        .race-selector-list::-webkit-scrollbar { height: 6px; }
        .race-selector-list::-webkit-scrollbar-track { background: transparent; }
        .race-selector-list::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .race-card-pick {
            flex-shrink: 0; padding: 12px 16px; background: var(--bg-secondary); border: 2px solid var(--border-color);
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease; min-width: 150px; position: relative;
        }
        .race-card-pick:hover { border-color: rgba(0,194,255,0.4); background: rgba(0,194,255,0.05); }
        .race-card-pick.selected-primary {
            border-color: var(--accent-blue); background: rgba(0,194,255,0.08);
            box-shadow: 0 0 0 3px rgba(0,194,255,0.15);
        }
        .race-card-pick.selected-compare {
            border-color: var(--accent-purple); background: rgba(167,139,250,0.08);
            box-shadow: 0 0 0 3px rgba(167,139,250,0.15);
        }
        .race-card-pick .rc-event { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .race-card-pick .rc-time { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        .race-card-pick .rc-date { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .race-card-pick .rc-badge {
            position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: 700;
            padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .race-card-pick.selected-primary .rc-badge { background: var(--accent-blue); color: white; }
        .race-card-pick.selected-compare .rc-badge { background: var(--accent-purple); color: white; }
        .rc-course-tag { display:inline-block; font-size:9px; font-weight:700; padding:1px 5px; border-radius:4px; background:var(--tag-bg); color:var(--tag-text); border:1px solid var(--tag-border); vertical-align:middle; margin-left:4px; letter-spacing:0.5px; }
        .race-selector-clear {
            font-size: 12px; color: var(--accent-blue); cursor: pointer; font-weight: 500; 
            border: none; background: none; font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
        }
        .race-selector-clear:hover { text-decoration: underline; }

        .race-tab-bar {
            display: flex; gap: 0; border-bottom: 2px solid var(--border-color); margin-bottom: 20px;
        }
        .race-tab {
            padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: 500;
            color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .race-tab:hover { color: var(--text-secondary); }
        .race-tab.active { color: var(--accent-blue); border-bottom-color: var(--accent-blue); }
        .race-tab-content { display: none; }
        .race-tab-content.active { display: block; }

        /* Split Bar Visualization */
        .split-bars { display: flex; flex-direction: column; gap: 6px; }
        .split-bar-row {
            display: grid; grid-template-columns: 60px 1fr 70px; align-items: center; gap: 10px;
        }
        .split-bar-label { font-size: 12px; color: var(--text-secondary); font-weight: 500; text-align: right; }
        .split-bar-track {
            height: 28px; background: var(--bg-secondary); border-radius: 6px; overflow: hidden; position: relative;
        }
        .split-bar-fill {
            height: 100%; border-radius: 6px; transition: width 0.5s ease; display: flex;
            align-items: center; justify-content: flex-end; padding-right: 8px;
            font-size: 11px; font-weight: 600; color: white; min-width: 30px;
        }
        .split-bar-time {
            font-size: 13px; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); text-align: right;
        }
        .split-bar-fill.fastest { background: linear-gradient(90deg, var(--accent-green), #00B86B); }
        .split-bar-fill.fast { background: linear-gradient(90deg, var(--accent-blue), #0097CC); }
        .split-bar-fill.medium { background: linear-gradient(90deg, var(--accent-orange), #D98E10); }
        .split-bar-fill.slow { background: linear-gradient(90deg, var(--accent-red), #E54545); }

        /* ===== TURN MODULE ===== */
        .turn-selector-list {
            display: flex; gap: 10px; overflow-x: auto; padding: 4px 0 12px 0;
            scrollbar-width: thin; scrollbar-color: var(--border-color) transparent;
        }
        .turn-selector-list::-webkit-scrollbar { height: 4px; }
        .turn-selector-list::-webkit-scrollbar-track { background: transparent; }
        .turn-selector-list::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .turn-card-pick {
            flex-shrink: 0; padding: 12px 16px; background: var(--bg-secondary); border: 2px solid var(--border-color);
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease; min-width: 150px; position: relative;
        }
        .turn-card-pick:hover { border-color: rgba(167,139,250,0.4); background: rgba(167,139,250,0.05); }
        .turn-card-pick.selected-primary {
            border-color: var(--accent-purple); background: rgba(167,139,250,0.08);
            box-shadow: 0 0 0 3px rgba(167,139,250,0.15);
        }
        .turn-card-pick.selected-compare {
            border-color: var(--accent-cyan); background: rgba(0,194,255,0.08);
            box-shadow: 0 0 0 3px rgba(0,194,255,0.15);
        }
        .turn-card-pick .tc-style { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; text-transform: capitalize; }
        .turn-card-pick .tc-time { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        .turn-card-pick .tc-date { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .turn-card-pick .tc-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .turn-card-pick .tc-badge {
            position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: 700;
            padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .turn-card-pick.selected-primary .tc-badge { background: var(--accent-purple); color: white; }
        .turn-card-pick.selected-compare .tc-badge { background: var(--accent-cyan); color: white; }
        .turn-selector-clear {
            font-size: 12px; color: var(--accent-purple); cursor: pointer; font-weight: 500;
            border: none; background: none; font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
        }
        .turn-selector-clear:hover { text-decoration: underline; }

        .turn-tab-bar {
            display: flex; gap: 0; border-bottom: 2px solid var(--border-color); margin-bottom: 20px;
        }
        .turn-tab {
            padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: 500;
            color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .turn-tab:hover { color: var(--text-secondary); }
        .turn-tab.active { color: var(--accent-purple); border-bottom-color: var(--accent-purple); }
        .turn-tab-content { display: none; }
        .turn-tab-content.active { display: block; }

        .turn-trials-table tr.row-primary { border-left: 3px solid var(--accent-purple); background: rgba(167,139,250,0.04); }
        .turn-trials-table tr.row-compare { border-left: 3px solid var(--accent-cyan); background: rgba(0,194,255,0.04); }

        /* ===== START MODULE ===== */
        .start-selector-list {
            display: flex; gap: 10px; overflow-x: auto; padding: 4px 0 12px 0;
            scrollbar-width: thin; scrollbar-color: var(--border-color) transparent;
        }
        .start-selector-list::-webkit-scrollbar { height: 4px; }
        .start-selector-list::-webkit-scrollbar-track { background: transparent; }
        .start-selector-list::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .start-card-pick {
            flex-shrink: 0; padding: 12px 16px; background: var(--bg-secondary); border: 2px solid var(--border-color);
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease; min-width: 150px; position: relative;
        }
        .start-card-pick:hover { border-color: rgba(245,166,35,0.4); background: rgba(245,166,35,0.05); }
        .start-card-pick.selected-primary {
            border-color: var(--accent-orange); background: rgba(245,166,35,0.08);
            box-shadow: 0 0 0 3px rgba(245,166,35,0.15);
        }
        .start-card-pick.selected-compare {
            border-color: var(--accent-cyan); background: rgba(0,194,255,0.08);
            box-shadow: 0 0 0 3px rgba(0,194,255,0.15);
        }
        .start-card-pick .sc-style { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; text-transform: capitalize; }
        .start-card-pick .sc-reaction { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        .start-card-pick .sc-date { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .start-card-pick .sc-sub { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .start-card-pick .sc-badge {
            position: absolute; top: 8px; right: 8px; font-size: 9px; font-weight: 700;
            padding: 2px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .start-card-pick.selected-primary .sc-badge { background: var(--accent-orange); color: white; }
        .start-card-pick.selected-compare .sc-badge { background: var(--accent-cyan); color: white; }
        .start-selector-clear {
            font-size: 12px; color: var(--accent-orange); cursor: pointer; font-weight: 500;
            border: none; background: none; font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
        }
        .start-selector-clear:hover { text-decoration: underline; }

        .start-tab-bar {
            display: flex; gap: 0; border-bottom: 2px solid var(--border-color); margin-bottom: 20px;
        }
        .start-tab {
            padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: 500;
            color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .start-tab:hover { color: var(--text-secondary); }
        .start-tab.active { color: var(--accent-orange); border-bottom-color: var(--accent-orange); }
        .start-tab-content { display: none; }
        .start-tab-content.active { display: block; }

        /* Phase bar visualization */
        .phase-bar-stack {
            display: flex; height: 40px; border-radius: 8px; overflow: hidden; margin: 12px 0;
        }
        .phase-bar-segment {
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 600; color: white; transition: width 0.5s ease;
            min-width: 30px; position: relative;
        }
        .phase-bar-segment .seg-label {
            font-size: 9px; font-weight: 500; opacity: 0.85; position: absolute; top: 2px; left: 6px;
        }
        .phase-bar-segment .seg-value {
            font-size: 13px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
        }

        /* Approach timeline visual */
        .approach-timeline {
            position: relative; display: flex; align-items: center;
            background: rgba(148,163,184,0.06); border-radius: 12px;
            padding: 28px 16px 16px; margin: 12px 0 8px; overflow: visible;
        }
        .approach-lane {
            flex: 1; display: flex; align-items: center; position: relative; height: 48px;
        }
        .approach-seg {
            position: relative; height: 48px; display: flex; align-items: center;
            justify-content: center; border-radius: 6px; transition: all 0.3s ease;
            flex: 1;
        }
        .approach-seg .seg-time {
            font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 700;
            color: white; z-index: 1;
        }
        .approach-seg .seg-zone {
            position: absolute; top: -18px; left: 0; right: 0; text-align: center;
            font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;
            letter-spacing: 0.5px; white-space: nowrap;
        }
        .approach-marker {
            display: flex; flex-direction: column; align-items: center; padding: 0 3px;
            z-index: 2; flex-shrink: 0;
        }
        .approach-marker .marker-dist {
            font-size: 10px; font-weight: 700; color: var(--text-secondary);
            margin-bottom: 2px;
        }
        .approach-marker .marker-line {
            width: 2px; height: 12px; background: var(--text-muted); opacity: 0.4;
            border-radius: 1px;
        }
        .approach-wall {
            flex-shrink: 0; width: 4px; height: 56px; background: var(--accent-purple);
            border-radius: 2px; margin: 0 6px; box-shadow: 0 0 8px rgba(167,139,250,0.4);
        }
        .approach-wall-label {
            font-size: 9px; font-weight: 700; color: var(--accent-purple);
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* Start metric grid */
        .start-metric-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;
        }
        .start-metric-item {
            padding: 14px; background: var(--bg-secondary); border-radius: 10px; border: 1px solid var(--border-color);
        }
        .start-metric-item .smi-label { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; }
        .start-metric-item .smi-value {
            font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary);
        }
        .start-metric-item .smi-unit { font-size: 11px; color: var(--text-muted); font-weight: 400; margin-left: 2px; }
        .start-metric-item .smi-delta {
            display: inline-block; font-size: 11px; font-weight: 600; padding: 1px 6px; border-radius: 4px; margin-left: 6px;
        }
        .start-metric-item .smi-delta.positive { background: rgba(0,230,138,0.15); color: var(--accent-green); }
        .start-metric-item .smi-delta.negative { background: rgba(255,107,107,0.15); color: var(--accent-red); }
        .start-metric-item .smi-delta.neutral { background: rgba(148,163,184,0.15); color: var(--text-secondary); }

        /* "" Flight Path - Minimalist "" */
        .flight-path-container {
            position: relative; background: rgba(148,163,184,0.04); border-radius: 14px;
            border: 1px solid var(--border-color); padding: 20px 24px 16px; margin-bottom: 20px;
        }
        .flight-path-container h4 { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 4px; }
        .flight-path-container .fp-sub { font-size: 11px; color: var(--text-muted); margin-bottom: 16px; }
        .flight-path-svg { width: 100%; height: auto; display: block; }
        .fp-val { font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 13px; fill: var(--text-primary); }
        .fp-unit { font-size: 10px; fill: var(--text-muted); font-weight: 500; }
        .fp-lbl { font-size: 9px; fill: var(--text-muted); font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }
        .fp-stat-row { display: flex; gap: 24px; margin-top: 14px; flex-wrap: wrap; }
        .fp-stat { display: flex; flex-direction: column; }
        .fp-stat-label { font-size: 10px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
        .fp-stat-val { font-size: 16px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        .fp-stat-val .unit { font-size: 11px; color: var(--text-muted); font-weight: 400; margin-left: 2px; }
        .fp-stat-delta { font-size: 11px; font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

        /* "" Velocity Decay Chart container "" */
        .vel-decay-container {
            background: rgba(148,163,184,0.04); border-radius: 14px;
            border: 1px solid var(--border-color); padding: 20px 24px 16px; margin-bottom: 20px;
        }
        .vel-decay-container h4 { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 14px; }

        /* "" Entry Geometry Visual "" */
        .entry-geom-container {
            background: rgba(148,163,184,0.04); border-radius: 14px;
            border: 1px solid var(--border-color); padding: 20px 24px 16px; margin-bottom: 20px;
        }
        .entry-geom-container h4 { font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 14px; }
        .entry-geom-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .entry-geom-card {
            text-align: center; padding: 16px 12px; background: var(--bg-secondary);
            border-radius: 10px; border: 1px solid var(--border-color);
        }
        .entry-geom-card .egc-icon { font-size: 20px; margin-bottom: 6px; color: var(--accent-purple); }
        .entry-geom-card .egc-label { font-size: 10px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 4px; }
        .entry-geom-card .egc-value { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); }
        .entry-geom-card .egc-unit { font-size: 11px; color: var(--text-muted); font-weight: 400; }
        .entry-geom-card .egc-bar { margin-top: 8px; height: 4px; border-radius: 2px; background: rgba(148,163,184,0.15); overflow: hidden; }
        .entry-geom-card .egc-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        @media (max-width: 768px) {
            .entry-geom-grid { grid-template-columns: 1fr; }
        }

        /* ============================================ */
        /* COACH DASHBOARD STYLES                      */
        /* ============================================ */
        #coachDashboard { display: none; }
        .coach-section-header { display:flex; align-items:center; gap:10px; margin:24px 0 14px; }
        .coach-section-header h2 { font-size:15px; font-weight:600; color:var(--text-primary); display:flex; align-items:center; gap:8px; flex:1; }
        .coach-section-header h2 svg { width:18px; height:18px; color:var(--text-muted); }
        .coach-section-header .section-count { font-size:12px; color:var(--text-muted); font-weight:400; margin-left:4px; }
        .collapsible-header { cursor:pointer; user-select:none; }
        .collapsible-header:hover h2 { color:var(--accent-blue); }
        .collapse-chevron { width:18px; height:18px; color:var(--text-muted); transition:transform 0.25s ease; flex-shrink:0; }
        .collapse-chevron.collapsed { transform:rotate(-90deg); }
        .collapsible-body { overflow:hidden; transition: max-height 0.3s ease, opacity 0.25s ease; max-height:2000px; opacity:1; }
        .collapsible-body.collapsed { max-height:0; opacity:0; pointer-events:none; }

        /* ============================================ */
        /* HOME PAGE CAROUSELS (v02.11) - Option C     */
        /* ============================================ */
        .home-carousels-row { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px; }
        @media (max-width: 900px) { .home-carousels-row { grid-template-columns:1fr; } }
        
        .carousel-card { 
            background:var(--card-bg); 
            border:1px solid var(--border); 
            border-radius:16px; 
            overflow:hidden;
            min-height:340px;
            display:flex;
            flex-direction:column;
            box-shadow: 0 0 20px rgba(0, 194, 255, 0.06), inset 0 1px 0 rgba(255,255,255,0.03);
        }
        .carousel-card.records-carousel {
            border-top: 2px solid var(--accent-blue);
        }
        .carousel-card.competition-carousel {
            border-top: 2px solid var(--accent-gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.06), inset 0 1px 0 rgba(255,255,255,0.03);
        }
        .carousel-header { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border); }
        .carousel-title { display:flex; align-items:center; gap:10px; font-size:14px; font-weight:600; color:var(--text-primary); }
        .carousel-title svg { width:18px; height:18px; color:var(--accent-blue); }
        .carousel-filter { display:flex; gap:3px; background:rgba(0,0,0,0.25); padding:3px; border-radius:8px; }
        .carousel-filter-btn { padding:5px 10px; border-radius:6px; font-size:11px; font-weight:600; color:var(--text-muted); background:transparent; border:none; cursor:pointer; transition:all 0.2s; }
        .carousel-filter-btn.active { background:var(--accent-blue); color:#000; }
        .carousel-filter-btn:hover:not(.active) { color:var(--text-primary); }
        .carousel-body { padding:20px; flex:1; display:flex; flex-direction:column; }
        .carousel-nav { display:flex; align-items:center; justify-content:space-between; padding:12px 18px; border-top:1px solid var(--border); background:rgba(0,0,0,0.15); }
        .carousel-dots { display:flex; gap:5px; }
        .carousel-dot { width:8px; height:8px; border-radius:50%; background:var(--bg-tertiary); cursor:pointer; transition:all 0.2s; }
        .carousel-dot.active { background:var(--accent-blue); width:18px; border-radius:4px; }
        .carousel-arrows { display:flex; gap:6px; }
        .carousel-arrow { width:30px; height:30px; border-radius:8px; background:var(--bg-tertiary); border:1px solid var(--border); color:var(--text-muted); display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s; }
        .carousel-arrow:hover { background:var(--border); color:var(--text-primary); }
        .carousel-arrow:disabled { opacity:0.4; cursor:not-allowed; }
        
        /* Records Carousel Slide */
        .records-slide-title { text-align:center; margin-bottom:16px; }
        .records-slide-title .stroke-name { font-size:16px; font-weight:700; color:var(--text-primary); }
        .records-slide-title .stroke-icon { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; border-radius:8px; margin-right:8px; vertical-align:middle; }
        .stroke-icon.freestyle { background:rgba(0,194,255,0.15); color:var(--accent-blue); }
        .stroke-icon.backstroke { background:rgba(168,85,247,0.15); color:var(--accent-purple); }
        .stroke-icon.breaststroke { background:rgba(34,197,94,0.15); color:var(--accent-green); }
        .stroke-icon.butterfly { background:rgba(249,115,22,0.15); color:var(--accent-orange); }
        .stroke-icon.im { background:rgba(236,72,153,0.15); color:#ec4899; }
        .stroke-icon.medley { background:rgba(236,72,153,0.15); color:#ec4899; }
        
        .records-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:12px; flex:1; }
        .record-card { 
            background:linear-gradient(180deg, rgba(0,194,255,0.08) 0%, rgba(0,194,255,0.02) 100%);
            border:1px solid rgba(0,194,255,0.2); 
            border-radius:12px; 
            padding:14px; 
            text-align:center; 
            transition:all 0.2s; 
        }
        .record-card:hover { border-color:rgba(0,194,255,0.4); transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,194,255,0.1); }
        .record-card .event-dist { font-size:11px; color:var(--text-muted); margin-bottom:6px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
        .record-card .event-time { font-size:22px; font-weight:700; color:var(--accent-blue); font-family:'Monaco','Consolas',monospace; margin-bottom:8px; }
        .record-card .event-holder { display:flex; align-items:center; justify-content:center; gap:6px; }
        .record-card .holder-avatar { width:24px; height:24px; border-radius:50%; background:linear-gradient(135deg,#ffd700,#ff8c00); display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:700; color:#000; }
        .record-card .holder-name { font-size:11px; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65px; }
        .record-card .event-date { font-size:10px; color:var(--text-muted); margin-top:6px; }
        .record-card.pb-card { 
            background:linear-gradient(180deg, rgba(168,85,247,0.08) 0%, rgba(168,85,247,0.02) 100%);
            border:1px solid rgba(168,85,247,0.2); 
        }
        .record-card.pb-card:hover { border-color:rgba(168,85,247,0.4); box-shadow:0 4px 12px rgba(168,85,247,0.1); }
        .record-card.pb-card .event-time { color:var(--accent-purple); }
        .record-card.pb-card .pb-label { display:inline-flex; align-items:center; gap:3px; font-size:9px; color:var(--accent-gold); margin-top:4px; }
        .record-card.pb-card .pb-label svg { width:10px; height:10px; }
        .carousel-slide-label { text-align:center; font-size:10px; color:var(--text-muted); margin-top:auto; padding-top:12px; }
        
        /* Competition Podium Mini */
        .comp-slide-title { text-align:center; font-size:14px; font-weight:600; color:var(--accent-gold); margin-bottom:20px; display:flex; align-items:center; justify-content:center; gap:8px; }
        .comp-slide-title svg { width:18px; height:18px; }
        .comp-podium-mini { display:flex; align-items:flex-end; justify-content:center; gap:16px; flex:1; padding-top:10px; }
        .comp-podium-item { display:flex; flex-direction:column; align-items:center; width:100px; }
        .comp-podium-item.rank-1 { order:2; }
        .comp-podium-item.rank-2 { order:1; }
        .comp-podium-item.rank-3 { order:3; }
        .comp-avatar-mini { width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:700; margin-bottom:8px; position:relative; }
        .comp-podium-item.rank-1 .comp-avatar-mini { width:56px; height:56px; font-size:18px; background:linear-gradient(135deg,#ffd700,#ff8c00); color:#000; box-shadow:0 0 20px rgba(255,215,0,0.35); }
        .comp-podium-item.rank-2 .comp-avatar-mini { background:linear-gradient(135deg,#c0c0c0,#a0a0a0); color:#000; }
        .comp-podium-item.rank-3 .comp-avatar-mini { background:linear-gradient(135deg,#cd7f32,#a0522d); color:#fff; }
        .comp-medal-mini { position:absolute; bottom:-4px; right:-4px; width:18px; height:18px; border-radius:50%; background:var(--card-bg); border:2px solid; display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:700; }
        .comp-podium-item.rank-1 .comp-medal-mini { border-color:#ffd700; color:#ffd700; }
        .comp-podium-item.rank-2 .comp-medal-mini { border-color:#c0c0c0; color:#c0c0c0; }
        .comp-podium-item.rank-3 .comp-medal-mini { border-color:#cd7f32; color:#cd7f32; }
        .comp-name-mini { font-size:12px; font-weight:600; color:var(--text-primary); text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:90px; }
        .comp-team-mini { font-size:10px; color:var(--text-muted); margin-top:2px; text-align:center; }
        .comp-value-mini { font-size:14px; font-weight:700; color:var(--accent-gold); font-family:'Monaco',monospace; margin-top:6px; }
        .comp-podium-item.rank-1 .comp-value-mini { font-size:16px; color:#ffd700; }
        .comp-bar-mini { width:100%; border-radius:6px 6px 0 0; margin-top:8px; }
        .comp-podium-item.rank-1 .comp-bar-mini { height:55px; background:linear-gradient(to top,rgba(255,215,0,0.3),rgba(255,215,0,0.08)); }
        .comp-podium-item.rank-2 .comp-bar-mini { height:42px; background:linear-gradient(to top,rgba(192,192,192,0.3),rgba(192,192,192,0.08)); }
        .comp-podium-item.rank-3 .comp-bar-mini { height:30px; background:linear-gradient(to top,rgba(205,127,50,0.3),rgba(205,127,50,0.08)); }

        /* Event records grid */
        .event-records-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:10px; }
        @media(max-width:500px){ .event-records-grid { grid-template-columns:1fr 1fr; } }
        .event-record-card { background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px;
            padding:14px 16px; display:flex; flex-direction:column; gap:4px; position:relative; overflow:hidden; }
        .event-record-card:hover { border-color:rgba(0,194,255,0.3); }
        .event-record-card .er-event { font-size:11px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; }
        .event-record-card .er-time { font-size:22px; font-weight:700; color:var(--text-primary); font-family:'JetBrains Mono',monospace; }
        .event-record-card .er-athlete { font-size:11px; color:var(--accent-blue); cursor:pointer; }
        .event-record-card .er-athlete:hover { text-decoration:underline; }
        .event-record-card .er-date { font-size:10px; color:var(--text-muted); }
        .event-record-card .er-accent { position:absolute; top:0; left:0; right:0; height:3px; border-radius:3px 3px 0 0; }

        /* Attention dismiss button */
        .attention-card { position:relative; }
        .att-dismiss { position:absolute; top:8px; right:8px; width:20px; height:20px; border:none; background:none;
            color:var(--text-muted); cursor:pointer; opacity:0; transition:opacity 0.15s; display:flex; align-items:center; justify-content:center;
            border-radius:4px; }
        .attention-card:hover .att-dismiss { opacity:0.6; }
        .att-dismiss:hover { opacity:1 !important; background:rgba(148,163,184,0.1); }

        /* Team Goals */
        .team-goals-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:12px; margin-bottom:8px; }
        @media(max-width:500px){ .team-goals-grid { grid-template-columns:1fr; } }
        .tg-card { background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px;
            padding:14px 16px; position:relative; }
        .tg-card:hover { border-color:rgba(0,194,255,0.3); }
        .tg-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
        .tg-type { font-size:10px; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; padding:2px 8px;
            border-radius:6px; display:inline-block; }
        .tg-type.race { background:rgba(0,194,255,0.12); color:var(--accent-blue); }
        .tg-type.start { background:rgba(245,166,35,0.12); color:var(--accent-orange); }
        .tg-type.turn { background:rgba(0,194,255,0.12); color:var(--accent-blue); }
        .tg-athlete { font-size:11px; color:var(--text-muted); }
        .tg-event { font-size:14px; font-weight:600; color:var(--text-primary); margin-bottom:6px; }
        .tg-progress { display:flex; align-items:center; gap:10px; }
        .tg-bar-track { flex:1; height:6px; background:rgba(148,163,184,0.12); border-radius:3px; overflow:hidden; }
        .tg-bar-fill { height:100%; border-radius:3px; transition:width 0.4s ease; }
        .tg-pct { font-size:12px; font-weight:600; font-family:'JetBrains Mono',monospace; min-width:36px; text-align:right; }
        .tg-values { display:flex; justify-content:space-between; margin-top:6px; font-size:11px; color:var(--text-muted); }
        .tg-values .tg-current { color:var(--text-primary); font-weight:600; }
        .tg-actions { position:absolute; top:10px; right:10px; display:flex; gap:4px; opacity:0; transition:opacity 0.15s; }
        .tg-card:hover .tg-actions { opacity:1; }
        .tg-action-btn { width:22px; height:22px; border:none; background:rgba(148,163,184,0.08); color:var(--text-muted);
            cursor:pointer; border-radius:4px; display:flex; align-items:center; justify-content:center; }
        .tg-action-btn:hover { background:rgba(0,194,255,0.15); color:var(--accent-blue); }
        .tg-add-btn { display:flex; align-items:center; justify-content:center; gap:8px; padding:16px; border-radius:12px;
            border:2px dashed var(--border-color); color:var(--text-muted); cursor:pointer; font-size:13px; transition:all 0.15s; background:transparent; width:100%; }
        .tg-add-btn:hover { border-color:var(--accent-blue); color:var(--accent-blue); background:rgba(0,194,255,0.04); }
        .tg-notes { font-size:10px; color:var(--text-muted); margin-top:4px; font-style:italic; }

        /* Coach Filter Bar */
        .coach-filter-bar { display:flex; align-items:center; justify-content:space-between; gap:12px;
            background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px;
            padding:10px 16px; margin-bottom:8px; flex-wrap:wrap; }
        .filter-bar-left { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
        .filter-bar-left svg { color:var(--text-muted); flex-shrink:0; }
        .filter-bar-left select { background:var(--bg-input); border:1px solid var(--border-color); border-radius:8px;
            color:var(--text-primary); padding:7px 12px; font-size:13px; font-family:inherit; cursor:pointer;
            min-width:120px; }
        .filter-bar-left select option { background:var(--bg-input); color:var(--text-primary); padding:4px 8px; }
        .filter-bar-left select:focus { outline:none; border-color:var(--accent-blue); box-shadow:0 0 0 2px rgba(0,194,255,0.15); }
        .filter-bar-left select:hover { border-color:var(--accent-blue); }
        .filter-count { font-size:11px; color:var(--text-muted); }
        .filter-manage-btn { display:flex; align-items:center; gap:6px; padding:6px 12px; border-radius:8px;
            border:1px solid var(--border-color); background:transparent; color:var(--text-muted);
            font-size:12px; font-family:inherit; cursor:pointer; transition:all 0.15s; white-space:nowrap; }
        .filter-manage-btn:hover { border-color:var(--accent-blue); color:var(--accent-blue); background:rgba(0,194,255,0.06); }
        @media(max-width:600px) {
            .coach-filter-bar { flex-direction:column; align-items:stretch; }
            .filter-bar-left { flex-wrap:wrap; }
            .filter-manage-btn { align-self:flex-end; }
        }

        /* Groups Modal */
        .groups-modal-body { max-height:60vh; overflow-y:auto; }
        .group-list-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:10px;
            border:1px solid var(--border-color); margin-bottom:8px; background:var(--bg-surface); }
        .group-list-item:hover { border-color:rgba(0,194,255,0.3); }
        .group-color-dot { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
        .group-name-text { font-size:13px; font-weight:600; color:var(--text-primary); flex:1; }
        .group-member-count { font-size:11px; color:var(--text-muted); }
        .group-actions-btns { display:flex; gap:4px; }
        .group-actions-btns button { width:28px; height:28px; border:none; background:rgba(148,163,184,0.08); color:var(--text-muted);
            cursor:pointer; border-radius:6px; display:flex; align-items:center; justify-content:center; }
        .group-actions-btns button:hover { background:rgba(0,194,255,0.15); color:var(--accent-blue); }
        .create-group-row { display:flex; gap:8px; margin-bottom:16px; }
        .create-group-row input { flex:1; padding:8px 12px; border-radius:8px; border:1px solid var(--border-color);
            background:var(--bg-surface); color:var(--text-primary); font-size:13px; font-family:inherit; }
        .create-group-row input::placeholder { color:var(--text-muted); }
        .create-group-row button { padding:8px 16px; border-radius:8px; border:none; background:var(--accent-blue);
            color:white; font-size:13px; font-weight:500; cursor:pointer; white-space:nowrap; }
        .create-group-row button:hover { opacity:0.9; }
        .group-edit-section { padding:12px; border:1px solid var(--border-color); border-radius:10px;
            background:var(--bg-primary); margin-bottom:16px; }
        .group-edit-title { font-size:13px; font-weight:600; color:var(--text-primary); margin-bottom:8px;
            display:flex; align-items:center; gap:6px; }
        .group-member-chips { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; }
        .group-chip { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:20px;
            font-size:11px; font-weight:500; }
        .group-chip.member { background:rgba(0,194,255,0.12); color:var(--accent-blue); }
        .group-chip.available { background:rgba(148,163,184,0.08); color:var(--text-muted); cursor:pointer; border:1px dashed var(--border-color); }
        .group-chip.available:hover { border-color:var(--accent-blue); color:var(--accent-blue); }
        .group-chip .chip-remove { cursor:pointer; opacity:0.6; margin-left:2px; }
        .group-chip .chip-remove:hover { opacity:1; }
        /* Gender edit in roster */
        .gender-select-mini { background:var(--bg-input); border:1px solid var(--border-color); border-radius:6px;
            color:var(--text-primary); padding:3px 8px; font-size:11px; font-family:inherit; cursor:pointer; }
        .gender-select-mini option { background:var(--bg-input); color:var(--text-primary); }
        .gender-select-mini:focus { outline:none; border-color:var(--accent-blue); }
        .gender-select-mini:hover { border-color:var(--accent-blue); }
        .gender-badge { font-size:10px; padding:2px 8px; border-radius:10px; font-weight:600; }
        .gender-badge.male { background:rgba(0,194,255,0.12); color:var(--accent-blue); }
        .gender-badge.female { background:rgba(236,72,153,0.12); color:#ec4899; }

        /* Unified Race Filter Bar */
        .race-filter-bar {
            background:var(--bg-secondary); border:1px solid var(--border-color); border-radius:12px;
            margin-bottom:16px; overflow:hidden;
        }
        .rfb-row { display:flex; align-items:flex-end; gap:10px; padding:10px 16px; flex-wrap:wrap; }
        .rfb-row-scope { border-bottom:1px solid var(--border-color); }
        .rfb-row-label { font-size:10px; font-weight:700; color:var(--text-muted); text-transform:uppercase;
            letter-spacing:0.6px; align-self:center; padding:0 4px 0 0; white-space:nowrap; opacity:0.7; }
        .rfb-field { display:flex; flex-direction:column; gap:3px; flex:1; min-width:110px; max-width:200px; }
        .rfb-field label { font-size:10px; font-weight:600; color:var(--text-muted); letter-spacing:0.3px; text-transform:uppercase; }
        .rfb-field select {
            background:var(--bg-input); border:1px solid var(--border-color); border-radius:8px;
            color:var(--text-primary); padding:7px 10px; font-size:12px; font-family:inherit;
            cursor:pointer; width:100%;
        }
        .rfb-field select option { background:var(--bg-input); color:var(--text-primary); }
        .rfb-field select:focus { outline:none; border-color:var(--accent-blue); box-shadow:0 0 0 2px rgba(0,194,255,0.15); }
        .rfb-info {
            font-size:11px; color:var(--text-muted); margin-left:auto; align-self:center;
            display:flex; align-items:center; gap:6px; white-space:nowrap;
        }
        .rfb-info svg { width:14px; height:14px; opacity:0.5; flex-shrink:0; }
        @media(max-width:768px) {
            .rfb-row { flex-direction:column; align-items:stretch; gap:8px; }
            .rfb-field { flex:none; width:100%; max-width:none; }
            .rfb-row-label { padding-bottom:4px; }
        }
        /* Race card athlete name tag (multi-athlete view) */
        .rc-athlete { font-size:10px; font-weight:600; color:var(--accent-blue); margin-bottom:2px;
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:110px; }

        /* Team Pulse Grid */
        .team-pulse-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:14px; margin-bottom:6px; }
        @media(max-width:900px){ .team-pulse-grid { grid-template-columns: repeat(2,1fr); } }
        @media(max-width:500px){ .team-pulse-grid { grid-template-columns: 1fr; } }

        /* Roster Table */
        .roster-table { width:100%; border-collapse:collapse; font-size:13px; }
        .roster-table th { text-align:left; padding:10px 12px; font-size:11px; font-weight:600; color:var(--text-muted);
            text-transform:uppercase; letter-spacing:0.4px; border-bottom:1px solid var(--border-color); background:var(--bg-secondary); }
        .roster-table td { padding:10px 12px; border-bottom:1px solid rgba(148,163,184,0.06); vertical-align:middle; }
        .roster-table tr:hover td { background:rgba(0,194,255,0.04); }
        .roster-name-btn { background:none; border:none; color:var(--accent-blue); font-weight:600; font-size:13px;
            cursor:pointer; padding:0; text-align:left; }
        .roster-name-btn:hover { text-decoration:underline; }
        .roster-stat { font-family:'JetBrains Mono',monospace; font-size:12px; color:var(--text-primary); }
        .roster-stat.muted { color:var(--text-muted); }
        .roster-badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:10px; font-weight:600; }
        .roster-badge.active { background:rgba(0,230,138,0.1); color:var(--accent-green); }
        .roster-badge.inactive { background:rgba(255,107,107,0.1); color:var(--accent-red); }

        /* Activity Feed */
        .activity-feed { display:flex; flex-direction:column; gap:2px; }
        .activity-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:10px;
            cursor:pointer; transition:background 0.15s; }
        .activity-item:hover { background:rgba(0,194,255,0.05); }
        .activity-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
        .activity-dot.start { background:var(--accent-orange); }
        .activity-dot.turn { background:var(--accent-cyan); }
        .activity-dot.race { background:var(--accent-green); }
        .activity-info { flex:1; min-width:0; }
        .activity-name { font-size:13px; font-weight:600; color:var(--text-primary); }
        .activity-desc { font-size:11px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .activity-time { font-size:11px; color:var(--text-muted); flex-shrink:0; }

        /* Attention Flags */
        .attention-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:12px; }
        .attention-card { display:flex; align-items:flex-start; gap:12px; padding:14px 16px; border-radius:12px;
            border:1px solid var(--border-color); background:var(--bg-secondary); }
        .attention-card .att-icon { width:36px; height:36px; border-radius:10px; display:flex; align-items:center;
            justify-content:center; flex-shrink:0; }
        .attention-card .att-icon svg { width:18px; height:18px; }
        .attention-card .att-icon.decline { background:rgba(255,107,107,0.1); color:var(--accent-red); }
        .attention-card .att-icon.inactive { background:rgba(245,166,35,0.1); color:var(--accent-orange); }
        .attention-card .att-icon.goal { background:rgba(167,139,250,0.1); color:var(--accent-purple); }
        .attention-card .att-body { flex:1; min-width:0; }
        .attention-card .att-title { font-size:13px; font-weight:600; color:var(--text-primary); margin-bottom:2px; }
        .attention-card .att-desc { font-size:11px; color:var(--text-muted); }

        /* Leaderboard */
        .leaderboard-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
        @media(max-width:900px){ .leaderboard-grid { grid-template-columns: 1fr; } }
        .lb-card { background:var(--bg-secondary); border-radius:14px; border:1px solid var(--border-color); padding:16px; }
        .lb-card h4 { font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase;
            letter-spacing:0.4px; margin-bottom:12px; display:flex; align-items:center; gap:6px; }
        .lb-card h4 svg { width:14px; height:14px; }
        .lb-row { display:flex; align-items:center; gap:10px; padding:6px 0; }
        .lb-rank { width:22px; height:22px; border-radius:50%; display:flex; align-items:center; justify-content:center;
            font-size:11px; font-weight:700; flex-shrink:0; font-family:'JetBrains Mono',monospace; }
        .lb-rank.r1 { background:rgba(245,166,35,0.15); color:var(--accent-orange); }
        .lb-rank.r2 { background:rgba(148,163,184,0.15); color:var(--text-muted); }
        .lb-rank.r3 { background:rgba(180,130,80,0.15); color:#b4824f; }
        .lb-rank.r4, .lb-rank.r5 { background:rgba(148,163,184,0.08); color:var(--text-muted); }
        .lb-name { flex:1; font-size:13px; font-weight:500; color:var(--text-primary); white-space:nowrap;
            overflow:hidden; text-overflow:ellipsis; cursor:pointer; }
        .lb-name:hover { color:var(--accent-blue); }
        .lb-val { font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:600; color:var(--text-primary); }

        /* Start trial table highlight */
        .start-trials-table tr.row-primary { border-left: 3px solid var(--accent-orange); background: rgba(245,166,35,0.04); }
        .start-trials-table tr.row-compare { border-left: 3px solid var(--accent-cyan); background: rgba(0,194,255,0.04); }

        /* Race detail expand */
        .race-row-expandable { cursor: pointer; }
        .race-row-expandable:hover td { background: rgba(0, 194, 255, 0.05); }
        .race-detail-row { display: none; }
        .race-detail-row.open { display: table-row; }
        .race-detail-cell {
            padding: 20px 16px !important; background: var(--bg-secondary) !important;
        }
        .race-detail-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;
        }
        .race-detail-section h4 {
            font-size: 12px; font-weight: 600; color: var(--text-muted);
            text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;
        }
        .race-detail-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .race-metric-item {
            display: flex; flex-direction: column; gap: 2px;
            padding: 8px 10px; background: var(--bg-card); border-radius: 8px;
        }
        .race-metric-label { font-size: 11px; color: var(--text-muted); }
        .race-metric-value { font-size: 14px; font-family: 'JetBrains Mono', monospace; font-weight: 600; }

        /* Race chart toggle */
        .chart-toggle { display: flex; gap: 0; background: var(--bg-secondary); border-radius: 8px; padding: 2px; }
        .chart-toggle-btn {
            padding: 6px 14px; border: none; background: transparent; color: var(--text-muted);
            font-size: 12px; font-weight: 500; cursor: pointer; border-radius: 6px;
            font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif; transition: all 0.2s;
        }
        .chart-toggle-btn.active { background: var(--accent-blue); color: white; }

        /* Stroke heatmap */
        .stroke-grid {
            display: grid; grid-template-columns: 80px repeat(auto-fill, minmax(50px, 1fr)); gap: 2px;
        }
        .stroke-cell {
            padding: 8px 4px; text-align: center; border-radius: 4px;
            font-size: 12px; font-family: 'JetBrains Mono', monospace; font-weight: 500;
        }
        .stroke-cell.header { color: var(--text-muted); font-size: 11px; font-weight: 600; background: transparent; }
        .stroke-cell.label { color: var(--text-secondary); text-align: right; padding-right: 8px; background: transparent; }
        .stroke-cell.low { background: rgba(0, 230, 138, 0.2); color: var(--accent-green); }
        .stroke-cell.mid { background: rgba(0, 194, 255, 0.2); color: var(--accent-blue); }
        .stroke-cell.high { background: rgba(245, 166, 35, 0.2); color: var(--accent-orange); }
        .stroke-cell.very-high { background: rgba(255, 107, 107, 0.2); color: var(--accent-red); }

        /* Compare summary cards */
        .compare-summary-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;
        }
        .compare-mini-section { margin-bottom: 20px; }
        .compare-mini-section h4 {
            font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px;
        }
        .compare-mini-section h4 svg { width: 16px; height: 16px; }
        .delta-badge {
            display: inline-flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 600;
            padding: 2px 7px; border-radius: 6px;
        }
        .delta-badge.positive { background: rgba(0,230,138,0.15); color: var(--accent-green); }
        .delta-badge.negative { background: rgba(255,107,107,0.15); color: var(--accent-red); }
        .delta-badge.neutral { background: rgba(148,163,184,0.15); color: var(--text-muted); }

        /* KPI context badge */
        .kpi-context-badge {
            font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; display: inline-block;
        }
        .kpi-context-badge.single { background: rgba(0,194,255,0.15); color: var(--accent-blue); }
        .kpi-context-badge.average { background: rgba(148,163,184,0.15); color: var(--text-muted); }

        @media (max-width: 768px) {
            .race-controls { flex-direction: column; }
            .race-controls select, .race-controls input { min-width: 100%; }
            .split-bar-row { grid-template-columns: 50px 1fr 60px; }
            .race-detail-grid { grid-template-columns: 1fr; }
            .race-card-pick { min-width: 130px; }
            .start-card-pick { min-width: 130px; }
            .start-tab { padding: 8px 12px; font-size: 12px; }
            .start-metric-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
            #startUnderwaterCharts > div:first-child { grid-template-columns: 1fr !important; }
            .turn-card-pick { min-width: 130px; }
            .turn-tab { padding: 8px 12px; font-size: 12px; }
            .turn-chart-2col { grid-template-columns: 1fr !important; }
            .compare-summary-grid { grid-template-columns: 1fr; }
        }

        /* ============================================ */
        /* TOAST NOTIFICATIONS & CONFIRM MODAL - v02.05 */
        /* ============================================ */
        .toast-container {
            position: fixed; top: 16px; right: 16px; z-index: 10000;
            display: flex; flex-direction: column; gap: 8px; pointer-events: none;
        }
        .toast {
            pointer-events: auto; display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; border-radius: 10px; min-width: 280px; max-width: 420px;
            background: var(--bg-card); border: 1px solid var(--border-color);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3); font-size: 13px; color: var(--text-primary);
            transform: translateX(120%); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0;
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.toast-success { border-color: rgba(0,230,138,0.4); }
        .toast.toast-error { border-color: rgba(255,107,107,0.4); }
        .toast.toast-info { border-color: rgba(0,194,255,0.4); }
        .toast.toast-warning { border-color: rgba(245,166,35,0.4); }
        .toast-icon { width: 20px; height: 20px; flex-shrink: 0; }
        .toast-icon.success { color: var(--accent-green); }
        .toast-icon.error { color: var(--accent-red); }
        .toast-icon.info { color: var(--accent-blue); }
        .toast-icon.warning { color: var(--accent-orange); }
        .toast-msg { flex: 1; line-height: 1.4; }
        .toast-close { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px;
            width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 4px; flex-shrink: 0; }
        .toast-close:hover { background: rgba(148,163,184,0.1); color: var(--text-primary); }

        /* Styled Confirm Modal */
        .confirm-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .confirm-overlay.active { display: flex; }
        .confirm-box {
            background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 14px;
            padding: 24px; max-width: 400px; width: 100%; box-shadow: 0 16px 48px rgba(0,0,0,0.3);
        }
        .confirm-title { font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .confirm-msg { font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 20px; }
        .confirm-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .confirm-btn { padding: 8px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; font-family: inherit; transition: all 0.15s; }
        .confirm-btn.cancel { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .confirm-btn.cancel:hover { border-color: var(--text-muted); }
        .confirm-btn.danger { background: var(--accent-red); color: white; }
        .confirm-btn.danger:hover { opacity: 0.9; }
        .confirm-btn.primary { background: var(--accent-blue); color: white; }
        .confirm-btn.primary:hover { opacity: 0.9; }

        @media (max-width: 768px) {
            .toast-container { top: 64px; right: 8px; left: 8px; }
            .toast { min-width: auto; max-width: 100%; }
        }

        /* ============================================ */
        /* MOBILE RESPONSIVE - v02.04                   */
        /* ============================================ */

        /* --- Mobile Header Bar with Hamburger --- */
        .mobile-header {
            display: none;
            position: fixed; top: 0; left: 0; right: 0; height: 56px; z-index: 150;
            background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
            align-items: center; justify-content: space-between; padding: 0 16px;
        }
        .mobile-header-logo {
            display: flex; align-items: center; gap: 8px;
        }
        .mobile-header-logo svg { width: 24px; height: auto; }
        .mobile-header-logo span {
            font-size: 15px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;
            background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .hamburger-btn {
            width: 40px; height: 40px; border: none; background: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; border-radius: 8px;
            color: var(--text-primary); transition: background 0.15s;
        }
        .hamburger-btn:hover { background: rgba(148,163,184,0.1); }
        .hamburger-btn svg { width: 24px; height: 24px; }

        /* --- Sidebar Overlay for Mobile --- */
        .sidebar-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
            z-index: 99; opacity: 0; transition: opacity 0.3s ease;
        }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* --- Mobile Sidebar Close Button --- */
        .sidebar-close-btn {
            display: none; position: absolute; top: 16px; right: 16px;
            width: 32px; height: 32px; border: none; background: rgba(148,163,184,0.1);
            border-radius: 8px; cursor: pointer; color: var(--text-muted);
            align-items: center; justify-content: center; transition: all 0.15s;
        }
        .sidebar-close-btn:hover { background: rgba(255,107,107,0.15); color: var(--accent-red); }
        .sidebar-close-btn svg { width: 18px; height: 18px; }

        /* --- Table Scroll Wrapper (applied via JS) --- */
        .table-scroll-wrapper {
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            margin: 0 -4px; padding: 0 4px;
        }
        .table-scroll-wrapper::-webkit-scrollbar { height: 4px; }
        .table-scroll-wrapper::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 2px; }

        @media (max-width: 1024px) {
            /* Show mobile header */
            .mobile-header { display: flex; }

            /* Push content below fixed mobile header */
            .main-content { margin-top: 56px; }

            /* Sidebar becomes overlay drawer */
            .sidebar {
                top: 0; width: 280px;
                box-shadow: 4px 0 24px rgba(0,0,0,0.3);
            }
            .sidebar-close-btn { display: flex; }
        }

        @media (max-width: 768px) {
            /* Reduce content padding */
            .main-content { padding: 20px 14px; }

            /* Smaller page headers */
            .page-header { margin-bottom: 20px; }
            .page-header h1 { font-size: 20px; }
            .page-header p { font-size: 13px; }

            /* KPI grid: 2 columns on mobile */
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
            .kpi-card { padding: 14px; }
            .kpi-value { font-size: 22px; }
            .kpi-label { font-size: 10px; }
            .kpi-context-badge { font-size: 8px; padding: 2px 6px; }

            /* Cards: less padding */
            .card-header { padding: 14px 16px; }
            .card-body { padding: 16px; }

            /* Charts: shorter on mobile */
            .chart-container { height: 240px; }

            /* Tables: horizontal scroll + smaller text */
            .data-table th, .data-table td { padding: 10px 8px; font-size: 12px; white-space: nowrap; }
            .data-table th { font-size: 10px; }
            .data-table .mono { font-size: 11px; }

            /* Race/Start/Turn selector cards: smaller */
            .race-selector-list, .start-selector-list, .turn-selector-list { gap: 8px; }
            .race-card-pick, .start-card-pick, .turn-card-pick { min-width: 120px; padding: 10px 12px; }
            .race-card-pick .rc-time, .start-card-pick .sc-reaction, .turn-card-pick .tc-time { font-size: 16px; }
            .race-card-pick .rc-event, .start-card-pick .sc-style, .turn-card-pick .tc-style { font-size: 12px; }

            /* Tab bars: scrollable */
            .race-tab-bar, .start-tab-bar, .turn-tab-bar { overflow-x: auto; -webkit-overflow-scrolling: touch; flex-wrap: nowrap; }
            .race-tab, .start-tab, .turn-tab { white-space: nowrap; flex-shrink: 0; }

            /* Athlete selector */
            .athlete-selector { flex-direction: column; align-items: stretch; }
            .athlete-selector select { min-width: 100%; }

            /* Welcome bar */
            .welcome-bar { padding: 16px; }
            .wb-right { margin-top: 4px; }

            /* Login card: full width on mobile */
            .login-card { margin: 20px 12px; padding: 28px 20px; }

            /* Modals: full width on mobile */
            .modal-box { width: 95%; max-width: 95%; margin: 20px auto; max-height: 85vh; }

            /* Coach filter bar */
            .coach-filter-bar { padding: 8px 12px; }
            .filter-bar-left select { min-width: 100px; font-size: 12px; padding: 6px 8px; }

            /* Approach timeline: stack */
            .approach-timeline { min-width: 100%; }

            /* Split bars */
            .split-bar-row { grid-template-columns: 45px 1fr 55px; gap: 6px; }
            .split-bar-label { font-size: 10px; }

            /* Stroke grid: horizontal scroll */
            .stroke-grid { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }

        @media (max-width: 480px) {
            /* Even smaller screens */
            .main-content { padding: 16px 10px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .kpi-value { font-size: 20px; }
            .chart-container { height: 200px; }
            .race-card-pick, .start-card-pick, .turn-card-pick { min-width: 110px; padding: 8px 10px; }
            .data-table th, .data-table td { padding: 8px 6px; font-size: 11px; }

            /* Login: tighter */
            .login-card { padding: 24px 16px; }
            .login-card h1 { font-size: 22px; }
        }
        /* ============================================
           LEADERBOARDS MODULE (v02.07)
           ============================================ */

        /* Category Tabs */
        .lb-category-bar {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .lb-cat-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex: 1;
            justify-content: center;
        }
        .lb-cat-tab:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }
        .lb-cat-tab.active {
            background: rgba(0, 194, 255, 0.12);
            color: var(--accent-blue);
        }
        .lb-cat-tab svg { opacity: 0.6; }
        .lb-cat-tab.active svg { opacity: 1; }

        /* Filter Bar */
        .lb-filter-bar {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }
        .lb-filter-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .lb-filter-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 120px;
        }
        .lb-filter-field label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .lb-filter-field select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 13px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .lb-filter-field select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .lb-filter-info {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
        }

        /* Podium */
        .lb-podium-wrap {
            margin-bottom: 24px;
        }
        .lb-podium {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 12px;
            padding: 24px 16px 0;
        }
        .lb-podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 0 1 200px;
            max-width: 220px;
        }
        .lb-podium-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 10px;
            position: relative;
            box-shadow: 0 4px 16px rgba(0,0,0,0.25);
        }
        .lb-podium-item.rank-1 .lb-podium-avatar {
            width: 68px;
            height: 68px;
            font-size: 22px;
            background: linear-gradient(135deg, #FFD700, #FFA000);
            box-shadow: 0 4px 24px rgba(255, 215, 0, 0.35);
        }
        .lb-podium-item.rank-2 .lb-podium-avatar {
            background: linear-gradient(135deg, #C0C0C0, #8E8E8E);
        }
        .lb-podium-item.rank-3 .lb-podium-avatar {
            background: linear-gradient(135deg, #CD7F32, #A0522D);
        }
        .lb-podium-medal {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 800;
            color: #fff;
            border: 2px solid var(--bg-card);
        }
        .lb-podium-item.rank-1 .lb-podium-medal { background: #FFD700; color: #7B5E00; }
        .lb-podium-item.rank-2 .lb-podium-medal { background: #C0C0C0; color: #4A4A4A; }
        .lb-podium-item.rank-3 .lb-podium-medal { background: #CD7F32; color: #5C3310; }
        .lb-podium-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            margin-bottom: 2px;
            max-width: 160px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .lb-podium-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 4px;
        }
        .lb-podium-item.rank-1 .lb-podium-value { color: #FFD700; font-size: 22px; }
        .lb-podium-meta {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
        }
        .lb-podium-bar {
            width: 100%;
            border-radius: 10px 10px 0 0;
            margin-top: 10px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            transition: height 0.4s ease;
        }
        .lb-podium-item.rank-1 .lb-podium-bar {
            height: 100px;
            background: linear-gradient(180deg, rgba(255,215,0,0.18) 0%, rgba(255,215,0,0.06) 100%);
            border: 1px solid rgba(255,215,0,0.25);
            border-bottom: none;
        }
        .lb-podium-item.rank-2 .lb-podium-bar {
            height: 72px;
            background: linear-gradient(180deg, rgba(192,192,192,0.14) 0%, rgba(192,192,192,0.04) 100%);
            border: 1px solid rgba(192,192,192,0.2);
            border-bottom: none;
        }
        .lb-podium-item.rank-3 .lb-podium-bar {
            height: 52px;
            background: linear-gradient(180deg, rgba(205,127,50,0.14) 0%, rgba(205,127,50,0.04) 100%);
            border: 1px solid rgba(205,127,50,0.2);
            border-bottom: none;
        }
        .lb-podium-rank-num {
            font-size: 28px;
            font-weight: 800;
            opacity: 0.15;
            margin-bottom: 8px;
        }

        /* Table Card */
        .lb-table-card { margin-bottom: 32px; }
        .lb-record-count {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Rankings Table */
        .lb-table {
            width: 100%;
            border-collapse: collapse;
        }
        .lb-table th, .lb-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .lb-table th {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-secondary);
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .lb-table tr:hover td {
            background: var(--bg-card-hover);
        }
        .lb-table td {
            font-size: 13px;
        }
        .lb-rank-cell {
            width: 48px;
            text-align: center;
        }
        .lb-rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
        }
        .lb-rank-badge.gold {
            background: rgba(255,215,0,0.15);
            color: #FFD700;
            border: 1px solid rgba(255,215,0,0.3);
        }
        .lb-rank-badge.silver {
            background: rgba(192,192,192,0.12);
            color: #C0C0C0;
            border: 1px solid rgba(192,192,192,0.25);
        }
        .lb-rank-badge.bronze {
            background: rgba(205,127,50,0.12);
            color: #CD7F32;
            border: 1px solid rgba(205,127,50,0.25);
        }
        .lb-rank-badge.normal {
            background: transparent;
            color: var(--text-muted);
        }
        .lb-athlete-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .lb-athlete-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        .lb-athlete-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        .lb-value-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .lb-date-cell {
            font-size: 12px;
            color: var(--text-muted);
        }
        .lb-style-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
        }
        .lb-style-pill.freestyle { background: rgba(0,194,255,0.10); color: var(--color-freestyle); }
        .lb-style-pill.backstroke { background: rgba(167,139,250,0.10); color: var(--color-backstroke); }
        .lb-style-pill.breaststroke { background: rgba(6,214,160,0.10); color: var(--color-breaststroke); }
        .lb-style-pill.butterfly { background: rgba(245,166,35,0.10); color: var(--color-butterfly); }
        .lb-style-pill.im { background: rgba(255,107,157,0.10); color: var(--color-im); }

        .lb-self-row td {
            background: rgba(0, 194, 255, 0.04);
        }
        .lb-self-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-blue);
            padding: 1px 6px;
            border-radius: 4px;
            background: rgba(0,194,255,0.10);
            margin-left: 6px;
        }

        .lb-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        .lb-empty svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.4;
        }
        .lb-empty h3 {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .lb-empty p { font-size: 13px; }

        /* Leaderboard responsive */
        @media (max-width: 768px) {
            .lb-podium { gap: 6px; padding: 16px 8px 0; }
            .lb-podium-item { flex: 0 1 120px; }
            .lb-podium-avatar { width: 42px; height: 42px; font-size: 14px; }
            .lb-podium-item.rank-1 .lb-podium-avatar { width: 52px; height: 52px; font-size: 17px; }
            .lb-podium-name { font-size: 12px; max-width: 100px; }
            .lb-podium-value { font-size: 14px; }
            .lb-podium-item.rank-1 .lb-podium-value { font-size: 17px; }
            .lb-podium-item.rank-1 .lb-podium-bar { height: 72px; }
            .lb-podium-item.rank-2 .lb-podium-bar { height: 52px; }
            .lb-podium-item.rank-3 .lb-podium-bar { height: 36px; }
            .lb-filter-group { flex-direction: column; width: 100%; }
            .lb-filter-field { width: 100%; }
            .lb-filter-field select { width: 100%; }
            .lb-table th, .lb-table td { padding: 10px 8px; }
            .lb-athlete-avatar { display: none; }
        }

        /* ============================================
           v02.08  MODE TABS, COMPETITION, BADGES
           ============================================ */

        /* Mode Bar (Team vs Competition top tabs) */
        .lb-mode-bar {
            display: flex;
            gap: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }
        .lb-mode-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .lb-mode-tab:hover { color: var(--text-primary); background: var(--bg-card-hover); }
        .lb-mode-tab.active {
            background: rgba(0,194,255,0.12);
            color: var(--accent-blue);
        }
        .lb-mode-tab svg { opacity: 0.6; }
        .lb-mode-tab.active svg { opacity: 1; }

        /* Panels */
        .lb-panel { display: none; }
        .lb-panel.active { display: block; }

        /* Competition Opt-in Card */
        .comp-optin-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
        }
        .comp-optin-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .comp-optin-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(255,215,0,0.12), rgba(255,215,0,0.04));
            border: 1px solid rgba(255,215,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: #FFD700;
        }
        .comp-optin-text { flex: 1; min-width: 0; }
        .comp-optin-text h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .comp-optin-text p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .comp-optin-toggle-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }
        .comp-optin-toggle {
            width: 52px;
            height: 28px;
            border-radius: 14px;
            background: var(--border-color);
            border: 1px solid var(--border-hover);
            cursor: pointer;
            position: relative;
            padding: 0;
            transition: background 0.3s, border-color 0.3s;
        }
        .comp-optin-toggle.active {
            background: #FFD700;
            border-color: #FFD700;
        }
        .comp-toggle-knob {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #fff;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: left 0.3s cubic-bezier(0.68,-0.55,0.27,1.55);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .comp-optin-toggle.active .comp-toggle-knob { left: 26px; }
        .comp-optin-status {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .comp-optin-toggle.active + .comp-optin-status { color: #FFD700; }

        /* Competition Events Grid */
        .comp-events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        .comp-event-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            transition: all 0.2s;
        }
        .comp-event-item:hover { border-color: var(--border-hover); }
        .comp-event-check {
            position: relative;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .comp-event-check input {
            opacity: 0;
            position: absolute;
            width: 0;
            height: 0;
        }
        .comp-checkmark {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 2px solid var(--border-hover);
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .comp-event-check input:checked + .comp-checkmark {
            background: #FFD700;
            border-color: #FFD700;
        }
        .comp-event-check input:checked + .comp-checkmark::after {
            content: '';
            display: block;
            width: 5px;
            height: 9px;
            border: solid #000;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            margin-top: -2px;
        }
        .comp-event-info { flex: 1; min-width: 0; }
        .comp-event-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .comp-event-desc { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
        .comp-event-icon { flex-shrink: 0; opacity: 0.7; }

        /* Competition Board Tabs */
        .comp-board-bar {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 16px;
            overflow: visible;
            position: relative;
        }
        .comp-board-tab {
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex: 1;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .comp-board-tab:hover { background: var(--bg-card-hover); color: var(--text-primary); }
        .comp-board-tab.active { background: rgba(255,215,0,0.12); color: #FFD700; }

        /* Competition Info Tooltip */
        .comp-info-tip {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            font-style: normal;
            color: var(--text-muted);
            cursor: help;
            flex-shrink: 0;
            position: relative;
        }
        .comp-board-tab.active .comp-info-tip {
            background: rgba(255,215,0,0.2);
            color: #FFD700;
        }
        .comp-info-tip::after {
            content: attr(data-tooltip);
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #1a2e44;
            border: 1px solid var(--border-hover);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 400;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }
        .comp-info-tip::before {
            content: '';
            position: absolute;
            top: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-bottom-color: #1a2e44;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        .comp-info-tip:hover::after,
        .comp-info-tip:hover::before {
            opacity: 1;
            visibility: visible;
        }
        @media (max-width: 768px) {
            .comp-info-tip::after {
                white-space: normal;
                width: 200px;
                left: auto;
                right: -10px;
                transform: none;
            }
            .comp-info-tip::before {
                left: auto;
                right: 5px;
                transform: none;
            }
        }

        /* Competition filter row */
        .comp-filter-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .comp-participant-count {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
            white-space: nowrap;
        }

        /* Team name in competition table */
        .lb-team-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            background: var(--tag-bg);
            color: var(--tag-text);
            border: 1px solid var(--tag-border);
            margin-left: 6px;
        }

        /* ===== HOME PAGE BADGES ===== */
        .comp-badges-grid {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        .comp-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            min-width: 200px;
            flex: 1;
            max-width: 300px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .comp-badge:hover {
            border-color: var(--border-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-card);
        }
        .comp-badge-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 800;
            flex-shrink: 0;
        }
        .comp-badge-icon.elite {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,215,0,0.08));
            border: 2px solid rgba(255,215,0,0.4);
            color: #FFD700;
            box-shadow: 0 0 16px rgba(255,215,0,0.15);
        }
        .comp-badge-icon.contender {
            background: linear-gradient(135deg, rgba(192,192,192,0.15), rgba(192,192,192,0.05));
            border: 2px solid rgba(192,192,192,0.3);
            color: #C0C0C0;
        }
        .comp-badge-icon.ranked {
            background: linear-gradient(135deg, rgba(205,127,50,0.15), rgba(205,127,50,0.05));
            border: 2px solid rgba(205,127,50,0.3);
            color: #CD7F32;
        }
        .comp-badge-text { flex: 1; min-width: 0; }
        .comp-badge-tier {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .comp-badge-tier.elite { color: #FFD700; }
        .comp-badge-tier.contender { color: #C0C0C0; }
        .comp-badge-tier.ranked { color: #CD7F32; }
        .comp-badge-comp {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        .comp-badge-rank {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .comp-badge-detail {
            font-size: 10px;
            color: var(--text-muted);
        }
        .comp-badge-right {
            text-align: right;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .comp-optin-header { flex-direction: column; text-align: center; }
            .comp-optin-toggle-wrap { flex-direction: row; }
            .comp-events-grid { grid-template-columns: 1fr; }
            .comp-badges-grid { flex-direction: column; }
            .comp-badge { max-width: 100%; }
            .comp-filter-row { flex-direction: column; align-items: stretch; }
            .comp-participant-count { margin-left: 0; }
        }

    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <svg viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg" style="width:64px;">
                    <polygon points="50,2 95,72 78,72 50,22 22,72 5,72" fill="url(#loginGrad)"/>
                    <defs><linearGradient id="loginGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="var(--accent-blue)"/><stop offset="100%" stop-color="var(--accent-purple)"/></linearGradient></defs>
                </svg>
                <h1>Peak Athlete</h1>
                <p>Train Smarter. Reach Your Peak.</p>
            </div>

            <div class="login-error" id="loginError"></div>
            <div class="login-success" id="signupSuccess"></div>

            <!-- Sign In Form -->
            <form id="loginForm">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="your@email.com" required>
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" placeholder="Password" required>
                </div>

                <button type="submit" class="btn btn-primary" id="loginBtn">
                    Sign In
                </button>

                <div class="login-links">
                    <a onclick="toggleAuthMode('forgot')" class="forgot-link">Forgot password?</a>
                    <span class="login-links-sep">|</span>
                    <span>Don't have an account? <a onclick="toggleAuthMode('signup')">Create Account</a></span>
                </div>
            </form>

            <!-- Forgot Password Form -->
            <form id="forgotForm" style="display:none;">
                <div class="form-section-label">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <span>Reset Password</span>
                </div>
                <p class="form-helper-text">Enter your email address and we'll send a password reset link.</p>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="forgotEmail" placeholder="your@email.com" required>
                </div>
                <button type="submit" class="btn btn-primary" id="forgotBtn">
                    Send Reset Link
                </button>
                <div class="login-links">
                    <a onclick="toggleAuthMode('login')">Back to Sign In</a>
                </div>
            </form>

            <!-- Sign Up Form -->
            <form id="signupForm" style="display:none;">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="signupFirstName" placeholder="First name" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="signupLastName" placeholder="Last name" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com" required>
                </div>

                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signupPassword" placeholder="Password" required minlength="6">
                    <div class="password-requirements">Minimum 6 characters</div>
                </div>

                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" placeholder="Confirm password" required minlength="6">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Gender</label>
                        <select id="signupGender" style="width:100%;padding:12px 16px;border-radius:12px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:14px;">
                            <option value="">Prefer not to say</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="signupRole" style="width:100%;padding:12px 16px;border-radius:12px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-primary);font-size:14px;">
                            <option value="athlete">Athlete</option>
                            <option value="coach">Coach</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" id="signupBtn">
                    Create Account
                </button>

                <div class="login-links">
                    Already have an account? <a onclick="toggleAuthMode('login')">Sign In</a>
                </div>
            </form>

            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span>Checking connection...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container (v02.05) -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Styled Confirm Modal (v02.05) -->
    <div class="confirm-overlay" id="confirmOverlay">
        <div class="confirm-box">
            <div class="confirm-title" id="confirmTitle">Confirm</div>
            <div class="confirm-msg" id="confirmMsg"></div>
            <div class="confirm-actions">
                <button class="confirm-btn cancel" id="confirmCancel">Cancel</button>
                <button class="confirm-btn primary" id="confirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal (v02.04) -->
    <div class="modal-overlay" id="passwordResetModal">
        <div class="modal-box" style="max-width: 400px;">
            <div class="modal-header">
                <h2>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20" style="vertical-align: -3px; margin-right: 8px;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    Set New Password
                </h2>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px; line-height: 1.5;">
                    You clicked a password reset link. Enter your new password below.
                </p>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" id="resetNewPassword" placeholder="Minimum 6 characters" minlength="6" required>
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" id="resetConfirmPassword" placeholder="Re-enter your new password" minlength="6" required>
                </div>
                <div id="resetPasswordError" style="color: var(--accent-red); font-size: 13px; margin-top: 8px; display: none;"></div>
                <div id="resetPasswordSuccess" style="color: var(--accent-green); font-size: 13px; margin-top: 8px; display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal save" id="resetPasswordSubmitBtn" onclick="submitPasswordReset()">
                    Update Password
                </button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Mobile Header Bar -->
        <div class="mobile-header" id="mobileHeader">
            <div class="mobile-header-logo">
                <svg viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="50,2 95,72 78,72 50,22 22,72 5,72" fill="url(#mobileGrad)"/>
                    <defs><linearGradient id="mobileGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="var(--accent-blue)"/><stop offset="100%" stop-color="var(--accent-purple)"/></linearGradient></defs>
                </svg>
                <span>Peak Athlete</span>
            </div>
            <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMobileSidebar()" aria-label="Open menu">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
        </div>

        <!-- Sidebar Overlay (mobile backdrop) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>

        <!-- Sidebar -->
        <nav class="sidebar">
            <!-- Mobile Close Button -->
            <button class="sidebar-close-btn" id="sidebarCloseBtn" onclick="closeMobileSidebar()" aria-label="Close menu">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <div class="sidebar-logo">
                <svg viewBox="0 0 100 80" xmlns="http://www.w3.org/2000/svg">
                    <polygon points="50,2 95,72 78,72 50,22 22,72 5,72" fill="url(#sideGrad)"/>
                    <defs><linearGradient id="sideGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="var(--accent-blue)"/><stop offset="100%" stop-color="var(--accent-purple)"/></linearGradient></defs>
                </svg>
                <div class="sidebar-logo-text">
                    <h2>Peak Athlete</h2>
                    <span>Analytics <span class="version-tag">v02.11</span></span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Home</div>
                <div class="nav-item active" data-page="home">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    The Deck
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Analysis</div>
                <div class="nav-item" data-page="starts">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                    Starts
                </div>
                <div class="nav-item" data-page="turns">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
                    Turns
                </div>
                <div class="nav-item" data-page="races">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                    Races
                </div>
            </div>

            <div class="nav-section" id="leaderboardSection">
                <div class="nav-section-title">Rankings</div>
                <div class="nav-item" data-page="leaderboards">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="6" width="4" height="15" rx="1"/><rect x="17" y="2" width="4" height="19" rx="1"/></svg>
                    Leaderboards
                </div>
            </div>

            <div class="nav-section" id="coachSection" style="display: none;">
                <div class="nav-section-title">Team</div>
                <div class="nav-item" data-page="team">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    Team Overview
                    <span id="pendingBadge" class="pending-count-badge" style="display:none;">0</span>
                </div>
            </div>

            <div class="sidebar-footer">
                <!-- Theme Toggle -->
                <div class="theme-toggle-row" id="themeToggleRow">
                    <div class="theme-toggle-label">
                        <svg id="themeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        <span id="themeLabel">Dark Mode</span>
                    </div>
                    <button class="theme-toggle-btn" id="themeToggleBtn" onclick="toggleTheme()" aria-label="Toggle theme">
                        <div class="theme-toggle-knob"></div>
                    </button>
                </div>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">--</div>
                    <div class="user-details">
                        <h4 id="userName">Loading...</h4>
                        <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                            <span class="role-badge athlete" id="userRole">Athlete</span>
                            <span class="role-badge" id="subscriptionBadge" style="display:none; background:linear-gradient(135deg,var(--accent-green),#00B86B); color:#fff;">Pro</span>
                        </div>
                    </div>
                </div>
                <div class="nav-item" id="subscriptionBtn" onclick="openSubscriptionModal()" style="background:linear-gradient(135deg,var(--accent-green),#00B86B); color:#fff; font-weight:500;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                    <span id="subscriptionBtnText">Upgrade</span>
                </div>
                <div class="nav-item" id="logoutBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    Sign Out
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Home Page (Athlete Dashboard) -->
            <section class="page-section active" id="page-home">
                <!-- Welcome Hero -->
                <div id="welcomeHero">
                    <div class="welcome-strip"></div>
                    <div class="welcome-bar">
                        <div>
                            <h1 id="welcomeMessage">Welcome back!</h1>
                            <div class="wb-sub" id="greetingTime"></div>
                        </div>
                        <div class="wb-right">
                            <span class="wb-badge" id="userRoleBadge"></span>
                        </div>
                    </div>
                </div>

                <!-- Coach: Athlete Selector -->
                <div class="athlete-selector" id="athleteSelector" style="display: none;">
                    <label>Select Athlete:</label>
                    <select id="athleteDropdown">
                        <option value="">All Athletes</option>
                    </select>
                </div>

                <!-- Membership Pending Banner -->
                <div id="pendingBanner" style="display:none;"></div>

                <!-- === COACH DASHBOARD (shown when no athlete selected) === -->
                <div id="coachDashboard">
                    <!-- Filter Bar -->
                    <div class="coach-filter-bar" id="coachFilterBar">
                        <div class="filter-bar-left">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            <select id="filterGroup" onchange="applyCoachFilters()">
                                <option value="">All Groups</option>
                            </select>
                            <select id="filterGender" onchange="applyCoachFilters()">
                                <option value="">All Genders</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                            <span class="filter-count" id="filterCount"></span>
                        </div>
                        <button class="filter-manage-btn" onclick="openGroupsModal()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            Manage Groups
                        </button>
                    </div>

                    <!-- Team Pulse -->
                    <div class="coach-section-header"><h2>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        Team Pulse</h2></div>
                    <div class="team-pulse-grid" id="teamPulseGrid">
                        <div class="loading" style="grid-column:1/-1;"><div class="loading-spinner"></div>Loading team metrics...</div>
                    </div>

                    <!-- Home Page Carousels (v02.11) -->
                    <div class="home-carousels-row" id="homeCarouselsRow">
                        <!-- Team Records / Personal Bests Carousel -->
                        <div class="carousel-card records-carousel">
                            <div class="carousel-header">
                                <div class="carousel-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>
                                    <span id="recordsCarouselTitle">Team Records</span>
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <div class="carousel-filter" id="recordsGenderFilter">
                                        <button class="carousel-filter-btn active" data-gender="">All</button>
                                        <button class="carousel-filter-btn" data-gender="male">M</button>
                                        <button class="carousel-filter-btn" data-gender="female">F</button>
                                    </div>
                                    <div class="carousel-filter" id="recordsCourseFilter">
                                        <button class="carousel-filter-btn active" data-course="SCY">SCY</button>
                                        <button class="carousel-filter-btn" data-course="SCM">SCM</button>
                                        <button class="carousel-filter-btn" data-course="LCM">LCM</button>
                                    </div>
                                </div>
                            </div>
                            <div class="carousel-body" id="recordsCarouselBody">
                                <div class="loading"><div class="loading-spinner"></div>Loading records...</div>
                            </div>
                            <div class="carousel-nav">
                                <div class="carousel-dots" id="recordsCarouselDots"></div>
                                <div class="carousel-arrows">
                                    <button class="carousel-arrow" id="recordsPrev"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                                    <button class="carousel-arrow" id="recordsNext"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Competition Leaders Carousel -->
                        <div class="carousel-card competition-carousel" id="compCarouselCard">
                            <div class="carousel-header">
                                <div class="carousel-title" style="color:var(--accent-gold);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="6" width="4" height="15" rx="1"/><rect x="17" y="2" width="4" height="19" rx="1"/></svg>
                                    Competition Leaders
                                </div>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <div class="carousel-filter" id="compGenderFilterCarousel">
                                        <button class="carousel-filter-btn active" data-gender="">All</button>
                                        <button class="carousel-filter-btn" data-gender="male">M</button>
                                        <button class="carousel-filter-btn" data-gender="female">F</button>
                                    </div>
                                    <a href="#" onclick="navigateTo('leaderboards');return false;" style="font-size:11px;color:var(--accent-blue);text-decoration:none;">View All </a>
                                </div>
                            </div>
                            <div class="carousel-body" id="compCarouselBody">
                                <div class="loading"><div class="loading-spinner"></div>Loading competition...</div>
                            </div>
                            <div class="carousel-nav">
                                <div class="carousel-dots" id="compCarouselDots"></div>
                                <div class="carousel-arrows">
                                    <button class="carousel-arrow" id="compPrev"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                                    <button class="carousel-arrow" id="compNext"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Team Goals (coach can add/manage) -->
                    <div class="coach-section-header collapsible-header" onclick="toggleCoachSection('teamGoalsCollapse','teamGoalsChevron')">
                        <h2>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                            Team Goals<span class="section-count" id="teamGoalsCount"></span>
                        </h2>
                        <svg id="teamGoalsChevron" class="collapse-chevron collapsed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="collapsible-body collapsed" id="teamGoalsCollapse">
                        <div id="teamGoalsGrid">
                            <div class="loading"><div class="loading-spinner"></div>Loading goals...</div>
                        </div>
                    </div>

                    <!-- Team Roster (collapsible) -->
                    <div class="coach-section-header collapsible-header" id="rosterHeader" onclick="toggleCoachSection('rosterCollapse','rosterChevron')">
                        <h2>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Team Roster<span class="section-count" id="rosterCount"></span>
                        </h2>
                        <svg id="rosterChevron" class="collapse-chevron collapsed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="collapsible-body collapsed" id="rosterCollapse">
                        <div class="card" style="margin-bottom:6px;"><div class="card-body" id="teamRosterBody" style="padding:0; overflow-x:auto;">
                            <div class="loading"><div class="loading-spinner"></div>Loading roster...</div>
                        </div></div>
                    </div>

                    <!-- Recent Team Activity (collapsible) -->
                    <div class="coach-section-header collapsible-header" onclick="toggleCoachSection('activityCollapse','activityChevron')">
                        <h2>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Recent Team Activity
                        </h2>
                        <svg id="activityChevron" class="collapse-chevron collapsed" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="collapsible-body collapsed" id="activityCollapse">
                        <div class="card" style="margin-bottom:20px;"><div class="card-body" id="teamActivityFeed" style="padding:8px;">
                            <div class="loading"><div class="loading-spinner"></div>Loading activity...</div>
                        </div></div>
                    </div>

                    <!-- Quick Actions (same for coach) -->
                    <div class="coach-section-header"><h2>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        Detailed Analysis</h2></div>
                    <div class="quick-actions">
                        <div class="quick-action" data-nav="starts"><div class="quick-action-icon starts"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div><div class="quick-action-text"><h3>Start Analysis</h3><p>Reaction Time, Velocity, Distance</p></div></div>
                        <div class="quick-action" data-nav="turns"><div class="quick-action-icon turns"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg></div><div class="quick-action-text"><h3>Turn Analysis</h3><p>Approach, Velocity, Push-Off</p></div></div>
                        <div class="quick-action" data-nav="races"><div class="quick-action-icon races"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg></div><div class="quick-action-text"><h3>Race Analysis</h3><p>Splits and performance</p></div></div>
                    </div>
                </div>

                <!-- === ATHLETE HOME SECTIONS (shown when athlete selected, or for athlete role) === -->
                <div id="athleteHomeSections">

                <!-- Alerts Section -->
                <div class="alerts-section" id="alertsSection"></div>

                <!-- Competition Badges (v02.08) -->
                <div id="compBadgesSection" style="display:none;">
                    <div class="section-header">
                        <h2>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>
                            Competition Badges
                        </h2>
                    </div>
                    <div class="comp-badges-grid" id="compBadgesGrid"></div>
                </div>

                <!-- Performance Pulse - 4 trend KPI cards -->
                <div class="section-header">
                    <h2>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                        Performance Pulse
                        <span class="info-tip"><span class="tip-content">Shows your <strong>recent trend</strong> across key metrics. Arrows compare your last 3 sessions to the previous 3.</span></span>
                    </h2>
                </div>
                <div class="pulse-grid" id="pulseGrid">
                    <div class="loading"><div class="loading-spinner"></div>Loading metrics...</div>
                </div>

                <!-- Athlete Carousels (v02.11) - PBs + Competition -->
                <div class="home-carousels-row" id="athleteCarouselsRow">
                    <!-- Personal Bests Carousel -->
                    <div class="carousel-card records-carousel">
                        <div class="carousel-header">
                            <div class="carousel-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>
                                <span>My Personal Bests</span>
                            </div>
                            <div class="carousel-filter" id="athleteCourseFilter">
                                <button class="carousel-filter-btn active" data-course="SCY">SCY</button>
                                <button class="carousel-filter-btn" data-course="SCM">SCM</button>
                                <button class="carousel-filter-btn" data-course="LCM">LCM</button>
                            </div>
                        </div>
                        <div class="carousel-body" id="athleteRecordsBody">
                            <div class="loading"><div class="loading-spinner"></div>Loading PBs...</div>
                        </div>
                        <div class="carousel-nav">
                            <div class="carousel-dots" id="athleteRecordsDots"></div>
                            <div class="carousel-arrows">
                                <button class="carousel-arrow" id="athleteRecordsPrev"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                                <button class="carousel-arrow" id="athleteRecordsNext"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Competition Leaders Carousel (Athlete View) -->
                    <div class="carousel-card competition-carousel" id="athleteCompCarouselCard">
                        <div class="carousel-header">
                            <div class="carousel-title" style="color:var(--accent-gold);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="6" width="4" height="15" rx="1"/><rect x="17" y="2" width="4" height="19" rx="1"/></svg>
                                Competition Leaders
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                <div class="carousel-filter" id="athleteCompGenderFilter">
                                    <button class="carousel-filter-btn active" data-gender="">All</button>
                                    <button class="carousel-filter-btn" data-gender="male">M</button>
                                    <button class="carousel-filter-btn" data-gender="female">F</button>
                                </div>
                                <a href="#" onclick="navigateTo('leaderboards');return false;" style="font-size:11px;color:var(--accent-blue);text-decoration:none;">View All </a>
                            </div>
                        </div>
                        <div class="carousel-body" id="athleteCompBody">
                            <div class="loading"><div class="loading-spinner"></div>Loading competition...</div>
                        </div>
                        <div class="carousel-nav">
                            <div class="carousel-dots" id="athleteCompDots"></div>
                            <div class="carousel-arrows">
                                <button class="carousel-arrow" id="athleteCompPrev"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                                <button class="carousel-arrow" id="athleteCompNext"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Last Session Snapshot - compact clickable card -->
                <div id="lastSessionCard" class="last-session-compact" style="display:none;">
                    <div class="last-session-inner" id="lastSessionBody">
                        <div class="loading"><div class="loading-spinner"></div>Loading...</div>
                    </div>
                </div>

                <!-- Goals -->
                <div class="section-header">
                    <h2>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>
                        Goals
                    </h2>
                    <button class="btn-small" id="addGoalBtn">+ Add Goal</button>
                </div>
                <div class="goals-grid" id="goalsGrid">
                    <div class="loading"><div class="loading-spinner"></div>Loading goals...</div>
                </div>

                <!-- Quick Actions -->
                <div class="section-header">
                    <h2>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                        Detailed Analysis
                    </h2>
                </div>
                <div class="quick-actions">
                    <div class="quick-action" data-nav="starts">
                        <div class="quick-action-icon starts">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                        </div>
                        <div class="quick-action-text">
                            <h3>Start Analysis</h3>
                            <p>Reaction Time, Velocity, Distance</p>
                        </div>
                    </div>
                    <div class="quick-action" data-nav="turns">
                        <div class="quick-action-icon turns">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>
                        </div>
                        <div class="quick-action-text">
                            <h3>Turn Analysis</h3>
                            <p>Approach, Velocity, Push-Off</p>
                        </div>
                    </div>
                    <div class="quick-action" data-nav="races">
                        <div class="quick-action-icon races">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
                        </div>
                        <div class="quick-action-text">
                            <h3>Race Analysis</h3>
                            <p>Splits and performance</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Sessions (condensed) -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header">
                        <h3 class="card-title">Session History</h3>
                    </div>
                    <div class="card-body" id="recentSessions">
                        <div class="loading"><div class="loading-spinner"></div>Loading sessions...</div>
                    </div>
                </div>
                </div><!-- close #athleteHomeSections -->
            </section>

            <!-- Goal Modal -->
            <div class="modal-overlay" id="goalModal">
                <div class="modal-box">
                    <div class="modal-header">
                        <h2>Add New Goal</h2>
                        <button class="modal-close" id="closeGoalModal">&#x2715;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Goal Type</label>
                            <select id="goalTypeSelect">
                                <option value="race_time">Race Time</option>
                                <option value="start_reaction">Start - Reaction Time</option>
                                <option value="start_15m">Start - Time to 15m</option>
                                <option value="turn_time">Turn - 15m In/Out</option>
                            </select>
                        </div>
                        <div class="form-group" id="goalEventGroup">
                            <label>Event (for race goals)</label>
                            <select id="goalEventSelect">
                                <option value="">Select event...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Target Value (seconds)</label>
                            <input type="number" id="goalTargetInput" step="0.01" placeholder="e.g., 52.50">
                        </div>
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <input type="text" id="goalNotesInput" placeholder="e.g., Conference meet goal">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal cancel" id="cancelGoalBtn">Cancel</button>
                        <button class="btn-modal save" id="saveGoalBtn">Save Goal</button>
                    </div>
                </div>
            </div>

            <!-- Team Join/Create Modal -->
            <div class="modal-overlay" id="teamModal">
                <div class="modal-box">
                    <div class="modal-header">
                        <h2 id="teamModalTitle">Join Team</h2>
                        <button class="modal-close" onclick="closeTeamModal()">&#x2715;</button>
                    </div>
                    <div class="modal-body">
                        <!-- JOIN MODE -->
                        <div id="teamJoinFields">
                            <div class="form-group">
                                <label>Team Code</label>
                                <input type="text" id="joinTeamCode" placeholder="e.g. GATOR" style="text-transform:uppercase;">
                                <div class="password-requirements">Enter the team abbreviation provided by your coach or admin.</div>
                            </div>
                            <div id="joinTeamPreview" style="display:none; padding:12px; border-radius:10px; background:rgba(0,230,138,0.08); border:1px solid rgba(0,230,138,0.2); margin-top:8px;">
                            </div>
                        </div>
                        <!-- CREATE MODE (coach only) -->
                        <div id="teamCreateFields" style="display:none;">
                            <div class="form-group">
                                <label>Team Name</label>
                                <input type="text" id="newTeamName" placeholder="e.g. Gator Swim Club">
                            </div>
                            <div class="form-group">
                                <label>Team Code <span style="font-weight:400;color:var(--text-muted)">(short abbreviation, 2-10 characters)</span></label>
                                <input type="text" id="newTeamCode" placeholder="e.g. GATOR" maxlength="10" style="text-transform:uppercase;">
                                <div class="password-requirements">This is the code athletes and other coaches will use to join your team.</div>
                            </div>
                        </div>
                        <div id="teamModalError" style="display:none; color:var(--accent-red); padding:10px; border-radius:8px; background:rgba(255,107,107,0.08); font-size:13px; margin-top:8px;"></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal cancel" onclick="closeTeamModal()">Cancel</button>
                        <button class="btn-modal save" id="teamModalSubmitBtn" onclick="submitTeamAction()">Join Team</button>
                    </div>
                </div>
            </div>

            <!-- Team Goal Modal (coach) -->
            <div class="modal-overlay" id="teamGoalModal">
                <div class="modal-box">
                    <div class="modal-header">
                        <h2>Add Team Goal</h2>
                        <button class="modal-close" onclick="closeTeamGoalModal()">&#x2715;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Athlete</label>
                            <select id="tgAthleteSelect">
                                <option value="">Select athlete...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Metric</label>
                            <select id="tgMetricSelect" onchange="onTeamGoalMetricChange()">
                                <option value="">Select metric...</option>
                                <option value="race_time">Race Time</option>
                                <option value="start_reaction">Reaction Time</option>
                                <option value="start_15m">Start to 15m</option>
                                <option value="turn_time">Turn 15m In/Out</option>
                            </select>
                        </div>
                        <div class="form-group" id="tgEventGroup" style="display:none;">
                            <label>Event</label>
                            <select id="tgEventSelect">
                                <option value="">Select event...</option>
                            </select>
                        </div>
                        <div class="form-group" id="tgCurrentGroup" style="display:none;">
                            <label>Current Best</label>
                            <div id="tgCurrentBest" style="font-size:18px;font-weight:600;font-family:'JetBrains Mono',monospace;color:var(--text-primary);padding:4px 0;">--</div>
                        </div>
                        <div class="form-group">
                            <label>Target (seconds)</label>
                            <input type="number" id="tgTargetInput" step="0.01" placeholder="e.g., 52.50">
                        </div>
                        <div class="form-group">
                            <label>Notes (optional)</label>
                            <input type="text" id="tgNotesInput" placeholder="e.g., Conference meet target">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-modal cancel" onclick="closeTeamGoalModal()">Cancel</button>
                        <button class="btn-modal save" onclick="saveTeamGoal()">Save Goal</button>
                    </div>
                </div>
            </div>

            <!-- Subscription Modal -->
            <div class="modal-overlay" id="subscriptionModal">
                <div class="modal-box" style="max-width:480px;">
                    <div class="modal-header">
                        <h2 id="subscriptionModalTitle">Upgrade to Pro</h2>
                        <button class="modal-close" onclick="closeSubscriptionModal()">&#x2715;</button>
                    </div>
                    <div class="modal-body" id="subscriptionModalBody">
                        <!-- Content loaded dynamically -->
                    </div>
                </div>
            </div>

            <!-- Manage Groups Modal (coach) -->
            <div class="modal-overlay" id="groupsModal">
                <div class="modal-box" style="max-width:540px;">
                    <div class="modal-header">
                        <h2>Manage Groups</h2>
                        <button class="modal-close" onclick="closeGroupsModal()">&#x2715;</button>
                    </div>
                    <div class="modal-body groups-modal-body">
                        <div class="create-group-row">
                            <input type="text" id="newGroupName" placeholder="New group name (e.g., Sprint, Distance, IM)">
                            <input type="color" id="newGroupColor" value="#00C2FF" style="width:36px;height:36px;padding:2px;border-radius:8px;border:1px solid var(--border-color);cursor:pointer;">
                            <button onclick="createGroup()">Create</button>
                        </div>
                        <div id="groupsList">
                            <div class="loading"><div class="loading-spinner"></div>Loading groups...</div>
                        </div>
                        <div id="groupEditPanel" style="display:none;"></div>
                    </div>
                </div>
            </div>

            <!-- Starts Page -->
            <section class="page-section" id="page-starts">
                <div class="page-header">
                    <h1>Start Analysis</h1>
                    <p>Dive start performance metrics and trends</p>
                </div>

                <!-- Unified Filter Bar (same design as Race page) -->
                <div class="race-filter-bar" id="startFilterBar">
                    <!-- Row 1: Scope (coach only) -->
                    <div class="rfb-row rfb-row-scope rfb-start-coach" style="display:none;">
                        <span class="rfb-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Scope
                        </span>
                        <div class="rfb-field">
                            <label>Athlete</label>
                            <select id="startAthleteFilter" onchange="onStartAthleteChange()">
                                <option value="">All Team</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Group</label>
                            <select id="startGroupFilter" onchange="onStartGroupChange()">
                                <option value="">No Group</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Gender</label>
                            <select id="startGenderFilter" onchange="onStartGenderChange()">
                                <option value="">All</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="rfb-info" id="startCoachInfo"></div>
                    </div>
                    <!-- Row 2: Filters (everyone) -->
                    <div class="rfb-row rfb-row-filters">
                        <span class="rfb-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px;"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            Filters
                        </span>
                        <div class="rfb-field">
                            <label>Style</label>
                            <select id="startStyleFilter">
                                <option value="">All Strokes</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Date</label>
                            <select id="startDateFilter">
                                <option value="">All Time</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Start Selector Cards -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <h3 class="card-title">Select Start Trial</h3>
                        <button class="start-selector-clear" id="startClearBtn" style="display:none;" onclick="clearStartSelection()">Clear Selection</button>
                    </div>
                    <div class="card-body">
                        <div class="start-selector-list" id="startSelectorList">
                            <div class="loading"><div class="loading-spinner"></div> Loading trials...</div>
                        </div>
                        <div id="startSelectorHint" style="font-size:12px; color:var(--text-muted); margin-top:8px;">
                            <svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            Click a trial to view details. Click a second to compare.
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="kpi-grid" id="startKpis">
                    <div class="loading"><div class="loading-spinner"></div> Loading start metrics...</div>
                </div>

                <!-- Tab Bar -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-body" style="padding-top:0;">
                        <div class="start-tab-bar" id="startTabBar">
                            <div class="start-tab active" data-tab="block">Block Phase</div>
                            <div class="start-tab" data-tab="flight">Flight & Entry</div>
                            <div class="start-tab" data-tab="underwater">Underwater</div>
                            <div class="start-tab" data-tab="velocity">Velocity</div>
                            <div class="start-tab" data-tab="summary">Start Summary</div>
                        </div>

                        <!-- Block Phase Tab -->
                        <div class="start-tab-content active" id="startTab-block">
                            <div id="startBlockPhaseContent">
                                <div class="empty-state"><h3>Select a start trial to view block phase details</h3></div>
                            </div>
                        </div>

                        <!-- Flight & Entry Tab -->
                        <div class="start-tab-content" id="startTab-flight">
                            <div id="startFlightCharts"></div>
                            <div id="startFlightCards">
                                <div class="empty-state"><h3>Select a start trial to view flight and entry data</h3></div>
                            </div>
                        </div>

                        <!-- Underwater Tab -->
                        <div class="start-tab-content" id="startTab-underwater">
                            <div id="startUnderwaterContent">
                                <div class="empty-state"><h3>Select a start trial to view underwater phase</h3></div>
                            </div>
                            <div id="startUnderwaterCharts" style="display:none;">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                                    <div>
                                        <h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:10px;">Split Times</h4>
                                        <div class="chart-container" style="height:240px;">
                                            <canvas id="uwSplitChart"></canvas>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:10px;">Underwater Velocity <span class="info-tip"><span class="tip-content">Speed during the underwater phase. <span class="tip-good">Aim to hold velocity above 1.8 m/s</span> through breakout. A sharp drop means early surfacing or weak kicks.</span></span></h4>
                                        <div class="chart-container" style="height:240px;">
                                            <canvas id="uwVelocityChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div id="startUnderwaterMetrics"></div>
                            </div>
                        </div>

                        <!-- Velocity Tab -->
                        <div class="start-tab-content" id="startTab-velocity">
                            <div style="margin-bottom:16px;">
                                <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Velocity Segments <span class="info-tip"><span class="tip-content">Full velocity profile from block to 15m. Should show a <strong>high peak at takeoff</strong> (4+ m/s) with a gradual taper. Sudden drops indicate energy loss at entry or transition.</span></span></h3>
                                <p style="font-size:12px; color:var(--text-muted);">Speed across 0-5m, 5-10m, and 10-15m zones</p>
                            </div>
                            <div class="chart-container" style="height:300px;">
                                <canvas id="startVelocityChart"></canvas>
                            </div>
                            <div id="startVelocityMetrics"></div>
                        </div>

                        <!-- Start Summary Tab -->
                        <div class="start-tab-content" id="startTab-summary">
                            <div id="startSummaryContent">
                                <div class="empty-state"><h3>Select a start trial to view summary</h3></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trials Table (collapsible) -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header collapsible-header" onclick="toggleCoachSection('startTrialsBody','startTrialsChevron')">
                        <h3 class="card-title">All Start Trials</h3>
                        <svg class="collapse-chevron collapsed" id="startTrialsChevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="collapsible-body collapsed" id="startTrialsBody">
                        <div class="card-body" id="startTrialsTable">
                            <div class="loading"><div class="loading-spinner"></div> Loading trials...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Turns Page -->
            <section class="page-section" id="page-turns">
                <div class="page-header">
                    <h1>Turn Analysis</h1>
                    <p>Wall turn performance, approach, and underwater metrics</p>
                </div>

                <!-- Unified Filter Bar -->
                <div class="race-filter-bar" id="turnFilterBar">
                    <!-- Row 1: Scope (coach only) -->
                    <div class="rfb-row rfb-row-scope rfb-turn-coach" style="display:none;">
                        <span class="rfb-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Scope
                        </span>
                        <div class="rfb-field">
                            <label>Athlete</label>
                            <select id="turnAthleteFilter" onchange="onTurnAthleteChange()">
                                <option value="">All Team</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Group</label>
                            <select id="turnGroupFilter" onchange="onTurnGroupChange()">
                                <option value="">No Group</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Gender</label>
                            <select id="turnGenderFilter" onchange="onTurnGenderChange()">
                                <option value="">All</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="rfb-info" id="turnCoachInfo"></div>
                    </div>
                    <!-- Row 2: Filters (everyone) -->
                    <div class="rfb-row rfb-row-filters">
                        <span class="rfb-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px;"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            Filters
                        </span>
                        <div class="rfb-field">
                            <label>Style</label>
                            <select id="turnStyleFilter">
                                <option value="">All Strokes</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Date</label>
                            <select id="turnDateFilter">
                                <option value="">All Time</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Turn Selector Cards -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <h3 class="card-title">Select Turn Trial</h3>
                        <button class="turn-selector-clear" id="turnClearBtn" style="display:none;" onclick="clearTurnSelection()">Clear Selection</button>
                    </div>
                    <div class="card-body">
                        <div class="turn-selector-list" id="turnSelectorList">
                            <div class="loading"><div class="loading-spinner"></div> Loading trials...</div>
                        </div>
                        <div id="turnSelectorHint" style="font-size:12px; color:var(--text-muted); margin-top:8px;">
                            <svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            Click a trial to view details. Click a second to compare.
                        </div>
                    </div>
                </div>

                <!-- KPIs -->
                <div class="kpi-grid" id="turnKpis">
                    <div class="loading"><div class="loading-spinner"></div> Loading turn metrics...</div>
                </div>

                <!-- Tab Bar -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-body" style="padding-top:0;">
                        <div class="turn-tab-bar" id="turnTabBar">
                            <div class="turn-tab active" data-tab="approach">Approach</div>
                            <div class="turn-tab" data-tab="wall">Wall Contact</div>
                            <div class="turn-tab" data-tab="underwater">Underwater</div>
                            <div class="turn-tab" data-tab="velocity">Velocity Profile</div>
                            <div class="turn-tab" data-tab="summary">Turn Summary</div>
                        </div>

                        <!-- Approach Tab -->
                        <div class="turn-tab-content active" id="turnTab-approach">
                            <div id="turnApproachContent">
                                <div class="empty-state"><h3>Select a turn trial to view approach data</h3></div>
                            </div>
                            <div id="turnApproachCharts" style="display:none;">
                                <div id="turnApproachTimeline"></div>
                                <div style="margin-top:20px;">
                                    <h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:10px;">Approach Velocity <span class="info-tip"><span class="tip-content">Speed in the last 15m before the wall, split into three 5m zones. <span class="tip-watch">Watch for big drop-offs</span> - maintain speed into the wall.</span></span></h4>
                                    <div class="chart-container" style="height:220px;"><canvas id="turnApproachVelChart"></canvas></div>
                                </div>
                                <div id="turnApproachMetrics"></div>
                            </div>
                        </div>

                        <!-- Wall Contact Tab -->
                        <div class="turn-tab-content" id="turnTab-wall">
                            <div id="turnWallContent">
                                <div class="empty-state"><h3>Select a turn trial to view wall contact data</h3></div>
                            </div>
                        </div>

                        <!-- Underwater Tab -->
                        <div class="turn-tab-content" id="turnTab-underwater">
                            <div id="turnUWContent">
                                <div class="empty-state"><h3>Select a turn trial to view underwater phase</h3></div>
                            </div>
                            <div id="turnUWCharts" style="display:none;">
                                <div id="turnUWTimeline"></div>
                                <div style="margin-top:20px;">
                                    <h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:10px;">Post-Turn Velocity <span class="info-tip"><span class="tip-content">Velocity after the wall push-off. <span class="tip-good">Good turns maintain 2.0+ m/s</span> through the underwater before breakout.</span></span></h4>
                                    <div class="chart-container" style="height:220px;"><canvas id="turnUWVelChart"></canvas></div>
                                </div>
                                <div id="turnUWMetrics"></div>
                            </div>
                        </div>

                        <!-- Velocity Profile Tab -->
                        <div class="turn-tab-content" id="turnTab-velocity">
                            <div style="margin-bottom:16px;">
                                <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Full Velocity Profile <span class="info-tip"><span class="tip-content">Complete velocity: approach (3 zones) -> wall -> departure (3 zones). Look for <strong>symmetry</strong> - approach speed should be matched or exceeded in departure.</span></span></h3>
                                <p style="font-size:12px; color:var(--text-muted);">Approach through departure - 6 velocity zones</p>
                            </div>
                            <div class="chart-container" style="height:300px;"><canvas id="turnFullVelChart"></canvas></div>
                            <div id="turnVelocityMetrics"></div>
                        </div>

                        <!-- Turn Summary Tab -->
                        <div class="turn-tab-content" id="turnTab-summary">
                            <div id="turnSummaryContent">
                                <div class="empty-state"><h3>Select a turn trial to view summary</h3></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trials Table (collapsible) -->
                <div class="card" style="margin-top:20px;">
                    <div class="card-header collapsible-header" onclick="toggleCoachSection('turnTrialsBody','turnTrialsChevron')">
                        <h3 class="card-title">All Turn Trials</h3>
                        <svg class="collapse-chevron collapsed" id="turnTrialsChevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="collapsible-body collapsed" id="turnTrialsBody">
                        <div class="card-body" id="turnTrialsTable">
                            <div class="loading"><div class="loading-spinner"></div> Loading trials...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Races Page -->
            <section class="page-section" id="page-races">
                <div class="page-header">
                    <h1>Race Analysis</h1>
                    <p>Race performance, splits, pacing, and stroke analysis</p>
                </div>

                <!-- Unified Filter Bar -->
                <div class="race-filter-bar" id="raceFilterBar">
                    <!-- Row 1: Scope (coach only) -->
                    <div class="rfb-row rfb-row-scope rfb-coach-only" style="display:none;">
                        <span class="rfb-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Scope
                        </span>
                        <div class="rfb-field">
                            <label>Athlete</label>
                            <select id="raceAthleteFilter" onchange="onRaceAthleteChange()">
                                <option value="">All Team</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Group</label>
                            <select id="raceGroupFilter" onchange="onRaceGroupChange()">
                                <option value="">No Group</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Gender</label>
                            <select id="raceGenderFilter" onchange="onRaceGenderChange()">
                                <option value="">All</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="rfb-info" id="raceCoachInfo"></div>
                    </div>
                    <!-- Row 2: Filters (everyone) -->
                    <div class="rfb-row rfb-row-filters">
                        <span class="rfb-row-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:3px;"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                            Filters
                        </span>
                        <div class="rfb-field">
                            <label>Course</label>
                            <select id="raceCourseFilter">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Event</label>
                            <select id="raceEventFilter">
                                <option value="">All Distances</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Style</label>
                            <select id="raceStyleFilter">
                                <option value="">All Strokes</option>
                            </select>
                        </div>
                        <div class="rfb-field">
                            <label>Date</label>
                            <select id="raceDateFilter">
                                <option value="">All Time</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                                <option value="180">Last 6 Months</option>
                                <option value="365">Last Year</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Race Selector (clickable race cards) -->
                <div class="race-selector-wrap">
                    <div class="race-selector-header">
                        <h3>Select a Race</h3>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <span class="race-selector-hint" id="raceSelectorHint">Click a race to view details. Click a second to compare.</span>
                            <button class="race-selector-clear" id="raceSelectorClear" style="display:none;" onclick="clearRaceSelection()">Clear Selection</button>
                        </div>
                    </div>
                    <div class="race-selector-list" id="raceSelectorList">
                        <div class="loading"><div class="loading-spinner"></div></div>
                    </div>
                </div>

                <!-- Race KPI Module (context-aware) -->
                <div class="kpi-grid" id="raceKpis">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Loading race metrics...
                    </div>
                </div>

                <!-- Race Tab Navigation -->
                <div class="race-tab-bar" id="raceTabBar">
                    <div class="race-tab active" data-tab="splits">Split Analysis</div>
                    <div class="race-tab" data-tab="pacing">Pacing</div>
                    <div class="race-tab" data-tab="strokes">Stroke Data</div>
                    <div class="race-tab" data-tab="summary">Race Summary</div>
                </div>

                <!-- TAB: Split Analysis -->
                <div class="race-tab-content active" id="raceTab-splits">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Split Times <span class="info-tip"><span class="tip-content">Cumulative time at each wall. Switch to "Per Segment" to see individual lap times and identify pacing patterns.</span></span></h3>
                                <div class="chart-toggle" id="splitChartToggle">
                                    <button class="chart-toggle-btn active" data-mode="cumulative">Cumulative</button>
                                    <button class="chart-toggle-btn" data-mode="segment">Per Segment</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="splitsChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Lap Split Breakdown <span class="info-tip"><span class="tip-content">Visual comparison of each lap. <span class="tip-good">Green = fastest</span>, blue = average, <span class="tip-watch">red = slowest</span>. Even splits indicate good pacing strategy.</span></span></h3>
                            </div>
                            <div class="card-body" id="splitBarsContainer">
                                <div class="loading"><div class="loading-spinner"></div>Loading splits...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Pacing -->
                <div class="race-tab-content" id="raceTab-pacing">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Velocity per Segment <span class="info-tip"><span class="tip-content">Average speed per segment. <span class="tip-watch">Watch for negative splits</span> (getting faster) vs positive splits (slowing down). Elite pacing often shows a slight U-shape.</span></span></h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="raceVelocityChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Start Phase Breakdown <span class="info-tip"><span class="tip-content">Breakdown of time in each phase of the race start: on-block, flight, dip, and underwater to surface break.</span></span></h3>
                            </div>
                            <div class="card-body" id="raceStartPhase">
                                <div class="loading"><div class="loading-spinner"></div>Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Strokes -->
                <div class="race-tab-content" id="raceTab-strokes">
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Stroke Rate by Segment <span class="info-tip"><span class="tip-content">Strokes per minute in each segment. Increasing stroke rate with decreasing distance-per-stroke can indicate fatigue.</span></span></h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="strokeRateChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Stroke Count per Lap <span class="info-tip"><span class="tip-content">Total strokes per lap. Fewer strokes with the same split time means better efficiency (distance per stroke).</span></span></h3>
                            </div>
                            <div class="card-body" id="strokeCountGrid">
                                <div class="loading"><div class="loading-spinner"></div>Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: Race Summary (comparison digest) -->
                <div class="race-tab-content" id="raceTab-summary">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title" id="summaryTitle">Race Summary</h3>
                        </div>
                        <div class="card-body" id="raceSummaryContent">
                            <div class="empty-state">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l4.58-4.58c.94-.94.94-2.48 0-3.42L9 5z"></path><circle cx="6" cy="9" r="1"></circle></svg>
                                <h3>Select a race above</h3>
                                <p>The summary tab shows a consolidated overview of all key metrics for the selected race. Select two races to see a comparison digest.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Race History Table (collapsible) -->
                <div class="card">
                    <div class="card-header collapsible-header" onclick="toggleCoachSection('raceHistoryBody','raceHistoryChevron')">
                        <h3 class="card-title">Full Race History</h3>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:12px;color:var(--text-muted);">Click row to expand details</span>
                            <svg class="collapse-chevron collapsed" id="raceHistoryChevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                    </div>
                    <div class="collapsible-body collapsed" id="raceHistoryBody">
                        <div class="card-body" id="raceTrialsTable">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                                Loading races...
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Leaderboards Page (v02.08) -->
            <section class="page-section" id="page-leaderboards">
                <div class="page-header">
                    <h1>Leaderboards</h1>
                    <p>Team rankings and universal competition boards</p>
                </div>

                <!-- Top-level mode tabs: Team vs Competition -->
                <div class="lb-mode-bar" id="lbModeBar">
                    <div class="lb-mode-tab active" data-lbmode="team">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        Team Rankings
                    </div>
                    <div class="lb-mode-tab" data-lbmode="competition">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>
                        Competition
                    </div>
                </div>

                <!-- ======== TEAM RANKINGS PANEL ======== -->
                <div class="lb-panel active" id="lbPanelTeam">
                    <!-- Category Tabs -->
                    <div class="lb-category-bar" id="lbCategoryBar">
                        <div class="lb-cat-tab active" data-lbcat="race">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
                            Race Times
                        </div>
                        <div class="lb-cat-tab" data-lbcat="start">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                            Starts
                        </div>
                        <div class="lb-cat-tab" data-lbcat="turn">
                            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                            Turns
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div class="lb-filter-bar" id="lbFilterBar">
                        <div class="lb-filter-group">
                            <div class="lb-filter-field" id="lbGroupFilterWrap" style="display:none;">
                                <label>Group</label>
                                <select id="lbGroupFilter" onchange="applyLbFilters()"><option value="">All Athletes</option></select>
                            </div>
                            <div class="lb-filter-field" id="lbDistanceFilterWrap">
                                <label>Distance</label>
                                <select id="lbDistanceFilter" onchange="applyLbFilters()"><option value="">All Distances</option></select>
                            </div>
                            <div class="lb-filter-field" id="lbStrokeFilterWrap">
                                <label>Stroke</label>
                                <select id="lbStrokeFilter" onchange="applyLbFilters()"><option value="">All Strokes</option></select>
                            </div>
                            <div class="lb-filter-field" id="lbCourseFilterWrap">
                                <label>Course</label>
                                <select id="lbCourseFilter" onchange="applyLbFilters()">
                                    <option value="">All Courses</option><option value="SCY">SCY</option><option value="SCM">SCM</option><option value="LCM">LCM</option>
                                </select>
                            </div>
                            <div class="lb-filter-field">
                                <label>Gender</label>
                                <select id="lbGenderFilter" onchange="applyLbFilters()">
                                    <option value="">All</option><option value="male">Male</option><option value="female">Female</option>
                                </select>
                            </div>
                            <div class="lb-filter-field" id="lbMetricFilterWrap">
                                <label>Metric</label>
                                <select id="lbMetricFilter" onchange="applyLbFilters()"></select>
                            </div>
                        </div>
                        <div class="lb-filter-info" id="lbFilterInfo"></div>
                    </div>

                    <!-- Podium -->
                    <div class="lb-podium-wrap"><div class="lb-podium" id="lbPodium"></div></div>

                    <!-- Rankings Table -->
                    <div class="card lb-table-card" id="lbTableCard">
                        <div class="card-header">
                            <h3 class="card-title" id="lbTableTitle">Full Rankings</h3>
                            <span class="lb-record-count" id="lbRecordCount"></span>
                        </div>
                        <div class="card-body" style="padding:0; overflow-x:auto;">
                            <div id="lbTableBody"><div class="loading"><div class="loading-spinner"></div>Loading leaderboard...</div></div>
                        </div>
                    </div>
                </div>

                <!-- ======== COMPETITION PANEL ======== -->
                <div class="lb-panel" id="lbPanelCompetition">

                    <!-- Opt-in Settings Card -->
                    <div class="comp-optin-card" id="compOptinCard">
                        <div class="comp-optin-header">
                            <div class="comp-optin-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg>
                            </div>
                            <div class="comp-optin-text">
                                <h3>Universal Competition</h3>
                                <p>Compete against athletes across all teams. Your name, team, and best performances will be visible to all participants.</p>
                            </div>
                            <div class="comp-optin-toggle-wrap">
                                <button class="comp-optin-toggle" id="compMasterToggle" onclick="toggleCompetitionOptIn()">
                                    <div class="comp-toggle-knob"></div>
                                </button>
                                <span class="comp-optin-status" id="compOptinStatus">Not Enrolled</span>
                            </div>
                        </div>

                        <!-- Per-competition checkboxes (shown when opted in) -->
                        <div class="comp-events-grid" id="compEventsGrid" style="display:none;">
                            <div class="comp-event-item" data-comp="fastest_start_15m">
                                <label class="comp-event-check">
                                    <input type="checkbox" id="compCheck_fastest_start_15m" onchange="toggleCompetitionEntry('fastest_start_15m', this.checked)">
                                    <span class="comp-checkmark"></span>
                                </label>
                                <div class="comp-event-info">
                                    <div class="comp-event-name">Fastest Start</div>
                                    <div class="comp-event-desc">0m to 15m split time</div>
                                </div>
                                <div class="comp-event-icon" style="color:var(--accent-orange);">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                                </div>
                            </div>
                            <div class="comp-event-item" data-comp="best_reaction">
                                <label class="comp-event-check">
                                    <input type="checkbox" id="compCheck_best_reaction" onchange="toggleCompetitionEntry('best_reaction', this.checked)">
                                    <span class="comp-checkmark"></span>
                                </label>
                                <div class="comp-event-info">
                                    <div class="comp-event-name">Best Reaction Time</div>
                                    <div class="comp-event-desc">Start signal to first movement</div>
                                </div>
                                <div class="comp-event-icon" style="color:var(--accent-cyan);">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                </div>
                            </div>
                            <div class="comp-event-item" data-comp="fastest_turn_15_15">
                                <label class="comp-event-check">
                                    <input type="checkbox" id="compCheck_fastest_turn_15_15" onchange="toggleCompetitionEntry('fastest_turn_15_15', this.checked)">
                                    <span class="comp-checkmark"></span>
                                </label>
                                <div class="comp-event-info">
                                    <div class="comp-event-name">Fastest Turn</div>
                                    <div class="comp-event-desc">15m in to 15m out</div>
                                </div>
                                <div class="comp-event-icon" style="color:var(--accent-purple);">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                                </div>
                            </div>
                            <div class="comp-event-item" data-comp="best_race_pb">
                                <label class="comp-event-check">
                                    <input type="checkbox" id="compCheck_best_race_pb" onchange="toggleCompetitionEntry('best_race_pb', this.checked)">
                                    <span class="comp-checkmark"></span>
                                </label>
                                <div class="comp-event-info">
                                    <div class="comp-event-name">Best Race PB</div>
                                    <div class="comp-event-desc">Personal best times by event</div>
                                </div>
                                <div class="comp-event-icon" style="color:var(--accent-green);">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Competition Board Selector -->
                    <div class="comp-board-bar" id="compBoardBar" style="display:none;">
                        <div class="comp-board-tab active" data-compboard="fastest_start_15m">
                            Fastest Start
                            <span class="comp-info-tip" data-tooltip="Time from starting signal to 15m mark. Lower is better.">i</span>
                        </div>
                        <div class="comp-board-tab" data-compboard="best_reaction">
                            Reaction Time
                            <span class="comp-info-tip" data-tooltip="Time from beep to first movement off block. Lower is better.">i</span>
                        </div>
                        <div class="comp-board-tab" data-compboard="fastest_turn_15_15">
                            Fastest Turn
                            <span class="comp-info-tip" data-tooltip="Time from 15m in to 15m out (30m total). Lower is better.">i</span>
                        </div>
                        <div class="comp-board-tab" data-compboard="best_race_pb">
                            Race PB
                            <span class="comp-info-tip" data-tooltip="Personal best race time. Filtered by event & course. Lower is better.">i</span>
                        </div>
                    </div>

                    <!-- Competition Gender Filter -->
                    <div class="comp-filter-row" id="compFilterRow" style="display:none;">
                        <div class="lb-filter-field">
                            <label>Gender</label>
                            <select id="compGenderFilter" onchange="loadCompetitionBoard()">
                                <option value="">All</option><option value="male">Male</option><option value="female">Female</option>
                            </select>
                        </div>
                        <div class="lb-filter-field" id="compDistanceFilterWrap" style="display:none;">
                            <label>Distance</label>
                            <select id="compDistanceFilter" onchange="loadCompetitionBoard()"><option value="">All Distances</option></select>
                        </div>
                        <div class="lb-filter-field" id="compStrokeFilterWrap" style="display:none;">
                            <label>Stroke</label>
                            <select id="compStrokeFilter" onchange="loadCompetitionBoard()"><option value="">All Strokes</option></select>
                        </div>
                        <div class="comp-participant-count" id="compParticipantCount"></div>
                    </div>

                    <!-- Competition Podium -->
                    <div class="lb-podium-wrap" id="compPodiumWrap" style="display:none;">
                        <div class="lb-podium" id="compPodium"></div>
                    </div>

                    <!-- Competition Table -->
                    <div class="card lb-table-card" id="compTableCard" style="display:none;">
                        <div class="card-header">
                            <h3 class="card-title" id="compTableTitle">Competition Rankings</h3>
                            <span class="lb-record-count" id="compRecordCount"></span>
                        </div>
                        <div class="card-body" style="padding:0; overflow-x:auto;">
                            <div id="compTableBody"><div class="lb-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg><h3>Opt in above to see competition rankings</h3><p>Compete against athletes from all teams</p></div></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Team Page (Coach Only) -->
            <section class="page-section" id="page-team">
                <div class="page-header">
                    <h1>Team Overview</h1>
                    <p>Manage team members, approvals, and performance</p>
                </div>

                <div id="teamInfoBar"></div>

                <div id="pendingMembersSection" style="display:none;">
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card-header">
                            <h3 class="card-title">Pending Approvals</h3>
                        </div>
                        <div class="card-body" id="pendingMembers">
                            <div class="loading"><div class="loading-spinner"></div>Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom:20px;">
                    <div class="card-header">
                        <h3 class="card-title">Active Athletes</h3>
                    </div>
                    <div class="card-body" id="teamAthletes">
                        <div class="loading"><div class="loading-spinner"></div>Loading team...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Coaches</h3>
                    </div>
                    <div class="card-body" id="teamCoaches">
                        <div class="loading"><div class="loading-spinner"></div>Loading...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ============================================
        // THEME MANAGEMENT
        // ============================================
        // TOAST NOTIFICATIONS (replaces alert())
        // ============================================
        const TOAST_ICONS = {
            success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
            error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
            info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
            warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
        };

        /**
         * Sanitize text for display: strip URLs (especially GitHub/hosting URLs) and
         * internal identifiers so they never appear in toasts, modals, or error messages.
         */
        function sanitizeForDisplay(text) {
            if (!text || typeof text !== 'string') return text || '';
            // First escape HTML entities to prevent XSS
            let clean = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
            // Remove full URLs (http/https) - replaces with generic label
            clean = clean.replace(/https?:\/\/[^\s"'<>)}\]]+/gi, '[link]');
            // Remove anything that looks like a GitHub pages URL fragment
            clean = clean.replace(/[a-zA-Z0-9_-]+\.github\.io[^\s]*/gi, '[service]');
            // Remove Supabase project references
            clean = clean.replace(/[a-z]{20,}\.supabase\.co/gi, '[service]');
            // Collapse multiple [service] references
            clean = clean.replace(/(\[service\]\s*)+/g, '[service] ');
            return clean.trim();
        }

        function showToast(message, type = 'info', duration = 4000) {
            const safeMessage = sanitizeForDisplay(message);
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon ${type}">${TOAST_ICONS[type] || TOAST_ICONS.info}</div>
                <div class="toast-msg">${safeMessage}</div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>`;
            container.appendChild(toast);
            requestAnimationFrame(() => { requestAnimationFrame(() => { toast.classList.add('show'); }); });
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ============================================
        // STYLED CONFIRM MODAL (replaces confirm())
        // ============================================
        function showConfirm(message, title = 'Confirm', isDanger = false) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirmOverlay');
                const titleEl = document.getElementById('confirmTitle');
                const msgEl = document.getElementById('confirmMsg');
                const okBtn = document.getElementById('confirmOk');
                const cancelBtn = document.getElementById('confirmCancel');

                titleEl.textContent = sanitizeForDisplay(title);
                msgEl.textContent = sanitizeForDisplay(message);
                okBtn.className = isDanger ? 'confirm-btn danger' : 'confirm-btn primary';
                okBtn.textContent = isDanger ? 'Yes, remove' : 'Confirm';
                overlay.classList.add('active');

                function cleanup(result) {
                    overlay.classList.remove('active');
                    okBtn.removeEventListener('click', onOk);
                    cancelBtn.removeEventListener('click', onCancel);
                    overlay.removeEventListener('click', onBackdrop);
                    resolve(result);
                }
                function onOk() { cleanup(true); }
                function onCancel() { cleanup(false); }
                function onBackdrop(e) { if (e.target === overlay) cleanup(false); }

                okBtn.addEventListener('click', onOk);
                cancelBtn.addEventListener('click', onCancel);
                overlay.addEventListener('click', onBackdrop);
            });
        }

        // ============================================
        // MOBILE SIDEBAR
        // ============================================
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const isOpen = sidebar.classList.contains('open');
            if (isOpen) { closeMobileSidebar(); } else { openMobileSidebar(); }
        }
        function openMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.add('open');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden'; // prevent background scroll
        }
        function closeMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar) sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        // ============================================
        // THEME SYSTEM
        // ============================================
        function initTheme() {
            const saved = localStorage.getItem('pa-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeUI(saved);
        }
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('pa-theme', next);
            updateThemeUI(next);
            // Re-render any active canvas charts with new colors
            if (typeof renderAllStartVisuals === 'function') try { renderAllStartVisuals(); } catch(e) {}
            if (typeof renderAllTurnVisuals === 'function') try { renderAllTurnVisuals(); } catch(e) {}
            if (typeof renderAllRaceVisuals === 'function') try { renderAllRaceVisuals(); } catch(e) {}
        }
        function updateThemeUI(theme) {
            const label = document.getElementById('themeLabel');
            const icon = document.getElementById('themeIcon');
            if (label) label.textContent = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
            if (icon) {
                icon.innerHTML = theme === 'dark'
                    ? '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>'
                    : '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            }
        }
        initTheme();

        // Mobile: auto-wrap data-tables in scroll containers
        if (window.innerWidth <= 768) {
            const wrapTablesForMobile = () => {
                document.querySelectorAll('.data-table').forEach(table => {
                    if (table.parentElement && table.parentElement.classList.contains('table-scroll-wrapper')) return;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-scroll-wrapper';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                });
            };
            // Run on DOM changes (tables are dynamically rendered)
            const tableObserver = new MutationObserver(() => { requestAnimationFrame(wrapTablesForMobile); });
            tableObserver.observe(document.body, { childList: true, subtree: true });
        }

        // ============================================
        // THEME-AWARE COLOR HELPERS
        // ============================================
        // ============================================
        // INFO-TIP HELPER - generates tooltip HTML
        // ============================================
        function infoTip(text, pos) {
            const cls = pos === 'left' ? ' tip-left' : pos === 'right' ? ' tip-right' : '';
            return `<span class="info-tip${cls}"><span class="tip-content">${text}</span></span>`;
        }

        // Centralized tooltip content map
        const TIPS = {
            // "" HOME ""
            perfPulse: 'Shows your <strong>recent trend</strong> across key metrics. Arrows compare your last 3 sessions to the previous 3.',
            personalBests: 'Your fastest time in each event. Tap a card to jump to the full race analysis.',

            // "" STARTS ""
            reactionTime: 'Time from the start signal to first movement on the block. <span class="tip-good">Lower is better</span> - elite swimmers react in 0.55-0.70s.',
            flightPhase: 'Time spent in the air from block departure to water entry. A longer flight with good distance is ideal.',
            split15m: 'Total time from signal to the 15m mark - combines reaction, block, flight, and underwater phases.',
            velocity05: 'Average speed in the first 5m off the block. <span class="tip-good">Higher = faster start.</span>',
            flightPath: 'Tracks your <strong>hip trajectory</strong> through the start. The curve shows height and distance traveled through takeoff, flight, and entry. A good start shows a smooth arc peaking around 0.8-1.0m with entry distance of 3-4m.',
            uwSplits: 'Underwater split times per kick phase after entry. Consistent spacing indicates steady dolphin kicks.',
            uwVelocity: 'Speed during the underwater phase. <span class="tip-good">Aim to hold velocity above 1.8 m/s</span> through breakout. A sharp drop means early surfacing or weak kicks.',
            startVelocity: 'Full velocity profile from block to 15m. The chart should show a <strong>high peak at takeoff</strong> (4+ m/s) with a gradual taper. Sudden drops indicate energy loss at entry or transition.',
            blockMetrics: 'Detailed block phase: push time (time pushing off the block), takeoff velocity, and launch angle. <span class="tip-good">Shorter push + higher velocity = explosive start.</span>',

            // "" TURNS ""
            turn15inout: 'Time from 15m before the wall to 15m after. <span class="tip-good">Lower is better</span> - this is the full turn cycle time.',
            rotation: 'Time spent rotating at the wall (from hand contact to feet planting). <span class="tip-good">Faster rotation ~ 0.5-0.7s.</span>',
            pushOff: 'Time spent pushing off the wall. Shorter push-off times with high velocity mean a more powerful turn.',
            kickRate: 'Dolphin kicks per minute during the underwater phase. <span class="tip-good">Higher rates (110-130) with maintained velocity</span> indicate strong underwater work.',
            approachVel: 'Speed in the last 15m before the wall, split into three 5m zones. <span class="tip-watch">Watch for big drop-offs</span> - you want to maintain speed into the wall.',
            wallContact: 'Time phases at the wall: adaptation (prep), rotation (flip), hand contact, and push-off. Quick transition through all four phases is key.',
            turnUWVel: 'Velocity after the wall push-off. <span class="tip-good">Good turns maintain 2.0+ m/s</span> through the underwater before breakout.',
            turnFullVel: 'Complete velocity profile: approach (3 zones) -> wall -> departure (3 zones). Look for <strong>symmetry</strong> - approach speed should be matched or exceeded in departure.',

            // "" RACES ""
            raceTime: 'Official finish time. Compare against your personal best and the event record to gauge performance.',
            blockTime: 'Time from start signal to leaving the block. Combines reaction time and push-off.',
            splitTimes: 'Cumulative time at each wall. Switch to "Per Segment" to see individual lap times and identify pacing patterns.',
            splitBars: 'Visual comparison of each lap. <span class="tip-good">Green = fastest</span>, blue = average, <span class="tip-watch">red = slowest</span>. Even splits indicate good pacing strategy.',
            raceVelocity: 'Average speed per segment. <span class="tip-watch">Watch for negative splits</span> (getting faster) vs positive splits (slowing down). Elite pacing often shows a slight U-shape.',
            strokeRate: 'Strokes per minute in each segment. Increasing stroke rate with decreasing distance-per-stroke can indicate fatigue.',
            strokeCount: 'Total strokes per lap. Fewer strokes with the same split time means better efficiency (distance per stroke).',
            startPhase: 'Breakdown of time spent in each phase of the race start: on-block, flight, dip, and underwater to surface break.',
        };

        // ============================================
        // SAMPLE DATA - demo records for empty teams
        // ============================================
        const SAMPLE_STARTS = [
            {
                trial_uuid: 'sample-start-1', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-15', style: 'freestyle', lap_length: 50,
                reaction_time_s: 0.648, push_time_s: 0.49, flight_phase_s: 0.37,
                split_5m_s: 1.87, split_10m_s: 3.76, split_15m_s: 6.39,
                avg_vel_0_5: 2.67, avg_vel_5_10: 2.65, avg_vel_10_15: 1.90,
                v_takeoff_hor: 4.18, v_takeoff_ver: 1.01, v_takeoff_res: 3.60,
                height_hip_takeoff: 1.28, height_hip_entry: 0.35, distance_to_water_entry: 3.49,
                angle_hip_takeoff_deg: 42.9, angle_hip_entry_deg: 44.4,
                hor_dist_hands_feet_entry: 1.56,
                hor_vel_hip_flight: 3.38, hor_vel_hands_entry: 3.49,
                hor_vel_hip_to_kick1: 2.56, hor_vel_hip_3kicks: 2.09,
                hor_vel_hip_stroke1: 2.21, hor_vel_hip_stroke2: 1.85,
                block_reaction_s: 0.15, block_grab_release_s: 0.08,
                block_pushing_duration_s: 0.34, block_empty_s: 0.55,
                kick_rate: 110, surface_break_s: 5.47,
                _sample: true
            },
            {
                trial_uuid: 'sample-start-2', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-22', style: 'freestyle', lap_length: 50,
                reaction_time_s: 0.612, push_time_s: 0.46, flight_phase_s: 0.35,
                split_5m_s: 1.78, split_10m_s: 3.58, split_15m_s: 6.12,
                avg_vel_0_5: 2.81, avg_vel_5_10: 2.78, avg_vel_10_15: 1.97,
                v_takeoff_hor: 4.35, v_takeoff_ver: 1.08, v_takeoff_res: 3.75,
                height_hip_takeoff: 1.32, height_hip_entry: 0.33, distance_to_water_entry: 3.62,
                angle_hip_takeoff_deg: 41.2, angle_hip_entry_deg: 42.8,
                hor_dist_hands_feet_entry: 1.61,
                hor_vel_hip_flight: 3.52, hor_vel_hands_entry: 3.65,
                hor_vel_hip_to_kick1: 2.71, hor_vel_hip_3kicks: 2.18,
                hor_vel_hip_stroke1: 2.30, hor_vel_hip_stroke2: 1.92,
                block_reaction_s: 0.13, block_grab_release_s: 0.07,
                block_pushing_duration_s: 0.32, block_empty_s: 0.52,
                kick_rate: 116, surface_break_s: 5.20,
                _sample: true
            },
            {
                trial_uuid: 'sample-start-3', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-08', style: 'butterfly', lap_length: 50,
                reaction_time_s: 0.685, push_time_s: 0.51, flight_phase_s: 0.39,
                split_5m_s: 1.94, split_10m_s: 3.92, split_15m_s: 6.65,
                avg_vel_0_5: 2.58, avg_vel_5_10: 2.53, avg_vel_10_15: 1.83,
                v_takeoff_hor: 4.05, v_takeoff_ver: 0.95, v_takeoff_res: 3.48,
                height_hip_takeoff: 1.24, height_hip_entry: 0.38, distance_to_water_entry: 3.35,
                angle_hip_takeoff_deg: 44.1, angle_hip_entry_deg: 46.2,
                hor_dist_hands_feet_entry: 1.49,
                hor_vel_hip_flight: 3.25, hor_vel_hands_entry: 3.30,
                hor_vel_hip_to_kick1: 2.42, hor_vel_hip_3kicks: 1.98,
                hor_vel_hip_stroke1: 2.08, hor_vel_hip_stroke2: 1.78,
                block_reaction_s: 0.16, block_grab_release_s: 0.09,
                block_pushing_duration_s: 0.36, block_empty_s: 0.58,
                kick_rate: 105, surface_break_s: 5.72,
                _sample: true
            }
        ];

        const SAMPLE_TURNS = [
            {
                trial_uuid: 'sample-turn-1', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-20', style: 'freestyle', lap_length: 25,
                time_15in_15out_s: 9.51, time_5in_5out_s: 6.25, time_5in_15out_s: 12.90,
                split_5m_s: 2.86, split_10m_s: 6.24, split_15m_s: 9.51,
                split_15m_pre_s: -9.79, split_10m_pre_s: -6.46, split_5m_pre_s: -3.33,
                adaption_time_s: 0.38, hand_contact_time_s: 0.12,
                rotation_time_s: 0.62, push_off_time_s: 0.45,
                push_off_velocity: 2.35, kick_rate: 118.3,
                surface_break_s: 5.73, stroke_rate_pre_turn: 52.4, stroke_rate_post_turn: 54.8,
                avg_vel_15_10_pre: 1.50, avg_vel_10_5_pre: 1.60, avg_vel_5_0_pre: 1.50,
                avg_vel_0_5: 1.75, avg_vel_5_10: 1.48, avg_vel_10_15: 1.53,
                _sample: true
            },
            {
                trial_uuid: 'sample-turn-2', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-27', style: 'freestyle', lap_length: 25,
                time_15in_15out_s: 9.18, time_5in_5out_s: 5.95, time_5in_15out_s: 12.52,
                split_5m_s: 2.72, split_10m_s: 5.98, split_15m_s: 9.18,
                split_15m_pre_s: -9.42, split_10m_pre_s: -6.26, split_5m_pre_s: -3.23,
                adaption_time_s: 0.34, hand_contact_time_s: 0.10,
                rotation_time_s: 0.56, push_off_time_s: 0.42,
                push_off_velocity: 2.48, kick_rate: 122.6,
                surface_break_s: 5.45, stroke_rate_pre_turn: 54.1, stroke_rate_post_turn: 56.2,
                avg_vel_15_10_pre: 1.58, avg_vel_10_5_pre: 1.65, avg_vel_5_0_pre: 1.55,
                avg_vel_0_5: 1.84, avg_vel_5_10: 1.56, avg_vel_10_15: 1.60,
                _sample: true
            },
            {
                trial_uuid: 'sample-turn-3', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-13', style: 'backstroke', lap_length: 25,
                time_15in_15out_s: 10.02, time_5in_5out_s: 6.60, time_5in_15out_s: 13.45,
                split_5m_s: 3.05, split_10m_s: 6.52, split_15m_s: 10.02,
                split_15m_pre_s: -10.28, split_10m_pre_s: -6.76, split_5m_pre_s: -3.47,
                adaption_time_s: 0.42, hand_contact_time_s: 0.14,
                rotation_time_s: 0.70, push_off_time_s: 0.48,
                push_off_velocity: 2.22, kick_rate: 112.0,
                surface_break_s: 6.10, stroke_rate_pre_turn: 48.5, stroke_rate_post_turn: 50.1,
                avg_vel_15_10_pre: 1.42, avg_vel_10_5_pre: 1.52, avg_vel_5_0_pre: 1.44,
                avg_vel_0_5: 1.64, avg_vel_5_10: 1.44, avg_vel_10_15: 1.43,
                _sample: true
            }
        ];

        const SAMPLE_RACES = [
            {
                trial_uuid: 'sample-race-1', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-10', course: 'SCY',
                metrics_json: {
                    Distance: 100, Style: 'breaststroke', Runtime: '01:02.45',
                    'Leaving block': 0.67, 'Flight phase': 0.37, 'Underwater phase': 4.43,
                    'Surface break': 5.47, 'On-block phase': 0.67, Dip: 1.03,
                    'Split 25 m': 14.12, 'Split 50 m': 30.85, 'Split 75 m': 47.65, 'Split 100 m': 62.45,
                    'Stroke rate 25 m': 55.4, 'Stroke rate 50 m': 51.4, 'Stroke rate 75 m': 52.2, 'Stroke rate 100 m': 51.4,
                    'Stroke count lap 1': 6, 'Stroke count lap 2': 7, 'Stroke count lap 3': 7, 'Stroke count lap 4': 8
                },
                _sample: true
            },
            {
                trial_uuid: 'sample-race-2', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-24', course: 'SCY',
                metrics_json: {
                    Distance: 100, Style: 'breaststroke', Runtime: '01:01.18',
                    'Leaving block': 0.64, 'Flight phase': 0.35, 'Underwater phase': 4.28,
                    'Surface break': 5.27, 'On-block phase': 0.64, Dip: 0.99,
                    'Split 25 m': 13.78, 'Split 50 m': 30.02, 'Split 75 m': 46.35, 'Split 100 m': 61.18,
                    'Stroke rate 25 m': 57.1, 'Stroke rate 50 m': 53.2, 'Stroke rate 75 m': 53.8, 'Stroke rate 100 m': 54.0,
                    'Stroke count lap 1': 6, 'Stroke count lap 2': 7, 'Stroke count lap 3': 7, 'Stroke count lap 4': 7
                },
                _sample: true
            },
            {
                trial_uuid: 'sample-race-3', athlete_uuid: 'sample-athlete',
                source_date: '2026-01-17', course: 'SCY',
                metrics_json: {
                    Distance: 200, Style: 'freestyle', Runtime: '01:48.92',
                    'Leaving block': 0.62, 'Flight phase': 0.34, 'Underwater phase': 4.10,
                    'Surface break': 5.06, 'On-block phase': 0.62, Dip: 0.96,
                    'Split 25 m': 12.35, 'Split 50 m': 25.80, 'Split 75 m': 39.92, 'Split 100 m': 54.10,
                    'Split 125 m': 68.25, 'Split 150 m': 82.48, 'Split 175 m': 96.15, 'Split 200 m': 108.92,
                    'Stroke rate 25 m': 62.4, 'Stroke rate 50 m': 58.8, 'Stroke rate 75 m': 57.2, 'Stroke rate 100 m': 56.5,
                    'Stroke rate 125 m': 55.8, 'Stroke rate 150 m': 55.2, 'Stroke rate 175 m': 56.8, 'Stroke rate 200 m': 58.4,
                    'Stroke count lap 1': 10, 'Stroke count lap 2': 12, 'Stroke count lap 3': 12, 'Stroke count lap 4': 13,
                    'Stroke count lap 5': 13, 'Stroke count lap 6': 13, 'Stroke count lap 7': 14, 'Stroke count lap 8': 14
                },
                _sample: true
            }
        ];

        const SAMPLE_ICON = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>';

        function sampleBannerHTML(module) {
            return `<div class="sample-banner" id="${module}SampleBanner">
                ${SAMPLE_ICON}
                <div class="sample-banner-text">
                    <strong>No ${module} data yet.</strong> Load sample data to explore the dashboard and see how it works with real analysis data.
                </div>
                <button class="btn-sample" onclick="activateSampleData('${module}')">Load Sample Data</button>
            </div>`;
        }

        function sampleActiveBannerHTML(module) {
            return `<div class="sample-banner" id="${module}SampleActiveBanner" style="border-color:rgba(245,166,35,0.5); background:rgba(245,166,35,0.08);">
                ${SAMPLE_ICON}
                <div class="sample-banner-text">
                    <strong>Sample data is active.</strong> This is demo data to showcase the dashboard. Upload your own data to see real results.
                </div>
                <button class="btn-exit-sample" onclick="deactivateSampleData('${module}')">Exit Sample Mode</button>
            </div>`;
        }

        function sampleBadgeHTML() {
            return '<span class="sample-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>SAMPLE</span>';
        }

        function activateSampleData(module) {
            if (module === 'start') {
                startModuleState._sampleMode = true;
                startModuleState.allStarts = [...SAMPLE_STARTS];
                startModuleState.filteredStarts = [...SAMPLE_STARTS];
                startModuleState._multiAthlete = false;
                startModuleState.primaryIdx = 0;
                startModuleState.compareIdx = 1;
                renderStartSelectorCards();
                renderAllStartVisuals();
            } else if (module === 'turn') {
                turnModuleState._sampleMode = true;
                turnModuleState.allTurns = [...SAMPLE_TURNS];
                turnModuleState.filteredTurns = [...SAMPLE_TURNS];
                turnModuleState._multiAthlete = false;
                turnModuleState.primaryIdx = 0;
                turnModuleState.compareIdx = 1;
                renderTurnSelectorCards();
                renderAllTurnVisuals();
            } else if (module === 'race') {
                raceModuleState._sampleMode = true;
                // Pre-hydrate mj so race functions can access it
                const hydrated = SAMPLE_RACES.map(r => ({ ...r, mj: r.metrics_json }));
                raceModuleState.allRaces = hydrated;
                raceModuleState.filteredRaces = hydrated;
                raceModuleState._multiAthlete = false;
                raceModuleState.primaryIdx = 0;
                raceModuleState.compareIdx = 1;
                populateRaceFilters();
                renderRaceSelectorCards();
                renderAllRaceVisuals();
            }
        }

        function deactivateSampleData(module) {
            if (module === 'start') {
                startModuleState._sampleMode = false;
                startModuleState.allStarts = [];
                startModuleState.filteredStarts = [];
                startModuleState.primaryIdx = null;
                startModuleState.compareIdx = null;
                renderStartSelectorCards();
                renderAllStartVisuals();
            } else if (module === 'turn') {
                turnModuleState._sampleMode = false;
                turnModuleState.allTurns = [];
                turnModuleState.filteredTurns = [];
                turnModuleState.primaryIdx = null;
                turnModuleState.compareIdx = null;
                renderTurnSelectorCards();
                renderAllTurnVisuals();
            } else if (module === 'race') {
                raceModuleState._sampleMode = false;
                raceModuleState.allRaces = [];
                raceModuleState.filteredRaces = [];
                raceModuleState.primaryIdx = null;
                raceModuleState.compareIdx = null;
                populateRaceFilters();
                renderRaceSelectorCards();
                renderAllRaceVisuals();
            }
        }

        function getThemeColors() {
            const s = getComputedStyle(document.documentElement);
            return {
                accent: s.getPropertyValue('--accent-blue').trim(),
                purple: s.getPropertyValue('--accent-purple').trim(),
                green: s.getPropertyValue('--accent-green').trim(),
                red: s.getPropertyValue('--accent-red').trim(),
                orange: s.getPropertyValue('--accent-orange').trim(),
                text: s.getPropertyValue('--text-primary').trim(),
                textSec: s.getPropertyValue('--text-secondary').trim(),
                textMuted: s.getPropertyValue('--text-muted').trim(),
                border: s.getPropertyValue('--border-color').trim(),
                bgCard: s.getPropertyValue('--bg-card').trim(),
                freestyle: s.getPropertyValue('--color-freestyle').trim() || '#00C2FF',
                backstroke: s.getPropertyValue('--color-backstroke').trim() || '#A78BFA',
                breaststroke: s.getPropertyValue('--color-breaststroke').trim() || '#06D6A0',
                butterfly: s.getPropertyValue('--color-butterfly').trim() || '#F5A623',
                im: s.getPropertyValue('--color-im').trim() || '#FF6B9D',
            };
        }

        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://wbqgshvbopfukwyqsndq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndicWdzaHZib3BmdWt3eXFzbmRxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMDk4OTAsImV4cCI6MjA4NDU4NTg5MH0.lmbqvVTyfmlkgkUCo8dAGZuK7Z9tGXUA4Fq9FAsmvhU';
        
        // Auth email redirects  always use the Wix-hosted page, not the raw iframe URL
        const AUTH_REDIRECT_URL = 'https://www.mypeakathlete.com/blank-2';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // APP STATE
        // ============================================
        let appState = {
            user: null,
            userProfile: null,
            role: null, // 'athlete' or 'coach'
            athleteUuid: null,
            coachUuid: null, // current coach's coach_uuid
            teamUuid: null,
            isTeamOwner: false, // true if this coach created the team
            selectedAthleteUuid: null, // For coach view
            membershipStatus: null, // 'active', 'pending', 'inactive'
            currentPage: 'home',
            charts: {},
            // Subscription
            subscription: null, // { plan_id, status, is_active, features, days_remaining, etc. }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        /**
         * Safe Supabase .in() filter.
         * When the values array is too large (>15 items), the URL exceeds
         * Supabase's max length and returns HTTP 400.
         * Solution: skip the .in() filter, fetch all rows, then filter client-side.
         *
         * Returns { query, clientFilter } where:
         *   - query: the (possibly modified) Supabase query
         *   - clientFilter: a function to apply after fetching (identity if .in() was used)
         */
        const SUPABASE_IN_LIMIT = 15;

        function safeInFilter(query, column, values) {
            if (!values || values.length <= SUPABASE_IN_LIMIT) {
                return {
                    query: values && values.length ? query.in(column, values) : query,
                    clientFilter: rows => rows
                };
            }
            // Too many values - skip .in(), filter after fetch
            const allowed = new Set(values);
            return {
                query: query,
                clientFilter: rows => rows.filter(r => allowed.has(r[column]))
            };
        }

        function formatTime(seconds) {
            if (seconds === null || seconds === undefined || seconds === '') return '--';
            const val = parseFloat(seconds);
            if (isNaN(val)) return '--';
            if (val >= 60) {
                const mins = Math.floor(val / 60);
                const secs = val - (mins * 60);
                return mins + ':' + secs.toFixed(2).padStart(5, '0');
            }
            return val.toFixed(2);
        }

        function formatVelocity(mps) {
            if (mps === null || mps === undefined) return '--';
            return parseFloat(mps).toFixed(2) + ' m/s';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '--';
            return new Date(dateStr).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        function getInitials(firstName, lastName) {
            const f = firstName ? firstName[0] : '';
            const l = lastName ? lastName[0] : '';
            return (f + l).toUpperCase() || '??';
        }

        // ============================================
        // CONNECTION TEST
        // ============================================
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                // Simple test query
                const { data, error } = await supabaseClient.from('teams').select('team_uuid').limit(1);
                
                if (error) throw error;
                
                statusEl.className = 'connection-status connected';
                statusEl.innerHTML = '<span class="status-dot"></span><span>Connected to Supabase</span>';
                return true;
            } catch (e) {
                statusEl.className = 'connection-status disconnected';
                statusEl.innerHTML = '<span class="status-dot"></span><span>Connection failed</span>';
                console.error('Connection error:', e);
                return false;
            }
        }

        // ============================================
        // AUTH - TOGGLE LOGIN / SIGNUP
        // ============================================
        // AUTH - TOGGLE LOGIN / SIGNUP
        // ============================================
        function toggleAuthMode(mode) {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const forgotForm = document.getElementById('forgotForm');
            const errorEl = document.getElementById('loginError');
            const successEl = document.getElementById('signupSuccess');

            errorEl.classList.remove('show');
            successEl.classList.remove('show');

            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            forgotForm.style.display = 'none';

            if (mode === 'signup') signupForm.style.display = 'block';
            else if (mode === 'forgot') forgotForm.style.display = 'block';
            else loginForm.style.display = 'block';
        }

        // ============================================
        // AUTH - FORGOT PASSWORD
        // ============================================
        document.getElementById('forgotForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const btn = document.getElementById('forgotBtn');
            const email = document.getElementById('forgotEmail').value.trim();
            const errorEl = document.getElementById('loginError');
            const successEl = document.getElementById('signupSuccess');
            errorEl.classList.remove('show');
            successEl.classList.remove('show');

            if (!email) { errorEl.textContent = 'Please enter your email address.'; errorEl.classList.add('show'); return; }

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: AUTH_REDIRECT_URL
                });
                if (error) throw error;
                successEl.textContent = 'Password reset link sent! Check your email inbox (and spam folder).';
                successEl.classList.add('show');
                successEl.style.display = 'block';
            } catch (err) {
                errorEl.textContent = sanitizeForDisplay(err.message) || 'Failed to send reset link. Please try again.';
                errorEl.classList.add('show');
                errorEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Reset Link';
            }
        });

        // Handle password reset callback (v02.04 - uses onAuthStateChange instead of hash parsing)
        // Supabase v2 fires PASSWORD_RECOVERY event when user clicks the email reset link.
        // This works regardless of how the dashboard is hosted or embedded.
        let _passwordRecoverySession = null;

        supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'PASSWORD_RECOVERY') {
                // Store the recovery session so updateUser can authenticate
                _passwordRecoverySession = session;
                // Show the styled password reset modal
                document.getElementById('passwordResetModal').classList.add('active');
                // Hide login screen elements to avoid confusion
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('forgotForm').style.display = 'none';
                // Clear any previous state in the modal fields
                document.getElementById('resetNewPassword').value = '';
                document.getElementById('resetConfirmPassword').value = '';
                document.getElementById('resetPasswordError').style.display = 'none';
                document.getElementById('resetPasswordSuccess').style.display = 'none';
                document.getElementById('resetPasswordSubmitBtn').disabled = false;
                document.getElementById('resetPasswordSubmitBtn').textContent = 'Update Password';
                document.getElementById('resetPasswordSubmitBtn').style.display = '';
                // Clean up the URL hash so it doesn't re-trigger on refresh
                if (window.location.hash) {
                    history.replaceState(null, '', window.location.pathname + window.location.search);
                }
            }
        });

        async function submitPasswordReset() {
            const newPass = document.getElementById('resetNewPassword').value;
            const confirmPass = document.getElementById('resetConfirmPassword').value;
            const errorEl = document.getElementById('resetPasswordError');
            const successEl = document.getElementById('resetPasswordSuccess');
            const btn = document.getElementById('resetPasswordSubmitBtn');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            // Validation
            if (!newPass || newPass.length < 6) {
                errorEl.textContent = 'Password must be at least 6 characters.';
                errorEl.style.display = 'block';
                return;
            }
            if (newPass !== confirmPass) {
                errorEl.textContent = 'Passwords do not match.';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Updating...';

            try {
                const { error } = await supabaseClient.auth.updateUser({ password: newPass });
                if (error) throw error;

                successEl.textContent = 'Password updated successfully! Redirecting to sign in...';
                successEl.style.display = 'block';
                btn.style.display = 'none';

                // Sign out the recovery session and redirect to login after a short delay
                setTimeout(async () => {
                    await supabaseClient.auth.signOut();
                    _passwordRecoverySession = null;
                    document.getElementById('passwordResetModal').classList.remove('active');
                    toggleAuthMode('login');
                    // Show success message on login form
                    const loginSuccess = document.getElementById('signupSuccess');
                    loginSuccess.textContent = 'Password updated! Sign in with your new password.';
                    loginSuccess.classList.add('show');
                    loginSuccess.style.display = 'block';
                }, 2000);

            } catch (err) {
                errorEl.textContent = sanitizeForDisplay(err.message) || 'Failed to update password. The reset link may have expired. Please request a new one.';
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Update Password';
            }
        }

        // Close reset modal on overlay click
        document.getElementById('passwordResetModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'passwordResetModal') {
                document.getElementById('passwordResetModal').classList.remove('active');
                toggleAuthMode('login');
            }
        });

        // ============================================
        // AUTH - SIGNUP (simple: name, email, password, role)
        // Team join/create happens inside the dashboard after login
        // ============================================
        async function handleSignup(e) {
            e.preventDefault();
            const signupBtn = document.getElementById('signupBtn');
            const errorEl = document.getElementById('loginError');
            const successEl = document.getElementById('signupSuccess');

            const firstName = document.getElementById('signupFirstName').value;
            const lastName = document.getElementById('signupLastName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
            const role = document.getElementById('signupRole').value;
            const gender = document.getElementById('signupGender').value || null;

            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';
            errorEl.classList.remove('show');
            successEl.classList.remove('show');

            try {
                if (!firstName.trim() || !lastName.trim()) {
                    throw new Error('First and last name are required');
                }
                if (password !== passwordConfirm) {
                    throw new Error('Passwords do not match');
                }
                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters');
                }

                // Create auth user
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            first_name: firstName.trim(),
                            last_name: lastName.trim(),
                            role: role,
                            gender: gender
                        },
                        emailRedirectTo: AUTH_REDIRECT_URL
                    }
                });

                if (authError) throw authError;
                const userId = authData.user?.id;
                if (!userId) {
                    throw new Error('Account created but no user ID returned. Please try signing in.');
                }

                // Profile row is created by a database trigger (handle_new_user)
                // This works regardless of email confirmation setting
                // The trigger reads role, first_name, last_name from auth.users.raw_user_meta_data

                const needsConfirmation = !authData.session;
                if (needsConfirmation) {
                    successEl.textContent = 'Account created! Check your email to confirm, then sign in.';
                } else {
                    successEl.textContent = 'Account created! You can now sign in. Join or create a team from the dashboard.';
                }
                successEl.classList.add('show');
                toggleAuthMode('login');
                document.getElementById('email').value = email;

            } catch (e) {
                errorEl.textContent = sanitizeForDisplay(e.message) || 'Failed to create account';
                errorEl.classList.add('show');
                console.error('Signup error:', e);
            } finally {
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        }


        // ============================================
        // AUTHENTICATION
        // ============================================
        async function handleLogin(email, password) {
            const loginBtn = document.getElementById('loginBtn');
            const errorEl = document.getElementById('loginError');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorEl.classList.remove('show');

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                appState.user = data.user;
                await loadUserProfile();
                showDashboard();

            } catch (e) {
                errorEl.textContent = sanitizeForDisplay(e.message) || 'Failed to sign in';
                errorEl.classList.add('show');
                console.error('Login error:', e);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            appState = {
                user: null,
                userProfile: null,
                role: null,
                athleteUuid: null,
                coachUuid: null,
                teamUuid: null,
                isTeamOwner: false,
                selectedAthleteUuid: null,
                membershipStatus: null,
                currentPage: 'home',
                charts: {}
            };
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
        }

        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                appState.user = session.user;
                await loadUserProfile();
                showDashboard();
            }
        }

        // ============================================
        // USER PROFILE & ROLE DETECTION
        // ============================================
        async function loadUserProfile() {
            if (!appState.user) return;

            // Check if user is an athlete
            const { data: athleteData, error: athleteError } = await supabaseClient
                .from('v_my_athlete')
                .select('*')
                .maybeSingle();

            if (athleteData) {
                appState.role = 'athlete';
                appState.userProfile = athleteData;
                appState.athleteUuid = athleteData.athlete_uuid;
                appState.teamUuid = athleteData.team_uuid;
                appState.selectedAthleteUuid = athleteData.athlete_uuid;
                appState.membershipStatus = athleteData.membership_status || 'active';
                return;
            }

            // Check if user is a coach
            const { data: coachData, error: coachError } = await supabaseClient
                .from('v_my_coach')
                .select('*')
                .maybeSingle();

            if (coachData) {
                appState.role = 'coach';
                appState.userProfile = coachData;
                appState.coachUuid = coachData.coach_uuid;
                appState.teamUuid = coachData.team_uuid;
                appState.membershipStatus = coachData.membership_status || 'active';

                // Check if this coach is the team owner (created_by_uuid on teams table)
                appState.isTeamOwner = false;
                if (appState.teamUuid && appState.membershipStatus === 'active') {
                    try {
                        const { data: teamInfo } = await supabaseClient
                            .from('teams')
                            .select('created_by_uuid')
                            .eq('team_uuid', appState.teamUuid)
                            .maybeSingle();
                        if (teamInfo && teamInfo.created_by_uuid === appState.user.id) {
                            appState.isTeamOwner = true;
                        } else if (!teamInfo?.created_by_uuid) {
                            // Fallback: if no created_by_uuid column exists, check if this is the
                            // earliest active coach on the team (first coach = team admin)
                            const { data: earliestCoach } = await supabaseClient
                                .from('coaches')
                                .select('coach_uuid')
                                .eq('team_uuid', appState.teamUuid)
                                .eq('membership_status', 'active')
                                .order('created_at', { ascending: true })
                                .limit(1)
                                .maybeSingle();
                            if (earliestCoach && earliestCoach.coach_uuid === appState.coachUuid) {
                                appState.isTeamOwner = true;
                            }
                        }
                    } catch (ownerCheckErr) {
                        console.warn('[loadUserProfile] Could not determine team ownership:', ownerCheckErr);
                    }
                }
                console.log('[loadUserProfile] Coach detected. teamUuid:', appState.teamUuid, 'membershipStatus:', appState.membershipStatus, 'isTeamOwner:', appState.isTeamOwner);
                return;
            }

            console.warn('User not found in athletes or coaches table');
            // New signup - check auth metadata for role hint
            const meta = appState.user.user_metadata || {};
            if (meta.role === 'coach') {
                appState.role = 'coach';
                appState.userProfile = { coach_name: (meta.first_name || '') + ' ' + (meta.last_name || '') };
            } else {
                appState.role = 'athlete';
                appState.userProfile = { first_name: meta.first_name || 'New', last_name: meta.last_name || 'User' };
            }
        }

        // ============================================
        // SUBSCRIPTION MANAGEMENT
        // ============================================
        
        const STRIPE_PAYMENT_LINK = 'https://buy.stripe.com/eVq5kC6iVb9Fg4Z2p4gjC01';
        
        async function loadSubscription() {
            try {
                const { data, error } = await supabaseClient
                    .from('v_my_subscription')
                    .select('*')
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading subscription:', error);
                }
                
                appState.subscription = data || { plan_id: 'free', is_active: false, features: [] };
                updateSubscriptionUI();
            } catch (e) {
                console.error('Subscription load error:', e);
                appState.subscription = { plan_id: 'free', is_active: false, features: [] };
                updateSubscriptionUI();
            }
        }
        
        function updateSubscriptionUI() {
            const sub = appState.subscription;
            const badge = document.getElementById('subscriptionBadge');
            const btn = document.getElementById('subscriptionBtn');
            const btnText = document.getElementById('subscriptionBtnText');
            
            if (!sub || sub.plan_id === 'free' || !sub.is_active) {
                // Free user - show upgrade button
                badge.style.display = 'none';
                btn.style.background = 'linear-gradient(135deg, var(--accent-green), #00B86B)';
                btnText.textContent = 'Upgrade';
            } else if (sub.status === 'trialing') {
                // Trial user
                badge.textContent = 'Trial';
                badge.style.display = 'inline-block';
                badge.style.background = 'linear-gradient(135deg, var(--accent-orange), #F5A623)';
                btn.style.background = 'var(--card-bg)';
                const trialEndDate = sub.trial_end ? new Date(sub.trial_end) : null;
                const daysRemaining = trialEndDate ? Math.max(0, Math.ceil((trialEndDate - new Date()) / (1000 * 60 * 60 * 24))) : 0;
                btnText.textContent = daysRemaining + 'd left';
            } else {
                // Paid user
                badge.textContent = 'Pro';
                badge.style.display = 'inline-block';
                badge.style.background = 'linear-gradient(135deg, var(--accent-green), #00B86B)';
                btn.style.background = 'var(--card-bg)';
                btnText.textContent = 'Manage';
            }
        }
        
        function hasFeature(featureName) {
            const sub = appState.subscription;
            if (!sub || !sub.features) return false;
            return sub.features.includes(featureName);
        }
        
        function openSubscriptionModal() {
            const sub = appState.subscription;
            const modal = document.getElementById('subscriptionModal');
            const title = document.getElementById('subscriptionModalTitle');
            const body = document.getElementById('subscriptionModalBody');
            
            if (!sub || sub.plan_id === 'free' || !sub.is_active) {
                // Show upgrade options
                title.textContent = 'Upgrade to Pro';
                body.innerHTML = `
                    <div style="text-align:center; padding:20px 0;">
                        <div style="width:64px; height:64px; background:linear-gradient(135deg,var(--accent-green),#00B86B); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </div>
                        <h3 style="font-size:20px; font-weight:600; margin-bottom:8px;">Unlock Full Access</h3>
                        <p style="color:var(--text-muted); margin-bottom:24px;">Get unlimited history, exports, goals, and more.</p>
                        
                        <div style="background:var(--bg-primary); border-radius:12px; padding:20px; text-align:left; margin-bottom:24px;">
                            <div style="display:flex; align-items:baseline; gap:4px; margin-bottom:16px;">
                                <span style="font-size:32px; font-weight:700;">$14.99</span>
                                <span style="color:var(--text-muted);">/month</span>
                            </div>
                            <ul style="list-style:none; padding:0; margin:0; display:grid; gap:10px;">
                                <li style="display:flex; align-items:center; gap:8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Unlimited session history
                                </li>
                                <li style="display:flex; align-items:center; gap:8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Full analysis & comparisons
                                </li>
                                <li style="display:flex; align-items:center; gap:8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Export to CSV & PDF
                                </li>
                                <li style="display:flex; align-items:center; gap:8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Goal tracking
                                </li>
                                <li style="display:flex; align-items:center; gap:8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Video links & notes
                                </li>
                                <li style="display:flex; align-items:center; gap:8px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                    Team management (coaches)
                                </li>
                            </ul>
                        </div>
                        
                        <button onclick="startCheckout()" class="btn btn-primary" style="width:100%; padding:14px; font-size:15px; font-weight:600; background:linear-gradient(135deg,var(--accent-green),#00B86B);">
                            Start 14-Day Free Trial
                        </button>
                        <p style="color:var(--text-muted); font-size:12px; margin-top:12px;">Cancel anytime. No charge during trial.</p>
                    </div>
                `;
            } else if (sub.status === 'trialing') {
                // Show trial status
                title.textContent = 'Your Trial';
                const trialEndDate = sub.trial_end ? new Date(sub.trial_end) : null;
                const daysRemaining = trialEndDate ? Math.max(0, Math.ceil((trialEndDate - new Date()) / (1000 * 60 * 60 * 24))) : 0;
                const trialEndFormatted = trialEndDate ? trialEndDate.toLocaleDateString() : 'N/A';
                
                body.innerHTML = `
                    <div style="text-align:center; padding:20px 0;">
                        <div style="width:64px; height:64px; background:linear-gradient(135deg,var(--accent-orange),#F5A623); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        </div>
                        <h3 style="font-size:20px; font-weight:600; margin-bottom:8px;">Trial Active</h3>
                        <p style="color:var(--text-muted); margin-bottom:8px;">You have full Pro access!</p>
                        <p style="font-size:24px; font-weight:700; color:var(--accent-orange); margin-bottom:24px;">${daysRemaining} days remaining</p>
                        
                        <p style="color:var(--text-muted); font-size:13px; margin-bottom:16px;">Your trial will convert to a paid subscription on ${trialEndFormatted}.</p>
                        
                        <button onclick="openBillingPortal()" class="btn" style="width:100%; padding:12px; background:var(--card-bg); border:1px solid var(--border-color); margin-bottom:8px;">
                            Manage Billing
                        </button>
                        <button onclick="cancelSubscription()" class="btn" style="width:100%; padding:12px; background:transparent; border:1px solid rgba(255,100,100,0.3); color:#ff6b6b;">
                            Cancel Trial
                        </button>
                    </div>
                `;
            } else {
                // Show active subscription
                title.textContent = 'Your Subscription';
                body.innerHTML = `
                    <div style="text-align:center; padding:20px 0;">
                        <div style="width:64px; height:64px; background:linear-gradient(135deg,var(--accent-green),#00B86B); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </div>
                        <h3 style="font-size:20px; font-weight:600; margin-bottom:8px;">Pro Plan</h3>
                        <p style="color:var(--accent-green); font-weight:500; margin-bottom:24px;">Active</p>
                        
                        <div style="background:var(--bg-primary); border-radius:12px; padding:16px; text-align:left; margin-bottom:24px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span style="color:var(--text-muted);">Plan</span>
                                <span style="font-weight:500;">${sub.plan_name || 'Pro'}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                                <span style="color:var(--text-muted);">Status</span>
                                <span style="color:var(--accent-green); font-weight:500;">${sub.status}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between;">
                                <span style="color:var(--text-muted);">Renews</span>
                                <span>${sub.current_period_end ? new Date(sub.current_period_end).toLocaleDateString() : 'N/A'}</span>
                            </div>
                            ${sub.cancel_at_period_end ? '<div style="margin-top:12px; padding:8px; background:rgba(255,100,100,0.1); border-radius:8px; color:#ff6b6b; font-size:13px;">Cancels at end of billing period</div>' : ''}
                        </div>
                        
                        <button onclick="openBillingPortal()" class="btn" style="width:100%; padding:12px; background:var(--card-bg); border:1px solid var(--border-color); margin-bottom:8px;">
                            Manage Billing
                        </button>
                        ${!sub.cancel_at_period_end ? '<button onclick="cancelSubscription()" class="btn" style="width:100%; padding:12px; background:transparent; border:1px solid rgba(255,100,100,0.3); color:#ff6b6b;">Cancel Subscription</button>' : ''}
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }
        
        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').classList.remove('active');
        }
        
        let subscriptionPollingInterval = null;
        
        async function startCheckout() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Opening...';
            
            try {
                // Get user email to prefill in Stripe
                const email = appState.user?.email || '';
                
                // Build payment link with prefilled email and client_reference_id for webhook
                let paymentUrl = STRIPE_PAYMENT_LINK;
                const params = new URLSearchParams();
                if (email) {
                    params.set('prefilled_email', email);
                }
                // Add user_id as client_reference_id so webhook can link the subscription
                if (appState.user?.id) {
                    params.set('client_reference_id', appState.user.id);
                }
                if (params.toString()) {
                    paymentUrl += '?' + params.toString();
                }
                
                // Create a clickable link that opens outside the iframe
                closeSubscriptionModal();
                
                // Show modal with direct link and polling status
                const linkModal = document.createElement('div');
                linkModal.id = 'checkoutLinkModal';
                linkModal.innerHTML = `
                    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:10000;">
                        <div style="background:var(--card-bg, #1a1a2e);padding:32px;border-radius:16px;max-width:420px;text-align:center;margin:20px;">
                            <div style="width:64px;height:64px;background:linear-gradient(135deg,#00C896,#00B86B);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                            </div>
                            <h3 style="margin-bottom:12px;font-size:20px;color:var(--text-primary, #fff);">Start Your Free Trial</h3>
                            <p style="margin-bottom:24px;color:var(--text-muted, #888);font-size:14px;">Click below to open secure Stripe checkout.</p>
                            <a href="${paymentUrl}" target="_blank" rel="noopener noreferrer" onclick="startSubscriptionPolling()" style="display:inline-block;padding:14px 32px;background:linear-gradient(135deg,#00C896,#00B86B);color:#fff;border-radius:8px;text-decoration:none;font-weight:600;font-size:15px;">
                                Continue to Checkout
                            </a>
                            <div id="pollingStatus" style="margin-top:20px;display:none;">
                                <div style="display:flex;align-items:center;justify-content:center;gap:8px;color:var(--text-muted, #888);font-size:13px;">
                                    <svg class="spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                                    <span>Waiting for payment confirmation...</span>
                                </div>
                            </div>
                            <p style="margin-top:16px;font-size:12px;color:var(--text-muted, #666);">14-day free trial  Cancel anytime</p>
                            <button onclick="stopSubscriptionPolling(); document.getElementById('checkoutLinkModal').remove()" style="margin-top:16px;padding:8px 20px;background:transparent;border:1px solid var(--border-color, #333);border-radius:8px;cursor:pointer;color:var(--text-muted, #888);font-size:13px;">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(linkModal);
                
                // Add spinning animation
                const style = document.createElement('style');
                style.textContent = '@keyframes spin { to { transform: rotate(360deg); } } .spin { animation: spin 1s linear infinite; }';
                document.head.appendChild(style);
                
                btn.disabled = false;
                btn.textContent = 'Start 14-Day Free Trial';
            } catch (e) {
                console.error('Checkout error:', e);
                showToast('Error: ' + e.message, 'error');
                btn.disabled = false;
                btn.textContent = 'Start 14-Day Free Trial';
            }
        }
        
        function startSubscriptionPolling() {
            // Show polling status
            const pollingStatus = document.getElementById('pollingStatus');
            if (pollingStatus) pollingStatus.style.display = 'block';
            
            // Stop any existing polling
            stopSubscriptionPolling();
            
            let attempts = 0;
            const maxAttempts = 60; // Poll for 5 minutes max (every 5 seconds)
            
            subscriptionPollingInterval = setInterval(async () => {
                attempts++;
                
                try {
                    // Check if subscription has been upgraded
                    const { data, error } = await supabaseClient
                        .from('subscriptions')
                        .select('plan_id, status')
                        .eq('user_id', appState.user.id)
                        .single();
                    
                    if (data && data.plan_id === 'pro') {
                        // Success! Subscription upgraded
                        stopSubscriptionPolling();
                        
                        // Remove modal
                        const modal = document.getElementById('checkoutLinkModal');
                        if (modal) modal.remove();
                        
                        // Show success message
                        showToast('Welcome to Pro! Your trial has started.', 'success');
                        
                        // Reload subscription data
                        await loadSubscription();
                        
                        // Update UI
                        updateUpgradeButton();
                        
                        return;
                    }
                } catch (e) {
                    console.error('Polling error:', e);
                }
                
                // Stop after max attempts
                if (attempts >= maxAttempts) {
                    stopSubscriptionPolling();
                    const pollingStatus = document.getElementById('pollingStatus');
                    if (pollingStatus) {
                        pollingStatus.innerHTML = `
                            <p style="color:var(--text-muted, #888);font-size:13px;">
                                Still waiting? <a href="#" onclick="location.reload()" style="color:var(--accent-green);">Refresh page</a>
                            </p>
                        `;
                    }
                }
            }, 5000); // Check every 5 seconds
        }
        
        function stopSubscriptionPolling() {
            if (subscriptionPollingInterval) {
                clearInterval(subscriptionPollingInterval);
                subscriptionPollingInterval = null;
            }
        }
        
        async function openBillingPortal() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                const response = await fetch('https://wbqgshvbopfukwyqsndq.supabase.co/functions/v1/create-portal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + session.access_token
                    },
                    body: JSON.stringify({
                        returnUrl: 'https://www.mypeakathlete.com/blank-3'
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                if (data.url) {
                    // Open in new tab because Wix embeds in iframe
                    window.open(data.url, '_blank');
                    showToast('Billing portal opened in new tab.', 'info');
                }
            } catch (e) {
                console.error('Portal error:', e);
                showToast('Error opening billing portal: ' + e.message, 'error');
            }
        }
        
        async function cancelSubscription() {
            const confirmed = await showConfirm(
                'Are you sure you want to cancel? You will lose access to Pro features at the end of your billing period.',
                'Cancel Subscription',
                true
            );
            
            if (!confirmed) return;
            
            try {
                // Open billing portal for cancellation (Stripe handles it securely)
                await openBillingPortal();
            } catch (e) {
                console.error('Cancel error:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }
        
        // Check for checkout success/cancel on page load
        function checkCheckoutStatus() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('checkout') === 'success') {
                showToast('Welcome to Pro! Your subscription is now active.', 'success');
                // Remove query param
                window.history.replaceState({}, '', window.location.pathname);
                // Reload subscription
                setTimeout(loadSubscription, 1000);
            } else if (params.get('checkout') === 'canceled') {
                showToast('Checkout canceled', 'info');
                window.history.replaceState({}, '', window.location.pathname);
            }
        }

        // ============================================
        // DASHBOARD INITIALIZATION
        // ============================================
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');

            updateUserUI();
            setupNavigation();
            loadHomeData();
            loadSubscription(); // Load subscription status
        }

        function updateUserUI() {
            const profile = appState.userProfile;
            const role = appState.role;

            // Update user info in sidebar
            const name = role === 'coach' 
                ? profile?.coach_name || 'Coach'
                : `${profile?.first_name || ''} ${profile?.last_name || ''}`.trim() || 'Athlete';
            
            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').textContent = role === 'coach'
                ? name[0]?.toUpperCase() || 'C'
                : getInitials(profile?.first_name, profile?.last_name);

            const roleEl = document.getElementById('userRole');
            roleEl.textContent = role === 'coach' ? 'Coach' : 'Athlete';
            roleEl.className = `role-badge ${role}`;

            // Show/hide coach-specific elements
            if (role === 'coach') {
                document.getElementById('coachSection').style.display = 'block';
                document.getElementById('athleteSelector').style.display = 'flex';
                loadTeamAthletes();
            }

            // Show leaderboard section if user has a team
            const lbSec = document.getElementById('leaderboardSection');
            if (lbSec) lbSec.style.display = appState.teamUuid ? 'block' : 'none';
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function setupNavigation() {
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    navigateTo(page);
                });
            });

            // Quick action links on home page
            document.querySelectorAll('.quick-action[data-nav]').forEach(item => {
                item.addEventListener('click', () => {
                    navigateTo(item.dataset.nav);
                });
            });
        }

        function navigateTo(page) {
            // Close mobile sidebar if open
            closeMobileSidebar();

            // Track current page
            appState.currentPage = page;

            // Update nav active state
            document.querySelectorAll('.nav-item[data-page]').forEach(item => {
                item.classList.toggle('active', item.dataset.page === page);
            });

            // Show correct page
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.toggle('active', section.id === `page-${page}`);
            });

            // Load page data
            loadPageData(page);
        }

        function loadPageData(page) {
            switch(page) {
                case 'home':
                    loadHomeData();
                    break;
                case 'starts':
                    loadStartData();
                    break;
                case 'turns':
                    loadTurnData();
                    break;
                case 'races':
                    loadRaceData();
                    break;
                case 'team':
                    loadTeamData();
                    break;
                case 'leaderboards':
                    loadLeaderboardData();
                    break;
            }
        }

        function reloadActivePage() {
            const page = appState.currentPage || 'home';
            loadPageData(page);
        }

        // ============================================
        // DATA LOADING - HOME PAGE
        // ============================================
        async function loadHomeData() {
            updateWelcomeHero();
            updatePendingBanner();

            const isCoachTeamView = appState.role === 'coach' && !appState.selectedAthleteUuid && appState.teamUuid;
            console.log('[loadHomeData] role:', appState.role, 'selectedAthlete:', appState.selectedAthleteUuid, 'teamUuid:', appState.teamUuid, '-> isCoachTeamView:', isCoachTeamView);

            // Toggle visibility
            const coachDash = document.getElementById('coachDashboard');
            const athSections = document.getElementById('athleteHomeSections');
            if (coachDash) coachDash.style.display = isCoachTeamView ? 'block' : 'none';
            if (athSections) athSections.style.display = isCoachTeamView ? 'none' : 'block';

            if (isCoachTeamView) {
                // Coach team-level dashboard
                console.log('[loadHomeData] Loading coach team dashboard...');
                _allTeamAthletes = null; // clear cache on fresh load
                await loadGroupsDropdown();
                initHomeCarousels(false); // Initialize coach carousel controls
                await Promise.all([
                    loadTeamPulse(),
                    loadRecordsCarousel(),
                    loadCompetitionCarousel(),
                    loadTeamGoals(),
                    loadTeamRoster(),
                    loadTeamActivity(),
                    checkPendingApprovals()
                ]);
            } else {
                // Individual athlete view (athlete role, or coach with athlete selected)
                initHomeCarousels(true); // Initialize athlete carousel controls
                await Promise.all([
                    loadAlerts(),
                    loadLastSession(),
                    loadPerformancePulse(),
                    loadGoals(),
                    loadAthleteRecordsCarousel(),
                    loadAthleteCompCarousel(),
                    loadRecentSessions(),
                    checkPendingApprovals(),
                    loadCompBadges()
                ]);
            }
        }

        function updatePendingBanner() {
            const banner = document.getElementById('pendingBanner');
            if (appState.membershipStatus === 'pending') {
                banner.style.display = 'block';
                banner.innerHTML = `
                    <div class="pending-banner">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div class="pending-banner-text" style="flex:1;">
                            <h4>Membership Pending</h4>
                            <p>Your request to join the team is waiting for coach approval. You can still view your personal data.</p>
                        </div>
                        <button class="btn" style="padding:8px 16px; font-size:12px; background:rgba(255,100,100,0.15); color:#ff6b6b; border:1px solid rgba(255,100,100,0.3);" onclick="leaveTeam()">
                            Cancel Request
                        </button>
                    </div>
                `;
            } else if (!appState.teamUuid) {
                banner.style.display = 'block';
                const isCoach = appState.role === 'coach';
                banner.innerHTML = `
                    <div class="pending-banner" style="border-color: rgba(0,194,255,0.25); background: rgba(0,194,255,0.06);">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--accent-blue);">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <div class="pending-banner-text" style="flex:1;">
                            <h4 style="color:var(--accent-blue);">No Team Assigned</h4>
                            <p>Join an existing team with a team code${isCoach ? ' or create a new one' : ''}. Your coach or admin can provide the code.</p>
                        </div>
                        <div style="display:flex; gap:8px; flex-shrink:0;">
                            <button class="btn btn-primary" style="padding:8px 20px; font-size:13px; white-space:nowrap;" onclick="openTeamModal('join')">
                                Join Team
                            </button>
                            ${isCoach ? '<button class="btn btn-primary" style="padding:8px 20px; font-size:13px; white-space:nowrap; background:linear-gradient(135deg,var(--accent-green),#00B86B);" onclick="openTeamModal(\'create\')">Create Team</button>' : ''}
                        </div>
                    </div>
                `;
            } else {
                banner.style.display = 'none';
            }
        }

        function updateWelcomeHero() {
            const hour = new Date().getHours();
            let greeting = 'Good evening';
            if (hour < 12) greeting = 'Good morning';
            else if (hour < 17) greeting = 'Good afternoon';

            const name = appState.role === 'coach'
                ? (appState.userProfile?.coach_name || 'Coach').split(' ')[0]
                : appState.userProfile?.first_name || 'Athlete';

            document.getElementById('welcomeMessage').textContent = `${greeting}, ${name}`;
            const datePart = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            const ctxPart = appState.role === 'coach'
                ? (appState.selectedAthleteUuid ? 'Individual athlete view' : 'Team performance overview')
                : 'Performance snapshot';
            document.getElementById('greetingTime').textContent = `${datePart}  |  ${ctxPart}`;
            const badge = document.getElementById('userRoleBadge');
            if (badge) badge.textContent = appState.role === 'coach' ? 'COACH' : 'ATHLETE';
        }

        async function loadAlerts() {
            const container = document.getElementById('alertsSection');
            const alerts = [];

            try {
                const athleteUuid = appState.role === 'athlete' ? appState.athleteUuid : appState.selectedAthleteUuid;
                if (!athleteUuid) { container.innerHTML = ''; return; }

                // Check for recent race data
                const { data: recentRaces } = await supabaseClient
                    .from('v_race_kpis')
                    .select('race_time_s, style, distance_m, source_date, course')
                    .eq('athlete_uuid', athleteUuid)
                    .order('source_date', { ascending: false })
                    .limit(5);

                if (recentRaces?.length) {
                    const latest = recentRaces[0];
                    const lc = (latest.course || 'SCY').toUpperCase();
                    const lu = lc === 'SCY' ? 'Yds' : 'm';
                    const daysAgo = Math.floor((Date.now() - new Date(latest.source_date)) / 86400000);
                    alerts.push({
                        type: 'info',
                        title: `${recentRaces.length} recent race${recentRaces.length > 1 ? 's' : ''} on file`,
                        message: `Latest: ${latest.distance_m} ${lu} ${latest.style || ''} (${lc}) - ${formatTime(latest.race_time_s)}`,
                        time: daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo}d ago`
                    });
                }

                // Check for goals nearing completion
                const { data: goals } = await supabaseClient
                    .from('goals')
                    .select('*')
                    .eq('athlete_uuid', athleteUuid)
                    .eq('status', 'active');

                if (goals?.length) {
                    goals.forEach(g => {
                        if (g.current_best && g.target_value) {
                            const pct = Math.min(100, Math.max(0, ((g.current_best - g.target_value) / (g.current_best - g.target_value + 0.001)) * 100));
                            if (pct > 80) {
                                alerts.push({
                                    type: 'success',
                                    title: 'Goal almost reached!',
                                    message: `${g.event_name || g.goal_type}: ${formatTime(g.current_best)} / ${formatTime(g.target_value)}`,
                                    time: 'Active'
                                });
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Error loading alerts:', e);
            }

            if (!alerts.length) { container.innerHTML = ''; return; }

            const iconSvg = {
                success: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>',
                warning: '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>',
                info: '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>'
            };

            // Filter out recently dismissed alerts
            const visibleAlerts = alerts.filter((a, idx) => !isAlertDismissed('alert-' + a.title.replace(/\s+/g, '_')));

            if (!visibleAlerts.length) { container.innerHTML = ''; return; }

            container.innerHTML = visibleAlerts.map((a, idx) => {
                const alertId = 'alert-' + a.title.replace(/\s+/g, '_');
                return `
                <div class="alert-item ${a.type}" id="${alertId}">
                    <div class="alert-icon ${a.type}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${iconSvg[a.type]}</svg>
                    </div>
                    <div class="alert-content">
                        <h4>${a.title}</h4>
                        <p>${a.message}</p>
                    </div>
                    <span class="alert-time">${a.time}</span>
                    <button class="alert-dismiss" onclick="dismissAlert('${alertId}')" title="Dismiss">&#x2715;</button>
                </div>
            `}).join('');
        }

        function dismissAlert(alertId) {
            const el = document.getElementById(alertId);
            if (el) {
                el.style.transition = 'opacity 0.2s, transform 0.2s';
                el.style.opacity = '0';
                el.style.transform = 'translateX(20px)';
                setTimeout(() => el.remove(), 200);

                // Store dismiss timestamp - suppress for 8 hours
                try {
                    const dismissed = JSON.parse(localStorage.getItem('pa_dismissed_alerts') || '{}');
                    dismissed[alertId] = Date.now();
                    localStorage.setItem('pa_dismissed_alerts', JSON.stringify(dismissed));
                } catch (e) { /* storage unavailable */ }
            }
        }

        function isAlertDismissed(alertId) {
            try {
                const dismissed = JSON.parse(localStorage.getItem('pa_dismissed_alerts') || '{}');
                const ts = dismissed[alertId];
                if (!ts) return false;
                const eightHours = 8 * 60 * 60 * 1000;
                if (Date.now() - ts > eightHours) {
                    // Expired - remove from storage
                    delete dismissed[alertId];
                    localStorage.setItem('pa_dismissed_alerts', JSON.stringify(dismissed));
                    return false;
                }
                return true;
            } catch (e) { return false; }
        }

        async function checkPendingApprovals() {
            // Only ACTIVE coaches with a team should see pending counts
            if (appState.role !== 'coach' || !appState.teamUuid || appState.membershipStatus !== 'active') return;

            const badge = document.getElementById('pendingBadge');
            const banner = document.getElementById('pendingBanner');
            
            try {
                // Count pending athletes
                const { data: pendingAthletes, error: e1 } = await supabaseClient
                    .from('athletes')
                    .select('athlete_uuid', { count: 'exact', head: false })
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'pending');

                // Count pending coaches (we will filter out self below)
                const { data: pendingCoaches, error: e2 } = await supabaseClient
                    .from('coaches')
                    .select('coach_uuid, auth_user_id', { count: 'exact', head: false })
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'pending');

                // Filter out current user from pending coaches count
                const myAuthId = appState.user?.id;
                const filteredPendingCoaches = (pendingCoaches || []).filter(c => c.auth_user_id !== myAuthId);

                const totalPending = (pendingAthletes?.length || 0) + filteredPendingCoaches.length;

                // Update nav badge
                if (badge) {
                    if (totalPending > 0) {
                        badge.textContent = totalPending;
                        badge.style.display = 'inline-flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }

                // Show approval alert on Home page (above other alerts)
                if (totalPending > 0 && banner) {
                    const existingApprovalAlert = document.getElementById('approvalAlert');
                    if (existingApprovalAlert) existingApprovalAlert.remove();

                    const alertHtml = `
                        <div class="approval-alert" id="approvalAlert" onclick="navigateTo('team')">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            <div class="approval-alert-text">
                                <h4>${totalPending} Pending Approval${totalPending > 1 ? 's' : ''}</h4>
                                <p>${totalPending} member${totalPending > 1 ? 's are' : ' is'} waiting for your approval to join the team. Click to review.</p>
                            </div>
                        </div>
                    `;
                    banner.insertAdjacentHTML('afterend', alertHtml);
                }
            } catch (e) {
                console.error('Error checking pending approvals:', e);
            }
        }

        async function loadPersonalBests() {
            const container = document.getElementById('pbGrid');
            try {
                const athleteUuid = appState.role === 'athlete' ? appState.athleteUuid : appState.selectedAthleteUuid;
                if (!athleteUuid) {
                    container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>Select an athlete to see personal bests</p></div>';
                    return;
                }

                const { data: races, error } = await supabaseClient
                    .from('v_race_kpis')
                    .select('race_time_s, style, distance_m, source_date, course')
                    .eq('athlete_uuid', athleteUuid)
                    .not('race_time_s', 'is', null)
                    .order('source_date', { ascending: false });

                if (error) throw error;

                if (!races?.length) {
                    container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>No race data yet. Complete some races to see personal bests!</p></div>';
                    return;
                }

                // Group by event+course, find PB per event
                const eventMap = {};
                races.forEach(r => {
                    const c = (r.course || 'SCY').toUpperCase();
                    const unit = c === 'SCY' ? 'Yds' : 'm';
                    const label = `${r.distance_m} ${unit} ${r.style || 'Unknown'}`;
                    const key = `${r.distance_m}|${r.style || 'Unknown'}|${c}`;
                    if (!eventMap[key]) eventMap[key] = { label, course: c, entries: [] };
                    eventMap[key].entries.push({ time: r.race_time_s, date: r.source_date });
                });

                const pbs = Object.entries(eventMap).map(([key, obj]) => {
                    const times = obj.entries;
                    times.sort((a, b) => new Date(b.date) - new Date(a.date)); // newest first
                    const best = times.reduce((min, t) => t.time < min.time ? t : min, times[0]);

                    // Trend: compare avg of 2 most recent vs older
                    let trend = 'stable';
                    if (times.length >= 3) {
                        const recentAvg = (times[0].time + times[1].time) / 2;
                        const olderTimes = times.slice(2);
                        const olderAvg = olderTimes.reduce((s, t) => s + t.time, 0) / olderTimes.length;
                        if (recentAvg < olderAvg - 0.1) trend = 'improving';
                        else if (recentAvg > olderAvg + 0.1) trend = 'declining';
                    }

                    return { event: obj.label, course: obj.course, best: best.time, date: best.date, count: times.length, trend };
                });

                // Sort by number of races (most raced first)
                pbs.sort((a, b) => b.count - a.count);

                const trendLabels = { improving: 'Improving', declining: 'Slower', stable: 'Stable' };
                const trendIcons = { improving: '&#x25B2;', declining: '&#x25BC;', stable: '&#x25CF;' };

                container.innerHTML = pbs.slice(0, 8).map(pb => `
                    <div class="pb-card">
                        <div class="event-name">${pb.event} <span class="rc-course-tag">${pb.course}</span></div>
                        <div class="pb-time">${formatTime(pb.best)}</div>
                        <div class="pb-date">${new Date(pb.date).toLocaleDateString()} | ${pb.count} race${pb.count > 1 ? 's' : ''}</div>
                        <div class="trend-indicator ${pb.trend}">${trendIcons[pb.trend]} ${trendLabels[pb.trend]}</div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Error loading PBs:', e);
                container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>Error loading personal bests</p></div>';
            }
        }

        // ============================================
        // GOALS CRUD
        // ============================================
        async function loadGoals() {
            const container = document.getElementById('goalsGrid');
            try {
                const athleteUuid = appState.role === 'athlete' ? appState.athleteUuid : appState.selectedAthleteUuid;
                if (!athleteUuid) {
                    container.innerHTML = '<div class="add-goal-card" onclick="openGoalModal()"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg><span>Add your first goal</span></div>';
                    return;
                }

                const { data: goals, error } = await supabaseClient
                    .from('goals')
                    .select('*')
                    .eq('athlete_uuid', athleteUuid)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = '';
                if (goals?.length) {
                    html = goals.map(g => {
                        let progressPct = 0;
                        if (g.current_best && g.target_value && g.current_best > g.target_value) {
                            // For time-based goals: lower is better
                            // Progress = how much of the gap has been closed
                            const startVal = g.current_best * 1.05; // assume 5% above PB was starting point
                            progressPct = Math.min(100, Math.max(0, ((startVal - g.current_best) / (startVal - g.target_value)) * 100));
                        } else if (g.current_best && g.target_value && g.current_best <= g.target_value) {
                            progressPct = 100;
                        }

                        const roleLabel = g.created_by_role === 'coach' ? 'coach-set' : 'athlete-set';
                        const roleText = g.created_by_role === 'coach' ? 'Coach Goal' : 'My Goal';

                        return `
                            <div class="goal-card" data-goal-id="${g.goal_uuid}">
                                <div class="goal-card-header">
                                    <span class="goal-type-badge ${roleLabel}">${roleText}</span>
                                    <span style="font-size:11px;color:var(--text-muted)">${g.goal_type.replace('_', ' ')}</span>
                                </div>
                                <div class="goal-event-name">${g.event_name || g.goal_type.replace('_', ' ')}</div>
                                <div class="goal-values">
                                    <div class="goal-val">
                                        <label>Target</label>
                                        <span class="target">${formatTime(g.target_value)}</span>
                                    </div>
                                    <div class="goal-val">
                                        <label>Current Best</label>
                                        <span class="current">${g.current_best ? formatTime(g.current_best) : '--'}</span>
                                    </div>
                                </div>
                                <div class="goal-progress">
                                    <div class="goal-progress-bar" style="width: ${progressPct}%"></div>
                                </div>
                                <div class="goal-progress-text">${progressPct.toFixed(0)}% progress</div>
                                ${g.notes ? `<div class="goal-notes">${g.notes}</div>` : ''}
                                <div class="goal-actions">
                                    <button class="goal-btn achieved" onclick="markGoalAchieved('${g.goal_uuid}')">Mark Achieved</button>
                                    <button class="goal-btn delete" onclick="deleteGoal('${g.goal_uuid}')">Remove</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Always add the "Add goal" card at the end
                html += `
                    <div class="add-goal-card" onclick="openGoalModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        <span>Add new goal</span>
                    </div>
                `;

                container.innerHTML = html;

            } catch (e) {
                console.error('Error loading goals:', e);
                // If goals table doesn't exist yet, show add card
                container.innerHTML = `
                    <div class="add-goal-card" onclick="openGoalModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        <span>Add your first goal</span>
                    </div>
                `;
            }
        }

        async function openGoalModal() {
            document.getElementById('goalModal').classList.add('active');

            // Load event options from existing races
            const athleteUuid = appState.role === 'athlete' ? appState.athleteUuid : appState.selectedAthleteUuid;
            if (athleteUuid) {
                try {
                    const { data: races } = await supabaseClient
                        .from('v_race_kpis')
                        .select('style, distance_m, course')
                        .eq('athlete_uuid', athleteUuid);

                    const evSet = new Set();
                    const events = [];
                    (races||[]).forEach(r => {
                        const c = (r.course || 'SCY').toUpperCase();
                        const u = c === 'SCY' ? 'Yds' : 'm';
                        const val = `${r.distance_m} ${r.style}`;
                        const label = `${r.distance_m} ${u} ${r.style} (${c})`;
                        if (val && !evSet.has(val+'|'+c)) { evSet.add(val+'|'+c); events.push({ val, label }); }
                    });
                    const select = document.getElementById('goalEventSelect');
                    select.innerHTML = '<option value="">Select event...</option>' +
                        events.map(e => `<option value="${e.val}">${e.label}</option>`).join('');
                } catch (e) {
                    console.error('Error loading events for goal modal:', e);
                }
            }

            // Show/hide event group based on goal type
            document.getElementById('goalTypeSelect').addEventListener('change', function() {
                document.getElementById('goalEventGroup').style.display =
                    this.value === 'race_time' ? 'block' : 'none';
            });
        }

        function closeGoalModal() {
            document.getElementById('goalModal').classList.remove('active');
            // Reset form
            document.getElementById('goalTypeSelect').value = 'race_time';
            document.getElementById('goalEventSelect').value = '';
            document.getElementById('goalTargetInput').value = '';
            document.getElementById('goalNotesInput').value = '';
            document.getElementById('goalEventGroup').style.display = 'block';
        }

        async function saveGoal() {
            const goalType = document.getElementById('goalTypeSelect').value;
            const eventName = goalType === 'race_time' ? document.getElementById('goalEventSelect').value : goalType.replace('_', ' ');
            const targetValue = parseFloat(document.getElementById('goalTargetInput').value);
            const notes = document.getElementById('goalNotesInput').value.trim();

            if (!targetValue || isNaN(targetValue)) {
                showToast('Please enter a valid target value', 'warning');
                return;
            }

            const athleteUuid = appState.role === 'athlete' ? appState.athleteUuid : appState.selectedAthleteUuid;
            if (!athleteUuid) {
                showToast('No athlete selected', 'warning');
                return;
            }

            // Get current best for this event type
            let currentBest = null;
            try {
                if (goalType === 'race_time' && eventName) {
                    const parts = eventName.split(' ');
                    const dist = parseInt(parts[0]);
                    const style = parts.slice(1).join(' ');
                    const { data } = await supabaseClient
                        .from('v_race_kpis')
                        .select('race_time_s')
                        .eq('athlete_uuid', athleteUuid)
                        .eq('distance_m', dist)
                        .eq('style', style)
                        .not('race_time_s', 'is', null)
                        .order('race_time_s', { ascending: true })
                        .limit(1);
                    if (data?.[0]) currentBest = data[0].race_time_s;
                } else if (goalType === 'start_reaction') {
                    const { data } = await supabaseClient
                        .from('v_start_kpis')
                        .select('reaction_time_s')
                        .eq('athlete_uuid', athleteUuid)
                        .not('reaction_time_s', 'is', null)
                        .order('reaction_time_s', { ascending: true })
                        .limit(1);
                    if (data?.[0]) currentBest = data[0].reaction_time_s;
                } else if (goalType === 'start_15m') {
                    const { data } = await supabaseClient
                        .from('v_start_kpis')
                        .select('split_15m_s')
                        .eq('athlete_uuid', athleteUuid)
                        .not('split_15m_s', 'is', null)
                        .order('split_15m_s', { ascending: true })
                        .limit(1);
                    if (data?.[0]) currentBest = data[0].split_15m_s;
                } else if (goalType === 'turn_time') {
                    const { data } = await supabaseClient
                        .from('v_turn_kpis')
                        .select('split_15m_s')
                        .eq('athlete_uuid', athleteUuid)
                        .not('split_15m_s', 'is', null)
                        .order('split_15m_s', { ascending: true })
                        .limit(1);
                    if (data?.[0]) currentBest = data[0].split_15m_s;
                }
            } catch (e) {
                console.error('Error fetching current best:', e);
            }

            // Save goal
            try {
                const { error } = await supabaseClient
                    .from('goals')
                    .insert({
                        athlete_uuid: athleteUuid,
                        created_by_uuid: appState.user.id,
                        created_by_role: appState.role,
                        goal_type: goalType,
                        event_name: eventName || null,
                        target_value: targetValue,
                        current_best: currentBest,
                        notes: notes || null
                    });

                if (error) throw error;

                closeGoalModal();
                await loadGoals();
                await loadAlerts();
            } catch (e) {
                console.error('Error saving goal:', e);
                showToast('Error saving goal: ' + e.message, 'error');
            }
        }

        async function markGoalAchieved(goalUuid) {
            if (!(await showConfirm('Mark this goal as achieved?', 'Confirm'))) return;
            try {
                const { error } = await supabaseClient
                    .from('goals')
                    .update({ status: 'achieved', achieved_at: new Date().toISOString() })
                    .eq('goal_uuid', goalUuid);

                if (error) throw error;
                await loadGoals();
            } catch (e) {
                console.error('Error updating goal:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function deleteGoal(goalUuid) {
            if (!(await showConfirm('Remove this goal?', 'Remove Goal', true))) return;
            try {
                const { error } = await supabaseClient
                    .from('goals')
                    .delete()
                    .eq('goal_uuid', goalUuid);

                if (error) throw error;
                await loadGoals();
            } catch (e) {
                console.error('Error deleting goal:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function loadPerformancePulse() {
            const container = document.getElementById('pulseGrid');
            
            try {
                const athleteUuid = appState.role === 'athlete'
                    ? appState.athleteUuid
                    : appState.selectedAthleteUuid;

                if (!athleteUuid) {
                    container.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><p>Select an athlete to view performance data</p></div>';
                    return;
                }

                // Fetch all data in parallel
                const [startRes, turnRes, raceRes] = await Promise.all([
                    supabaseClient.from('v_start_kpis')
                        .select('reaction_time_s, split_15m_s, source_date')
                        .eq('athlete_uuid', athleteUuid)
                        .order('source_date', { ascending: true }),
                    supabaseClient.from('v_turn_kpis')
                        .select('split_15m_s, source_date')
                        .eq('athlete_uuid', athleteUuid)
                        .order('source_date', { ascending: true }),
                    supabaseClient.from('v_race_kpis')
                        .select('race_time_s, style, distance_m, source_date, course')
                        .eq('athlete_uuid', athleteUuid)
                        .not('race_time_s', 'is', null)
                        .order('source_date', { ascending: true })
                ]);

                const starts = startRes.data || [];
                const turns = turnRes.data || [];
                const races = raceRes.data || [];

                // Helper: compute trend from array of values (lower is better for times)
                function computeTrend(values) {
                    if (values.length < 2) return { trend: 'new-data', pct: 0, label: 'New' };
                    const recent = values.slice(-Math.min(3, Math.ceil(values.length / 2)));
                    const older = values.slice(0, -recent.length);
                    if (!older.length) return { trend: 'new-data', pct: 0, label: 'New' };
                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
                    const pct = ((olderAvg - recentAvg) / olderAvg * 100);
                    if (Math.abs(pct) < 0.5) return { trend: 'stable', pct: 0, label: 'Stable' };
                    if (pct > 0) return { trend: 'improving', pct: pct.toFixed(1), label: '-' + pct.toFixed(1) + '%' };
                    return { trend: 'declining', pct: Math.abs(pct).toFixed(1), label: '+' + Math.abs(pct).toFixed(1) + '%' };
                }

                // Helper: build sparkline bars
                function buildSparkline(values, color) {
                    if (values.length < 2) return '';
                    const last8 = values.slice(-8);
                    const min = Math.min(...last8);
                    const max = Math.max(...last8);
                    const range = max - min || 1;
                    // For times: invert so lower = taller bar
                    return '<div class="pulse-sparkline">' + 
                        last8.map((v, i) => {
                            const h = Math.max(4, ((max - v) / range) * 28 + 4);
                            return '<div class="spark-bar" style="height:' + h + 'px;background:' + color + ';" title="' + v.toFixed(2) + 's"></div>';
                        }).join('') + '</div>';
                }

                // Card 1: Reaction Time
                const reactions = starts.filter(d => d.reaction_time_s).map(d => parseFloat(d.reaction_time_s));
                const reactionTrend = computeTrend(reactions);
                const bestReaction = reactions.length ? Math.min(...reactions) : null;
                const latestReaction = reactions.length ? reactions[reactions.length - 1] : null;

                // Card 2: Start to 15m
                const start15s = starts.filter(d => d.split_15m_s).map(d => parseFloat(d.split_15m_s));
                const start15Trend = computeTrend(start15s);
                const bestStart15 = start15s.length ? Math.min(...start15s) : null;

                // Card 3: Turn to 15m
                const turn15s = turns.filter(d => d.split_15m_s).map(d => parseFloat(d.split_15m_s));
                const turnTrend = computeTrend(turn15s);
                const bestTurn15 = turn15s.length ? Math.min(...turn15s) : null;

                // Card 4: Best Race - pick the most-raced event
                let raceCard = { value: '--', sub: 'No race data', trend: { trend: 'new-data', label: 'New' }, sparkline: '', eventLabel: 'Race Time' };
                if (races.length) {
                    const eventMap = {};
                    races.forEach(r => {
                        const key = r.distance_m + ' ' + (r.style || '');
                        if (!eventMap[key]) eventMap[key] = [];
                        eventMap[key].push(parseFloat(r.race_time_s));
                    });
                    const topEvent = Object.entries(eventMap).sort((a, b) => b[1].length - a[1].length)[0];
                    const topTimes = topEvent[1];
                    raceCard = {
                        value: formatTime(Math.min(...topTimes)),
                        sub: 'Best ' + topEvent[0],
                        trend: computeTrend(topTimes),
                        sparkline: buildSparkline(topTimes, 'var(--accent-green)'),
                        eventLabel: topEvent[0]
                    };
                }

                const trendIcon = (t) => {
                    if (t === 'improving') return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="18 15 12 9 6 15"></polyline></svg>';
                    if (t === 'declining') return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="6 9 12 15 18 9"></polyline></svg>';
                    if (t === 'new-data') return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"></circle></svg>';
                    return '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="5" y1="12" x2="19" y2="12"></line></svg>';
                };

                container.innerHTML = `
                    <div class="pulse-card">
                        <div class="pulse-accent" style="background:var(--accent-orange);"></div>
                        <div class="pulse-label">Reaction Time</div>
                        <div class="pulse-row">
                            <div class="pulse-value">${latestReaction ? latestReaction.toFixed(3) + 's' : '--'}</div>
                            <span class="pulse-trend ${reactionTrend.trend}">${trendIcon(reactionTrend.trend)} ${reactionTrend.label}</span>
                        </div>
                        <div class="pulse-sub">Best: ${bestReaction ? bestReaction.toFixed(3) + 's' : '--'} | ${reactions.length} trial${reactions.length !== 1 ? 's' : ''}</div>
                        ${buildSparkline(reactions, 'var(--accent-orange)')}
                    </div>

                    <div class="pulse-card">
                        <div class="pulse-accent" style="background:var(--accent-blue);"></div>
                        <div class="pulse-label">Start to 15m</div>
                        <div class="pulse-row">
                            <div class="pulse-value">${start15s.length ? start15s[start15s.length - 1].toFixed(2) + 's' : '--'}</div>
                            <span class="pulse-trend ${start15Trend.trend}">${trendIcon(start15Trend.trend)} ${start15Trend.label}</span>
                        </div>
                        <div class="pulse-sub">Best: ${bestStart15 ? bestStart15.toFixed(2) + 's' : '--'} | ${start15s.length} trial${start15s.length !== 1 ? 's' : ''}</div>
                        ${buildSparkline(start15s, 'var(--accent-blue)')}
                    </div>

                    <div class="pulse-card">
                        <div class="pulse-accent" style="background:var(--accent-cyan);"></div>
                        <div class="pulse-label">Turn to 15m</div>
                        <div class="pulse-row">
                            <div class="pulse-value">${turn15s.length ? turn15s[turn15s.length - 1].toFixed(2) + 's' : '--'}</div>
                            <span class="pulse-trend ${turnTrend.trend}">${trendIcon(turnTrend.trend)} ${turnTrend.label}</span>
                        </div>
                        <div class="pulse-sub">Best: ${bestTurn15 ? bestTurn15.toFixed(2) + 's' : '--'} | ${turn15s.length} trial${turn15s.length !== 1 ? 's' : ''}</div>
                        ${buildSparkline(turn15s, 'var(--accent-cyan)')}
                    </div>

                    <div class="pulse-card">
                        <div class="pulse-accent" style="background:var(--accent-green);"></div>
                        <div class="pulse-label">${raceCard.eventLabel}</div>
                        <div class="pulse-row">
                            <div class="pulse-value">${raceCard.value}</div>
                            <span class="pulse-trend ${raceCard.trend.trend}">${trendIcon(raceCard.trend.trend)} ${raceCard.trend.label}</span>
                        </div>
                        <div class="pulse-sub">${raceCard.sub} | ${races.length} race${races.length !== 1 ? 's' : ''}</div>
                        ${raceCard.sparkline}
                    </div>
                `;
            } catch (e) {
                console.error('Error loading performance pulse:', e);
                container.innerHTML = '<div class="empty-state"><h3>Error loading metrics</h3><p>' + sanitizeForDisplay(e.message) + '</p></div>';
            }
        }

        // ================================================================
        // COACH DASHBOARD FUNCTIONS
        // ================================================================

        // Helper: get all active team athletes with their UUIDs and names
        function toggleCoachSection(bodyId, chevronId) {
            const body = document.getElementById(bodyId);
            const chevron = document.getElementById(chevronId);
            if (!body) return;
            body.classList.toggle('collapsed');
            if (chevron) chevron.classList.toggle('collapsed');
        }

        function dismissAttentionCard(btn, flagKey) {
            const card = btn.closest('.attention-card');
            if (!card) return;
            // Store dismiss timestamp in localStorage (8 hour expiry)
            try {
                const dismissals = JSON.parse(localStorage.getItem('rsl_attention_dismissed') || '{}');
                dismissals[flagKey] = Date.now();
                localStorage.setItem('rsl_attention_dismissed', JSON.stringify(dismissals));
            } catch(e) {}
            card.style.transition = 'opacity 0.25s, transform 0.25s';
            card.style.opacity = '0';
            card.style.transform = 'scale(0.95)';
            setTimeout(() => {
                card.remove();
                // Update count and check if grid is empty
                const grid = document.getElementById('attentionGrid');
                const remaining = grid ? grid.querySelectorAll('.attention-card').length : 0;
                const countEl = document.getElementById('attentionCount');
                if (countEl) countEl.textContent = remaining > 0 ? `(${remaining})` : '';
                if (remaining === 0 && grid) {
                    grid.innerHTML = '<div style="padding:12px 0; color:var(--text-muted); font-size:13px; display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>All clear - no flags right now</div>';
                }
            }, 250);
        }

        function getActiveDismissals() {
            try {
                const raw = JSON.parse(localStorage.getItem('rsl_attention_dismissed') || '{}');
                const eightHours = 8 * 60 * 60 * 1000;
                const now = Date.now();
                const active = {};
                let cleaned = false;
                Object.entries(raw).forEach(([k, ts]) => {
                    if (now - ts < eightHours) {
                        active[k] = ts;
                    } else {
                        cleaned = true;
                    }
                });
                if (cleaned) localStorage.setItem('rsl_attention_dismissed', JSON.stringify(active));
                return active;
            } catch(e) { return {}; }
        }

        // "" COACH FILTER STATE ""
        let coachFilters = { group: '', gender: '' };
        let _allTeamAthletes = null;
        let _teamGroups = null;

        async function getTeamAthleteList(forceRefresh) {
            if (!appState.teamUuid) { console.warn('[getTeamAthleteList] No teamUuid!'); return []; }
            if (!_allTeamAthletes || forceRefresh) {
                const { data, error } = await supabaseClient
                    .from('athletes')
                    .select('athlete_uuid, first_name, last_name, athlete_code, gender')
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'active');
                if (error) console.error('[getTeamAthleteList] Error:', error);
                _allTeamAthletes = data || [];
            }
            let list = [..._allTeamAthletes];

            // Gender filter
            if (coachFilters.gender) {
                list = list.filter(a => a.gender === coachFilters.gender);
            }

            // Group filter
            if (coachFilters.group && coachFilters._groupMembers) {
                list = list.filter(a => coachFilters._groupMembers.has(a.athlete_uuid));
            }

            console.log('[getTeamAthleteList] Returning', list.length, 'of', _allTeamAthletes.length, '(group:', coachFilters.group||'all', 'gender:', coachFilters.gender||'all', ')');
            return list;
        }

        async function loadGroupsDropdown() {
            if (!appState.teamUuid) return;
            const { data } = await supabaseClient
                .from('athlete_groups')
                .select('group_uuid, group_name, group_color')
                .eq('team_uuid', appState.teamUuid)
                .order('group_name');
            _teamGroups = data || [];
            const sel = document.getElementById('filterGroup');
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">All Groups</option>' +
                _teamGroups.map(g => `<option value="${g.group_uuid}" ${g.group_uuid===current?'selected':''}>${g.group_name}</option>`).join('');
        }

        async function applyCoachFilters() {
            coachFilters.group = document.getElementById('filterGroup')?.value || '';
            coachFilters.gender = document.getElementById('filterGender')?.value || '';

            // Pre-fetch group members if group selected
            if (coachFilters.group) {
                const { data } = await supabaseClient
                    .from('athlete_group_members')
                    .select('athlete_uuid')
                    .eq('group_uuid', coachFilters.group);
                coachFilters._groupMembers = new Set((data||[]).map(m => m.athlete_uuid));
            } else {
                coachFilters._groupMembers = null;
            }

            const athletes = await getTeamAthleteList();
            const total = _allTeamAthletes?.length || 0;
            const countEl = document.getElementById('filterCount');
            if (countEl) {
                if (coachFilters.group || coachFilters.gender) {
                    const genderSet = (_allTeamAthletes||[]).filter(a => a.gender).length;
                    let hint = `Showing ${athletes.length} of ${total}`;
                    if (coachFilters.gender && genderSet < total) {
                        hint += ` (${total - genderSet} without gender set - update in Roster)`;
                    }
                    countEl.textContent = hint;
                } else {
                    countEl.textContent = '';
                }
            }
            await Promise.all([
                loadTeamPulse(),
                loadEventRecords(),
                loadTeamGoals(),
                loadTeamRoster(),
                loadAttentionFlags(),
            ]);
        }

        // "" GROUPS MODAL ""
        async function openGroupsModal() {
            document.getElementById('groupsModal').classList.add('active');
            document.getElementById('groupEditPanel').style.display = 'none';
            await renderGroupsList();
        }

        function closeGroupsModal() {
            document.getElementById('groupsModal').classList.remove('active');
            loadGroupsDropdown();
        }

        async function renderGroupsList() {
            const container = document.getElementById('groupsList');
            if (!appState.teamUuid) return;

            const { data: groups } = await supabaseClient
                .from('athlete_groups')
                .select('group_uuid, group_name, group_color')
                .eq('team_uuid', appState.teamUuid)
                .order('group_name');

            if (!groups?.length) {
                container.innerHTML = '<p style="color:var(--text-muted);font-size:13px;padding:8px 0;">No groups yet. Create one above to organize your athletes.</p>';
                return;
            }
            const groupUuids = groups.map(g => g.group_uuid);
            const { data: allMembers } = await supabaseClient
                .from('athlete_group_members').select('group_uuid, athlete_uuid').in('group_uuid', groupUuids);
            const countMap = {};
            (allMembers||[]).forEach(m => { countMap[m.group_uuid] = (countMap[m.group_uuid]||0) + 1; });

            container.innerHTML = groups.map(g => `
                <div class="group-list-item">
                    <div class="group-color-dot" style="background:${g.group_color||getThemeColors().accent}"></div>
                    <div class="group-name-text">${g.group_name}</div>
                    <div class="group-member-count">${countMap[g.group_uuid]||0} athletes</div>
                    <div class="group-actions-btns">
                        <button title="Edit members" onclick="editGroupMembers('${g.group_uuid}',\`${g.group_name}\`,'${g.group_color||getThemeColors().accent}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="16" y1="11" x2="22" y2="11"/></svg>
                        </button>
                        <button title="Delete group" onclick="deleteGroup('${g.group_uuid}')">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function createGroup() {
            const nameEl = document.getElementById('newGroupName');
            const colorEl = document.getElementById('newGroupColor');
            const name = nameEl.value.trim();
            if (!name) { showToast('Please enter a group name', 'warning'); return; }
            try {
                const { error } = await supabaseClient.from('athlete_groups').insert({
                    team_uuid: appState.teamUuid, group_name: name,
                    group_color: colorEl.value||getThemeColors().accent, created_by_uuid: appState.user.id
                });
                if (error) throw error;
                nameEl.value = '';
                await renderGroupsList();
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        async function deleteGroup(groupUuid) {
            if (!(await showConfirm('Delete this group? Athletes stay on the team.', 'Delete Group', true))) return;
            try {
                const { error } = await supabaseClient.from('athlete_groups').delete().eq('group_uuid', groupUuid);
                if (error) throw error;
                document.getElementById('groupEditPanel').style.display = 'none';
                await renderGroupsList();
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        async function editGroupMembers(groupUuid, groupName, groupColor) {
            const panel = document.getElementById('groupEditPanel');
            panel.style.display = 'block';
            // Always use the FULL unfiltered team list, not the filtered one
            if (!_allTeamAthletes) {
                const { data } = await supabaseClient
                    .from('athletes')
                    .select('athlete_uuid, first_name, last_name, athlete_code, gender')
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'active');
                _allTeamAthletes = data || [];
            }
            const allAthletes = _allTeamAthletes;
            const { data: members } = await supabaseClient
                .from('athlete_group_members').select('athlete_uuid').eq('group_uuid', groupUuid);
            const memberSet = new Set((members||[]).map(m => m.athlete_uuid));
            const inGroup = allAthletes.filter(a => memberSet.has(a.athlete_uuid));
            const notInGroup = allAthletes.filter(a => !memberSet.has(a.athlete_uuid));

            panel.innerHTML = `
                <div class="group-edit-section">
                    <div class="group-edit-title"><div class="group-color-dot" style="background:${groupColor}"></div>${groupName} - Members (${inGroup.length})</div>
                    <div class="group-member-chips">
                        ${inGroup.length ? inGroup.map(a => `
                            <span class="group-chip member">${a.first_name} ${a.last_name.charAt(0)}.<span class="chip-remove" onclick="removeFromGroup('${groupUuid}','${a.athlete_uuid}',\`${groupName}\`,'${groupColor}')">&times;</span></span>
                        `).join('') : '<span style="font-size:11px;color:var(--text-muted);">No members</span>'}
                    </div>
                    <div class="group-edit-title" style="margin-top:8px;">Add Athletes</div>
                    <div class="group-member-chips">
                        ${notInGroup.length ? notInGroup.map(a => `
                            <span class="group-chip available" onclick="addToGroup('${groupUuid}','${a.athlete_uuid}',\`${groupName}\`,'${groupColor}')">+ ${a.first_name} ${a.last_name.charAt(0)}.</span>
                        `).join('') : '<span style="font-size:11px;color:var(--text-muted);">All athletes assigned</span>'}
                    </div>
                </div>`;
        }

        async function addToGroup(groupUuid, athleteUuid, groupName, groupColor) {
            try {
                const { error } = await supabaseClient.from('athlete_group_members').insert({ group_uuid: groupUuid, athlete_uuid: athleteUuid });
                if (error) throw error;
                await editGroupMembers(groupUuid, groupName, groupColor);
                await renderGroupsList();
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        async function removeFromGroup(groupUuid, athleteUuid, groupName, groupColor) {
            try {
                const { error } = await supabaseClient.from('athlete_group_members')
                    .delete().eq('group_uuid', groupUuid).eq('athlete_uuid', athleteUuid);
                if (error) throw error;
                await editGroupMembers(groupUuid, groupName, groupColor);
                await renderGroupsList();
            } catch (e) { showToast('Error: ' + e.message, 'error'); }
        }

        async function updateAthleteGender(athleteUuid, gender) {
            try {
                const { error } = await supabaseClient.from('athletes')
                    .update({ gender: gender || null }).eq('athlete_uuid', athleteUuid);
                if (error) throw error;
                if (_allTeamAthletes) {
                    const ath = _allTeamAthletes.find(a => a.athlete_uuid === athleteUuid);
                    if (ath) ath.gender = gender || null;
                }
            } catch (e) { console.error('Error updating gender:', e); showToast('Error: ' + e.message, 'error'); }
        }

        // Helper: select an athlete from coach dashboard
        function coachSelectAthlete(uuid) {
            const dropdown = document.getElementById('athleteDropdown');
            if (dropdown) { dropdown.value = uuid; }
            appState.selectedAthleteUuid = uuid;
            reloadActivePage();
        }

        // "" 1. TEAM PULSE ""
        async function loadTeamPulse() {
            const container = document.getElementById('teamPulseGrid');
            if (!container) return;
            try {
                const athletes = await getTeamAthleteList();
                if (!athletes.length) {
                    container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>No active athletes on this team yet</p></div>';
                    return;
                }
                const uuids = athletes.map(a => a.athlete_uuid);
                const _uf = new Set(uuids);
                const _small = uuids.length <= SUPABASE_IN_LIMIT;
                const _ufilt = rows => _small ? rows : (rows||[]).filter(r => _uf.has(r.athlete_uuid));

                const _sq = supabaseClient.from('v_start_kpis').select('athlete_uuid, reaction_time_s, split_15m_s, source_date');
                const _tq = supabaseClient.from('v_turn_kpis').select('athlete_uuid, split_15m_s, source_date');
                const _rq = supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s, style, distance_m, source_date, course');
                const [startRes, turnRes, raceRes] = await Promise.all([
                    (_small ? _sq.in('athlete_uuid', uuids) : _sq).order('source_date', { ascending: true }),
                    (_small ? _tq.in('athlete_uuid', uuids) : _tq).order('source_date', { ascending: true }),
                    (_small ? _rq.in('athlete_uuid', uuids) : _rq).not('race_time_s', 'is', null).order('source_date', { ascending: true })
                ]);

                const starts = _ufilt(startRes.data || []);
                const turns = _ufilt(turnRes.data || []);
                const races = _ufilt(raceRes.data || []);

                const reactions = starts.filter(d => d.reaction_time_s).map(d => parseFloat(d.reaction_time_s));
                const start15s = starts.filter(d => d.split_15m_s).map(d => parseFloat(d.split_15m_s));
                const turn15s = turns.filter(d => d.split_15m_s).map(d => parseFloat(d.split_15m_s));

                const avg = arr => arr.length ? (arr.reduce((a,b) => a+b, 0) / arr.length) : null;
                const best = arr => arr.length ? Math.min(...arr) : null;

                const athWithStarts = new Set(starts.filter(d=>d.reaction_time_s).map(d=>d.athlete_uuid)).size;
                const athWithTurns = new Set(turns.filter(d=>d.split_15m_s).map(d=>d.athlete_uuid)).size;
                const athWithRaces = new Set(races.map(d=>d.athlete_uuid)).size;
                const uniqueEvents = new Set(races.map(d => `${d.distance_m} ${d.style}`)).size;

                const pulseCard = (label, value, fmt, bestVal, count, color, athCount) => {
                    return `<div class="pulse-card">
                        <div class="pulse-accent" style="background:${color};"></div>
                        <div class="pulse-label">${label}</div>
                        <div class="pulse-row">
                            <div class="pulse-value">${value !== null ? fmt(value) : '--'}</div>
                            <span class="pulse-trend stable" style="font-size:11px; color:var(--text-muted);">${athCount} athlete${athCount!==1?'s':''}</span>
                        </div>
                        <div class="pulse-sub">Best: ${bestVal !== null ? fmt(bestVal) : '--'} | ${count} total trial${count!==1?'s':''}</div>
                    </div>`;
                };

                const fmtT = (v) => v.toFixed(3) + 's';
                const fmtS = (v) => v.toFixed(2) + 's';

                // 4th card: race count + unique events (meaningful, not avg across mixed events)
                const raceCountCard = `<div class="pulse-card">
                    <div class="pulse-accent" style="background:var(--accent-green);"></div>
                    <div class="pulse-label">Races on File</div>
                    <div class="pulse-row">
                        <div class="pulse-value">${races.length}</div>
                        <span class="pulse-trend stable" style="font-size:11px; color:var(--text-muted);">${athWithRaces} athlete${athWithRaces!==1?'s':''}</span>
                    </div>
                    <div class="pulse-sub">${uniqueEvents} unique event${uniqueEvents!==1?'s':''} tracked</div>
                </div>`;

                container.innerHTML = `
                    ${pulseCard('Avg Reaction Time', avg(reactions), fmtT, best(reactions), reactions.length, 'var(--accent-orange)', athWithStarts)}
                    ${pulseCard('Avg Start to 15m', avg(start15s), fmtS, best(start15s), start15s.length, 'var(--accent-blue)', athWithStarts)}
                    ${pulseCard('Avg Turn to 15m', avg(turn15s), fmtS, best(turn15s), turn15s.length, 'var(--accent-cyan)', athWithTurns)}
                    ${raceCountCard}
                `;
            } catch (e) {
                console.error('Error loading team pulse:', e);
                container.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><p>Error loading team metrics</p></div>';
            }
        }

        // "" 2. ATTENTION FLAGS ""
        async function loadAttentionFlags() {
            const container = document.getElementById('attentionGrid');
            const countEl = document.getElementById('attentionCount');
            const headerEl = document.getElementById('attentionHeader');
            if (!container) return;
            try {
                const athletes = await getTeamAthleteList();
                if (!athletes.length) { container.innerHTML = '<p style="color:var(--text-muted);font-size:12px;">No athletes to monitor</p>'; return; }
                const uuids = athletes.map(a => a.athlete_uuid);
                const _uf2 = new Set(uuids);
                const _small2 = uuids.length <= SUPABASE_IN_LIMIT;
                const _ufilt2 = rows => _small2 ? rows : (rows||[]).filter(r => _uf2.has(r.athlete_uuid));
                const nameMap = {};
                athletes.forEach(a => { nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name; });

                const cutoff14 = new Date(Date.now() - 14*86400000).toISOString().slice(0,10);

                const _sq2 = supabaseClient.from('v_start_kpis').select('athlete_uuid, reaction_time_s, split_15m_s, source_date');
                const _tq2 = supabaseClient.from('v_turn_kpis').select('athlete_uuid, split_15m_s, source_date');
                const _rq2 = supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s, source_date');
                const _gq2 = supabaseClient.from('goals').select('athlete_uuid, goal_type, event_name, target_value, current_best, status');
                const [startRes, turnRes, raceRes, goalsRes] = await Promise.all([
                    _small2 ? _sq2.in('athlete_uuid', uuids) : _sq2,
                    _small2 ? _tq2.in('athlete_uuid', uuids) : _tq2,
                    (_small2 ? _rq2.in('athlete_uuid', uuids) : _rq2).not('race_time_s', 'is', null),
                    (_small2 ? _gq2.in('athlete_uuid', uuids) : _gq2).eq('status', 'active')
                ]);

                const flags = [];

                // Check for inactive athletes
                const allSessions = [..._ufilt2(startRes.data||[]), ..._ufilt2(turnRes.data||[]), ..._ufilt2(raceRes.data||[])];
                const lastDateMap = {};
                allSessions.forEach(s => {
                    const d = s.source_date;
                    if (!lastDateMap[s.athlete_uuid] || d > lastDateMap[s.athlete_uuid]) lastDateMap[s.athlete_uuid] = d;
                });
                athletes.forEach(a => {
                    const last = lastDateMap[a.athlete_uuid];
                    if (!last) {
                        flags.push({ type: 'inactive', name: nameMap[a.athlete_uuid], uuid: a.athlete_uuid,
                            desc: 'No session data on file', key: 'inactive_' + a.athlete_uuid });
                    } else if (last < cutoff14) {
                        const days = Math.floor((Date.now() - new Date(last)) / 86400000);
                        flags.push({ type: 'inactive', name: nameMap[a.athlete_uuid], uuid: a.athlete_uuid,
                            desc: `Last session ${days} days ago`, key: 'inactive_' + a.athlete_uuid });
                    }
                });

                // Check for declining performance
                const startsByAth = {};
                (startRes.data||[]).forEach(s => {
                    if (!startsByAth[s.athlete_uuid]) startsByAth[s.athlete_uuid] = [];
                    if (s.reaction_time_s) startsByAth[s.athlete_uuid].push({ date: s.source_date, val: parseFloat(s.reaction_time_s) });
                });
                Object.entries(startsByAth).forEach(([uuid, arr]) => {
                    if (arr.length < 3) return;
                    arr.sort((a,b) => a.date.localeCompare(b.date));
                    const recent = arr.slice(-3).map(x=>x.val);
                    const older = arr.slice(0, -3).map(x=>x.val);
                    if (!older.length) return;
                    const recentAvg = recent.reduce((a,b)=>a+b,0)/recent.length;
                    const olderAvg = older.reduce((a,b)=>a+b,0)/older.length;
                    const pctWorse = ((recentAvg - olderAvg) / olderAvg * 100);
                    if (pctWorse > 5) {
                        flags.push({ type: 'decline', name: nameMap[uuid], uuid,
                            desc: `Reaction time up ${pctWorse.toFixed(1)}% (${olderAvg.toFixed(3)}s -> ${recentAvg.toFixed(3)}s)`,
                            key: 'decline_rt_' + uuid });
                    }
                });

                // Goals close to completion
                _ufilt2(goalsRes.data||[]).forEach(g => {
                    if (g.current_best && g.target_value) {
                        const pct = g.target_value > 0 ? Math.min(100, (1 - (g.current_best - g.target_value) / g.current_best) * 100) : 0;
                        if (pct > 85 && pct < 100) {
                            flags.push({ type: 'goal', name: nameMap[g.athlete_uuid], uuid: g.athlete_uuid,
                                desc: `Close to goal: ${g.event_name || g.goal_type} (${pct.toFixed(0)}% there)`,
                                key: 'goal_' + g.athlete_uuid + '_' + (g.event_name || g.goal_type) });
                        }
                    }
                });

                // Filter out dismissed flags (8hr expiry)
                const dismissed = getActiveDismissals();
                const visibleFlags = flags.filter(f => !dismissed[f.key]);

                if (countEl) countEl.textContent = visibleFlags.length > 0 ? `(${visibleFlags.length})` : '';

                if (!visibleFlags.length) {
                    container.innerHTML = '<div style="padding:12px 0; color:var(--text-muted); font-size:13px; display:flex; align-items:center; gap:8px;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>All clear - no flags right now</div>';
                    if (headerEl && !flags.length) headerEl.style.display = 'none';
                    return;
                }

                const iconMap = {
                    decline: '<div class="att-icon decline"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/><polyline points="17 18 23 18 23 12"/></svg></div>',
                    inactive: '<div class="att-icon inactive"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>',
                    goal: '<div class="att-icon goal"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></div>'
                };

                container.innerHTML = visibleFlags.slice(0, 8).map(f => `
                    <div class="attention-card" style="cursor:pointer;" onclick="if(!event.target.closest('.att-dismiss'))coachSelectAthlete('${f.uuid}')">
                        ${iconMap[f.type]}
                        <div class="att-body">
                            <div class="att-title">${f.name}</div>
                            <div class="att-desc">${f.desc}</div>
                        </div>
                        <button class="att-dismiss" onclick="event.stopPropagation();dismissAttentionCard(this,'${f.key}')" title="Dismiss for 8 hours">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading attention flags:', e);
                container.innerHTML = '<p style="color:var(--text-muted); font-size:12px;">Error checking athlete status</p>';
            }
        }

        // "" 3. TEAM ROSTER ""
        async function loadTeamRoster() {
            const container = document.getElementById('teamRosterBody');
            const countEl = document.getElementById('rosterCount');
            if (!container) return;
            try {
                const athletes = await getTeamAthleteList();
                if (countEl) countEl.textContent = `(${athletes.length})`;
                if (!athletes.length) {
                    container.innerHTML = '<div class="empty-state"><p>No active athletes</p></div>';
                    return;
                }
                const uuids = athletes.map(a => a.athlete_uuid);
                const _uf3 = new Set(uuids);
                const _small3 = uuids.length <= SUPABASE_IN_LIMIT;
                const _ufilt3 = rows => _small3 ? rows : (rows||[]).filter(r => _uf3.has(r.athlete_uuid));

                // Fetch summary stats per athlete
                const _sq3 = supabaseClient.from('v_start_kpis').select('athlete_uuid, reaction_time_s, source_date');
                const _tq3 = supabaseClient.from('v_turn_kpis').select('athlete_uuid, source_date');
                const _rq3 = supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s, distance_m, style, source_date');
                const [startRes, turnRes, raceRes] = await Promise.all([
                    _small3 ? _sq3.in('athlete_uuid', uuids) : _sq3,
                    _small3 ? _tq3.in('athlete_uuid', uuids) : _tq3,
                    (_small3 ? _rq3.in('athlete_uuid', uuids) : _rq3).not('race_time_s', 'is', null)
                ]);

                // Build per-athlete stats
                const stats = {};
                athletes.forEach(a => {
                    stats[a.athlete_uuid] = { name: a.first_name + ' ' + a.last_name, code: a.athlete_code,
                        uuid: a.athlete_uuid, gender: a.gender || '', sessions: 0, lastDate: null, bestReaction: null, bestRace: null, bestRaceEvent: '' };
                });

                const allData = [..._ufilt3(startRes.data||[]), ..._ufilt3(turnRes.data||[]), ..._ufilt3(raceRes.data||[])];
                allData.forEach(d => {
                    const s = stats[d.athlete_uuid];
                    if (!s) return;
                    s.sessions++;
                    if (!s.lastDate || d.source_date > s.lastDate) s.lastDate = d.source_date;
                });

                _ufilt3(startRes.data||[]).forEach(d => {
                    const s = stats[d.athlete_uuid];
                    if (!s || !d.reaction_time_s) return;
                    const v = parseFloat(d.reaction_time_s);
                    if (s.bestReaction === null || v < s.bestReaction) s.bestReaction = v;
                });

                _ufilt3(raceRes.data||[]).forEach(d => {
                    const s = stats[d.athlete_uuid];
                    if (!s) return;
                    const v = parseFloat(d.race_time_s);
                    if (s.bestRace === null || v < s.bestRace) {
                        s.bestRace = v;
                        s.bestRaceEvent = (d.distance_m||'') + ' ' + (d.style||'');
                    }
                });

                const roster = Object.values(stats).sort((a,b) => a.name.localeCompare(b.name));
                const now = Date.now();

                container.innerHTML = `<table class="roster-table">
                    <thead><tr>
                        <th>Athlete</th><th>Code</th><th>Gender</th><th>Sessions</th><th>Last Active</th>
                        <th>Best Reaction</th><th>Best Race</th><th>Status</th>
                    </tr></thead>
                    <tbody>${roster.map(r => {
                        const daysAgo = r.lastDate ? Math.floor((now - new Date(r.lastDate)) / 86400000) : null;
                        const statusCls = daysAgo === null ? 'inactive' : daysAgo > 14 ? 'inactive' : 'active';
                        const statusTxt = daysAgo === null ? 'No data' : daysAgo > 14 ? 'Inactive' : 'Active';
                        const lastTxt = daysAgo === null ? '--' : daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : daysAgo + 'd ago';
                        return `<tr>
                            <td><button class="roster-name-btn" onclick="coachSelectAthlete('${r.uuid}')">${r.name}</button></td>
                            <td class="roster-stat muted">${r.code || '--'}</td>
                            <td class="roster-stat"><select class="gender-select-mini" onchange="updateAthleteGender('${r.uuid}',this.value)">
                                <option value="" ${!r.gender?'selected':''}>--</option>
                                <option value="male" ${r.gender==='male'?'selected':''}>M</option>
                                <option value="female" ${r.gender==='female'?'selected':''}>F</option>
                            </select></td>
                            <td class="roster-stat">${r.sessions}</td>
                            <td class="roster-stat">${lastTxt}</td>
                            <td class="roster-stat">${r.bestReaction !== null ? r.bestReaction.toFixed(3) + 's' : '--'}</td>
                            <td class="roster-stat">${r.bestRace !== null ? formatTime(r.bestRace) : '--'}${r.bestRaceEvent ? '<span style="font-size:10px;color:var(--text-muted);margin-left:4px;">'+r.bestRaceEvent.trim()+'</span>' : ''}</td>
                            <td><span class="roster-badge ${statusCls}">${statusTxt}</span></td>
                        </tr>`;
                    }).join('')}</tbody></table>`;
            } catch (e) {
                console.error('Error loading roster:', e);
                container.innerHTML = '<div class="empty-state"><p>Error loading roster</p></div>';
            }
        }

        // "" 4. LEADERBOARDS ""
        async function loadEventRecords() {
            const container = document.getElementById('teamEventRecords');
            if (!container) return;
            try {
                const athletes = await getTeamAthleteList();
                if (!athletes.length) {
                    container.innerHTML = '<div class="empty-state"><p>No athlete data for event records</p></div>';
                    return;
                }
                const uuids = athletes.map(a => a.athlete_uuid);
                const _uf4 = new Set(uuids);
                const _small4 = uuids.length <= SUPABASE_IN_LIMIT;
                const nameMap = {};
                athletes.forEach(a => { nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.'; });

                let _rq4 = supabaseClient
                    .from('v_race_kpis')
                    .select('athlete_uuid, race_time_s, style, distance_m, source_date, course');
                if (_small4) _rq4 = _rq4.in('athlete_uuid', uuids);
                const { data: rawRaces, error } = await _rq4.not('race_time_s', 'is', null);

                if (error) throw error;
                const races = _small4 ? rawRaces : (rawRaces||[]).filter(r => _uf4.has(r.athlete_uuid));

                if (!races?.length) {
                    container.innerHTML = '<div style="padding:12px 0; color:var(--text-muted); font-size:13px;">No race data yet</div>';
                    return;
                }

                // Group by event+course, find best time and record holder per event
                const eventMap = {};
                races.forEach(r => {
                    const dist = r.distance_m || 0;
                    const style = (r.style || 'unknown').toLowerCase();
                    const course = (r.course || 'SCY').toUpperCase();
                    const key = `${dist}_${style}_${course}`;
                    const time = parseFloat(r.race_time_s);
                    if (isNaN(time) || time <= 0) return;
                    if (!eventMap[key] || time < eventMap[key].time) {
                        eventMap[key] = { time, uuid: r.athlete_uuid, date: r.source_date, dist, style, course };
                    }
                });

                const events = Object.values(eventMap).sort((a, b) => {
                    if (a.dist !== b.dist) return a.dist - b.dist;
                    return a.style.localeCompare(b.style);
                });

                if (!events.length) {
                    container.innerHTML = '<div style="padding:12px 0; color:var(--text-muted); font-size:13px;">No race records yet</div>';
                    return;
                }

                // Color palette per style (theme-aware)
                const _tc = getThemeColors();
                const styleColors = {
                    freestyle: _tc.freestyle, backstroke: _tc.backstroke, breaststroke: _tc.breaststroke,
                    butterfly: _tc.butterfly, medley: _tc.im, im: _tc.im
                };
                const getColor = (s) => styleColors[s] || _tc.textMuted;

                container.innerHTML = `<div class="event-records-grid">${events.map(ev => {
                    const color = getColor(ev.style);
                    const unit = ev.course === 'SCY' ? 'Yds' : 'm';
                    const eventLabel = ev.dist + ' ' + unit + ' ' + ev.style.charAt(0).toUpperCase() + ev.style.slice(1);
                    const holderName = nameMap[ev.uuid] || 'Unknown';
                    const dateStr = ev.date ? new Date(ev.date).toLocaleDateString('en-US', { month:'short', day:'numeric' }) : '';
                    return `<div class="event-record-card">
                        <div class="er-accent" style="background:${color};"></div>
                        <div class="er-event">${eventLabel} <span class="rc-course-tag">${ev.course}</span></div>
                        <div class="er-time">${formatTime(ev.time)}</div>
                        <div class="er-athlete" onclick="coachSelectAthlete('${ev.uuid}')">${holderName}</div>
                        <div class="er-date">${dateStr}</div>
                    </div>`;
                }).join('')}</div>`;
            } catch (e) {
                console.error('Error loading event records:', e);
                container.innerHTML = '<div class="empty-state"><p>Error loading event records</p></div>';
            }
        }

        // ============================================
        // HOME PAGE CAROUSELS (v02.11)
        // ============================================
        const carouselState = {
            records: { currentSlide: 0, slides: [], course: 'SCY', gender: '' },
            competition: { currentSlide: 0, slides: [], gender: '' },
            athleteRecords: { currentSlide: 0, slides: [], course: 'SCY' },
            athleteComp: { currentSlide: 0, slides: [], gender: '' }
        };

        const STROKES_ORDER = ['freestyle', 'backstroke', 'breaststroke', 'butterfly', 'im', 'medley'];
        const STROKE_ICONS = {
            freestyle: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h20"/></svg>',
            backstroke: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20"/></svg>',
            breaststroke: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>',
            butterfly: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>',
            im: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>',
            medley: '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>'
        };

        function initHomeCarousels(isAthlete = false) {
            if (isAthlete) {
                // Athlete course filter
                document.querySelectorAll('#athleteCourseFilter .carousel-filter-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('#athleteCourseFilter .carousel-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        carouselState.athleteRecords.course = btn.dataset.course;
                        carouselState.athleteRecords.currentSlide = 0;
                        loadAthleteRecordsCarousel();
                    };
                });

                // Athlete competition gender filter
                document.querySelectorAll('#athleteCompGenderFilter .carousel-filter-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('#athleteCompGenderFilter .carousel-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        carouselState.athleteComp.gender = btn.dataset.gender;
                        carouselState.athleteComp.currentSlide = 0;
                        loadAthleteCompCarousel();
                    };
                });

                // Athlete records arrows
                document.getElementById('athleteRecordsPrev')?.addEventListener('click', () => {
                    if (carouselState.athleteRecords.currentSlide > 0) {
                        carouselState.athleteRecords.currentSlide--;
                        renderAthleteRecordsSlide();
                    }
                });
                document.getElementById('athleteRecordsNext')?.addEventListener('click', () => {
                    if (carouselState.athleteRecords.currentSlide < carouselState.athleteRecords.slides.length - 1) {
                        carouselState.athleteRecords.currentSlide++;
                        renderAthleteRecordsSlide();
                    }
                });

                // Athlete competition arrows
                document.getElementById('athleteCompPrev')?.addEventListener('click', () => {
                    if (carouselState.athleteComp.currentSlide > 0) {
                        carouselState.athleteComp.currentSlide--;
                        renderAthleteCompSlide();
                    }
                });
                document.getElementById('athleteCompNext')?.addEventListener('click', () => {
                    if (carouselState.athleteComp.currentSlide < carouselState.athleteComp.slides.length - 1) {
                        carouselState.athleteComp.currentSlide++;
                        renderAthleteCompSlide();
                    }
                });
            } else {
                // Coach course filter buttons
                document.querySelectorAll('#recordsCourseFilter .carousel-filter-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('#recordsCourseFilter .carousel-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        carouselState.records.course = btn.dataset.course;
                        carouselState.records.currentSlide = 0;
                        loadRecordsCarousel();
                    };
                });

                // Coach records gender filter
                document.querySelectorAll('#recordsGenderFilter .carousel-filter-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('#recordsGenderFilter .carousel-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        carouselState.records.gender = btn.dataset.gender;
                        carouselState.records.currentSlide = 0;
                        loadRecordsCarousel();
                    };
                });

                // Coach competition gender filter
                document.querySelectorAll('#compGenderFilterCarousel .carousel-filter-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('#compGenderFilterCarousel .carousel-filter-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        carouselState.competition.gender = btn.dataset.gender;
                        carouselState.competition.currentSlide = 0;
                        loadCompetitionCarousel();
                    };
                });

                // Records carousel arrows
                document.getElementById('recordsPrev')?.addEventListener('click', () => {
                    if (carouselState.records.currentSlide > 0) {
                        carouselState.records.currentSlide--;
                        renderRecordsSlide();
                    }
                });
                document.getElementById('recordsNext')?.addEventListener('click', () => {
                    if (carouselState.records.currentSlide < carouselState.records.slides.length - 1) {
                        carouselState.records.currentSlide++;
                        renderRecordsSlide();
                    }
                });

                // Competition carousel arrows
                document.getElementById('compPrev')?.addEventListener('click', () => {
                    if (carouselState.competition.currentSlide > 0) {
                        carouselState.competition.currentSlide--;
                        renderCompSlide();
                    }
                });
                document.getElementById('compNext')?.addEventListener('click', () => {
                    if (carouselState.competition.currentSlide < carouselState.competition.slides.length - 1) {
                        carouselState.competition.currentSlide++;
                        renderCompSlide();
                    }
                });
            }
        }

        async function loadRecordsCarousel() {
            const body = document.getElementById('recordsCarouselBody');
            const titleEl = document.getElementById('recordsCarouselTitle');
            if (!body) return;

            const isCoach = appState.role === 'coach' && !appState.selectedAthleteUuid;
            if (titleEl) titleEl.textContent = isCoach ? 'Team Records' : 'My Personal Bests';

            body.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading...</div>';

            try {
                const course = carouselState.records.course;
                const genderFilter = carouselState.records.gender;
                let athletes, uuids, nameMap = {}, genderMap = {};

                if (isCoach) {
                    athletes = await getTeamAthleteList();
                    // Filter by gender if specified
                    if (genderFilter) {
                        athletes = athletes.filter(a => a.gender === genderFilter);
                    }
                    uuids = athletes.map(a => a.athlete_uuid);
                    athletes.forEach(a => { 
                        nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.';
                        genderMap[a.athlete_uuid] = a.gender;
                    });
                } else {
                    uuids = [appState.selectedAthleteUuid || appState.athleteUuid];
                }

                if (!uuids.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No athlete data available</p></div>';
                    return;
                }

                const _uf = new Set(uuids);
                const _small = uuids.length <= SUPABASE_IN_LIMIT;

                let query = supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s, style, distance_m, source_date, course');
                if (_small) query = query.in('athlete_uuid', uuids);
                query = query.eq('course', course).not('race_time_s', 'is', null);

                const { data: rawRaces, error } = await query;
                if (error) throw error;

                const races = _small ? rawRaces : (rawRaces || []).filter(r => _uf.has(r.athlete_uuid));

                if (!races?.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No ' + course + ' race data yet</p></div>';
                    document.getElementById('recordsCarouselDots').innerHTML = '';
                    return;
                }

                // Group by stroke, then find best time per event
                const strokeEvents = {};
                races.forEach(r => {
                    const stroke = (r.style || 'unknown').toLowerCase();
                    const dist = r.distance_m || 0;
                    const time = parseFloat(r.race_time_s);
                    if (isNaN(time) || time <= 0) return;

                    if (!strokeEvents[stroke]) strokeEvents[stroke] = {};
                    const eventKey = dist;
                    if (!strokeEvents[stroke][eventKey] || time < strokeEvents[stroke][eventKey].time) {
                        strokeEvents[stroke][eventKey] = { 
                            time, uuid: r.athlete_uuid, date: r.source_date, dist, stroke 
                        };
                    }
                });

                // Build slides - one per stroke that has data
                const slides = [];
                STROKES_ORDER.forEach(stroke => {
                    if (strokeEvents[stroke] && Object.keys(strokeEvents[stroke]).length > 0) {
                        const events = Object.values(strokeEvents[stroke]).sort((a, b) => a.dist - b.dist);
                        slides.push({ stroke, events, nameMap, isCoach, course });
                    }
                });

                // Check other strokes not in order
                Object.keys(strokeEvents).forEach(stroke => {
                    if (!STROKES_ORDER.includes(stroke) && Object.keys(strokeEvents[stroke]).length > 0) {
                        const events = Object.values(strokeEvents[stroke]).sort((a, b) => a.dist - b.dist);
                        slides.push({ stroke, events, nameMap, isCoach, course });
                    }
                });

                carouselState.records.slides = slides;
                if (carouselState.records.currentSlide >= slides.length) carouselState.records.currentSlide = 0;
                
                renderRecordsSlide();
                renderRecordsDots();

            } catch (e) {
                console.error('Error loading records carousel:', e);
                body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>Error loading records</p></div>';
            }
        }

        function renderRecordsSlide() {
            const body = document.getElementById('recordsCarouselBody');
            const slides = carouselState.records.slides;
            const idx = carouselState.records.currentSlide;
            
            if (!slides.length || !body) return;
            const slide = slides[idx];
            const unit = slide.course === 'SCY' ? 'Yds' : 'm';
            const strokeLabel = slide.stroke.charAt(0).toUpperCase() + slide.stroke.slice(1);
            const strokeClass = slide.stroke.replace(' ', '');

            let html = `<div class="records-slide-title">
                <span class="stroke-icon ${strokeClass}">${STROKE_ICONS[slide.stroke] || ''}</span>
                <span class="stroke-name">${strokeLabel}</span>
            </div>
            <div class="records-grid">`;

            slide.events.forEach(ev => {
                const holderName = slide.nameMap[ev.uuid] || '';
                const initials = holderName ? holderName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0,2) : '??';
                const dateStr = ev.date ? new Date(ev.date).toLocaleDateString('en-US', { month:'short', day:'numeric' }) : '';

                if (slide.isCoach) {
                    html += `<div class="record-card">
                        <div class="event-dist">${ev.dist} ${unit}</div>
                        <div class="event-time">${formatTime(ev.time)}</div>
                        <div class="event-holder">
                            <div class="holder-avatar">${initials}</div>
                            <span class="holder-name">${holderName}</span>
                        </div>
                        <div class="event-date">${dateStr}</div>
                    </div>`;
                } else {
                    html += `<div class="record-card pb-card">
                        <div class="event-dist">${ev.dist} ${unit}</div>
                        <div class="event-time">${formatTime(ev.time)}</div>
                        <div class="event-date">${dateStr}</div>
                        <div class="pb-label"><svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>PB</div>
                    </div>`;
                }
            });

            html += `</div>
            <div class="carousel-slide-label">Slide ${idx + 1} of ${slides.length}  ${strokeLabel}</div>`;
            body.innerHTML = html;

            // Update dots
            document.querySelectorAll('#recordsCarouselDots .carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === idx);
            });
        }

        function renderRecordsDots() {
            const dotsEl = document.getElementById('recordsCarouselDots');
            if (!dotsEl) return;
            const slides = carouselState.records.slides;
            dotsEl.innerHTML = slides.map((s, i) => 
                `<div class="carousel-dot${i === carouselState.records.currentSlide ? ' active' : ''}" onclick="carouselState.records.currentSlide=${i};renderRecordsSlide();" title="${s.stroke}"></div>`
            ).join('');
        }

        // Competition carousel
        const COMP_CAROUSEL_BOARDS = [
            { key: 'fastest_start', label: 'Fastest Start (0-15m)', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' },
            { key: 'best_reaction', label: 'Best Reaction Time', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>' },
            { key: 'fastest_turn', label: 'Fastest Turn (15m-15m)', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>' },
            { key: 'best_race_pb', label: 'Best Race Time', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/></svg>' }
        ];

        async function loadCompetitionCarousel() {
            const body = document.getElementById('compCarouselBody');
            const card = document.getElementById('compCarouselCard');
            if (!body) return;

            body.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading...</div>';

            try {
                const genderFilter = carouselState.competition.gender;
                
                // Get competition athletes
                const { data: compAthletes, error: compErr } = await supabaseClient
                    .from('v_competition_athletes')
                    .select('athlete_uuid, first_name, last_name, team_name');

                if (compErr || !compAthletes?.length) {
                    if (card) card.style.display = 'none';
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No athletes found</p></div>';
                    return;
                }

                // If gender filter, we need to get gender from athletes table
                let filteredAthletes = compAthletes;
                if (genderFilter) {
                    const compUuids = compAthletes.map(a => a.athlete_uuid);
                    const { data: athGenders } = await supabaseClient
                        .from('athletes')
                        .select('athlete_uuid, gender')
                        .in('athlete_uuid', compUuids)
                        .eq('gender', genderFilter);
                    
                    if (!athGenders?.length) {
                        body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No ' + (genderFilter === 'male' ? 'male' : 'female') + ' athletes found</p></div>';
                        document.getElementById('compCarouselDots').innerHTML = '';
                        return;
                    }
                    
                    const genderUuids = new Set(athGenders.map(a => a.athlete_uuid));
                    filteredAthletes = compAthletes.filter(a => genderUuids.has(a.athlete_uuid));
                }

                if (!filteredAthletes.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No athletes found</p></div>';
                    document.getElementById('compCarouselDots').innerHTML = '';
                    return;
                }

                if (card) card.style.display = '';
                const uuids = filteredAthletes.map(a => a.athlete_uuid);
                const nameMap = {};
                const teamMap = {};
                filteredAthletes.forEach(a => { 
                    nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.';
                    teamMap[a.athlete_uuid] = a.team_name || '';
                });

                // Load data for all boards
                const slides = [];

                // Fastest Start
                const { data: starts } = await supabaseClient.from('v_start_kpis').select('athlete_uuid, split_15m_s').in('athlete_uuid', uuids).not('split_15m_s', 'is', null);
                if (starts?.length) {
                    const best = {};
                    starts.forEach(r => { if (!best[r.athlete_uuid] || r.split_15m_s < best[r.athlete_uuid].split_15m_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.split_15m_s - b.split_15m_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[0], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.split_15m_s, unit: 's' })), nameMap, teamMap });
                }

                // Best Reaction
                const { data: reactions } = await supabaseClient.from('v_start_kpis').select('athlete_uuid, reaction_time_s').in('athlete_uuid', uuids).not('reaction_time_s', 'is', null);
                if (reactions?.length) {
                    const best = {};
                    reactions.forEach(r => { if (!best[r.athlete_uuid] || r.reaction_time_s < best[r.athlete_uuid].reaction_time_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.reaction_time_s - b.reaction_time_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[1], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.reaction_time_s, unit: 's' })), nameMap, teamMap });
                }

                // Fastest Turn
                const { data: turns } = await supabaseClient.from('v_turn_kpis').select('athlete_uuid, time_15in_15out_s').in('athlete_uuid', uuids).not('time_15in_15out_s', 'is', null);
                if (turns?.length) {
                    const best = {};
                    turns.forEach(r => { if (!best[r.athlete_uuid] || r.time_15in_15out_s < best[r.athlete_uuid].time_15in_15out_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.time_15in_15out_s - b.time_15in_15out_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[2], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.time_15in_15out_s, unit: 's' })), nameMap, teamMap });
                }

                // Best Race PB (just get overall best from any event)
                const { data: races } = await supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s').in('athlete_uuid', uuids).not('race_time_s', 'is', null);
                if (races?.length) {
                    const best = {};
                    races.forEach(r => { if (!best[r.athlete_uuid] || r.race_time_s < best[r.athlete_uuid].race_time_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.race_time_s - b.race_time_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[3], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.race_time_s, unit: '' })), nameMap, teamMap });
                }

                if (!slides.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No competition data yet</p></div>';
                    document.getElementById('compCarouselDots').innerHTML = '';
                    return;
                }

                carouselState.competition.slides = slides;
                if (carouselState.competition.currentSlide >= slides.length) carouselState.competition.currentSlide = 0;

                renderCompSlide();
                renderCompDots();

            } catch (e) {
                console.error('Error loading competition carousel:', e);
                body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>Competition not available</p></div>';
            }
        }

        function renderCompSlide() {
            const body = document.getElementById('compCarouselBody');
            const slides = carouselState.competition.slides;
            const idx = carouselState.competition.currentSlide;

            if (!slides.length || !body) return;
            const slide = slides[idx];

            let html = `<div class="comp-slide-title">${slide.icon}${slide.label}</div>
            <div class="comp-podium-mini">`;

            [1, 0, 2].forEach(rank => { // Order: 2nd, 1st, 3rd for visual display
                const item = slide.top3[rank];
                if (!item) return;
                const name = slide.nameMap[item.uuid] || 'Unknown';
                const team = slide.teamMap[item.uuid] || '';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                const valueStr = slide.unit === 's' ? item.value.toFixed(3) + 's' : formatTime(item.value);
                const isMe = item.uuid === appState.athleteUuid;

                html += `<div class="comp-podium-item rank-${rank + 1}">
                    <div class="comp-avatar-mini" ${isMe ? 'style="background:linear-gradient(135deg,#a855f7,#7c3aed);box-shadow:0 0 12px rgba(168,85,247,0.4);"' : ''}>${initials}<div class="comp-medal-mini">${rank + 1}</div></div>
                    <div class="comp-name-mini" ${isMe ? 'style="color:var(--accent-purple);"' : ''}>${isMe ? 'You' : name}</div>
                    <div class="comp-team-mini">${team}</div>
                    <div class="comp-value-mini">${valueStr}</div>
                    <div class="comp-bar-mini"></div>
                </div>`;
            });

            html += `</div><div class="carousel-slide-label">Slide ${idx + 1} of ${slides.length}</div>`;
            body.innerHTML = html;

            // Update dots
            document.querySelectorAll('#compCarouselDots .carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === idx);
            });
        }

        function renderCompDots() {
            const dotsEl = document.getElementById('compCarouselDots');
            if (!dotsEl) return;
            const slides = carouselState.competition.slides;
            dotsEl.innerHTML = slides.map((s, i) => 
                `<div class="carousel-dot${i === carouselState.competition.currentSlide ? ' active' : ''}" onclick="carouselState.competition.currentSlide=${i};renderCompSlide();" title="${s.label}"></div>`
            ).join('');
        }

        // ============================================
        // ATHLETE CAROUSELS (v02.11)
        // ============================================
        async function loadAthleteRecordsCarousel() {
            const body = document.getElementById('athleteRecordsBody');
            if (!body) return;

            body.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading PBs...</div>';

            try {
                const course = carouselState.athleteRecords.course;
                const uuid = appState.athleteUuid;

                if (!uuid) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No athlete data</p></div>';
                    return;
                }

                const { data: races, error } = await supabaseClient
                    .from('v_race_kpis')
                    .select('athlete_uuid, race_time_s, style, distance_m, source_date, course')
                    .eq('athlete_uuid', uuid)
                    .eq('course', course)
                    .not('race_time_s', 'is', null);

                if (error) throw error;

                if (!races?.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No ' + course + ' race data yet</p></div>';
                    document.getElementById('athleteRecordsDots').innerHTML = '';
                    return;
                }

                // Group by stroke, then find best time per event
                const strokeEvents = {};
                races.forEach(r => {
                    const stroke = (r.style || 'unknown').toLowerCase();
                    const dist = r.distance_m || 0;
                    const time = parseFloat(r.race_time_s);
                    if (isNaN(time) || time <= 0) return;
                    
                    if (!strokeEvents[stroke]) strokeEvents[stroke] = {};
                    const key = dist;
                    if (!strokeEvents[stroke][key] || time < strokeEvents[stroke][key].time) {
                        strokeEvents[stroke][key] = { time, date: r.source_date, uuid: r.athlete_uuid };
                    }
                });

                // Build slides per stroke
                const slides = [];
                STROKES_ORDER.forEach(stroke => {
                    if (!strokeEvents[stroke]) return;
                    const events = Object.entries(strokeEvents[stroke]).map(([dist, data]) => ({
                        dist: parseInt(dist), time: data.time, date: data.date, uuid: data.uuid
                    })).sort((a, b) => a.dist - b.dist);
                    
                    if (events.length) {
                        slides.push({ stroke, events, course });
                    }
                });

                if (!slides.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No PB data for ' + course + '</p></div>';
                    document.getElementById('athleteRecordsDots').innerHTML = '';
                    return;
                }

                carouselState.athleteRecords.slides = slides;
                if (carouselState.athleteRecords.currentSlide >= slides.length) carouselState.athleteRecords.currentSlide = 0;

                renderAthleteRecordsSlide();
                renderAthleteRecordsDots();

            } catch (e) {
                console.error('Error loading athlete records carousel:', e);
                body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>Error loading PBs</p></div>';
            }
        }

        function renderAthleteRecordsSlide() {
            const body = document.getElementById('athleteRecordsBody');
            const slides = carouselState.athleteRecords.slides;
            const idx = carouselState.athleteRecords.currentSlide;

            if (!slides.length || !body) return;
            const slide = slides[idx];

            const strokeClass = slide.stroke.toLowerCase().replace(' ', '');
            const unit = slide.course === 'SCY' ? 'YDS' : 'M';

            let html = `<div class="records-slide-title">
                <span class="stroke-icon ${strokeClass}">${STROKE_ICONS[strokeClass] || ''}</span>
                <span class="stroke-name">${slide.stroke.charAt(0).toUpperCase() + slide.stroke.slice(1)}</span>
            </div>
            <div class="records-grid">`;

            slide.events.forEach(ev => {
                const dateStr = ev.date ? new Date(ev.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                html += `<div class="record-card pb-card">
                    <div class="event-dist">${ev.dist} ${unit}</div>
                    <div class="event-time">${formatTime(ev.time)}</div>
                    <div class="event-date">${dateStr}</div>
                    <div class="pb-label"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>PB</div>
                </div>`;
            });

            html += `</div><div class="carousel-slide-label">Slide ${idx + 1} of ${slides.length}  ${slide.stroke.charAt(0).toUpperCase() + slide.stroke.slice(1)}</div>`;
            body.innerHTML = html;

            // Update dots
            document.querySelectorAll('#athleteRecordsDots .carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === idx);
            });
        }

        function renderAthleteRecordsDots() {
            const dotsEl = document.getElementById('athleteRecordsDots');
            if (!dotsEl) return;
            const slides = carouselState.athleteRecords.slides;
            dotsEl.innerHTML = slides.map((s, i) => 
                `<div class="carousel-dot${i === carouselState.athleteRecords.currentSlide ? ' active' : ''}" onclick="carouselState.athleteRecords.currentSlide=${i};renderAthleteRecordsSlide();" title="${s.stroke}"></div>`
            ).join('');
        }

        async function loadAthleteCompCarousel() {
            const body = document.getElementById('athleteCompBody');
            const card = document.getElementById('athleteCompCarouselCard');
            if (!body) return;

            body.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading...</div>';

            try {
                const genderFilter = carouselState.athleteComp.gender;
                
                // Get competition athletes
                const { data: compAthletes, error: compErr } = await supabaseClient
                    .from('v_competition_athletes')
                    .select('athlete_uuid, first_name, last_name, team_name');

                if (compErr || !compAthletes?.length) {
                    if (card) card.style.display = 'none';
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No athletes found</p></div>';
                    return;
                }

                // If gender filter, get gender from athletes table
                let filteredAthletes = compAthletes;
                if (genderFilter) {
                    const compUuids = compAthletes.map(a => a.athlete_uuid);
                    const { data: athGenders } = await supabaseClient
                        .from('athletes')
                        .select('athlete_uuid, gender')
                        .in('athlete_uuid', compUuids)
                        .eq('gender', genderFilter);
                    
                    if (!athGenders?.length) {
                        body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No ' + (genderFilter === 'male' ? 'male' : 'female') + ' athletes found</p></div>';
                        document.getElementById('athleteCompDots').innerHTML = '';
                        return;
                    }
                    
                    const genderUuids = new Set(athGenders.map(a => a.athlete_uuid));
                    filteredAthletes = compAthletes.filter(a => genderUuids.has(a.athlete_uuid));
                }

                if (!filteredAthletes.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No athletes found</p></div>';
                    document.getElementById('athleteCompDots').innerHTML = '';
                    return;
                }

                if (card) card.style.display = '';
                const uuids = filteredAthletes.map(a => a.athlete_uuid);
                const nameMap = {};
                const teamMap = {};
                filteredAthletes.forEach(a => { 
                    nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.';
                    teamMap[a.athlete_uuid] = a.team_name || '';
                });

                // Load data for all boards (same as coach but we highlight the current athlete)
                const slides = [];

                // Fastest Start
                const { data: starts } = await supabaseClient.from('v_start_kpis').select('athlete_uuid, split_15m_s').in('athlete_uuid', uuids).not('split_15m_s', 'is', null);
                if (starts?.length) {
                    const best = {};
                    starts.forEach(r => { if (!best[r.athlete_uuid] || r.split_15m_s < best[r.athlete_uuid].split_15m_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.split_15m_s - b.split_15m_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[0], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.split_15m_s, unit: 's' })), nameMap, teamMap });
                }

                // Best Reaction
                const { data: reactions } = await supabaseClient.from('v_start_kpis').select('athlete_uuid, reaction_time_s').in('athlete_uuid', uuids).not('reaction_time_s', 'is', null);
                if (reactions?.length) {
                    const best = {};
                    reactions.forEach(r => { if (!best[r.athlete_uuid] || r.reaction_time_s < best[r.athlete_uuid].reaction_time_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.reaction_time_s - b.reaction_time_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[1], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.reaction_time_s, unit: 's' })), nameMap, teamMap });
                }

                // Fastest Turn
                const { data: turns } = await supabaseClient.from('v_turn_kpis').select('athlete_uuid, time_15in_15out_s').in('athlete_uuid', uuids).not('time_15in_15out_s', 'is', null);
                if (turns?.length) {
                    const best = {};
                    turns.forEach(r => { if (!best[r.athlete_uuid] || r.time_15in_15out_s < best[r.athlete_uuid].time_15in_15out_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.time_15in_15out_s - b.time_15in_15out_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[2], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.time_15in_15out_s, unit: 's' })), nameMap, teamMap });
                }

                // Best Race PB
                const { data: races } = await supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s').in('athlete_uuid', uuids).not('race_time_s', 'is', null);
                if (races?.length) {
                    const best = {};
                    races.forEach(r => { if (!best[r.athlete_uuid] || r.race_time_s < best[r.athlete_uuid].race_time_s) best[r.athlete_uuid] = r; });
                    const sorted = Object.values(best).sort((a, b) => a.race_time_s - b.race_time_s).slice(0, 3);
                    if (sorted.length >= 1) slides.push({ ...COMP_CAROUSEL_BOARDS[3], top3: sorted.map(r => ({ uuid: r.athlete_uuid, value: r.race_time_s, unit: '' })), nameMap, teamMap });
                }

                if (!slides.length) {
                    body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>No competition data yet</p></div>';
                    document.getElementById('athleteCompDots').innerHTML = '';
                    return;
                }

                carouselState.athleteComp.slides = slides;
                if (carouselState.athleteComp.currentSlide >= slides.length) carouselState.athleteComp.currentSlide = 0;

                renderAthleteCompSlide();
                renderAthleteCompDots();

            } catch (e) {
                console.error('Error loading athlete competition carousel:', e);
                body.innerHTML = '<div class="empty-state" style="padding:40px 0;"><p>Competition not available</p></div>';
            }
        }

        function renderAthleteCompSlide() {
            const body = document.getElementById('athleteCompBody');
            const slides = carouselState.athleteComp.slides;
            const idx = carouselState.athleteComp.currentSlide;

            if (!slides.length || !body) return;
            const slide = slides[idx];

            let html = `<div class="comp-slide-title">${slide.icon}${slide.label}</div>
            <div class="comp-podium-mini">`;

            [1, 0, 2].forEach(rank => {
                const item = slide.top3[rank];
                if (!item) return;
                const name = slide.nameMap[item.uuid] || 'Unknown';
                const team = slide.teamMap[item.uuid] || '';
                const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                const valueStr = slide.unit === 's' ? item.value.toFixed(3) + 's' : formatTime(item.value);
                const isMe = item.uuid === appState.athleteUuid;

                html += `<div class="comp-podium-item rank-${rank + 1}">
                    <div class="comp-avatar-mini" ${isMe ? 'style="background:linear-gradient(135deg,#a855f7,#7c3aed);box-shadow:0 0 12px rgba(168,85,247,0.4);"' : ''}>${initials}<div class="comp-medal-mini">${rank + 1}</div></div>
                    <div class="comp-name-mini" ${isMe ? 'style="color:var(--accent-purple);"' : ''}>${isMe ? 'You' : name}</div>
                    <div class="comp-team-mini">${team}</div>
                    <div class="comp-value-mini">${valueStr}</div>
                    <div class="comp-bar-mini"></div>
                </div>`;
            });

            html += `</div><div class="carousel-slide-label">Slide ${idx + 1} of ${slides.length}</div>`;
            body.innerHTML = html;

            document.querySelectorAll('#athleteCompDots .carousel-dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === idx);
            });
        }

        function renderAthleteCompDots() {
            const dotsEl = document.getElementById('athleteCompDots');
            if (!dotsEl) return;
            const slides = carouselState.athleteComp.slides;
            dotsEl.innerHTML = slides.map((s, i) => 
                `<div class="carousel-dot${i === carouselState.athleteComp.currentSlide ? ' active' : ''}" onclick="carouselState.athleteComp.currentSlide=${i};renderAthleteCompSlide();" title="${s.label}"></div>`
            ).join('');
        }

        // "" TEAM GOALS ""
        async function loadTeamGoals() {
            const container = document.getElementById('teamGoalsGrid');
            const countEl = document.getElementById('teamGoalsCount');
            if (!container) return;
            try {
                const athletes = await getTeamAthleteList();
                if (!athletes.length) {
                    container.innerHTML = '<button class="tg-add-btn" onclick="openTeamGoalModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add first team goal</button>';
                    return;
                }
                const uuids = athletes.map(a => a.athlete_uuid);
                const _uf5 = new Set(uuids);
                const _small5 = uuids.length <= SUPABASE_IN_LIMIT;
                const nameMap = {};
                athletes.forEach(a => { nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.'; });

                let _gq5 = supabaseClient.from('goals').select('*');
                if (_small5) _gq5 = _gq5.in('athlete_uuid', uuids);
                const { data: rawGoals, error } = await _gq5
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                const goals = _small5 ? rawGoals : (rawGoals||[]).filter(g => _uf5.has(g.athlete_uuid));

                if (countEl) countEl.textContent = goals?.length ? `(${goals.length})` : '';

                if (!goals?.length) {
                    container.innerHTML = '<div class="team-goals-grid"><button class="tg-add-btn" onclick="openTeamGoalModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Set a team goal</button></div>';
                    return;
                }

                // Fetch current bests per athlete per metric
                const _sq6 = supabaseClient.from('v_start_kpis').select('athlete_uuid, reaction_time_s, split_15m_s');
                const _tq6 = supabaseClient.from('v_turn_kpis').select('athlete_uuid, split_15m_s');
                const _rq6 = supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s, style, distance_m');
                const [startRes, turnRes, raceRes] = await Promise.all([
                    _small5 ? _sq6.in('athlete_uuid', uuids) : _sq6,
                    _small5 ? _tq6.in('athlete_uuid', uuids) : _tq6,
                    (_small5 ? _rq6.in('athlete_uuid', uuids) : _rq6).not('race_time_s', 'is', null)
                ]);

                const _ufilt5b = rows => _small5 ? rows : (rows||[]).filter(r => _uf5.has(r.athlete_uuid));
                // Build best-per-athlete lookups
                const bestReaction = {}, bestStart15 = {}, bestTurn15 = {}, bestRace = {};
                _ufilt5b(startRes.data||[]).forEach(d => {
                    const v = parseFloat(d.reaction_time_s); if (!isNaN(v) && (!bestReaction[d.athlete_uuid] || v < bestReaction[d.athlete_uuid])) bestReaction[d.athlete_uuid] = v;
                    const s = parseFloat(d.split_15m_s); if (!isNaN(s) && (!bestStart15[d.athlete_uuid] || s < bestStart15[d.athlete_uuid])) bestStart15[d.athlete_uuid] = s;
                });
                _ufilt5b(turnRes.data||[]).forEach(d => {
                    const v = parseFloat(d.split_15m_s); if (!isNaN(v) && (!bestTurn15[d.athlete_uuid] || v < bestTurn15[d.athlete_uuid])) bestTurn15[d.athlete_uuid] = v;
                });
                _ufilt5b(raceRes.data||[]).forEach(d => {
                    const key = d.athlete_uuid + '_' + d.distance_m + '_' + d.style;
                    const v = parseFloat(d.race_time_s); if (!isNaN(v) && (!bestRace[key] || v < bestRace[key])) bestRace[key] = v;
                });

                const getCurrentBest = (g) => {
                    const uuid = g.athlete_uuid;
                    if (g.goal_type === 'start_reaction') return bestReaction[uuid] ?? null;
                    if (g.goal_type === 'start_15m') return bestStart15[uuid] ?? null;
                    if (g.goal_type === 'turn_time') return bestTurn15[uuid] ?? null;
                    if (g.goal_type === 'race_time' && g.event_name) {
                        const parts = g.event_name.split(' ');
                        const key = uuid + '_' + parts[0] + '_' + parts.slice(1).join(' ');
                        return bestRace[key] ?? null;
                    }
                    return null;
                };

                const typeLabel = { race_time:'Race', start_reaction:'Start', start_15m:'Start', turn_time:'Turn' };
                const typeCss = { race_time:'race', start_reaction:'start', start_15m:'start', turn_time:'turn' };
                const colorMap = { race_time:getThemeColors().accent, start_reaction:getThemeColors().orange, start_15m:getThemeColors().orange, turn_time:getThemeColors().accent };

                const cards = goals.map(g => {
                    const current = getCurrentBest(g);
                    const target = parseFloat(g.target_value);
                    // For time goals, lower is better: progress = how much of the gap has been closed
                    let pct = 0;
                    if (current !== null && !isNaN(target) && g.current_best) {
                        const baseline = parseFloat(g.current_best);
                        const gap = baseline - target;
                        if (gap > 0) {
                            pct = Math.min(100, Math.max(0, ((baseline - current) / gap) * 100));
                        } else if (current <= target) {
                            pct = 100;
                        }
                    } else if (current !== null && !isNaN(target)) {
                        pct = current <= target ? 100 : Math.max(0, Math.min(95, (target / current) * 100));
                    }
                    const barColor = pct >= 100 ? getThemeColors().green : pct >= 60 ? colorMap[g.goal_type] || getThemeColors().accent : 'var(--text-muted)';
                    const eventDisplay = g.event_name || g.goal_type.replace(/_/g, ' ');

                    return `<div class="tg-card">
                        <div class="tg-actions">
                            ${pct >= 100 ? `<button class="tg-action-btn" title="Mark achieved" onclick="markTeamGoalAchieved('${g.goal_uuid}')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></button>` : ''}
                            <button class="tg-action-btn" title="Archive" onclick="archiveTeamGoal('${g.goal_uuid}')"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button>
                        </div>
                        <div class="tg-top">
                            <span class="tg-type ${typeCss[g.goal_type] || ''}">${typeLabel[g.goal_type] || g.goal_type}</span>
                            <span class="tg-athlete" onclick="coachSelectAthlete('${g.athlete_uuid}')">${nameMap[g.athlete_uuid] || 'Unknown'}</span>
                        </div>
                        <div class="tg-event">${eventDisplay}</div>
                        <div class="tg-progress">
                            <div class="tg-bar-track"><div class="tg-bar-fill" style="width:${pct.toFixed(0)}%;background:${barColor};"></div></div>
                            <div class="tg-pct" style="color:${barColor}">${pct.toFixed(0)}%</div>
                        </div>
                        <div class="tg-values">
                            <span>Current: <span class="tg-current">${current !== null ? formatTime(current) : '--'}</span></span>
                            <span>Target: ${formatTime(target)}</span>
                        </div>
                        ${g.notes ? `<div class="tg-notes">${g.notes}</div>` : ''}
                    </div>`;
                }).join('');

                container.innerHTML = `<div class="team-goals-grid">${cards}
                    <button class="tg-add-btn" onclick="openTeamGoalModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Goal
                    </button>
                </div>`;
            } catch (e) {
                console.error('Error loading team goals:', e);
                container.innerHTML = '<div class="empty-state"><p>Error loading goals</p></div>';
            }
        }

        // Team goal modal helpers
        async function openTeamGoalModal() {
            const modal = document.getElementById('teamGoalModal');
            modal.classList.add('active');

            // Populate athlete dropdown
            const athletes = await getTeamAthleteList();
            const aSel = document.getElementById('tgAthleteSelect');
            aSel.innerHTML = '<option value="">Select athlete...</option>' +
                athletes.map(a => `<option value="${a.athlete_uuid}">${a.first_name} ${a.last_name} (${a.athlete_code})</option>`).join('');

            // Reset fields
            document.getElementById('tgMetricSelect').value = '';
            document.getElementById('tgEventGroup').style.display = 'none';
            document.getElementById('tgCurrentGroup').style.display = 'none';
            document.getElementById('tgTargetInput').value = '';
            document.getElementById('tgNotesInput').value = '';
            document.getElementById('tgCurrentBest').textContent = '--';
        }

        function closeTeamGoalModal() {
            document.getElementById('teamGoalModal').classList.remove('active');
        }

        async function onTeamGoalMetricChange() {
            const metric = document.getElementById('tgMetricSelect').value;
            const eventGrp = document.getElementById('tgEventGroup');
            const currentGrp = document.getElementById('tgCurrentGroup');
            const currentEl = document.getElementById('tgCurrentBest');

            eventGrp.style.display = metric === 'race_time' ? 'block' : 'none';
            currentGrp.style.display = 'none';
            currentEl.textContent = '--';

            if (metric === 'race_time') {
                // Load events for selected athlete
                const uuid = document.getElementById('tgAthleteSelect').value;
                if (uuid) {
                    const { data } = await supabaseClient.from('v_race_kpis')
                        .select('style, distance_m').eq('athlete_uuid', uuid);
                    const events = [...new Set(data?.map(r => `${r.distance_m} ${r.style}`).filter(Boolean) || [])];
                    document.getElementById('tgEventSelect').innerHTML = '<option value="">Select event...</option>' +
                        events.map(e => `<option value="${e}">${e}</option>`).join('');
                }
            } else {
                const uuid = document.getElementById('tgAthleteSelect').value;
                if (uuid) {
                    // Show current best for non-race metrics
                    let best = null;
                    if (metric === 'start_reaction') {
                        const { data } = await supabaseClient.from('v_start_kpis').select('reaction_time_s')
                            .eq('athlete_uuid', uuid).not('reaction_time_s','is',null).order('reaction_time_s',{ascending:true}).limit(1);
                        if (data?.[0]) best = parseFloat(data[0].reaction_time_s);
                    } else if (metric === 'start_15m') {
                        const { data } = await supabaseClient.from('v_start_kpis').select('split_15m_s')
                            .eq('athlete_uuid', uuid).not('split_15m_s','is',null).order('split_15m_s',{ascending:true}).limit(1);
                        if (data?.[0]) best = parseFloat(data[0].split_15m_s);
                    } else if (metric === 'turn_time') {
                        const { data } = await supabaseClient.from('v_turn_kpis').select('split_15m_s')
                            .eq('athlete_uuid', uuid).not('split_15m_s','is',null).order('split_15m_s',{ascending:true}).limit(1);
                        if (data?.[0]) best = parseFloat(data[0].split_15m_s);
                    }
                    if (best !== null) {
                        currentGrp.style.display = 'block';
                        currentEl.textContent = formatTime(best);
                    }
                }
            }
        }

        async function saveTeamGoal() {
            const athleteUuid = document.getElementById('tgAthleteSelect').value;
            const goalType = document.getElementById('tgMetricSelect').value;
            const eventName = goalType === 'race_time' ? document.getElementById('tgEventSelect').value : goalType.replace(/_/g, ' ');
            const target = parseFloat(document.getElementById('tgTargetInput').value);
            const notes = document.getElementById('tgNotesInput').value.trim();

            if (!athleteUuid) { showToast('Please select an athlete', 'warning'); return; }
            if (!goalType) { showToast('Please select a metric', 'warning'); return; }
            if (goalType === 'race_time' && !document.getElementById('tgEventSelect').value) { showToast('Please select an event', 'warning'); return; }
            if (!target || isNaN(target)) { showToast('Please enter a valid target', 'warning'); return; }

            // Fetch current best
            let currentBest = null;
            try {
                if (goalType === 'race_time' && eventName) {
                    const parts = eventName.split(' ');
                    const dist = parseInt(parts[0]); const style = parts.slice(1).join(' ');
                    const { data } = await supabaseClient.from('v_race_kpis').select('race_time_s')
                        .eq('athlete_uuid', athleteUuid).eq('distance_m', dist).eq('style', style)
                        .not('race_time_s','is',null).order('race_time_s',{ascending:true}).limit(1);
                    if (data?.[0]) currentBest = data[0].race_time_s;
                } else if (goalType === 'start_reaction') {
                    const { data } = await supabaseClient.from('v_start_kpis').select('reaction_time_s')
                        .eq('athlete_uuid', athleteUuid).not('reaction_time_s','is',null).order('reaction_time_s',{ascending:true}).limit(1);
                    if (data?.[0]) currentBest = data[0].reaction_time_s;
                } else if (goalType === 'start_15m') {
                    const { data } = await supabaseClient.from('v_start_kpis').select('split_15m_s')
                        .eq('athlete_uuid', athleteUuid).not('split_15m_s','is',null).order('split_15m_s',{ascending:true}).limit(1);
                    if (data?.[0]) currentBest = data[0].split_15m_s;
                } else if (goalType === 'turn_time') {
                    const { data } = await supabaseClient.from('v_turn_kpis').select('split_15m_s')
                        .eq('athlete_uuid', athleteUuid).not('split_15m_s','is',null).order('split_15m_s',{ascending:true}).limit(1);
                    if (data?.[0]) currentBest = data[0].split_15m_s;
                }
            } catch(e) { console.error('Error fetching current best:', e); }

            try {
                const { error } = await supabaseClient.from('goals').insert({
                    athlete_uuid: athleteUuid,
                    created_by_uuid: appState.user.id,
                    created_by_role: 'coach',
                    goal_type: goalType,
                    event_name: eventName || null,
                    target_value: target,
                    current_best: currentBest,
                    notes: notes || null
                });
                if (error) throw error;
                closeTeamGoalModal();
                await loadTeamGoals();
            } catch (e) {
                console.error('Error saving team goal:', e);
                showToast('Error saving goal: ' + e.message, 'error');
            }
        }

        async function markTeamGoalAchieved(goalUuid) {
            if (!(await showConfirm('Mark this goal as achieved?', 'Confirm'))) return;
            try {
                const { error } = await supabaseClient.from('goals')
                    .update({ status: 'achieved', achieved_at: new Date().toISOString() })
                    .eq('goal_uuid', goalUuid);
                if (error) throw error;
                await loadTeamGoals();
            } catch (e) { console.error('Error marking goal:', e); showToast('Error: ' + e.message, 'error'); }
        }

        async function archiveTeamGoal(goalUuid) {
            if (!(await showConfirm('Archive this goal?', 'Archive Goal'))) return;
            try {
                const { error } = await supabaseClient.from('goals')
                    .update({ status: 'archived' })
                    .eq('goal_uuid', goalUuid);
                if (error) throw error;
                await loadTeamGoals();
            } catch (e) { console.error('Error archiving goal:', e); showToast('Error: ' + e.message, 'error'); }
        }

        // "" 5. RECENT TEAM ACTIVITY ""
        async function loadTeamActivity() {
            const container = document.getElementById('teamActivityFeed');
            if (!container) return;
            try {
                const athletes = await getTeamAthleteList();
                if (!athletes.length) {
                    container.innerHTML = '<p style="color:var(--text-muted);font-size:12px;padding:8px;">No team activity yet</p>';
                    return;
                }
                const uuids = athletes.map(a => a.athlete_uuid);
                const _uf7 = new Set(uuids);
                const _small7 = uuids.length <= SUPABASE_IN_LIMIT;
                const _ufilt7 = rows => _small7 ? rows : (rows||[]).filter(r => _uf7.has(r.athlete_uuid));
                const nameMap = {};
                athletes.forEach(a => { nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name; });

                const _sq7 = supabaseClient.from('v_start_kpis').select('athlete_uuid, source_date, style, reaction_time_s');
                const _tq7 = supabaseClient.from('v_turn_kpis').select('athlete_uuid, source_date, style');
                const _rq7 = supabaseClient.from('v_race_kpis').select('athlete_uuid, source_date, style, distance_m, race_time_s, course');
                const [startRes, turnRes, raceRes] = await Promise.all([
                    (_small7 ? _sq7.in('athlete_uuid', uuids) : _sq7).order('source_date', { ascending: false }).limit(50),
                    (_small7 ? _tq7.in('athlete_uuid', uuids) : _tq7).order('source_date', { ascending: false }).limit(50),
                    (_small7 ? _rq7.in('athlete_uuid', uuids) : _rq7).not('race_time_s', 'is', null).order('source_date', { ascending: false }).limit(50)
                ]);

                // Merge and sort all activities
                const activities = [];
                _ufilt7(startRes.data||[]).forEach(d => activities.push({
                    uuid: d.athlete_uuid, name: nameMap[d.athlete_uuid], type: 'start',
                    date: d.source_date, desc: `Start | ${d.style||'freestyle'} | RT ${parseFloat(d.reaction_time_s||0).toFixed(3)}s`
                }));
                _ufilt7(turnRes.data||[]).forEach(d => activities.push({
                    uuid: d.athlete_uuid, name: nameMap[d.athlete_uuid], type: 'turn',
                    date: d.source_date, desc: `Turn | ${d.style||'freestyle'}`
                }));
                _ufilt7(raceRes.data||[]).forEach(d => { const _u = (d.course||'SCY').toUpperCase() === 'SCY' ? 'Yds' : 'm'; activities.push({
                    uuid: d.athlete_uuid, name: nameMap[d.athlete_uuid], type: 'race',
                    date: d.source_date, desc: `Race | ${d.distance_m||''} ${_u} ${d.style||''} (${(d.course||'SCY').toUpperCase()}) | ${formatTime(parseFloat(d.race_time_s))}`
                }); });

                activities.sort((a,b) => (b.date||'').localeCompare(a.date||''));
                const recent = activities.slice(0, 12);

                if (!recent.length) {
                    container.innerHTML = '<p style="color:var(--text-muted);font-size:12px;padding:8px;">No recent activity</p>';
                    return;
                }

                const now = Date.now();
                container.innerHTML = '<div class="activity-feed">' + recent.map(a => {
                    const daysAgo = a.date ? Math.floor((now - new Date(a.date)) / 86400000) : null;
                    const timeStr = daysAgo === null ? '' : daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : daysAgo + 'd ago';
                    const navPage = a.type === 'race' ? 'races' : a.type === 'start' ? 'starts' : 'turns';
                    return `<div class="activity-item" onclick="coachSelectAthlete('${a.uuid}'); setTimeout(()=>navigateTo('${navPage}'),100);">
                        <div class="activity-dot ${a.type}"></div>
                        <div class="activity-info">
                            <div class="activity-name">${a.name}</div>
                            <div class="activity-desc">${a.desc}</div>
                        </div>
                        <div class="activity-time">${timeStr}</div>
                    </div>`;
                }).join('') + '</div>';
            } catch (e) {
                console.error('Error loading team activity:', e);
                container.innerHTML = '<p style="color:var(--text-muted);font-size:12px;padding:8px;">Error loading activity</p>';
            }
        }

        async function loadLastSession() {
            const card = document.getElementById('lastSessionCard');
            const body = document.getElementById('lastSessionBody');

            try {
                const athleteUuid = appState.role === 'athlete'
                    ? appState.athleteUuid
                    : appState.selectedAthleteUuid;

                if (!athleteUuid) { card.style.display = 'none'; return; }

                // Fetch most recent entry from each type
                const [startRes, turnRes, raceRes] = await Promise.all([
                    supabaseClient.from('v_start_kpis')
                        .select('reaction_time_s, split_15m_s, source_date, style')
                        .eq('athlete_uuid', athleteUuid)
                        .order('source_date', { ascending: false })
                        .limit(1),
                    supabaseClient.from('v_turn_kpis')
                        .select('split_15m_s, source_date, style')
                        .eq('athlete_uuid', athleteUuid)
                        .order('source_date', { ascending: false })
                        .limit(1),
                    supabaseClient.from('v_race_kpis')
                        .select('race_time_s, style, distance_m, source_date, course')
                        .eq('athlete_uuid', athleteUuid)
                        .not('race_time_s', 'is', null)
                        .order('source_date', { ascending: false })
                        .limit(1)
                ]);

                const s = startRes.data?.[0];
                const t = turnRes.data?.[0];
                const r = raceRes.data?.[0];

                if (!s && !t && !r) { card.style.display = 'none'; return; }

                const ago = (dateStr) => {
                    if (!dateStr) return '';
                    const d = Math.floor((Date.now() - new Date(dateStr)) / 86400000);
                    return d === 0 ? 'Today' : d === 1 ? 'Yesterday' : d < 7 ? d + 'd ago' : formatDate(dateStr);
                };

                const arrowSvg = '<svg class="chip-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>';

                let html = '';

                if (s) {
                    html += `<div class="last-session-chip" onclick="navigateTo('starts')">
                        <div class="chip-icon start-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg></div>
                        <div class="chip-text">
                            <div class="chip-title">Last Start${s.style ? ' | ' + s.style : ''} <span class="chip-date">${ago(s.source_date)}</span></div>
                            <div class="chip-values">
                                ${s.reaction_time_s ? '<div class="chip-val-group"><span class="chip-val">' + parseFloat(s.reaction_time_s).toFixed(3) + 's</span><span class="chip-val-label">Reaction</span></div>' : ''}
                                ${s.split_15m_s ? '<div class="chip-val-group"><span class="chip-val">' + parseFloat(s.split_15m_s).toFixed(2) + 's</span><span class="chip-val-label">15m Split</span></div>' : ''}
                            </div>
                        </div>
                        ${arrowSvg}
                    </div>`;
                }

                if (t) {
                    html += `<div class="last-session-chip" onclick="navigateTo('turns')">
                        <div class="chip-icon turn-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg></div>
                        <div class="chip-text">
                            <div class="chip-title">Last Turn${t.style ? ' | ' + t.style : ''} <span class="chip-date">${ago(t.source_date)}</span></div>
                            <div class="chip-values">
                                ${t.split_15m_s ? '<div class="chip-val-group"><span class="chip-val">' + parseFloat(t.split_15m_s).toFixed(2) + 's</span><span class="chip-val-label">15m Split</span></div>' : ''}
                            </div>
                        </div>
                        ${arrowSvg}
                    </div>`;
                }

                if (r) {
                    html += `<div class="last-session-chip" onclick="navigateTo('races')">
                        <div class="chip-icon race-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg></div>
                        <div class="chip-text">
                            <div class="chip-title">Last Race | ${r.distance_m || ''} ${(r.course||'SCY').toUpperCase() === 'SCY' ? 'Yds' : 'm'} ${r.style || ''} <span class="rc-course-tag">${(r.course||'SCY').toUpperCase()}</span> <span class="chip-date">${ago(r.source_date)}</span></div>
                            <div class="chip-values">
                                <div class="chip-val-group"><span class="chip-val">${formatTime(r.race_time_s)}</span><span class="chip-val-label">Final Time</span></div>
                            </div>
                        </div>
                        ${arrowSvg}
                    </div>`;
                }

                card.style.display = 'block';
                body.innerHTML = html;
            } catch (e) {
                console.error('Error loading last session:', e);
                card.style.display = 'none';
            }
        }

        async function loadRecentSessions() {
            const container = document.getElementById('recentSessions');
            
            try {
                let query = supabaseClient.from('v_athlete_sessions')
                    .select('*')
                    .order('session_date', { ascending: false })
                    .limit(10);

                if (appState.role === 'athlete') {
                    query = query.eq('athlete_uuid', appState.athleteUuid);
                } else if (appState.selectedAthleteUuid) {
                    query = query.eq('athlete_uuid', appState.selectedAthleteUuid);
                }

                const { data, error } = await query;
                if (error) throw error;

                if (!data?.length) {
                    container.innerHTML = '<div class="empty-state"><h3>No sessions found</h3><p>Sessions will appear here once data is uploaded.</p></div>';
                    return;
                }

                container.innerHTML = data.map(session => `
                    <div class="session-card">
                        <div class="session-date">${formatDate(session.session_date)}</div>
                        <div class="session-name">${session.session_name || 'Training Session'}</div>
                        <div class="session-stats">
                            <div class="session-stat">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                                ${session.start_trials || 0} starts
                            </div>
                            <div class="session-stat">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9"></path></svg>
                                ${session.turn_trials || 0} turns
                            </div>
                            <div class="session-stat">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3"></path></svg>
                                ${session.race_trials || 0} races
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                console.error('Error loading sessions:', e);
                container.innerHTML = '<div class="empty-state"><h3>Error loading sessions</h3></div>';
            }
        }

        // ============================================
        // DATA LOADING - STARTS (Modular v01.21)
        // ============================================
        let startModuleState = {
            allStarts: [],
            filteredStarts: [],
            primaryIdx: null,
            compareIdx: null,
            activeTab: 'block',
            _groupUuids: null,
            _genderFilter: '',
            _multiAthlete: false,
            _nameMap: {},
            _sampleMode: false
        };

        // Convenience getters
        function getStartPrimary() { return startModuleState.primaryIdx !== null ? startModuleState.filteredStarts[startModuleState.primaryIdx] : null; }
        function getStartCompare() { return startModuleState.compareIdx !== null ? startModuleState.filteredStarts[startModuleState.compareIdx] : null; }
        function hasStartSelection() { return startModuleState.primaryIdx !== null; }
        function hasStartComparison() { return startModuleState.compareIdx !== null; }

        // Label helpers
        function startLabel(s) {
            const style = (s.style || 'Start').charAt(0).toUpperCase() + (s.style || 'start').slice(1);
            return `${style} - ${formatDate(s.source_date)}`;
        }

        // "" INIT COACH BAR ""
        async function initStartCoachBar() {
            const scopeRow = document.querySelector('#startFilterBar .rfb-start-coach');
            if (appState.role !== 'coach' || !appState.teamUuid) {
                if (scopeRow) scopeRow.style.display = 'none';
                return;
            }
            if (scopeRow) scopeRow.style.display = 'flex';

            // Populate athlete dropdown
            const athletes = _allTeamAthletes || await (async () => {
                const { data } = await supabaseClient.from('athletes')
                    .select('athlete_uuid, first_name, last_name, athlete_code, gender')
                    .eq('team_uuid', appState.teamUuid).eq('membership_status', 'active');
                _allTeamAthletes = data || [];
                return _allTeamAthletes;
            })();
            const athSelect = document.getElementById('startAthleteFilter');
            const current = appState.selectedAthleteUuid || '';
            athSelect.innerHTML = '<option value="">All Team</option>' +
                athletes.sort((a,b)=>(a.last_name||'').localeCompare(b.last_name||''))
                .map(a => `<option value="${a.athlete_uuid}" ${a.athlete_uuid===current?'selected':''}>${a.first_name} ${a.last_name}</option>`).join('');

            // Populate group dropdown
            const groups = _teamGroups || [];
            const grpSelect = document.getElementById('startGroupFilter');
            grpSelect.innerHTML = '<option value="">No Group</option>' +
                groups.map(g => `<option value="${g.group_uuid}">${g.group_name}</option>`).join('');
        }

        // "" COACH SCOPE HANDLERS ""
        async function onStartAthleteChange() {
            const val = document.getElementById('startAthleteFilter').value;
            if (val) {
                document.getElementById('startGroupFilter').value = '';
                document.getElementById('startGenderFilter').value = '';
                startModuleState._groupUuids = null;
                startModuleState._genderFilter = '';
            }
            appState.selectedAthleteUuid = val || null;
            await loadStartRawData();
            applyStartFilters();
        }

        async function onStartGroupChange() {
            const groupUuid = document.getElementById('startGroupFilter').value;
            if (groupUuid) {
                document.getElementById('startAthleteFilter').value = '';
                appState.selectedAthleteUuid = null;
                const { data } = await supabaseClient.from('athlete_group_members')
                    .select('athlete_uuid').eq('group_uuid', groupUuid);
                startModuleState._groupUuids = (data||[]).map(m => m.athlete_uuid);
            } else {
                startModuleState._groupUuids = null;
            }
            await loadStartRawData();
            applyStartFilters();
        }

        async function onStartGenderChange() {
            const gender = document.getElementById('startGenderFilter').value;
            startModuleState._genderFilter = gender;
            if (gender) {
                document.getElementById('startAthleteFilter').value = '';
                appState.selectedAthleteUuid = null;
            }
            await loadStartRawData();
            applyStartFilters();
        }

        function updateStartInfoBadge() {
            const infoEl = document.getElementById('startCoachInfo');
            if (!infoEl || appState.role !== 'coach') return;
            const starts = startModuleState.allStarts;
            const uniqueAthletes = new Set(starts.map(s => s.athlete_uuid)).size;
            const parts = [];
            parts.push(`${starts.length} trial${starts.length!==1?'s':''}`);
            if (startModuleState._multiAthlete) parts.push(`from ${uniqueAthletes} athlete${uniqueAthletes!==1?'s':''}`);
            const gf = startModuleState._genderFilter;
            if (gf) parts.push(`(${gf})`);
            infoEl.textContent = parts.join(' ');
            infoEl.style.display = 'flex';
        }

        // "" MAIN LOAD ""
        async function loadStartData() {
            await initStartCoachBar();

            // Wire filters (only once - use onchange directly)
            document.getElementById('startStyleFilter').onchange = () => { clearStartSelection(); applyStartFilters(); };
            document.getElementById('startDateFilter').onchange = () => { clearStartSelection(); applyStartFilters(); };

            // Wire tab bar
            document.querySelectorAll('#startTabBar .start-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('#startTabBar .start-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.start-tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    startModuleState.activeTab = tab.dataset.tab;
                    const content = document.getElementById('startTab-' + tab.dataset.tab);
                    if (content) content.classList.add('active');
                    renderAllStartVisuals();
                };
            });

            if (startModuleState._sampleMode) {
                // Already in sample mode - just re-render
                renderStartSelectorCards();
                renderAllStartVisuals();
                return;
            }

            await loadStartRawData();
            applyStartFilters();
        }

        async function loadStartRawData() {
            try {
                const athleteUuid = appState.selectedAthleteUuid || appState.athleteUuid;
                const groupUuids = startModuleState._groupUuids;
                const genderFilter = startModuleState._genderFilter || '';
                let query = supabaseClient.from('v_start_kpis').select('*').order('source_date', { ascending: false });

                console.log('[loadStartRawData] role:', appState.role, 'athleteUuid:', athleteUuid, 'groupUuids:', groupUuids, 'gender:', genderFilter, '_allTeamAthletes count:', (_allTeamAthletes||[]).length);

                // Build scope
                let scopeUuids = null;       // null = no filtering needed
                let clientFilterSet = null;   // Set for post-query filtering when .in() is too large
                if (groupUuids && groupUuids.length) {
                    scopeUuids = groupUuids;
                    startModuleState._multiAthlete = true;
                } else if (athleteUuid) {
                    query = query.eq('athlete_uuid', athleteUuid);
                    startModuleState._multiAthlete = false;
                } else if (appState.role === 'coach' && appState.teamUuid) {
                    // All Team mode - don't filter, load everything
                    scopeUuids = (_allTeamAthletes || []).map(a => a.athlete_uuid);
                    startModuleState._multiAthlete = true;
                } else {
                    startModuleState._multiAthlete = false;
                }

                // Apply gender filter - narrow scopeUuids to matching athletes
                if (genderFilter && appState.role === 'coach' && _allTeamAthletes) {
                    const genderUuids = new Set(_allTeamAthletes
                        .filter(a => a.gender === genderFilter)
                        .map(a => a.athlete_uuid));
                    if (scopeUuids) {
                        scopeUuids = scopeUuids.filter(u => genderUuids.has(u));
                    } else {
                        scopeUuids = [...genderUuids];
                    }
                    startModuleState._multiAthlete = true;
                }

                // Apply scope to query - use .in() for small sets, client-side filter for large
                if (scopeUuids) {
                    if (!scopeUuids.length) {
                        startModuleState.allStarts = [];
                        updateStartInfoBadge();
                        populateStartStyleFilter();
                        return;
                    }
                    if (scopeUuids.length <= SUPABASE_IN_LIMIT) {
                        query = query.in('athlete_uuid', scopeUuids);
                    } else {
                        // Too many UUIDs for URL - skip .in(), filter client-side after fetch
                        clientFilterSet = new Set(scopeUuids);
                        console.log('[loadStartRawData] Using client-side filter for', scopeUuids.length, 'athletes');
                    }
                }

                const { data, error } = await query;
                console.log('[loadStartRawData] query returned:', (data||[]).length, 'rows, error:', error ? JSON.stringify(error) : null);
                if (error) throw new Error(JSON.stringify(error));

                // Client-side filter if needed
                let rows = data || [];
                if (clientFilterSet) {
                    rows = rows.filter(s => clientFilterSet.has(s.athlete_uuid));
                    console.log('[loadStartRawData] after client filter:', rows.length, 'rows');
                }

                // Build name map
                const nameMap = {};
                if (_allTeamAthletes) {
                    _allTeamAthletes.forEach(a => { nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.'; });
                }
                startModuleState._nameMap = nameMap;

                // Deduplicate
                const seen = new Set();
                const deduped = [];
                rows.forEach(s => {
                    if (s.trial_uuid) {
                        if (seen.has('t:' + s.trial_uuid)) return;
                        seen.add('t:' + s.trial_uuid);
                        deduped.push(s);
                        return;
                    }
                    const key = [
                        s.athlete_uuid || '',
                        s.source_date || '',
                        (s.style || '').toLowerCase(),
                        s.reaction_time_s != null ? parseFloat(s.reaction_time_s).toFixed(3) : '',
                        s.split_15m_s != null ? parseFloat(s.split_15m_s).toFixed(2) : ''
                    ].join('|');
                    if (!seen.has('f:' + key)) {
                        seen.add('f:' + key);
                        deduped.push(s);
                    }
                });
                startModuleState.allStarts = deduped;
                console.log('[loadStartRawData] after dedup:', deduped.length, 'starts');

                updateStartInfoBadge();
                populateStartStyleFilter();
            } catch (e) {
                console.error('[loadStartRawData] ERROR:', e);
                startModuleState.allStarts = [];
            }
        }

        function populateStartStyleFilter() {
            const styles = [...new Set(startModuleState.allStarts.map(s => s.style).filter(Boolean))];
            const styleSel = document.getElementById('startStyleFilter');
            if (styleSel) {
                styleSel.innerHTML = '<option value="">All Strokes</option>' +
                    styles.sort().map(st => `<option value="${st}">${st.charAt(0).toUpperCase() + st.slice(1)}</option>`).join('');
            }
        }

        function applyStartFilters() {
            const styleVal = document.getElementById('startStyleFilter')?.value || '';
            const dateVal = document.getElementById('startDateFilter')?.value || '';
            let filtered = [...startModuleState.allStarts];
            if (styleVal) filtered = filtered.filter(s => s.style === styleVal);
            if (dateVal) {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - parseInt(dateVal));
                filtered = filtered.filter(s => new Date(s.source_date) >= cutoff);
            }
            startModuleState.filteredStarts = filtered;
            startModuleState.primaryIdx = null;
            startModuleState.compareIdx = null;
            renderStartSelectorCards();
            renderAllStartVisuals();
        }

        function renderStartSelectorCards() {
            const container = document.getElementById('startSelectorList');
            const clearBtn = document.getElementById('startClearBtn');
            const hint = document.getElementById('startSelectorHint');
            const starts = startModuleState.filteredStarts;
            const multi = startModuleState._multiAthlete;
            const nameMap = startModuleState._nameMap || {};
            const isSample = startModuleState._sampleMode;

            if (!starts.length) {
                container.innerHTML = sampleBannerHTML('start');
                if (clearBtn) clearBtn.style.display = 'none';
                if (hint) hint.textContent = '';
                return;
            }

            let topHtml = '';
            if (isSample) topHtml = sampleActiveBannerHTML('start');

            container.innerHTML = topHtml + starts.map((s, i) => {
                let cls = 'start-card-pick';
                let badge = '';
                if (i === startModuleState.primaryIdx) { cls += ' selected-primary'; badge = '<span class="sc-badge">Primary</span>'; }
                else if (i === startModuleState.compareIdx) { cls += ' selected-compare'; badge = '<span class="sc-badge">Compare</span>'; }
                const reaction = parseFloat(s.reaction_time_s);
                const reactionStr = !isNaN(reaction) ? reaction.toFixed(3) + 's' : '--';
                const t15 = parseFloat(s.split_15m_s);
                const t15Str = !isNaN(t15) ? t15.toFixed(2) + 's to 15m' : '';
                const athName = multi ? `<div class="rc-athlete">${nameMap[s.athlete_uuid]||'Unknown'}</div>` : '';
                return `<div class="${cls}" onclick="selectStartCard(${i})">${badge}${athName}
                    <div class="sc-style">${s.style || 'Start'}${isSample ? sampleBadgeHTML() : ''}</div>
                    <div class="sc-reaction">${reactionStr}</div>
                    <div class="sc-sub">${t15Str}</div>
                    <div class="sc-date">${formatDate(s.source_date)}</div>
                </div>`;
            }).join('');

            const hasSel = hasStartSelection();
            if (clearBtn) clearBtn.style.display = hasSel ? 'inline' : 'none';
            if (hint) {
                if (!hasSel) hint.innerHTML = '<svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>Click a trial to view details. Click a second to compare.';
                else if (!hasStartComparison()) hint.innerHTML = '<svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>Click another trial to compare, or click the selected one to deselect.';
                else hint.textContent = 'Two trials selected for comparison. Click a selected trial to deselect.';
            }
        }

        function selectStartCard(idx) {
            if (startModuleState.primaryIdx === idx) {
                startModuleState.primaryIdx = startModuleState.compareIdx;
                startModuleState.compareIdx = null;
            } else if (startModuleState.compareIdx === idx) {
                startModuleState.compareIdx = null;
            } else if (startModuleState.primaryIdx === null) {
                startModuleState.primaryIdx = idx;
            } else if (startModuleState.compareIdx === null) {
                startModuleState.compareIdx = idx;
            } else {
                startModuleState.compareIdx = idx;
            }
            renderStartSelectorCards();
            renderAllStartVisuals();
        }

        function clearStartSelection() {
            startModuleState.primaryIdx = null;
            startModuleState.compareIdx = null;
            renderStartSelectorCards();
            renderAllStartVisuals();
        }

        function renderAllStartVisuals() {
            renderStartKPIs();
            renderStartTrials();
            const tab = startModuleState.activeTab;
            if (tab === 'block') renderBlockPhaseTab();
            else if (tab === 'flight') renderFlightEntryTab();
            else if (tab === 'underwater') renderUnderwaterTab();
            else if (tab === 'velocity') renderStartVelocityTab();
            else if (tab === 'summary') renderStartSummary();
        }

        // Delta helper for start metrics (lower is better for time metrics)
        function startDelta(a, b, lowerBetter = true) {
            if (a == null || b == null || isNaN(a) || isNaN(b)) return '';
            const diff = a - b;
            if (Math.abs(diff) < 0.001) return '<span class="smi-delta neutral">0.000</span>';
            const better = lowerBetter ? diff < 0 : diff > 0;
            const cls = better ? 'positive' : 'negative';
            const sign = diff > 0 ? '+' : '';
            return `<span class="smi-delta ${cls}">${sign}${diff.toFixed(3)}</span>`;
        }

        // Start metric card HTML helper
        function startMetricCard(label, value, unit, deltaHtml) {
            return `<div class="start-metric-item">
                <div class="smi-label">${label}</div>
                <div class="smi-value">${value}<span class="smi-unit">${unit}</span>${deltaHtml || ''}</div>
            </div>`;
        }

        // "" KPIs ""
        function renderStartKPIs() {
            const container = document.getElementById('startKpis');
            const starts = startModuleState.filteredStarts;
            const prim = getStartPrimary();
            const comp = getStartCompare();

            if (!starts.length) {
                container.innerHTML = '<div class="empty-state"><h3>No start data available</h3></div>';
                return;
            }

            const avg = (arr, key) => { const vals = arr.map(r => parseFloat(r[key])).filter(v => !isNaN(v)); return vals.length ? vals.reduce((a,b) => a+b, 0) / vals.length : NaN; };
            const best = (arr, key) => { const vals = arr.map(r => parseFloat(r[key])).filter(v => !isNaN(v)); return vals.length ? Math.min(...vals) : NaN; };
            const pf = (v, d=3) => isNaN(v) ? '--' : v.toFixed(d);

            const badgeAvg = '<span class="kpi-context-badge average">Average</span>';
            const badgeSel = '<span class="kpi-context-badge single">Selected</span>';

            if (!prim) {
                // Aggregate mode
                const avgReact = avg(starts, 'reaction_time_s');
                const bestReact = best(starts, 'reaction_time_s');
                const avgFlight = avg(starts, 'flight_phase_s');
                const avg15 = avg(starts, 'split_15m_s');
                const best15 = best(starts, 'split_15m_s');
                const avgVel = avg(starts, 'avg_vel_0_5');

                container.innerHTML = `
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>${badgeAvg}</div><div class="kpi-value">${pf(avgReact)}s</div><div class="kpi-label">Avg Reaction Time ${infoTip(TIPS.reactionTime)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div></div><div class="kpi-value">${pf(bestReact)}s</div><div class="kpi-label">Best Reaction</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>${badgeAvg}</div><div class="kpi-value">${pf(avgFlight, 2)}s</div><div class="kpi-label">Avg Flight Phase ${infoTip(TIPS.flightPhase)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>${badgeAvg}</div><div class="kpi-value">${pf(avg15, 2)}s</div><div class="kpi-label">Avg 15m Split ${infoTip(TIPS.split15m)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div></div><div class="kpi-value">${pf(best15, 2)}s</div><div class="kpi-label">Best 15m Split</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg></div>${badgeAvg}</div><div class="kpi-value">${pf(avgVel, 2)} m/s</div><div class="kpi-label">Avg 0-5m Velocity ${infoTip(TIPS.velocity05)}</div></div>
                `;
            } else if (!comp) {
                // Single selected
                const r = prim;
                const bestReact = best(starts, 'reaction_time_s');
                const best15 = best(starts, 'split_15m_s');
                const reaction = parseFloat(r.reaction_time_s);
                const flight = parseFloat(r.flight_phase_s);
                const push = parseFloat(r.push_time_s);
                const s15 = parseFloat(r.split_15m_s);
                const vel05 = parseFloat(r.avg_vel_0_5);

                container.innerHTML = `
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div></div><div class="kpi-value">${pf(bestReact)}s</div><div class="kpi-label">Best Reaction (all)</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>${badgeSel}</div><div class="kpi-value">${pf(reaction)}s</div><div class="kpi-label">Reaction Time ${infoTip(TIPS.reactionTime)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>${badgeSel}</div><div class="kpi-value">${pf(flight, 2)}s</div><div class="kpi-label">Flight Phase ${infoTip(TIPS.flightPhase)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>${badgeSel}</div><div class="kpi-value">${pf(s15, 2)}s</div><div class="kpi-label">15m Split ${infoTip(TIPS.split15m)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon purple"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div></div><div class="kpi-value">${pf(best15, 2)}s</div><div class="kpi-label">Best 15m (all)</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg></div>${badgeSel}</div><div class="kpi-value">${pf(vel05, 2)} m/s</div><div class="kpi-label">0-5m Velocity ${infoTip(TIPS.velocity05)}</div></div>
                `;
            } else {
                // Comparison mode
                const rp = prim, rc = comp;
                const bestReact = best(starts, 'reaction_time_s');
                const rpReact = parseFloat(rp.reaction_time_s), rcReact = parseFloat(rc.reaction_time_s);
                const rpFlight = parseFloat(rp.flight_phase_s), rcFlight = parseFloat(rc.flight_phase_s);
                const rp15 = parseFloat(rp.split_15m_s), rc15 = parseFloat(rc.split_15m_s);
                const rpVel = parseFloat(rp.avg_vel_0_5), rcVel = parseFloat(rc.avg_vel_0_5);

                const dReact = startDelta(rpReact, rcReact, true);
                const dFlight = startDelta(rpFlight, rcFlight, true);
                const d15 = startDelta(rp15, rc15, true);
                const dVel = startDelta(rpVel, rcVel, false);

                container.innerHTML = `
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg></div></div><div class="kpi-value">${pf(bestReact)}s</div><div class="kpi-label">Best Reaction (all)</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon orange"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div></div><div class="kpi-value">${pf(rpReact)}s ${dReact}</div><div class="kpi-label">Primary Reaction</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div></div><div class="kpi-value">${pf(rcReact)}s</div><div class="kpi-label">Compare Reaction</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div></div><div class="kpi-value">${pf(rp15, 2)}s ${d15}</div><div class="kpi-label">Primary 15m</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon cyan"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div></div><div class="kpi-value">${pf(rc15, 2)}s</div><div class="kpi-label">Compare 15m</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg></div></div><div class="kpi-value">${pf(rpVel, 2)} ${dVel}</div><div class="kpi-label">Primary 0-5m Vel</div></div>
                `;
            }
        }

        // "" Trials Table ""
        function renderStartTrials() {
            const container = document.getElementById('startTrialsTable');
            const starts = startModuleState.filteredStarts;
            const multi = startModuleState._multiAthlete;
            const nameMap = startModuleState._nameMap || {};

            if (!starts.length) {
                container.innerHTML = '<div class="empty-state"><h3>No start trials found</h3></div>';
                return;
            }

            container.innerHTML = `<div style="overflow-x:auto;"><table class="data-table start-trials-table"><thead><tr>
                ${multi ? '<th>Athlete</th>' : ''}
                <th>Date</th><th>Style</th><th>Reaction</th><th>Push</th><th>Flight</th><th>5m</th><th>10m</th><th>15m</th><th>Vel 0-5m</th>
            </tr></thead><tbody>${starts.map((s, i) => {
                let cls = '';
                if (i === startModuleState.primaryIdx) cls = 'row-primary';
                else if (i === startModuleState.compareIdx) cls = 'row-compare';
                return `<tr class="${cls}" style="cursor:pointer;" onclick="selectStartCard(${i})">
                    ${multi ? `<td style="font-size:12px;font-weight:500;color:var(--accent-blue);">${nameMap[s.athlete_uuid]||'--'}</td>` : ''}
                    <td>${formatDate(s.source_date)}</td>
                    <td style="text-transform:capitalize">${s.style || '--'}</td>
                    <td class="mono">${formatTime(s.reaction_time_s)}</td>
                    <td class="mono">${formatTime(s.push_time_s)}</td>
                    <td class="mono">${formatTime(s.flight_phase_s)}</td>
                    <td class="mono">${formatTime(s.split_5m_s)}</td>
                    <td class="mono">${formatTime(s.split_10m_s)}</td>
                    <td class="mono">${formatTime(s.split_15m_s)}</td>
                    <td class="mono">${formatVelocity(s.avg_vel_0_5)}</td>
                </tr>`;
            }).join('')}</tbody></table></div>`;
        }

        // "" Block Phase Tab ""
        function renderBlockPhaseTab() {
            const container = document.getElementById('startBlockPhaseContent');
            const prim = getStartPrimary();
            const comp = getStartCompare();

            if (!prim) {
                // Show aggregate chart across all trials
                const starts = startModuleState.filteredStarts;
                if (!starts.length) { container.innerHTML = '<div class="empty-state"><h3>No start data</h3></div>'; return; }

                const avgReaction = starts.reduce((s,d) => s + (parseFloat(d.reaction_time_s)||0), 0) / starts.length;
                const avgPush = starts.reduce((s,d) => s + (parseFloat(d.push_time_s)||0), 0) / starts.length;
                const avgFlight = starts.reduce((s,d) => s + (parseFloat(d.flight_phase_s)||0), 0) / starts.length;
                const total = avgReaction + avgPush + avgFlight || 1;

                container.innerHTML = `
                    <div style="margin-bottom:16px;">
                        <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Average Phase Breakdown</h3>
                        <p style="font-size:12px; color:var(--text-muted);">Select a trial for detailed block phase data</p>
                    </div>
                    <div class="phase-bar-stack">
                        <div class="phase-bar-segment" style="width:${(avgReaction/total*100).toFixed(1)}%; background:rgba(245,166,35,0.85);">
                            <span class="seg-label">Reaction</span><span class="seg-value">${avgReaction.toFixed(3)}s</span>
                        </div>
                        <div class="phase-bar-segment" style="width:${(avgPush/total*100).toFixed(1)}%; background:rgba(0,194,255,0.85);">
                            <span class="seg-label">Push</span><span class="seg-value">${avgPush.toFixed(3)}s</span>
                        </div>
                        <div class="phase-bar-segment" style="width:${(avgFlight/total*100).toFixed(1)}%; background:rgba(168,85,247,0.85);">
                            <span class="seg-label">Flight</span><span class="seg-value">${avgFlight.toFixed(3)}s</span>
                        </div>
                    </div>
                    <div class="start-metric-grid" style="margin-top:16px;">
                        ${startMetricCard('Avg Reaction', avgReaction.toFixed(3), 's', '')}
                        ${startMetricCard('Avg Push Time', avgPush.toFixed(3), 's', '')}
                        ${startMetricCard('Avg Flight Phase', avgFlight.toFixed(3), 's', '')}
                        ${startMetricCard('Total Trials', starts.length, '', '')}
                    </div>
                `;
                return;
            }

            // Single or comparison mode
            const reaction = parseFloat(prim.reaction_time_s) || 0;
            const push = parseFloat(prim.push_time_s) || 0;
            const flight = parseFloat(prim.flight_phase_s) || 0;
            const blockEmpty = parseFloat(prim.block_empty_s) || 0;
            const blockReaction = parseFloat(prim.block_reaction_s) || 0;
            const blockGrabRelease = parseFloat(prim.block_grab_release_s) || 0;
            const blockPushDur = parseFloat(prim.block_pushing_duration_s) || 0;
            const total = reaction + push + flight || 1;

            let html = `<div style="margin-bottom:16px;">
                <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Block Phase - ${startLabel(prim)}</h3>
                ${comp ? `<p style="font-size:12px; color:var(--accent-cyan);">Compared with ${startLabel(comp)}</p>` : ''}
            </div>`;

            // Phase bar for primary
            html += `<div class="phase-bar-stack">
                <div class="phase-bar-segment" style="width:${(reaction/total*100).toFixed(1)}%; background:rgba(245,166,35,0.85);">
                    <span class="seg-label">Reaction</span><span class="seg-value">${reaction.toFixed(3)}s</span>
                </div>
                <div class="phase-bar-segment" style="width:${(push/total*100).toFixed(1)}%; background:rgba(0,194,255,0.85);">
                    <span class="seg-label">Push</span><span class="seg-value">${push.toFixed(3)}s</span>
                </div>
                <div class="phase-bar-segment" style="width:${(flight/total*100).toFixed(1)}%; background:rgba(168,85,247,0.85);">
                    <span class="seg-label">Flight</span><span class="seg-value">${flight.toFixed(3)}s</span>
                </div>
            </div>`;

            // Comparison bar
            if (comp) {
                const cr = parseFloat(comp.reaction_time_s) || 0;
                const cp = parseFloat(comp.push_time_s) || 0;
                const cf = parseFloat(comp.flight_phase_s) || 0;
                const ct = cr + cp + cf || 1;
                html += `<div style="font-size:11px; color:var(--accent-cyan); margin:8px 0 4px; font-weight:500;">Compare trial:</div>
                <div class="phase-bar-stack" style="height:30px; opacity:0.75;">
                    <div class="phase-bar-segment" style="width:${(cr/ct*100).toFixed(1)}%; background:rgba(245,166,35,0.6);">
                        <span class="seg-value" style="font-size:11px">${cr.toFixed(3)}s</span>
                    </div>
                    <div class="phase-bar-segment" style="width:${(cp/ct*100).toFixed(1)}%; background:rgba(0,194,255,0.6);">
                        <span class="seg-value" style="font-size:11px">${cp.toFixed(3)}s</span>
                    </div>
                    <div class="phase-bar-segment" style="width:${(cf/ct*100).toFixed(1)}%; background:rgba(168,85,247,0.6);">
                        <span class="seg-value" style="font-size:11px">${cf.toFixed(3)}s</span>
                    </div>
                </div>`;
            }

            // Metric grid with deltas
            const dReact = comp ? startDelta(reaction, parseFloat(comp.reaction_time_s)) : '';
            const dPush = comp ? startDelta(push, parseFloat(comp.push_time_s)) : '';
            const dFlight = comp ? startDelta(flight, parseFloat(comp.flight_phase_s)) : '';
            const dBlockPush = comp ? startDelta(blockPushDur, parseFloat(comp.block_pushing_duration_s)) : '';

            html += `<div class="start-metric-grid" style="margin-top:16px;">
                ${startMetricCard('Reaction Time', reaction.toFixed(3), 's', dReact)}
                ${startMetricCard('Push Time', push.toFixed(3), 's', dPush)}
                ${startMetricCard('Flight Phase', flight.toFixed(3), 's', dFlight)}
                ${startMetricCard('Block Empty', blockEmpty.toFixed(3), 's', '')}
                ${startMetricCard('Block Reaction', blockReaction.toFixed(3), 's', '')}
                ${startMetricCard('Block Push Duration', blockPushDur.toFixed(3), 's', dBlockPush)}
            </div>`;

            container.innerHTML = html;
        }

        // "" Flight & Entry Tab (v01.21 - charts + cards) ""
        function renderFlightEntryTab() {
            const chartsDiv = document.getElementById('startFlightCharts');
            const cardsDiv = document.getElementById('startFlightCards');
            const prim = getStartPrimary();
            const comp = getStartCompare();

            // Destroy previous chart instances
            if (appState.charts.flightVelDecay) { appState.charts.flightVelDecay.destroy(); appState.charts.flightVelDecay = null; }

            if (!prim) {
                chartsDiv.innerHTML = '';
                cardsDiv.innerHTML = '<div class="empty-state"><h3>Select a start trial to view flight and entry data</h3></div>';
                return;
            }

            const v = (key, d=2) => { const val = parseFloat(prim[key]); return isNaN(val) ? '--' : val.toFixed(d); };
            const vn = (key) => parseFloat(prim[key]);
            const vc = (key) => comp ? parseFloat(comp[key]) : null;
            const fmtV = (val, d=2) => (val == null || isNaN(val)) ? '--' : val.toFixed(d);

            // ============================================
            // CHARTS SECTION - v01.23 Minimalist
            // ============================================
            let cHtml = `<div style="margin-bottom:16px;">
                <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Flight & Entry - ${startLabel(prim)}</h3>
                ${comp ? `<p style="font-size:12px; color:var(--accent-cyan);">Compared with ${startLabel(comp)}</p>` : ''}
            </div>`;

            // "" 1. MINIMALIST FLIGHT PATH ""
            const hipTO = vn('height_hip_takeoff');
            const hipEN = vn('height_hip_entry');
            const entryDist = vn('distance_to_water_entry');
            const angleTO = vn('takeoff_angle_deg');
            const angleEN = vn('angle_hip_entry_deg');
            const hasArcData = !isNaN(hipTO) && !isNaN(entryDist);

            if (hasArcData) {
                const svgW = 560, svgH = 180;
                const padL = 40, padR = 40, padT = 24, padB = 36;
                const plotW = svgW - padL - padR;
                const plotH = svgH - padT - padB;

                const maxH = Math.max(hipTO, isNaN(hipEN)?hipTO:hipEN) * 1.55;
                const maxD = entryDist * 1.12;
                const sx = d => padL + (d / maxD) * plotW;
                const sy = h => padT + plotH - (h / maxH) * plotH;
                const waterY = sy(0);

                // Points
                const x0 = sx(0), y0 = sy(hipTO);
                const x1 = sx(entryDist), y1 = sy(isNaN(hipEN) ? 0 : hipEN);

                // Arc control - natural parabola
                const apex = Math.max(hipTO, isNaN(hipEN)?hipTO:hipEN) * 1.25;
                const cpX = sx(entryDist * 0.4), cpY = sy(apex);

                // Comparison arc
                let compPath = '';
                if (comp) {
                    const cTO = parseFloat(comp.height_hip_takeoff);
                    const cEN = parseFloat(comp.height_hip_entry);
                    const cD = parseFloat(comp.distance_to_water_entry);
                    if (!isNaN(cTO) && !isNaN(cD)) {
                        const cx1 = sx(cD), cy0 = sy(cTO), cy1 = sy(isNaN(cEN)?0:cEN);
                        const cApex = Math.max(cTO, isNaN(cEN)?cTO:cEN) * 1.25;
                        compPath = `<path d="M${x0},${cy0} Q${sx(cD*0.4)},${sy(cApex)} ${cx1},${cy1}" fill="none" stroke="rgba(0,194,255,0.4)" stroke-width="2" stroke-dasharray="6,4"/>
                            <circle cx="${x0}" cy="${cy0}" r="4.5" fill="rgba(0,194,255,0.6)" stroke="rgba(0,194,255,0.2)" stroke-width="6"/>
                            <circle cx="${cx1}" cy="${cy1}" r="4.5" fill="rgba(0,194,255,0.6)" stroke="rgba(0,194,255,0.2)" stroke-width="6"/>`;
                    }
                }

                cHtml += `<div class="flight-path-container">
                    <h4>Flight Path ${infoTip(TIPS.flightPath)}</h4>
                    <p class="fp-sub">Hip trajectory from block to water</p>
                    <svg class="flight-path-svg" viewBox="0 0 ${svgW} ${svgH}" preserveAspectRatio="xMidYMid meet">
                        <!-- Water -->
                        <rect x="${padL}" y="${waterY}" width="${plotW}" height="${svgH - waterY}" fill="rgba(0,194,255,0.04)" rx="0"/>
                        <line x1="${padL}" y1="${waterY}" x2="${padL + plotW}" y2="${waterY}" stroke="rgba(0,194,255,0.25)" stroke-width="1"/>
                        <text x="${padL + plotW + 4}" y="${waterY + 3}" class="fp-lbl" style="font-size:8px; fill:rgba(0,194,255,0.4);">water</text>

                        <!-- Block edge - simple vertical line -->
                        <line x1="${padL}" y1="${sy(maxH * 0.6)}" x2="${padL}" y2="${waterY}" stroke="rgba(148,163,184,0.2)" stroke-width="2"/>

                        <!-- Distance label on water line -->
                        <text x="${(x0+x1)/2}" y="${waterY + 16}" text-anchor="middle" class="fp-val" style="font-size:11px;">${fmtV(entryDist,1)}<tspan class="fp-unit"> m</tspan></text>
                        <text x="${(x0+x1)/2}" y="${waterY + 28}" text-anchor="middle" class="fp-lbl" style="font-size:8px;">distance</text>

                        <!-- Comparison (behind) -->
                        ${compPath}

                        <!-- Primary arc -->
                        <path d="M${x0},${y0} Q${cpX},${cpY} ${x1},${y1}" fill="none" stroke="rgba(245,166,35,0.8)" stroke-width="2.5" stroke-linecap="round"/>

                        <!-- Takeoff dot + label -->
                        <circle cx="${x0}" cy="${y0}" r="5.5" fill="rgba(245,166,35,1)" stroke="rgba(245,166,35,0.2)" stroke-width="8"/>
                        <text x="${x0 + 16}" y="${y0 - 6}" class="fp-val">${fmtV(hipTO)}<tspan class="fp-unit"> m</tspan></text>
                        <text x="${x0 + 16}" y="${y0 + 7}" class="fp-lbl">takeoff height</text>

                        <!-- Entry dot + label -->
                        <circle cx="${x1}" cy="${y1}" r="5.5" fill="rgba(167,139,250,1)" stroke="rgba(167,139,250,0.2)" stroke-width="8"/>
                        <text x="${x1 - 16}" y="${y1 - 6}" text-anchor="end" class="fp-val">${fmtV(isNaN(hipEN)?0:hipEN)}<tspan class="fp-unit"> m</tspan></text>
                        <text x="${x1 - 16}" y="${y1 + 7}" text-anchor="end" class="fp-lbl">entry height</text>
                    </svg>
                    <div class="fp-stat-row">
                        <div class="fp-stat">
                            <span class="fp-stat-label">Entry Distance</span>
                            <span class="fp-stat-val">${fmtV(entryDist, 1)}<span class="unit">m</span></span>
                            ${comp && !isNaN(parseFloat(comp.distance_to_water_entry)) ? `<span class="fp-stat-delta" style="color:${entryDist > parseFloat(comp.distance_to_water_entry) ? 'var(--accent-green)' : 'var(--accent-red)'};">${entryDist > parseFloat(comp.distance_to_water_entry)?'+':''}${(entryDist - parseFloat(comp.distance_to_water_entry)).toFixed(2)}m</span>` : ''}
                        </div>
                        <div class="fp-stat">
                            <span class="fp-stat-label">Takeoff Height</span>
                            <span class="fp-stat-val">${fmtV(hipTO)}<span class="unit">m</span></span>
                            ${comp && !isNaN(parseFloat(comp.height_hip_takeoff)) ? `<span class="fp-stat-delta" style="color:${hipTO > parseFloat(comp.height_hip_takeoff) ? 'var(--accent-green)' : 'var(--accent-red)'};">${hipTO > parseFloat(comp.height_hip_takeoff)?'+':''}${(hipTO - parseFloat(comp.height_hip_takeoff)).toFixed(2)}m</span>` : ''}
                        </div>
                        <div class="fp-stat">
                            <span class="fp-stat-label">Entry Height</span>
                            <span class="fp-stat-val">${fmtV(hipEN)}<span class="unit">m</span></span>
                            ${comp && !isNaN(parseFloat(comp.height_hip_entry)) ? `<span class="fp-stat-delta" style="color:${hipEN > parseFloat(comp.height_hip_entry) ? 'var(--accent-green)' : 'var(--accent-red)'};">${hipEN > parseFloat(comp.height_hip_entry)?'+':''}${(hipEN - parseFloat(comp.height_hip_entry)).toFixed(2)}m</span>` : ''}
                        </div>
                        ${!isNaN(angleTO) ? `<div class="fp-stat">
                            <span class="fp-stat-label">Takeoff Angle</span>
                            <span class="fp-stat-val">${fmtV(angleTO,1)}<span class="unit">&deg;</span></span>
                        </div>` : ''}
                        ${!isNaN(angleEN) ? `<div class="fp-stat">
                            <span class="fp-stat-label">Entry Angle</span>
                            <span class="fp-stat-val">${fmtV(angleEN,1)}<span class="unit">&deg;</span></span>
                        </div>` : ''}
                    </div>
                </div>`;
            } else {
                cHtml += '<div class="flight-path-container"><h4>Flight Path ${infoTip(TIPS.flightPath)}</h4><p style="color:var(--text-muted); font-size:12px;">No body position data for this trial</p></div>';
            }

            // "" 2. ENTRY GEOMETRY (full width) ""
            const entAngle = vn('angle_hip_entry_deg');
            const toAngle = vn('angle_hip_takeoff_deg');
            const hfDist = vn('hor_dist_hands_feet_entry');
            cHtml += `<div class="entry-geom-container">
                <h4>Entry Geometry</h4>
                <div class="entry-geom-grid">
                    <div class="entry-geom-card">
                        <div class="egc-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 22h20L12 2z"/></svg></div>
                        <div class="egc-label">Hip Angle @ Takeoff</div>
                        <div class="egc-value">${fmtV(toAngle,1)}<span class="egc-unit">&deg;</span></div>
                        <div class="egc-bar"><div class="egc-bar-fill" style="width:${isNaN(toAngle)?0:Math.min(100,(toAngle/90)*100)}%; background:linear-gradient(90deg, rgba(245,166,35,0.8), rgba(245,166,35,0.5));"></div></div>
                        ${comp && !isNaN(parseFloat(comp.angle_hip_takeoff_deg)) ? `<div style="font-size:11px; color:var(--accent-cyan); margin-top:4px;">Compare: ${parseFloat(comp.angle_hip_takeoff_deg).toFixed(1)}&deg;</div>` : ''}
                    </div>
                    <div class="entry-geom-card">
                        <div class="egc-icon" style="color:var(--accent-purple);"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12l10 10 10-10M12 2v20"/></svg></div>
                        <div class="egc-label">Hip Angle @ Entry</div>
                        <div class="egc-value">${fmtV(entAngle,1)}<span class="egc-unit">&deg;</span></div>
                        <div class="egc-bar"><div class="egc-bar-fill" style="width:${isNaN(entAngle)?0:Math.min(100,(entAngle/90)*100)}%; background:linear-gradient(90deg, rgba(167,139,250,0.8), rgba(167,139,250,0.5));"></div></div>
                        ${comp && !isNaN(parseFloat(comp.angle_hip_entry_deg)) ? `<div style="font-size:11px; color:var(--accent-cyan); margin-top:4px;">Compare: ${parseFloat(comp.angle_hip_entry_deg).toFixed(1)}&deg;</div>` : ''}
                    </div>
                    <div class="entry-geom-card">
                        <div class="egc-icon" style="color:var(--accent-cyan);"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 8l4 4-4 4"/><path d="M3 12h18"/><path d="M7 8l-4 4 4 4"/></svg></div>
                        <div class="egc-label">Hands-Feet Gap</div>
                        <div class="egc-value">${fmtV(hfDist)}<span class="egc-unit">m</span></div>
                        <div class="egc-bar"><div class="egc-bar-fill" style="width:${isNaN(hfDist)?0:Math.min(100,(hfDist/1.0)*100)}%; background:linear-gradient(90deg, rgba(0,194,255,0.8), rgba(0,194,255,0.5));"></div></div>
                        ${comp && !isNaN(parseFloat(comp.hor_dist_hands_feet_entry)) ? `<div style="font-size:11px; color:var(--accent-cyan); margin-top:4px;">Compare: ${parseFloat(comp.hor_dist_hands_feet_entry).toFixed(2)}m</div>` : ''}
                    </div>
                </div>
            </div>`;

            // "" 3. VELOCITY DECAY LINE CHART ""
            const velKeys = ['hor_vel_hip_flight', 'hor_vel_hands_entry', 'hor_vel_hip_to_kick1', 'hor_vel_hip_3kicks', 'hor_vel_hip_stroke1', 'hor_vel_hip_stroke2'];
            const velLabels = ['Hip (Flight)', 'Hands (Entry)', 'Hip->Kick 1', '3 Kicks', 'Stroke 1', 'Stroke 2'];
            const primVels = velKeys.map(k => { const x = parseFloat(prim[k]); return isNaN(x) ? null : x; });
            const hasVelData = primVels.some(v => v !== null);

            if (hasVelData) {
                cHtml += `<div class="vel-decay-container">
                    <h4>Velocity Profile - Flight to Swim</h4>
                    <div class="chart-container" style="height:260px;"><canvas id="flightVelDecayChart"></canvas></div>
                </div>`;
            }

            chartsDiv.innerHTML = cHtml;

            // "" Render velocity decay Chart.js ""
            if (hasVelData) {
                const canvas = document.getElementById('flightVelDecayChart');
                const filteredLabels = [], filteredPrim = [], filteredComp = [];
                velLabels.forEach((lbl, i) => {
                    if (primVels[i] !== null) {
                        filteredLabels.push(lbl);
                        filteredPrim.push(primVels[i]);
                        if (comp) {
                            const cv = parseFloat(comp[velKeys[i]]);
                            filteredComp.push(isNaN(cv) ? null : cv);
                        }
                    }
                });

                const datasets = [{
                    label: comp ? 'Primary' : 'Selected',
                    data: filteredPrim,
                    borderColor: 'rgba(245,166,35,1)',
                    backgroundColor: 'rgba(245,166,35,0.12)',
                    fill: true, tension: 0.35, pointRadius: 6, pointHoverRadius: 8,
                    pointBackgroundColor: 'rgba(245,166,35,1)', pointBorderColor: '#0f172a',
                    pointBorderWidth: 2.5, borderWidth: 3
                }];
                if (comp && filteredComp.length) {
                    datasets.push({
                        label: 'Compare',
                        data: filteredComp,
                        borderColor: 'rgba(0,194,255,1)',
                        backgroundColor: 'rgba(0,194,255,0.08)',
                        fill: true, tension: 0.35, pointRadius: 5, pointHoverRadius: 7,
                        pointBackgroundColor: 'rgba(0,194,255,1)', pointBorderColor: '#0f172a',
                        pointBorderWidth: 2, borderWidth: 2, borderDash: [5, 3]
                    });
                }

                appState.charts.flightVelDecay = new Chart(canvas, {
                    type: 'line',
                    data: { labels: filteredLabels, datasets },
                    plugins: [dataLabelsPlugin],
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        layout: { padding: { top: 24 } },
                        scales: {
                            x: { grid: { color: 'rgba(128,140,160,0.08)' }, ticks: { color: getThemeColors().textSec, font: { size: 11 } } },
                            y: {
                                grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec },
                                title: { display: true, text: 'm/s', color: getThemeColors().textSec },
                                beginAtZero: false
                            }
                        },
                        plugins: {
                            legend: { display: !!comp, position: 'bottom', labels: { color: getThemeColors().textSec, usePointStyle: true } },
                            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} m/s` } }
                        }
                    }
                });
            }

            // ============================================
            // KEY METRICS - compact summary below charts
            // ============================================
            let html = `<div style="margin-top:24px; padding-top:20px; border-top:1px solid var(--border-color);">
                <h4 style="font-size:13px; font-weight:600; color:var(--text-muted); margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px;">Key Metrics</h4>
            </div>`;

            // Takeoff velocities - not shown in any chart above, always display
            html += `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:10px;">Takeoff Velocity</h4>
            <div class="start-metric-grid">
                ${startMetricCard('Horizontal', v('v_takeoff_hor'), 'm/s', comp ? startDelta(vn('v_takeoff_hor'), vc('v_takeoff_hor'), false) : '')}
                ${startMetricCard('Vertical', v('v_takeoff_ver'), 'm/s', comp ? startDelta(vn('v_takeoff_ver'), vc('v_takeoff_ver'), false) : '')}
                ${startMetricCard('Resultant', v('v_takeoff_res'), 'm/s', comp ? startDelta(vn('v_takeoff_res'), vc('v_takeoff_res'), false) : '')}
                ${startMetricCard('Takeoff Angle', v('takeoff_angle_deg', 1), '&deg;', comp ? startDelta(vn('takeoff_angle_deg'), vc('takeoff_angle_deg'), false) : '')}
            </div>`;

            // Quick-reference summary - entry distance + key heights + peak velocity
            html += `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin:20px 0 10px;">Flight Summary</h4>
            <div class="start-metric-grid">
                ${startMetricCard('Entry Distance', v('distance_to_water_entry'), 'm', comp ? startDelta(vn('distance_to_water_entry'), vc('distance_to_water_entry'), false) : '')}
                ${startMetricCard('Hip Height @ Takeoff', v('height_hip_takeoff'), 'm', comp ? startDelta(vn('height_hip_takeoff'), vc('height_hip_takeoff'), false) : '')}
                ${startMetricCard('Hip Height @ Entry', v('height_hip_entry'), 'm', comp ? startDelta(vn('height_hip_entry'), vc('height_hip_entry'), false) : '')}
                ${startMetricCard('Peak Velocity', v('hor_vel_hip_flight'), 'm/s', comp ? startDelta(vn('hor_vel_hip_flight'), vc('hor_vel_hip_flight'), false) : '')}
                ${startMetricCard('Entry Velocity', v('hor_vel_hands_entry'), 'm/s', comp ? startDelta(vn('hor_vel_hands_entry'), vc('hor_vel_hands_entry'), false) : '')}
                ${startMetricCard('Hands-Feet Gap', v('hor_dist_hands_feet_entry'), 'm', comp ? startDelta(vn('hor_dist_hands_feet_entry'), vc('hor_dist_hands_feet_entry'), false) : '')}
            </div>`;

            cardsDiv.innerHTML = html;
        }

        // "" Underwater Tab ""
        function renderUnderwaterTab() {
            const contentDiv = document.getElementById('startUnderwaterContent');
            const chartsDiv = document.getElementById('startUnderwaterCharts');
            const metricsDiv = document.getElementById('startUnderwaterMetrics');
            const prim = getStartPrimary();
            const comp = getStartCompare();

            // Destroy existing charts
            if (appState.charts.uwSplit) { appState.charts.uwSplit.destroy(); appState.charts.uwSplit = null; }
            if (appState.charts.uwVelocity) { appState.charts.uwVelocity.destroy(); appState.charts.uwVelocity = null; }

            if (!prim) {
                contentDiv.style.display = '';
                contentDiv.innerHTML = '<div class="empty-state"><h3>Select a start trial to view underwater phase</h3></div>';
                chartsDiv.style.display = 'none';
                return;
            }

            // Show charts, hide empty state
            contentDiv.style.display = 'none';
            chartsDiv.style.display = '';

            const v = (key, d=2) => { const val = parseFloat(prim[key]); return isNaN(val) ? '--' : val.toFixed(d); };
            const vn = (key) => parseFloat(prim[key]);
            const vc = (key) => comp ? parseFloat(comp[key]) : null;

            // "" Split Times Chart (horizontal bar) ""
            const splitCanvas = document.getElementById('uwSplitChart');
            const splitLabels = ['5m', '7.5m', '10m', '15m'];
            const splitKeys = ['split_5m_s', 'split_7_5m_s', 'split_10m_s', 'split_15m_s'];
            const primSplits = splitKeys.map(k => parseFloat(prim[k]) || 0);

            const splitDatasets = [{
                label: comp ? 'Primary' : 'Selected',
                data: primSplits,
                backgroundColor: 'rgba(245,166,35,0.85)',
                borderRadius: 6, barPercentage: comp ? 0.45 : 0.6, categoryPercentage: 0.8
            }];
            if (comp) {
                splitDatasets.push({
                    label: 'Compare',
                    data: splitKeys.map(k => parseFloat(comp[k]) || 0),
                    backgroundColor: 'rgba(0,194,255,0.7)',
                    borderRadius: 6, barPercentage: 0.45, categoryPercentage: 0.8
                });
            }

            appState.charts.uwSplit = new Chart(splitCanvas, {
                type: 'bar',
                data: { labels: splitLabels, datasets: splitDatasets },
                plugins: [dataLabelsPlugin],
                options: {
                    indexAxis: 'y',
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: 'rgba(128,140,160,0.10)' },
                            ticks: { color: getThemeColors().textSec, callback: v => v + 's' },
                            title: { display: true, text: 'Time (s)', color: getThemeColors().textSec }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: getThemeColors().text, font: { weight: '600', size: 12 } }
                        }
                    },
                    plugins: {
                        legend: { display: !!comp, position: 'bottom', labels: { color: getThemeColors().textSec, usePointStyle: true, pointStyle: 'rectRounded' } },
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.x.toFixed(2)}s` } }
                    }
                }
            });

            // "" Underwater Velocity Progression Chart (line) ""
            const velCanvas = document.getElementById('uwVelocityChart');
            const velLabels = ['Entry', 'Kick 1', '3 Kicks', 'Stroke 1', 'Stroke 2'];
            const velKeys = ['hor_vel_hands_entry', 'hor_vel_hip_to_kick1', 'hor_vel_hip_3kicks', 'hor_vel_hip_stroke1', 'hor_vel_hip_stroke2'];
            const primVels = velKeys.map(k => parseFloat(prim[k]) || 0);

            const velDatasets = [{
                label: comp ? 'Primary' : 'Selected',
                data: primVels,
                borderColor: 'rgba(245,166,35,1)',
                backgroundColor: 'rgba(245,166,35,0.15)',
                fill: true, tension: 0.35, pointRadius: 5, pointBackgroundColor: 'rgba(245,166,35,1)',
                pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2.5
            }];
            if (comp) {
                velDatasets.push({
                    label: 'Compare',
                    data: velKeys.map(k => parseFloat(comp[k]) || 0),
                    borderColor: 'rgba(0,194,255,1)',
                    backgroundColor: 'rgba(0,194,255,0.1)',
                    fill: true, tension: 0.35, pointRadius: 5, pointBackgroundColor: 'rgba(0,194,255,1)',
                    pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2, borderDash: [5, 3]
                });
            }

            appState.charts.uwVelocity = new Chart(velCanvas, {
                type: 'line',
                data: { labels: velLabels, datasets: velDatasets },
                plugins: [dataLabelsPlugin],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 20 } },
                    scales: {
                        x: {
                            grid: { color: 'rgba(128,140,160,0.08)' },
                            ticks: { color: getThemeColors().textSec, font: { size: 11 } }
                        },
                        y: {
                            grid: { color: 'rgba(128,140,160,0.10)' },
                            ticks: { color: getThemeColors().textSec },
                            title: { display: true, text: 'm/s', color: getThemeColors().textSec }
                        }
                    },
                    plugins: {
                        legend: { display: !!comp, position: 'bottom', labels: { color: getThemeColors().textSec, usePointStyle: true } },
                        tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} m/s` } }
                    }
                }
            });

            // "" Metrics below charts ""
            let mHtml = `<div style="margin-bottom:16px;">
                <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Underwater Details - ${startLabel(prim)}</h3>
                ${comp ? `<p style="font-size:12px; color:var(--accent-cyan);">Compared with ${startLabel(comp)}</p>` : ''}
            </div>`;

            mHtml += `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:10px;">Kick Timing & Surface Break</h4>
            <div class="start-metric-grid">
                ${startMetricCard('Kick Rate', v('kick_rate', 1), 'kicks/min', comp ? startDelta(vn('kick_rate'), vc('kick_rate'), false) : '')}
                ${startMetricCard('Surface Break', v('abs_time_surface_break', 2), 's', comp ? startDelta(vn('abs_time_surface_break'), vc('abs_time_surface_break'), true) : '')}
                ${startMetricCard('Deepest Dive', v('abs_time_deepest_dive', 2), 's', '')}
            </div>`;

            mHtml += `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin:20px 0 10px;">Split Time Details</h4>
            <div class="start-metric-grid">
                ${startMetricCard('5m Split', v('split_5m_s'), 's', comp ? startDelta(vn('split_5m_s'), vc('split_5m_s'), true) : '')}
                ${startMetricCard('7.5m Split', v('split_7_5m_s'), 's', comp ? startDelta(vn('split_7_5m_s'), vc('split_7_5m_s'), true) : '')}
                ${startMetricCard('10m Split', v('split_10m_s'), 's', comp ? startDelta(vn('split_10m_s'), vc('split_10m_s'), true) : '')}
                ${startMetricCard('15m Split', v('split_15m_s'), 's', comp ? startDelta(vn('split_15m_s'), vc('split_15m_s'), true) : '')}
            </div>`;

            metricsDiv.innerHTML = mHtml;
        }

        // "" Velocity Tab ""
        function renderStartVelocityTab() {
            const starts = startModuleState.filteredStarts;
            const prim = getStartPrimary();
            const comp = getStartCompare();
            const metricsContainer = document.getElementById('startVelocityMetrics');

            // Destroy existing
            if (appState.charts.startVelocity) { appState.charts.startVelocity.destroy(); appState.charts.startVelocity = null; }

            const canvas = document.getElementById('startVelocityChart');
            if (!canvas || !starts.length) return;

            let datasets = [];
            let labels = [];

            if (prim && comp) {
                // Compare two
                labels = ['0-5m', '5-10m', '10-15m'];
                datasets = [
                    {
                        label: startLabel(prim),
                        data: [parseFloat(prim.avg_vel_0_5)||0, parseFloat(prim.avg_vel_5_10)||0, parseFloat(prim.avg_vel_10_15)||0],
                        backgroundColor: 'rgba(245,166,35,0.85)', borderRadius: 6
                    },
                    {
                        label: startLabel(comp),
                        data: [parseFloat(comp.avg_vel_0_5)||0, parseFloat(comp.avg_vel_5_10)||0, parseFloat(comp.avg_vel_10_15)||0],
                        backgroundColor: 'rgba(0,194,255,0.7)', borderRadius: 6
                    }
                ];
            } else if (prim) {
                // Single selected vs average
                const avgV05 = starts.reduce((s,d) => s+(parseFloat(d.avg_vel_0_5)||0),0)/starts.length;
                const avgV510 = starts.reduce((s,d) => s+(parseFloat(d.avg_vel_5_10)||0),0)/starts.length;
                const avgV1015 = starts.reduce((s,d) => s+(parseFloat(d.avg_vel_10_15)||0),0)/starts.length;
                labels = ['0-5m', '5-10m', '10-15m'];
                datasets = [
                    {
                        label: 'Selected',
                        data: [parseFloat(prim.avg_vel_0_5)||0, parseFloat(prim.avg_vel_5_10)||0, parseFloat(prim.avg_vel_10_15)||0],
                        backgroundColor: 'rgba(245,166,35,0.85)', borderRadius: 6
                    },
                    {
                        label: 'Average (all)',
                        data: [avgV05, avgV510, avgV1015],
                        backgroundColor: 'rgba(148,163,184,0.4)', borderRadius: 6
                    }
                ];
            } else {
                // All trials as grouped bars
                const recent = starts.slice(0, 8);
                labels = recent.map(s => formatDate(s.source_date));
                datasets = [
                    { label: '0-5m', data: recent.map(d => parseFloat(d.avg_vel_0_5)||0), backgroundColor: 'rgba(245,166,35,0.85)', borderRadius: 4 },
                    { label: '5-10m', data: recent.map(d => parseFloat(d.avg_vel_5_10)||0), backgroundColor: 'rgba(0,194,255,0.8)', borderRadius: 4 },
                    { label: '10-15m', data: recent.map(d => parseFloat(d.avg_vel_10_15)||0), backgroundColor: 'rgba(0,194,255,0.8)', borderRadius: 4 }
                ];
            }

            appState.charts.startVelocity = new Chart(canvas, {
                type: 'bar',
                data: { labels, datasets },
                plugins: [dataLabelsPlugin],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec, font: { size: 11 } } },
                        y: { grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec }, title: { display: true, text: 'm/s', color: getThemeColors().textSec } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: getThemeColors().textSec, usePointStyle: true, pointStyle: 'rectRounded' } } }
                }
            });

            // Velocity metrics below chart
            if (prim && metricsContainer) {
                const v05 = parseFloat(prim.avg_vel_0_5), v510 = parseFloat(prim.avg_vel_5_10), v1015 = parseFloat(prim.avg_vel_10_15);
                let metricHtml = `<div class="start-metric-grid" style="margin-top:16px;">
                    ${startMetricCard('0-5m Velocity', isNaN(v05)?'--':v05.toFixed(2), 'm/s', comp ? startDelta(v05, parseFloat(comp.avg_vel_0_5), false) : '')}
                    ${startMetricCard('5-10m Velocity', isNaN(v510)?'--':v510.toFixed(2), 'm/s', comp ? startDelta(v510, parseFloat(comp.avg_vel_5_10), false) : '')}
                    ${startMetricCard('10-15m Velocity', isNaN(v1015)?'--':v1015.toFixed(2), 'm/s', comp ? startDelta(v1015, parseFloat(comp.avg_vel_10_15), false) : '')}
                </div>`;
                metricsContainer.innerHTML = metricHtml;
            } else if (metricsContainer) {
                metricsContainer.innerHTML = '';
            }
        }

        // "" Start Summary Tab ""
        function renderStartSummary() {
            const container = document.getElementById('startSummaryContent');
            const prim = getStartPrimary();
            const comp = getStartCompare();

            if (!prim) {
                const starts = startModuleState.filteredStarts;
                if (!starts.length) { container.innerHTML = '<div class="empty-state"><h3>No start data</h3></div>'; return; }
                container.innerHTML = `<div class="empty-state"><h3>Select a start trial to see summary</h3>
                    <p style="color:var(--text-muted);font-size:13px;">Or select two for a side-by-side comparison</p></div>`;
                return;
            }

            const pf = (val, d=3) => { const n = parseFloat(val); return isNaN(n) ? '--' : n.toFixed(d); };

            if (!comp) {
                // Single trial digest
                const s = prim;
                let html = `<div style="margin-bottom:16px;">
                    <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Start Summary</h3>
                    <p style="font-size:13px; color:var(--text-muted);">${startLabel(s)}</p>
                </div>`;

                html += `<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">`;

                // Block phase section
                html += `<div class="start-metric-item" style="padding:20px;">
                    <div style="font-size:13px; font-weight:600; color:var(--accent-orange); margin-bottom:12px;">
                        <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        Block Phase
                    </div>
                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                        Reaction: <strong style="color:var(--text-primary)">${pf(s.reaction_time_s)}s</strong><br>
                        Push: <strong style="color:var(--text-primary)">${pf(s.push_time_s)}s</strong><br>
                        Flight: <strong style="color:var(--text-primary)">${pf(s.flight_phase_s)}s</strong>
                    </div>
                </div>`;

                // Velocity section
                html += `<div class="start-metric-item" style="padding:20px;">
                    <div style="font-size:13px; font-weight:600; color:var(--accent-blue); margin-bottom:12px;">
                        <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                        Velocity
                    </div>
                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                        0-5m: <strong style="color:var(--text-primary)">${pf(s.avg_vel_0_5, 2)} m/s</strong><br>
                        5-10m: <strong style="color:var(--text-primary)">${pf(s.avg_vel_5_10, 2)} m/s</strong><br>
                        10-15m: <strong style="color:var(--text-primary)">${pf(s.avg_vel_10_15, 2)} m/s</strong>
                    </div>
                </div>`;

                // Splits section
                html += `<div class="start-metric-item" style="padding:20px;">
                    <div style="font-size:13px; font-weight:600; color:var(--accent-cyan); margin-bottom:12px;">
                        <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22V8M5 12H2a10 10 0 0020 0h-3"/></svg>
                        Splits
                    </div>
                    <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                        5m: <strong style="color:var(--text-primary)">${pf(s.split_5m_s, 2)}s</strong><br>
                        10m: <strong style="color:var(--text-primary)">${pf(s.split_10m_s, 2)}s</strong><br>
                        15m: <strong style="color:var(--text-primary)">${pf(s.split_15m_s, 2)}s</strong>
                    </div>
                </div>`;

                html += `</div>`;
                container.innerHTML = html;
            } else {
                // Comparison table
                const rp = prim, rc = comp;
                const metrics = [
                    { label: 'Reaction Time', key: 'reaction_time_s', d: 3, unit: 's', lower: true },
                    { label: 'Push Time', key: 'push_time_s', d: 3, unit: 's', lower: true },
                    { label: 'Flight Phase', key: 'flight_phase_s', d: 3, unit: 's', lower: true },
                    { label: '5m Split', key: 'split_5m_s', d: 2, unit: 's', lower: true },
                    { label: '10m Split', key: 'split_10m_s', d: 2, unit: 's', lower: true },
                    { label: '15m Split', key: 'split_15m_s', d: 2, unit: 's', lower: true },
                    { label: 'Vel 0-5m', key: 'avg_vel_0_5', d: 2, unit: 'm/s', lower: false },
                    { label: 'Vel 5-10m', key: 'avg_vel_5_10', d: 2, unit: 'm/s', lower: false },
                    { label: 'Vel 10-15m', key: 'avg_vel_10_15', d: 2, unit: 'm/s', lower: false },
                    { label: 'Takeoff Velocity', key: 'v_takeoff_res', d: 2, unit: 'm/s', lower: false },
                    { label: 'Takeoff Angle', key: 'takeoff_angle_deg', d: 1, unit: '&deg;', lower: false },
                    { label: 'Entry Distance', key: 'distance_to_water_entry', d: 2, unit: 'm', lower: false },
                    { label: 'Kick Rate', key: 'kick_rate', d: 1, unit: '/min', lower: false },
                ];

                let html = `<div style="margin-bottom:16px;">
                    <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Side-by-Side Comparison</h3>
                </div>
                <div style="overflow-x:auto;">
                <table class="data-table"><thead><tr>
                    <th>Metric</th>
                    <th style="color:var(--accent-orange);">${startLabel(rp)}</th>
                    <th style="color:var(--accent-cyan);">${startLabel(rc)}</th>
                    <th>Delta</th>
                </tr></thead><tbody>`;

                metrics.forEach(m => {
                    const a = parseFloat(rp[m.key]);
                    const b = parseFloat(rc[m.key]);
                    const aStr = isNaN(a) ? '--' : a.toFixed(m.d) + m.unit;
                    const bStr = isNaN(b) ? '--' : b.toFixed(m.d) + m.unit;
                    const delta = startDelta(a, b, m.lower);
                    html += `<tr><td>${m.label}</td><td class="mono">${aStr}</td><td class="mono">${bStr}</td><td>${delta}</td></tr>`;
                });

                html += '</tbody></table></div>';
                container.innerHTML = html;
            }
        }


        // ============================================
        // DATA LOADING - TURNS (Modular v01.21)
        // v01.17 FIX: Corrected all column name mismatches against actual turn_raw view
        // v01.18 FIX: Derive pre-turn approach from existing columns (no SQL migration needed)
        // v01.21 UX: (1) Approach splits -> segmented timeline with 15m/5m/WALL markers
        //            (2) Wall contact phase order fixed: Adapt -> Hand -> Rotate -> Push
        //            (3) Info icon tooltips on wall contact metrics
        //            (4) Login branding: "Peak Athlete / Train Smarter. Reach Your Peak."
        // TODO: Welcome tour overlay for new users (after all modules complete)
        // ============================================
        let turnModuleState = {
            allTurns: [],
            filteredTurns: [],
            primaryIdx: null,
            compareIdx: null,
            activeTab: 'approach',
            _groupUuids: null,
            _genderFilter: '',
            _multiAthlete: false,
            _nameMap: {},
            _sampleMode: false
        };

        function getTurnPrimary() { return turnModuleState.primaryIdx !== null ? turnModuleState.filteredTurns[turnModuleState.primaryIdx] : null; }
        function getTurnCompare() { return turnModuleState.compareIdx !== null ? turnModuleState.filteredTurns[turnModuleState.compareIdx] : null; }
        function hasTurnSelection() { return turnModuleState.primaryIdx !== null; }
        function hasTurnComparison() { return turnModuleState.compareIdx !== null; }

        function turnLabel(t) {
            const style = (t.style || 'Turn').charAt(0).toUpperCase() + (t.style || 'turn').slice(1);
            return `${style} - ${formatDate(t.source_date)}`;
        }

        function turnDelta(a, b, lowerBetter = true) {
            if (a == null || b == null || isNaN(a) || isNaN(b)) return '';
            const diff = a - b;
            if (Math.abs(diff) < 0.001) return '<span class="smi-delta neutral">0.000</span>';
            const better = lowerBetter ? diff < 0 : diff > 0;
            const cls = better ? 'positive' : 'negative';
            const sign = diff > 0 ? '+' : '';
            return `<span class="smi-delta ${cls}">${sign}${diff.toFixed(3)}</span>`;
        }

        function turnMetricCard(label, value, unit, deltaHtml) {
            return `<div class="start-metric-item">
                <div class="smi-label">${label}</div>
                <div class="smi-value">${value}<span class="smi-unit">${unit}</span>${deltaHtml || ''}</div>
            </div>`;
        }

        // "" INIT TURN COACH BAR ""
        async function initTurnCoachBar() {
            const scopeRow = document.querySelector('#turnFilterBar .rfb-turn-coach');
            if (appState.role !== 'coach' || !appState.teamUuid) {
                if (scopeRow) scopeRow.style.display = 'none';
                return;
            }
            if (scopeRow) scopeRow.style.display = 'flex';

            const athletes = _allTeamAthletes || await (async () => {
                const { data } = await supabaseClient.from('athletes')
                    .select('athlete_uuid, first_name, last_name, athlete_code, gender')
                    .eq('team_uuid', appState.teamUuid).eq('membership_status', 'active');
                _allTeamAthletes = data || [];
                return _allTeamAthletes;
            })();
            const athSelect = document.getElementById('turnAthleteFilter');
            const current = appState.selectedAthleteUuid || '';
            athSelect.innerHTML = '<option value="">All Team</option>' +
                athletes.sort((a,b)=>(a.last_name||'').localeCompare(b.last_name||''))
                .map(a => `<option value="${a.athlete_uuid}" ${a.athlete_uuid===current?'selected':''}>${a.first_name} ${a.last_name}</option>`).join('');

            const groups = _teamGroups || [];
            const grpSelect = document.getElementById('turnGroupFilter');
            grpSelect.innerHTML = '<option value="">No Group</option>' +
                groups.map(g => `<option value="${g.group_uuid}">${g.group_name}</option>`).join('');
        }

        // "" TURN COACH SCOPE HANDLERS ""
        async function onTurnAthleteChange() {
            const val = document.getElementById('turnAthleteFilter').value;
            if (val) {
                document.getElementById('turnGroupFilter').value = '';
                document.getElementById('turnGenderFilter').value = '';
                turnModuleState._groupUuids = null;
                turnModuleState._genderFilter = '';
            }
            appState.selectedAthleteUuid = val || null;
            await loadTurnRawData();
            applyTurnFilters();
        }

        async function onTurnGroupChange() {
            const groupUuid = document.getElementById('turnGroupFilter').value;
            if (groupUuid) {
                document.getElementById('turnAthleteFilter').value = '';
                appState.selectedAthleteUuid = null;
                const { data } = await supabaseClient.from('athlete_group_members')
                    .select('athlete_uuid').eq('group_uuid', groupUuid);
                turnModuleState._groupUuids = (data||[]).map(m => m.athlete_uuid);
            } else {
                turnModuleState._groupUuids = null;
            }
            await loadTurnRawData();
            applyTurnFilters();
        }

        async function onTurnGenderChange() {
            const gender = document.getElementById('turnGenderFilter').value;
            turnModuleState._genderFilter = gender;
            if (gender) {
                document.getElementById('turnAthleteFilter').value = '';
                appState.selectedAthleteUuid = null;
            }
            await loadTurnRawData();
            applyTurnFilters();
        }

        function updateTurnInfoBadge() {
            const infoEl = document.getElementById('turnCoachInfo');
            if (!infoEl || appState.role !== 'coach') return;
            const turns = turnModuleState.allTurns;
            const uniqueAthletes = new Set(turns.map(t => t.athlete_uuid)).size;
            const parts = [];
            parts.push(`${turns.length} trial${turns.length!==1?'s':''}`);
            if (turnModuleState._multiAthlete) parts.push(`from ${uniqueAthletes} athlete${uniqueAthletes!==1?'s':''}`);
            const gf = turnModuleState._genderFilter;
            if (gf) parts.push(`(${gf})`);
            infoEl.textContent = parts.join(' ');
            infoEl.style.display = 'flex';
        }

        // "" MAIN TURN LOAD ""
        async function loadTurnData() {
            await initTurnCoachBar();

            document.getElementById('turnStyleFilter').onchange = () => { clearTurnSelection(); applyTurnFilters(); };
            document.getElementById('turnDateFilter').onchange = () => { clearTurnSelection(); applyTurnFilters(); };

            document.querySelectorAll('#turnTabBar .turn-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('#turnTabBar .turn-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.turn-tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    turnModuleState.activeTab = tab.dataset.tab;
                    const content = document.getElementById('turnTab-' + tab.dataset.tab);
                    if (content) content.classList.add('active');
                    renderAllTurnVisuals();
                };
            });

            if (turnModuleState._sampleMode) {
                // Already in sample mode - just re-render
                renderTurnSelectorCards();
                renderAllTurnVisuals();
                return;
            }

            await loadTurnRawData();
            applyTurnFilters();
        }

        async function loadTurnRawData() {
            try {
                const athleteUuid = appState.selectedAthleteUuid || appState.athleteUuid;
                const groupUuids = turnModuleState._groupUuids;
                const genderFilter = turnModuleState._genderFilter || '';
                let query = supabaseClient.from('v_turn_kpis').select('*').order('source_date', { ascending: false });

                console.log('[loadTurnRawData] role:', appState.role, 'athleteUuid:', athleteUuid, 'groupUuids:', groupUuids, 'gender:', genderFilter);

                let scopeUuids = null;
                let clientFilterSet = null;
                if (groupUuids && groupUuids.length) {
                    scopeUuids = groupUuids;
                    turnModuleState._multiAthlete = true;
                } else if (athleteUuid) {
                    query = query.eq('athlete_uuid', athleteUuid);
                    turnModuleState._multiAthlete = false;
                } else if (appState.role === 'coach' && appState.teamUuid) {
                    scopeUuids = (_allTeamAthletes || []).map(a => a.athlete_uuid);
                    turnModuleState._multiAthlete = true;
                } else {
                    turnModuleState._multiAthlete = false;
                }

                if (genderFilter && appState.role === 'coach' && _allTeamAthletes) {
                    const genderUuids = new Set(_allTeamAthletes
                        .filter(a => a.gender === genderFilter)
                        .map(a => a.athlete_uuid));
                    if (scopeUuids) {
                        scopeUuids = scopeUuids.filter(u => genderUuids.has(u));
                    } else {
                        scopeUuids = [...genderUuids];
                    }
                    turnModuleState._multiAthlete = true;
                }

                if (scopeUuids) {
                    if (!scopeUuids.length) {
                        turnModuleState.allTurns = [];
                        updateTurnInfoBadge();
                        populateTurnStyleFilter();
                        return;
                    }
                    if (scopeUuids.length <= SUPABASE_IN_LIMIT) {
                        query = query.in('athlete_uuid', scopeUuids);
                    } else {
                        clientFilterSet = new Set(scopeUuids);
                        console.log('[loadTurnRawData] Using client-side filter for', scopeUuids.length, 'athletes');
                    }
                }

                const { data, error } = await query;
                console.log('[loadTurnRawData] query returned:', (data||[]).length, 'rows, error:', error ? JSON.stringify(error) : null);
                if (error) throw new Error(JSON.stringify(error));

                let rows = data || [];
                if (clientFilterSet) {
                    rows = rows.filter(t => clientFilterSet.has(t.athlete_uuid));
                    console.log('[loadTurnRawData] after client filter:', rows.length, 'rows');
                }

                // Build name map
                const nameMap = {};
                if (_allTeamAthletes) {
                    _allTeamAthletes.forEach(a => { nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.'; });
                }
                turnModuleState._nameMap = nameMap;

                // Deduplicate
                const seen = new Set();
                const deduped = [];
                rows.forEach(t => {
                    const key = [
                        t.athlete_uuid || '',
                        t.source_date || '',
                        (t.style || '').toLowerCase(),
                        t.rotation_time_s != null ? parseFloat(t.rotation_time_s).toFixed(3) : '',
                        t.time_15in_15out_s != null ? parseFloat(t.time_15in_15out_s).toFixed(2) : ''
                    ].join('|');
                    if (!seen.has(key)) {
                        seen.add(key);
                        deduped.push(t);
                    }
                });
                turnModuleState.allTurns = deduped;
                console.log('[loadTurnRawData] after dedup:', deduped.length, 'turns');

                updateTurnInfoBadge();
                populateTurnStyleFilter();
            } catch (e) {
                console.error('[loadTurnRawData] ERROR:', e);
                turnModuleState.allTurns = [];
            }
        }

        function populateTurnStyleFilter() {
            const styles = [...new Set(turnModuleState.allTurns.map(t => t.style).filter(Boolean))];
            const styleSel = document.getElementById('turnStyleFilter');
            if (styleSel) {
                styleSel.innerHTML = '<option value="">All Strokes</option>' + styles.map(st => `<option value="${st}">${st.charAt(0).toUpperCase() + st.slice(1)}</option>`).join('');
            }
        }

        function applyTurnFilters() {
            const styleVal = document.getElementById('turnStyleFilter')?.value || '';
            const dateVal = document.getElementById('turnDateFilter')?.value || '';
            let filtered = [...turnModuleState.allTurns];
            if (styleVal) filtered = filtered.filter(t => t.style === styleVal);
            if (dateVal) {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - parseInt(dateVal));
                filtered = filtered.filter(t => new Date(t.source_date) >= cutoff);
            }
            turnModuleState.filteredTurns = filtered;
            turnModuleState.primaryIdx = null;
            turnModuleState.compareIdx = null;
            renderTurnSelectorCards();
            renderAllTurnVisuals();
        }

        function renderTurnSelectorCards() {
            const container = document.getElementById('turnSelectorList');
            const clearBtn = document.getElementById('turnClearBtn');
            const hint = document.getElementById('turnSelectorHint');
            const turns = turnModuleState.filteredTurns;
            const multi = turnModuleState._multiAthlete;
            const nameMap = turnModuleState._nameMap || {};
            const isSample = turnModuleState._sampleMode;

            if (!turns.length) {
                container.innerHTML = sampleBannerHTML('turn');
                if (clearBtn) clearBtn.style.display = 'none';
                if (hint) hint.textContent = '';
                return;
            }

            let topHtml = '';
            if (isSample) topHtml = sampleActiveBannerHTML('turn');

            container.innerHTML = topHtml + turns.map((t, i) => {
                let cls = 'turn-card-pick';
                let badge = '';
                if (i === turnModuleState.primaryIdx) { cls += ' selected-primary'; badge = '<span class="tc-badge">Primary</span>'; }
                else if (i === turnModuleState.compareIdx) { cls += ' selected-compare'; badge = '<span class="tc-badge">Compare</span>'; }
                const totalTime = parseFloat(t.time_15in_15out_s);
                const timeStr = !isNaN(totalTime) ? totalTime.toFixed(2) + 's' : '--';
                const rotation = parseFloat(t.rotation_time_s);
                const rotStr = !isNaN(rotation) ? 'Rot ' + rotation.toFixed(2) + 's' : '';
                const athName = multi ? `<div class="rc-athlete">${nameMap[t.athlete_uuid]||'Unknown'}</div>` : '';
                return `<div class="${cls}" onclick="selectTurnCard(${i})">${badge}${athName}
                    <div class="tc-style">${t.style || 'Turn'}${isSample ? sampleBadgeHTML() : ''}</div>
                    <div class="tc-time">${timeStr}</div>
                    <div class="tc-sub">${rotStr}</div>
                    <div class="tc-date">${formatDate(t.source_date)}</div>
                </div>`;
            }).join('');

            const hasSel = hasTurnSelection();
            if (clearBtn) clearBtn.style.display = hasSel ? 'inline' : 'none';
            if (hint) {
                if (!hasSel) hint.innerHTML = '<svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>Click a trial to view details. Click a second to compare.';
                else if (!hasTurnComparison()) hint.innerHTML = '<svg style="width:14px;height:14px;vertical-align:middle;margin-right:4px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>Click another trial to compare.';
                else hint.textContent = 'Two trials selected for comparison.';
            }
        }

        function selectTurnCard(idx) {
            if (turnModuleState.primaryIdx === idx) {
                turnModuleState.primaryIdx = turnModuleState.compareIdx;
                turnModuleState.compareIdx = null;
            } else if (turnModuleState.compareIdx === idx) {
                turnModuleState.compareIdx = null;
            } else if (turnModuleState.primaryIdx === null) {
                turnModuleState.primaryIdx = idx;
            } else if (turnModuleState.compareIdx === null) {
                turnModuleState.compareIdx = idx;
            } else {
                turnModuleState.compareIdx = idx;
            }
            renderTurnSelectorCards();
            renderAllTurnVisuals();
        }

        function clearTurnSelection() {
            turnModuleState.primaryIdx = null;
            turnModuleState.compareIdx = null;
            renderTurnSelectorCards();
            renderAllTurnVisuals();
        }

        function renderAllTurnVisuals() {
            renderTurnKPIs();
            renderTurnTrials();
            const tab = turnModuleState.activeTab;
            if (tab === 'approach') renderTurnApproach();
            else if (tab === 'wall') renderTurnWallContact();
            else if (tab === 'underwater') renderTurnUnderwater();
            else if (tab === 'velocity') renderTurnVelocityProfile();
            else if (tab === 'summary') renderTurnSummary();
        }

        // "" Turn KPIs ""
        function renderTurnKPIs() {
            const container = document.getElementById('turnKpis');
            const turns = turnModuleState.filteredTurns;
            const prim = getTurnPrimary();
            const comp = getTurnCompare();

            if (!turns.length) { container.innerHTML = '<div class="empty-state"><h3>No turn data available</h3></div>'; return; }

            const avg = (arr, key) => { const vals = arr.map(r => parseFloat(r[key])).filter(v => !isNaN(v)); return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : NaN; };
            const best = (arr, key) => { const vals = arr.map(r => parseFloat(r[key])).filter(v => !isNaN(v)); return vals.length ? Math.min(...vals) : NaN; };
            const pf = (v, d=2) => isNaN(v) ? '--' : v.toFixed(d);
            const badgeAvg = '<span class="kpi-context-badge average">Average</span>';
            const badgeSel = '<span class="kpi-context-badge single">Selected</span>';

            const iconClock = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';
            const iconStar = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
            const iconRotate = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9"/><polyline points="21 3 21 9 15 9"/></svg>';
            const iconBolt = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>';
            const iconTrend = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>';

            if (!prim) {
                const avg15 = avg(turns, 'time_15in_15out_s');
                const best15 = best(turns, 'time_15in_15out_s');
                const avgRot = avg(turns, 'rotation_time_s');
                const avgPush = avg(turns, 'push_off_time_s');
                const avgKick = avg(turns, 'kick_rate');
                container.innerHTML = `
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon purple">${iconClock}</div>${badgeAvg}</div><div class="kpi-value">${pf(avg15)}s</div><div class="kpi-label">Avg 15m In/Out ${infoTip(TIPS.turn15inout)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green">${iconStar}</div></div><div class="kpi-value">${pf(best15)}s</div><div class="kpi-label">Best 15m In/Out</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon cyan">${iconRotate}</div>${badgeAvg}</div><div class="kpi-value">${pf(avgRot)}s</div><div class="kpi-label">Avg Rotation ${infoTip(TIPS.rotation)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon blue">${iconBolt}</div>${badgeAvg}</div><div class="kpi-value">${pf(avgPush)}s</div><div class="kpi-label">Avg Push-Off ${infoTip(TIPS.pushOff)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon orange">${iconTrend}</div>${badgeAvg}</div><div class="kpi-value">${pf(avgKick, 1)}</div><div class="kpi-label">Avg Kick Rate ${infoTip(TIPS.kickRate)}</div></div>
                `;
            } else if (!comp) {
                const best15 = best(turns, 'time_15in_15out_s');
                const t15 = parseFloat(prim.time_15in_15out_s);
                const rot = parseFloat(prim.rotation_time_s);
                const push = parseFloat(prim.push_off_time_s);
                const kick = parseFloat(prim.kick_rate);
                const t5in5out = parseFloat(prim.time_5in_5out_s);
                container.innerHTML = `
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green">${iconStar}</div></div><div class="kpi-value">${pf(best15)}s</div><div class="kpi-label">Best 15m In/Out (all)</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon purple">${iconClock}</div>${badgeSel}</div><div class="kpi-value">${pf(t15)}s</div><div class="kpi-label">15m In/Out ${infoTip(TIPS.turn15inout)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon cyan">${iconRotate}</div>${badgeSel}</div><div class="kpi-value">${pf(rot)}s</div><div class="kpi-label">Rotation Time ${infoTip(TIPS.rotation)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon blue">${iconBolt}</div>${badgeSel}</div><div class="kpi-value">${pf(push)}s</div><div class="kpi-label">Push-Off Time ${infoTip(TIPS.pushOff)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon orange">${iconTrend}</div>${badgeSel}</div><div class="kpi-value">${pf(kick, 1)}</div><div class="kpi-label">Kick Rate ${infoTip(TIPS.kickRate)}</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green">${iconClock}</div>${badgeSel}</div><div class="kpi-value">${pf(t5in5out)}s</div><div class="kpi-label">5m In / 5m Out</div></div>
                `;
            } else {
                const best15 = best(turns, 'time_15in_15out_s');
                const rp = prim, rc = comp;
                const rp15 = parseFloat(rp.time_15in_15out_s), rc15 = parseFloat(rc.time_15in_15out_s);
                const rpRot = parseFloat(rp.rotation_time_s), rcRot = parseFloat(rc.rotation_time_s);
                const rpPush = parseFloat(rp.push_off_time_s), rcPush = parseFloat(rc.push_off_time_s);
                container.innerHTML = `
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon green">${iconStar}</div></div><div class="kpi-value">${pf(best15)}s</div><div class="kpi-label">Best 15m In/Out</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon purple">${iconClock}</div></div><div class="kpi-value">${pf(rp15)}s ${turnDelta(rp15, rc15)}</div><div class="kpi-label">Primary 15m In/Out</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon cyan">${iconClock}</div></div><div class="kpi-value">${pf(rc15)}s</div><div class="kpi-label">Compare 15m In/Out</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon purple">${iconRotate}</div></div><div class="kpi-value">${pf(rpRot)}s ${turnDelta(rpRot, rcRot)}</div><div class="kpi-label">Primary Rotation</div></div>
                    <div class="kpi-card"><div class="kpi-header"><div class="kpi-icon blue">${iconBolt}</div></div><div class="kpi-value">${pf(rpPush)}s ${turnDelta(rpPush, rcPush)}</div><div class="kpi-label">Primary Push-Off</div></div>
                `;
            }
        }

        // "" Turn Trials Table ""
        function renderTurnTrials() {
            const container = document.getElementById('turnTrialsTable');
            const turns = turnModuleState.filteredTurns;
            const multi = turnModuleState._multiAthlete;
            const nameMap = turnModuleState._nameMap || {};
            if (!turns.length) { container.innerHTML = '<div class="empty-state"><h3>No turn trials found</h3></div>'; return; }

            const athHeader = multi ? '<th>Athlete</th>' : '';
            container.innerHTML = `<div style="overflow-x:auto;"><table class="data-table turn-trials-table"><thead><tr>
                ${athHeader}<th>Date</th><th>Style</th><th>15m In/Out</th><th>Rotation</th><th>Push-Off</th><th>5m In/Out</th><th>Kick Rate</th><th>Surface Break</th>
            </tr></thead><tbody>${turns.map((t, i) => {
                let cls = '';
                if (i === turnModuleState.primaryIdx) cls = 'row-primary';
                else if (i === turnModuleState.compareIdx) cls = 'row-compare';
                const athCol = multi ? `<td>${nameMap[t.athlete_uuid]||'Unknown'}</td>` : '';
                return `<tr class="${cls}" style="cursor:pointer;" onclick="selectTurnCard(${i})">
                    ${athCol}
                    <td>${formatDate(t.source_date)}</td>
                    <td style="text-transform:capitalize">${t.style || '--'}</td>
                    <td class="mono">${formatTime(t.time_15in_15out_s)}</td>
                    <td class="mono">${formatTime(t.rotation_time_s)}</td>
                    <td class="mono">${formatTime(t.push_off_time_s)}</td>
                    <td class="mono">${formatTime(t.time_5in_5out_s)}</td>
                    <td class="mono">${t.kick_rate ? parseFloat(t.kick_rate).toFixed(1) : '--'}</td>
                    <td class="mono">${formatTime(t.surface_break_s)}</td>
                </tr>`;
            }).join('')}</tbody></table></div>`;
        }

        // "" Derive pre-turn approach data ""
        // Prefers direct columns from updated v_turn_kpis view.
        // Falls back to derived calculation from combined times if direct columns are null.
        function deriveTurnPre(t) {
            // Direct columns (from updated view - may be null if view not yet updated)
            const directSplit15 = parseFloat(t.split_15m_pre_s);
            const directSplit10 = parseFloat(t.split_10m_pre_s);
            const directSplit5  = parseFloat(t.split_5m_pre_s);
            const directVel15_10 = parseFloat(t.avg_vel_15_10_pre);
            const directVel10_5  = parseFloat(t.avg_vel_10_5_pre);
            const directVel5_0   = parseFloat(t.avg_vel_5_0_pre);
            const directStrokeRatePre = parseFloat(t.stroke_rate_pre_turn);
            const directPushOffVel = parseFloat(t.push_off_velocity);

            // Use direct if available
            if (!isNaN(directSplit15) || !isNaN(directVel5_0)) {
                return {
                    pre15: !isNaN(directSplit15) ? Math.abs(directSplit15) : NaN,
                    pre10: !isNaN(directSplit10) ? Math.abs(directSplit10) : NaN,
                    pre5:  !isNaN(directSplit5)  ? Math.abs(directSplit5)  : NaN,
                    vel_15_10: !isNaN(directVel15_10) ? directVel15_10 : NaN,
                    vel_10_5:  !isNaN(directVel10_5)  ? directVel10_5  : NaN,
                    vel_5_0:   !isNaN(directVel5_0)   ? directVel5_0   : NaN,
                    vel_15_5:  !isNaN(directVel15_10) && !isNaN(directVel10_5) ? (directVel15_10 + directVel10_5) / 2 : NaN,
                    strokeRatePre: !isNaN(directStrokeRatePre) ? directStrokeRatePre : NaN,
                    pushOffVel: !isNaN(directPushOffVel) ? directPushOffVel : NaN,
                    hasThreeZones: !isNaN(directVel15_10) && !isNaN(directVel10_5) && !isNaN(directVel5_0)
                };
            }

            // Fallback: derive from combined times
            const t15out = parseFloat(t.time_15in_15out_s);
            const t5out  = parseFloat(t.time_5in_5out_s);
            const s15    = parseFloat(t.split_15m_s);
            const s5     = parseFloat(t.split_5m_s);

            const pre15 = (!isNaN(t15out) && !isNaN(s15)) ? t15out - s15 : NaN;
            const pre5  = (!isNaN(t5out) && !isNaN(s5))   ? t5out  - s5  : NaN;

            const vel_5_0  = (!isNaN(pre5) && pre5 > 0)  ? 5 / pre5  : NaN;
            const vel_15_5 = (!isNaN(pre15) && !isNaN(pre5) && (pre15 - pre5) > 0) ? 10 / (pre15 - pre5) : NaN;

            return {
                pre15, pre10: NaN, pre5,
                vel_15_10: NaN, vel_10_5: NaN, vel_5_0, vel_15_5,
                strokeRatePre: NaN, pushOffVel: NaN,
                hasThreeZones: false
            };
        }

        // "" Approach Tab ""
        function renderTurnApproach() {
            const contentDiv = document.getElementById('turnApproachContent');
            const chartsDiv = document.getElementById('turnApproachCharts');
            const timelineDiv = document.getElementById('turnApproachTimeline');
            const metricsDiv = document.getElementById('turnApproachMetrics');
            const prim = getTurnPrimary();
            const comp = getTurnCompare();

            if (appState.charts.turnApproachVel) { appState.charts.turnApproachVel.destroy(); appState.charts.turnApproachVel = null; }

            if (!prim) {
                contentDiv.style.display = '';
                contentDiv.innerHTML = '<div class="empty-state"><h3>Select a turn trial to view approach data</h3></div>';
                chartsDiv.style.display = 'none';
                if (metricsDiv) metricsDiv.innerHTML = '';
                return;
            }

            const primPre = deriveTurnPre(prim);
            const compPre = comp ? deriveTurnPre(comp) : null;

            if (isNaN(primPre.pre15) && isNaN(primPre.pre5) && isNaN(primPre.vel_5_0)) {
                contentDiv.style.display = '';
                chartsDiv.style.display = 'none';
                contentDiv.innerHTML = '<div class="empty-state"><h3>Insufficient data to derive approach metrics</h3><p style="color:var(--text-muted);font-size:13px;">Requires time_15in_15out_s, time_5in_5out_s, split_15m_s, and split_5m_s</p></div>';
                if (metricsDiv) metricsDiv.innerHTML = '';
                return;
            }

            contentDiv.style.display = 'none';
            chartsDiv.style.display = '';

            const pf = (v, d=2) => isNaN(v) ? '--' : v.toFixed(d);
            const threeZone = primPre.hasThreeZones;

            // Build segmented timeline
            function buildTimeline3(pre, colors, isCompare) {
                const s1 = !isNaN(pre.pre15) && !isNaN(pre.pre10) ? Math.abs(pre.pre15) - Math.abs(pre.pre10) : NaN;
                const s2 = !isNaN(pre.pre10) && !isNaN(pre.pre5) ? Math.abs(pre.pre10) - Math.abs(pre.pre5) : NaN;
                const s3 = !isNaN(pre.pre5) ? Math.abs(pre.pre5) : NaN;
                const tot = (!isNaN(s1) ? s1 : 0) + (!isNaN(s2) ? s2 : 0) + (!isNaN(s3) ? s3 : 0) || 1;
                const s1Pct = !isNaN(s1) ? Math.max(15, (s1/tot)*100) : 0;
                const s2Pct = !isNaN(s2) ? Math.max(15, (s2/tot)*100) : 0;
                const s3Pct = !isNaN(s3) ? Math.max(15, (s3/tot)*100) : 0;
                const small = isCompare ? ' style="font-size:12px;"' : '';
                const hideZone = isCompare ? ' style="display:none;"' : '';
                return `
                <div class="approach-timeline"${isCompare ? ' style="padding-top:16px; background:rgba(0,194,255,0.04);"' : ''}>
                    <div class="approach-marker"><span class="marker-dist">15m</span><span class="marker-line"></span></div>
                    ${s1Pct > 0 ? `<div class="approach-seg" style="flex:${s1Pct}; background:${colors[0]}; margin:0 2px;">
                        <span class="seg-zone"${hideZone}>15m-10m</span><span class="seg-time"${small}>${pf(s1)}s</span>
                    </div><div class="approach-marker"><span class="marker-dist">10m</span><span class="marker-line"></span></div>` : ''}
                    ${s2Pct > 0 ? `<div class="approach-seg" style="flex:${s2Pct}; background:${colors[1]}; margin:0 2px;">
                        <span class="seg-zone"${hideZone}>10m-5m</span><span class="seg-time"${small}>${pf(s2)}s</span>
                    </div><div class="approach-marker"><span class="marker-dist">5m</span><span class="marker-line"></span></div>` : ''}
                    ${s3Pct > 0 ? `<div class="approach-seg" style="flex:${s3Pct}; background:${colors[2]}; margin:0 2px;">
                        <span class="seg-zone"${hideZone}>5m-Wall</span><span class="seg-time"${small}>${pf(s3)}s</span>
                    </div>` : ''}
                    <div class="approach-wall"${isCompare ? ' style="height:44px; background:var(--accent-cyan); box-shadow:0 0 8px rgba(0,194,255,0.3);"' : ''}></div>
                    <span class="approach-wall-label"${isCompare ? ' style="color:var(--accent-cyan);"' : ''}>WALL</span>
                </div>`;
            }

            function buildTimeline2(pre, colors, isCompare) {
                const seg1Time = pre.pre15 - pre.pre5;
                const seg2Time = pre.pre5;
                const totalPre = pre.pre15 || 1;
                const s1Pct = Math.max(20, (seg1Time / totalPre) * 100);
                const s2Pct = Math.max(20, (seg2Time / totalPre) * 100);
                const small = isCompare ? ' style="font-size:12px;"' : '';
                const hideZone = isCompare ? ' style="display:none;"' : '';
                return `
                <div class="approach-timeline"${isCompare ? ' style="padding-top:16px; background:rgba(0,194,255,0.04);"' : ''}>
                    <div class="approach-marker"><span class="marker-dist">15m</span><span class="marker-line"></span></div>
                    <div class="approach-seg" style="flex:${s1Pct}; background:${colors[0]}; margin:0 3px;">
                        <span class="seg-zone"${hideZone}>15m-5m</span><span class="seg-time"${small}>${pf(seg1Time)}s</span>
                    </div>
                    <div class="approach-marker"><span class="marker-dist">5m</span><span class="marker-line"></span></div>
                    <div class="approach-seg" style="flex:${s2Pct}; background:${colors[1]}; margin:0 3px;">
                        <span class="seg-zone"${hideZone}>5m-Wall</span><span class="seg-time"${small}>${pf(seg2Time)}s</span>
                    </div>
                    <div class="approach-wall"${isCompare ? ' style="height:44px; background:var(--accent-cyan); box-shadow:0 0 8px rgba(0,194,255,0.3);"' : ''}></div>
                    <span class="approach-wall-label"${isCompare ? ' style="color:var(--accent-cyan);"' : ''}>WALL</span>
                </div>`;
            }

            let tlHtml = `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">Approach Timeline (pre-turn)</h4>`;

            if (threeZone) {
                tlHtml += buildTimeline3(primPre, ['rgba(167,139,250,0.65)', 'rgba(99,102,241,0.75)', 'rgba(0,194,255,0.85)'], false);
                tlHtml += `<div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:8px; font-size:11px; color:var(--text-muted); padding:0 16px; margin-top:2px; margin-bottom:4px;">
                    <span>Vel 15-10m: <strong style="color:rgba(167,139,250,1)">${pf(primPre.vel_15_10)} m/s</strong></span>
                    <span>Vel 10-5m: <strong style="color:rgba(99,102,241,1)">${pf(primPre.vel_10_5)} m/s</strong></span>
                    <span>Vel 5-0m: <strong style="color:rgba(0,194,255,1)">${pf(primPre.vel_5_0)} m/s</strong></span>
                </div>`;
            } else {
                tlHtml += buildTimeline2(primPre, ['rgba(167,139,250,0.75)', 'rgba(0,194,255,0.85)'], false);
                tlHtml += `<div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:8px; font-size:11px; color:var(--text-muted); padding:0 16px; margin-top:2px; margin-bottom:4px;">
                    <span>Total approach: <strong style="color:var(--text-secondary)">${pf(primPre.pre15)}s</strong></span>
                    <span>Avg vel 15-5m: <strong style="color:var(--accent-purple)">${pf(primPre.vel_15_5)} m/s</strong></span>
                    <span>Avg vel 5-0m: <strong style="color:var(--accent-blue)">${pf(primPre.vel_5_0)} m/s</strong></span>
                </div>`;
            }

            if (compPre && (!isNaN(compPre.pre15) || !isNaN(compPre.vel_5_0))) {
                tlHtml += `<div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(148,163,184,0.1);">
                    <div style="font-size:11px; color:var(--accent-cyan); font-weight:500; margin-bottom:4px;">Compare trial:</div>`;
                if (compPre.hasThreeZones) {
                    tlHtml += buildTimeline3(compPre, ['rgba(0,194,255,0.45)', 'rgba(0,194,255,0.60)', 'rgba(0,194,255,0.75)'], true);
                } else {
                    tlHtml += buildTimeline2(compPre, ['rgba(0,194,255,0.55)', 'rgba(0,194,255,0.75)'], true);
                }
                tlHtml += `</div>`;
            }

            timelineDiv.innerHTML = tlHtml;

            // Velocity chart
            let velLabels, primVels;
            if (threeZone) {
                velLabels = ['15-10m pre', '10-5m pre', '5-0m pre'];
                primVels = [primPre.vel_15_10 || 0, primPre.vel_10_5 || 0, primPre.vel_5_0 || 0];
            } else {
                velLabels = ['15-5m pre', '5-0m pre'];
                primVels = [primPre.vel_15_5 || 0, primPre.vel_5_0 || 0];
            }
            const velDS = [{
                label: comp ? 'Primary' : 'Selected',
                data: primVels, borderColor: 'rgba(167,139,250,1)', backgroundColor: 'rgba(167,139,250,0.15)',
                fill: true, tension: 0.35, pointRadius: 6, pointBackgroundColor: 'rgba(167,139,250,1)',
                pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2.5
            }];
            if (compPre) {
                let compVels;
                if (threeZone && compPre.hasThreeZones) {
                    compVels = [compPre.vel_15_10 || 0, compPre.vel_10_5 || 0, compPre.vel_5_0 || 0];
                } else if (!threeZone) {
                    compVels = [compPre.vel_15_5 || 0, compPre.vel_5_0 || 0];
                } else {
                    compVels = [0, (compPre.vel_15_5 || 0), compPre.vel_5_0 || 0];
                }
                velDS.push({
                    label: 'Compare',
                    data: compVels,
                    borderColor: 'rgba(0,194,255,1)', backgroundColor: 'rgba(0,194,255,0.1)',
                    fill: true, tension: 0.35, pointRadius: 6, pointBackgroundColor: 'rgba(0,194,255,1)',
                    pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2, borderDash: [5, 3]
                });
            }

            appState.charts.turnApproachVel = new Chart(document.getElementById('turnApproachVelChart'), {
                type: 'line', data: { labels: velLabels, datasets: velDS },
                plugins: [dataLabelsPlugin],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 20 } },
                    scales: {
                        x: { grid: { color: 'rgba(128,140,160,0.08)' }, ticks: { color: getThemeColors().textSec, font: { size: 11 } } },
                        y: { grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec }, title: { display: true, text: 'm/s', color: getThemeColors().textSec } }
                    },
                    plugins: { legend: { display: !!comp, position: 'bottom', labels: { color: getThemeColors().textSec, usePointStyle: true } } }
                }
            });

            // Metric cards - enhanced with 3-zone and new metrics
            let mHtml = `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin:16px 0 10px;">Approach Details</h4>
            <div class="start-metric-grid">`;
            if (threeZone) {
                mHtml += turnMetricCard('Split 15m pre', pf(primPre.pre15), 's', compPre ? turnDelta(primPre.pre15, compPre.pre15, true) : '');
                mHtml += turnMetricCard('Split 10m pre', pf(primPre.pre10), 's', compPre ? turnDelta(primPre.pre10, compPre.pre10, true) : '');
                mHtml += turnMetricCard('Split 5m pre', pf(primPre.pre5), 's', compPre ? turnDelta(primPre.pre5, compPre.pre5, true) : '');
                mHtml += turnMetricCard('Vel 15-10m', pf(primPre.vel_15_10), 'm/s', compPre ? turnDelta(primPre.vel_15_10, compPre.vel_15_10, false) : '');
                mHtml += turnMetricCard('Vel 10-5m', pf(primPre.vel_10_5), 'm/s', compPre ? turnDelta(primPre.vel_10_5, compPre.vel_10_5, false) : '');
                mHtml += turnMetricCard('Vel 5-0m', pf(primPre.vel_5_0), 'm/s', compPre ? turnDelta(primPre.vel_5_0, compPre.vel_5_0, false) : '');
            } else {
                mHtml += turnMetricCard('15m pre Split', pf(primPre.pre15), 's', compPre ? turnDelta(primPre.pre15, compPre.pre15, true) : '');
                mHtml += turnMetricCard('5m pre Split', pf(primPre.pre5), 's', compPre ? turnDelta(primPre.pre5, compPre.pre5, true) : '');
                mHtml += turnMetricCard('Vel 15-5m pre', pf(primPre.vel_15_5), 'm/s', compPre ? turnDelta(primPre.vel_15_5, compPre.vel_15_5, false) : '');
                mHtml += turnMetricCard('Vel 5-0m pre', pf(primPre.vel_5_0), 'm/s', compPre ? turnDelta(primPre.vel_5_0, compPre.vel_5_0, false) : '');
            }
            // Extra metrics from new view columns
            if (!isNaN(primPre.strokeRatePre)) {
                mHtml += turnMetricCard('Stroke Rate (pre)', pf(primPre.strokeRatePre, 1), 'spm', compPre && !isNaN(compPre.strokeRatePre) ? turnDelta(primPre.strokeRatePre, compPre.strokeRatePre, false) : '');
            }
            if (!isNaN(primPre.pushOffVel)) {
                mHtml += turnMetricCard('Push-Off Velocity', pf(primPre.pushOffVel), 'm/s', compPre && !isNaN(compPre.pushOffVel) ? turnDelta(primPre.pushOffVel, compPre.pushOffVel, false) : '');
            }
            mHtml += `</div>`;
            metricsDiv.innerHTML = mHtml;
        }

        // "" Wall Contact Tab ""
        // Info icon SVG helper
        // wallTip renders label + tooltip for wall contact metrics

        function wallTip(label, tip) {
            return `${label} ${infoTip(tip)}`;
        }

        function renderTurnWallContact() {
            const container = document.getElementById('turnWallContent');
            const prim = getTurnPrimary();
            const comp = getTurnCompare();

            if (!prim) {
                container.innerHTML = '<div class="empty-state"><h3>Select a turn trial to view wall contact data</h3></div>';
                return;
            }

            const adaption = parseFloat(prim.adaption_time_s) || 0;
            const rotation = parseFloat(prim.rotation_time_s) || 0;
            const handContact = parseFloat(prim.hand_contact_time_s) || 0;
            const pushOff = parseFloat(prim.push_off_time_s) || 0;
            const total = adaption + rotation + handContact + pushOff || 1;

            let html = `<div style="margin-bottom:16px;">
                <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Wall Contact - ${turnLabel(prim)}</h3>
                ${comp ? `<p style="font-size:12px; color:var(--accent-cyan);">Compared with ${turnLabel(comp)}</p>` : ''}
            </div>`;

            // Phase bar - correct biomechanical order: Adapt -> Hand -> Rotate -> Push
            html += `<div class="phase-bar-stack">
                <div class="phase-bar-segment" style="width:${(adaption/total*100).toFixed(1)}%; background:rgba(245,166,35,0.85);">
                    <span class="seg-label">Adapt</span><span class="seg-value">${adaption.toFixed(3)}s</span>
                </div>
                <div class="phase-bar-segment" style="width:${(handContact/total*100).toFixed(1)}%; background:rgba(0,194,255,0.85);">
                    <span class="seg-label">Hand</span><span class="seg-value">${handContact.toFixed(3)}s</span>
                </div>
                <div class="phase-bar-segment" style="width:${(rotation/total*100).toFixed(1)}%; background:rgba(167,139,250,0.85);">
                    <span class="seg-label">Rotate</span><span class="seg-value">${rotation.toFixed(3)}s</span>
                </div>
                <div class="phase-bar-segment" style="width:${(pushOff/total*100).toFixed(1)}%; background:rgba(0,194,255,0.85);">
                    <span class="seg-label">Push</span><span class="seg-value">${pushOff.toFixed(3)}s</span>
                </div>
            </div>`;

            if (comp) {
                const ca = parseFloat(comp.adaption_time_s)||0, cr = parseFloat(comp.rotation_time_s)||0;
                const ch = parseFloat(comp.hand_contact_time_s)||0, cp = parseFloat(comp.push_off_time_s)||0;
                const ct = ca+cr+ch+cp || 1;
                html += `<div style="font-size:11px; color:var(--accent-cyan); margin:8px 0 4px; font-weight:500;">Compare trial:</div>
                <div class="phase-bar-stack" style="height:30px; opacity:0.75;">
                    <div class="phase-bar-segment" style="width:${(ca/ct*100).toFixed(1)}%; background:rgba(245,166,35,0.6);"><span class="seg-value" style="font-size:11px">${ca.toFixed(3)}s</span></div>
                    <div class="phase-bar-segment" style="width:${(ch/ct*100).toFixed(1)}%; background:rgba(0,194,255,0.6);"><span class="seg-value" style="font-size:11px">${ch.toFixed(3)}s</span></div>
                    <div class="phase-bar-segment" style="width:${(cr/ct*100).toFixed(1)}%; background:rgba(167,139,250,0.6);"><span class="seg-value" style="font-size:11px">${cr.toFixed(3)}s</span></div>
                    <div class="phase-bar-segment" style="width:${(cp/ct*100).toFixed(1)}%; background:rgba(0,194,255,0.6);"><span class="seg-value" style="font-size:11px">${cp.toFixed(3)}s</span></div>
                </div>`;
            }

            // Metric cards with info tooltips for each phase
            html += `<div class="start-metric-grid" style="margin-top:16px;">
                ${turnMetricCard(wallTip('Adaption', 'The time between the last stroke and initiating wall contact. Reflects how well the swimmer times their approach into the wall.'), adaption.toFixed(3), 's', comp ? turnDelta(adaption, parseFloat(comp.adaption_time_s)) : '')}
                ${turnMetricCard(wallTip('Hand Contact', 'Duration the hands are in contact with the wall. A shorter contact time typically means a faster transition into the turn.'), handContact.toFixed(3), 's', comp ? turnDelta(handContact, parseFloat(comp.hand_contact_time_s)) : '')}
                ${turnMetricCard(wallTip('Rotation', 'Time to complete the flip or turning motion after leaving the wall. Faster rotation helps maintain momentum.'), rotation.toFixed(3), 's', comp ? turnDelta(rotation, parseFloat(comp.rotation_time_s)) : '')}
                ${turnMetricCard(wallTip('Push-Off', 'Time spent pushing off the wall with the feet. A powerful, quick push-off generates higher exit velocity.'), pushOff.toFixed(3), 's', comp ? turnDelta(pushOff, parseFloat(comp.push_off_time_s)) : '')}
                ${turnMetricCard(wallTip('Total Wall Time', 'Combined time for all wall contact phases. Lower is generally better - it means less time on the wall and more time swimming.'), total.toFixed(3), 's', comp ? turnDelta(total, (parseFloat(comp.adaption_time_s)||0)+(parseFloat(comp.rotation_time_s)||0)+(parseFloat(comp.hand_contact_time_s)||0)+(parseFloat(comp.push_off_time_s)||0)) : '')}
                ${turnMetricCard('Push-Off Velocity', prim.push_off_velocity ? parseFloat(prim.push_off_velocity).toFixed(2) : '--', 'm/s', comp && comp.push_off_velocity ? turnDelta(parseFloat(prim.push_off_velocity), parseFloat(comp.push_off_velocity), false) : '')}
            </div>`;

            container.innerHTML = html;
        }

        // "" Turn Underwater Tab ""
        function renderTurnUnderwater() {
            const contentDiv = document.getElementById('turnUWContent');
            const chartsDiv = document.getElementById('turnUWCharts');
            const timelineDiv = document.getElementById('turnUWTimeline');
            const metricsDiv = document.getElementById('turnUWMetrics');
            const prim = getTurnPrimary();
            const comp = getTurnCompare();

            // Only velocity chart remains (split bar chart replaced by timeline)
            if (appState.charts.turnUWVel) { appState.charts.turnUWVel.destroy(); appState.charts.turnUWVel = null; }

            if (!prim) {
                contentDiv.style.display = '';
                contentDiv.innerHTML = '<div class="empty-state"><h3>Select a turn trial to view underwater phase</h3></div>';
                chartsDiv.style.display = 'none';
                return;
            }
            contentDiv.style.display = 'none';
            chartsDiv.style.display = '';

            const vn = (key) => parseFloat(prim[key]);
            const vc = (key) => comp ? parseFloat(comp[key]) : null;
            const pf = (v, d=2) => isNaN(v) ? '--' : v.toFixed(d);

            // Derive segment times from cumulative splits
            const s5 = parseFloat(prim.split_5m_s) || 0;
            const s10 = parseFloat(prim.split_10m_s) || 0;
            const s15 = parseFloat(prim.split_15m_s) || 0;
            const seg1 = s5;           // wall -> 5m
            const seg2 = s10 - s5;     // 5m -> 10m
            const seg3 = s15 - s10;    // 10m -> 15m
            const totalPost = s15 || 1;

            function buildPostTimeline(g1, g2, g3, tot, colors, isCompare) {
                return `
                <div class="approach-timeline"${isCompare ? ' style="padding-top:16px; background:rgba(0,194,255,0.04);"' : ''}>
                    <span class="approach-wall-label"${isCompare ? ' style="color:var(--accent-cyan);"' : ''}>WALL</span>
                    <div class="approach-wall"${isCompare ? ' style="height:44px; background:var(--accent-cyan); box-shadow:0 0 8px rgba(0,194,255,0.3);"' : ''}></div>
                    <div class="approach-seg" style="flex:${Math.max(15, (g1/tot)*100)}; background:${colors[0]}; margin:0 3px;">
                        <span class="seg-zone"${isCompare ? ' style="display:none;"' : ''}>Wall -> 5m</span>
                        <span class="seg-time"${isCompare ? ' style="font-size:12px;"' : ''}>${pf(g1)}s</span>
                    </div>
                    <div class="approach-marker"><span class="marker-dist">5m</span><span class="marker-line"></span></div>
                    <div class="approach-seg" style="flex:${Math.max(15, (g2/tot)*100)}; background:${colors[1]}; margin:0 3px;">
                        <span class="seg-zone"${isCompare ? ' style="display:none;"' : ''}>5m -> 10m</span>
                        <span class="seg-time"${isCompare ? ' style="font-size:12px;"' : ''}>${pf(g2)}s</span>
                    </div>
                    <div class="approach-marker"><span class="marker-dist">10m</span><span class="marker-line"></span></div>
                    <div class="approach-seg" style="flex:${Math.max(15, (g3/tot)*100)}; background:${colors[2]}; margin:0 3px;">
                        <span class="seg-zone"${isCompare ? ' style="display:none;"' : ''}>10m -> 15m</span>
                        <span class="seg-time"${isCompare ? ' style="font-size:12px;"' : ''}>${pf(g3)}s</span>
                    </div>
                    <div class="approach-marker"><span class="marker-dist">15m</span><span class="marker-line"></span></div>
                </div>`;
            }

            let tlHtml = `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:4px;">Post-Turn Splits</h4>`;
            tlHtml += buildPostTimeline(seg1, seg2, seg3, totalPost,
                ['rgba(167,139,250,0.65)', 'rgba(99,102,241,0.75)', 'rgba(0,194,255,0.85)'], false);

            // Summary row
            tlHtml += `<div style="display:flex; justify-content:space-between; flex-wrap:wrap; gap:8px; font-size:11px; color:var(--text-muted); padding:0 16px; margin-top:2px; margin-bottom:4px;">
                <span>Total 15m: <strong style="color:var(--text-secondary)">${pf(s15)}s</strong></span>
                <span>Surface break: <strong style="color:var(--accent-cyan)">${pf(vn('surface_break_s'))}s</strong></span>
                <span>Kick rate: <strong style="color:var(--accent-orange)">${pf(vn('kick_rate'), 1)} /min</strong></span>
            </div>`;

            // Compare timeline
            if (comp) {
                const cs5 = parseFloat(comp.split_5m_s) || 0;
                const cs10 = parseFloat(comp.split_10m_s) || 0;
                const cs15 = parseFloat(comp.split_15m_s) || 0;
                tlHtml += `<div style="margin-top:12px; padding-top:12px; border-top:1px solid rgba(148,163,184,0.1);">
                    <div style="font-size:11px; color:var(--accent-cyan); font-weight:500; margin-bottom:4px;">Compare trial:</div>`;
                tlHtml += buildPostTimeline(cs5, cs10-cs5, cs15-cs10, cs15||1,
                    ['rgba(0,194,255,0.5)', 'rgba(0,194,255,0.65)', 'rgba(0,194,255,0.8)'], true);
                tlHtml += `</div>`;
            }

            timelineDiv.innerHTML = tlHtml;

            // Post-turn velocity (line chart - kept)
            const velLabels = ['0-5m', '5-10m', '10-15m'];
            const velKeys = ['avg_vel_0_5', 'avg_vel_5_10', 'avg_vel_10_15'];
            const primVels = velKeys.map(k => parseFloat(prim[k]) || 0);
            const velDS = [{
                label: comp ? 'Primary' : 'Selected', data: primVels,
                borderColor: 'rgba(167,139,250,1)', backgroundColor: 'rgba(167,139,250,0.15)',
                fill: true, tension: 0.35, pointRadius: 5, pointBackgroundColor: 'rgba(167,139,250,1)',
                pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2.5
            }];
            if (comp) {
                velDS.push({
                    label: 'Compare', data: velKeys.map(k => parseFloat(comp[k]) || 0),
                    borderColor: 'rgba(0,194,255,1)', backgroundColor: 'rgba(0,194,255,0.1)',
                    fill: true, tension: 0.35, pointRadius: 5, pointBackgroundColor: 'rgba(0,194,255,1)',
                    pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2, borderDash: [5, 3]
                });
            }

            appState.charts.turnUWVel = new Chart(document.getElementById('turnUWVelChart'), {
                type: 'line', data: { labels: velLabels, datasets: velDS },
                plugins: [dataLabelsPlugin],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 20 } },
                    scales: {
                        x: { grid: { color: 'rgba(128,140,160,0.08)' }, ticks: { color: getThemeColors().textSec, font: { size: 11 } } },
                        y: { grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec }, title: { display: true, text: 'm/s', color: getThemeColors().textSec } }
                    },
                    plugins: { legend: { display: !!comp, position: 'bottom', labels: { color: getThemeColors().textSec, usePointStyle: true } } }
                }
            });

            // Metrics
            let mHtml = `<h4 style="font-size:13px; font-weight:600; color:var(--text-secondary); margin:16px 0 10px;">Underwater Details</h4>
            <div class="start-metric-grid">
                ${turnMetricCard('Kick Rate', (vn('kick_rate')||0).toFixed(1), '/min', comp ? turnDelta(vn('kick_rate'), vc('kick_rate'), false) : '')}
                ${turnMetricCard('Surface Break', (vn('surface_break_s')||0).toFixed(2), 's', comp ? turnDelta(vn('surface_break_s'), vc('surface_break_s'), true) : '')}
                ${turnMetricCard('Stroke Rate (post)', (vn('stroke_rate_post_turn')||0).toFixed(1), '/min', comp ? turnDelta(vn('stroke_rate_post_turn'), vc('stroke_rate_post_turn'), false) : '')}
                ${turnMetricCard('5m-in / 5m-out', (vn('time_5in_5out_s')||0).toFixed(2), 's', comp ? turnDelta(vn('time_5in_5out_s'), vc('time_5in_5out_s'), true) : '')}
                ${turnMetricCard('5m-in / 15m-out', (vn('time_5in_15out_s')||0).toFixed(2), 's', comp ? turnDelta(vn('time_5in_15out_s'), vc('time_5in_15out_s'), true) : '')}
            </div>`;
            metricsDiv.innerHTML = mHtml;
        }

        // "" Full Velocity Profile Tab ""
        function renderTurnVelocityProfile() {
            const turns = turnModuleState.filteredTurns;
            const prim = getTurnPrimary();
            const comp = getTurnCompare();
            const metricsDiv = document.getElementById('turnVelocityMetrics');

            if (appState.charts.turnFullVel) { appState.charts.turnFullVel.destroy(); appState.charts.turnFullVel = null; }
            const canvas = document.getElementById('turnFullVelChart');
            if (!canvas || !turns.length) return;

            // Determine if we have 3-zone pre-turn data
            const samplePre = deriveTurnPre(turns[0]);
            const useThreeZone = samplePre.hasThreeZones;

            const fullLabels = useThreeZone
                ? ['15-10m pre', '10-5m pre', '5-0m pre', '0-5m post', '5-10m post', '10-15m post']
                : ['15-5m pre', '5-0m pre', '0-5m post', '5-10m post', '10-15m post'];

            function buildVelData(t) {
                const pre = deriveTurnPre(t);
                if (useThreeZone) {
                    return [
                        isNaN(pre.vel_15_10) ? 0 : pre.vel_15_10,
                        isNaN(pre.vel_10_5) ? 0 : pre.vel_10_5,
                        isNaN(pre.vel_5_0) ? 0 : pre.vel_5_0,
                        parseFloat(t.avg_vel_0_5) || 0,
                        parseFloat(t.avg_vel_5_10) || 0,
                        parseFloat(t.avg_vel_10_15) || 0
                    ];
                }
                return [
                    isNaN(pre.vel_15_5) ? 0 : pre.vel_15_5,
                    isNaN(pre.vel_5_0) ? 0 : pre.vel_5_0,
                    parseFloat(t.avg_vel_0_5) || 0,
                    parseFloat(t.avg_vel_5_10) || 0,
                    parseFloat(t.avg_vel_10_15) || 0
                ];
            }

            let datasets = [];

            if (prim && comp) {
                datasets = [
                    {
                        label: turnLabel(prim), data: buildVelData(prim),
                        borderColor: 'rgba(167,139,250,1)', backgroundColor: 'rgba(167,139,250,0.12)',
                        fill: true, tension: 0.35, pointRadius: 5, pointBackgroundColor: 'rgba(167,139,250,1)',
                        pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2.5
                    },
                    {
                        label: turnLabel(comp), data: buildVelData(comp),
                        borderColor: 'rgba(0,194,255,1)', backgroundColor: 'rgba(0,194,255,0.08)',
                        fill: true, tension: 0.35, pointRadius: 5, pointBackgroundColor: 'rgba(0,194,255,1)',
                        pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2, borderDash: [5, 3]
                    }
                ];
            } else if (prim) {
                const avgData = fullLabels.map((_, i) => {
                    const vals = turns.map(t => buildVelData(t)[i]).filter(v => v > 0);
                    return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : 0;
                });
                datasets = [
                    {
                        label: 'Selected', data: buildVelData(prim),
                        borderColor: 'rgba(167,139,250,1)', backgroundColor: 'rgba(167,139,250,0.12)',
                        fill: true, tension: 0.35, pointRadius: 5, pointBackgroundColor: 'rgba(167,139,250,1)',
                        pointBorderColor: '#fff', pointBorderWidth: 2, borderWidth: 2.5
                    },
                    {
                        label: 'Average (all)', data: avgData,
                        borderColor: 'rgba(148,163,184,0.6)', backgroundColor: 'rgba(148,163,184,0.05)',
                        fill: false, tension: 0.35, pointRadius: 4, pointBackgroundColor: 'rgba(148,163,184,0.6)',
                        borderWidth: 1.5, borderDash: [4, 4]
                    }
                ];
            } else {
                const recent = turns.slice(0, 5);
                const colors = ['rgba(167,139,250,1)', 'rgba(0,194,255,1)', 'rgba(245,166,35,1)', 'rgba(0,194,255,1)', 'rgba(0,230,138,1)'];
                datasets = recent.map((t, i) => ({
                    label: formatDate(t.source_date), data: buildVelData(t),
                    borderColor: colors[i], backgroundColor: 'transparent',
                    fill: false, tension: 0.35, pointRadius: 4, pointBackgroundColor: colors[i],
                    borderWidth: 2
                }));
            }

            // Wall annotation - position depends on number of zones
            const wallIdx = useThreeZone ? 2.5 : 1.5;  // between last pre and first post
            const wallPlugin = {
                id: 'wallAnnotation',
                beforeDraw(chart) {
                    const { ctx, chartArea, scales } = chart;
                    if (!scales.x) return;
                    const x1 = scales.x.getPixelForValue(wallIdx - 0.5);
                    const x2 = scales.x.getPixelForValue(wallIdx + 0.5);
                    ctx.save();
                    ctx.fillStyle = 'rgba(167,139,250,0.06)';
                    ctx.fillRect(x1, chartArea.top, x2-x1, chartArea.bottom - chartArea.top);
                    ctx.fillStyle = 'rgba(167,139,250,0.5)';
                    ctx.font = '10px Montserrat, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText('WALL', (x1+x2)/2, chartArea.top + 14);
                    ctx.restore();
                }
            };

            appState.charts.turnFullVel = new Chart(canvas, {
                type: 'line', data: { labels: fullLabels, datasets },
                plugins: [dataLabelsPlugin, wallPlugin],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    layout: { padding: { top: 24 } },
                    scales: {
                        x: { grid: { color: 'rgba(128,140,160,0.08)' }, ticks: { color: getThemeColors().textSec, font: { size: 10 } } },
                        y: { grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec }, title: { display: true, text: 'm/s', color: getThemeColors().textSec } }
                    },
                    plugins: { legend: { position: 'bottom', labels: { color: getThemeColors().textSec, usePointStyle: true } } }
                }
            });

            // Metrics below
            if (prim && metricsDiv) {
                const primPre = deriveTurnPre(prim);
                const compPre = comp ? deriveTurnPre(comp) : null;
                const pf = (v) => isNaN(v) ? '--' : v.toFixed(2);
                const primData = buildVelData(prim);
                const compData = comp ? buildVelData(comp) : null;
                metricsDiv.innerHTML = `<div class="start-metric-grid" style="margin-top:16px;">
                    ${fullLabels.map((lbl, i) => {
                        const val = primData[i];
                        const cval = compData ? compData[i] : null;
                        return turnMetricCard(lbl, val > 0 ? val.toFixed(2) : '--', 'm/s', comp ? turnDelta(val, cval, false) : '');
                    }).join('')}
                </div>`;
            } else if (metricsDiv) {
                metricsDiv.innerHTML = '';
            }
        }

        // "" Turn Summary Tab ""
        function renderTurnSummary() {
            const container = document.getElementById('turnSummaryContent');
            const prim = getTurnPrimary();
            const comp = getTurnCompare();

            if (!prim) {
                container.innerHTML = `<div class="empty-state"><h3>Select a turn trial to see summary</h3>
                    <p style="color:var(--text-muted);font-size:13px;">Or select two for a side-by-side comparison</p></div>`;
                return;
            }

            const pf = (val, d=3) => { const n = parseFloat(val); return isNaN(n) ? '--' : n.toFixed(d); };

            if (!comp) {
                const primPre = deriveTurnPre(prim);
                const pushVel = parseFloat(prim.push_off_velocity);
                let html = `<div style="margin-bottom:16px;">
                    <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Turn Summary</h3>
                    <p style="font-size:13px; color:var(--text-muted);">${turnLabel(prim)}</p>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px;">
                    <div class="start-metric-item" style="padding:20px;">
                        <div style="font-size:13px; font-weight:600; color:var(--accent-purple); margin-bottom:12px;">
                            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                            Approach
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                            ${primPre.hasThreeZones ? `
                            Split 15m pre: <strong style="color:var(--text-primary)">${pf(primPre.pre15, 2)}s</strong><br>
                            Split 10m pre: <strong style="color:var(--text-primary)">${pf(primPre.pre10, 2)}s</strong><br>
                            Split 5m pre: <strong style="color:var(--text-primary)">${pf(primPre.pre5, 2)}s</strong><br>
                            Vel 15-10m: <strong style="color:var(--text-primary)">${pf(primPre.vel_15_10, 2)} m/s</strong><br>
                            Vel 10-5m: <strong style="color:var(--text-primary)">${pf(primPre.vel_10_5, 2)} m/s</strong><br>
                            Vel 5-0m: <strong style="color:var(--text-primary)">${pf(primPre.vel_5_0, 2)} m/s</strong>
                            ` : `
                            15m pre Split: <strong style="color:var(--text-primary)">${pf(primPre.pre15, 2)}s</strong><br>
                            5m pre Split: <strong style="color:var(--text-primary)">${pf(primPre.pre5, 2)}s</strong><br>
                            Vel 5-0m pre: <strong style="color:var(--text-primary)">${pf(primPre.vel_5_0, 2)} m/s</strong>
                            `}
                            ${!isNaN(primPre.strokeRatePre) ? `<br>Stroke Rate (pre): <strong style="color:var(--text-primary)">${pf(primPre.strokeRatePre, 1)} /min</strong>` : ''}
                        </div>
                    </div>
                    <div class="start-metric-item" style="padding:20px;">
                        <div style="font-size:13px; font-weight:600; color:var(--accent-orange); margin-bottom:12px;">
                            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9"/><polyline points="21 3 21 9 15 9"/></svg>
                            Wall Contact
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                            Rotation: <strong style="color:var(--text-primary)">${pf(prim.rotation_time_s)}s</strong><br>
                            Push-Off: <strong style="color:var(--text-primary)">${pf(prim.push_off_time_s)}s</strong><br>
                            Hand Contact: <strong style="color:var(--text-primary)">${pf(prim.hand_contact_time_s)}s</strong>
                            ${!isNaN(pushVel) ? `<br>Push-Off Vel: <strong style="color:var(--text-primary)">${pushVel.toFixed(2)} m/s</strong>` : ''}
                        </div>
                    </div>
                    <div class="start-metric-item" style="padding:20px;">
                        <div style="font-size:13px; font-weight:600; color:var(--accent-cyan); margin-bottom:12px;">
                            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22V8M5 12H2a10 10 0 0020 0h-3"/></svg>
                            Underwater (Post-Turn)
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                            Split 5m: <strong style="color:var(--text-primary)">${pf(prim.split_5m_s, 2)}s</strong><br>
                            Split 10m: <strong style="color:var(--text-primary)">${pf(prim.split_10m_s, 2)}s</strong><br>
                            Split 15m: <strong style="color:var(--text-primary)">${pf(prim.split_15m_s, 2)}s</strong><br>
                            Surface Break: <strong style="color:var(--text-primary)">${pf(prim.surface_break_s, 2)}s</strong><br>
                            Kick Rate: <strong style="color:var(--text-primary)">${pf(prim.kick_rate, 1)} /min</strong>
                        </div>
                    </div>
                    <div class="start-metric-item" style="padding:20px;">
                        <div style="font-size:13px; font-weight:600; color:var(--accent-green); margin-bottom:12px;">
                            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                            Post-Turn Velocity
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                            Vel 0-5m: <strong style="color:var(--text-primary)">${pf(prim.avg_vel_0_5, 2)} m/s</strong><br>
                            Vel 5-10m: <strong style="color:var(--text-primary)">${pf(prim.avg_vel_5_10, 2)} m/s</strong><br>
                            Vel 10-15m: <strong style="color:var(--text-primary)">${pf(prim.avg_vel_10_15, 2)} m/s</strong><br>
                            Stroke Rate: <strong style="color:var(--text-primary)">${pf(prim.stroke_rate_post_turn, 1)} /min</strong>
                        </div>
                    </div>
                    <div class="start-metric-item" style="padding:20px;">
                        <div style="font-size:13px; font-weight:600; color:var(--accent-blue); margin-bottom:12px;">
                            <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Overall
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary); line-height:1.8;">
                            15m In / 15m Out: <strong style="color:var(--text-primary)">${pf(prim.time_15in_15out_s, 2)}s</strong><br>
                            5m In / 5m Out: <strong style="color:var(--text-primary)">${pf(prim.time_5in_5out_s, 2)}s</strong><br>
                            5m In / 15m Out: <strong style="color:var(--text-primary)">${pf(prim.time_5in_15out_s, 2)}s</strong>
                        </div>
                    </div>
                </div>`;
                container.innerHTML = html;
            } else {
                // Comparison table
                const rp = prim, rc = comp;
                const rpPre = deriveTurnPre(rp);
                const rcPre = deriveTurnPre(rc);
                const metrics = [
                    { label: '15m In / 15m Out', key: 'time_15in_15out_s', d: 2, unit: 's', lower: true },
                    { label: '5m In / 5m Out', key: 'time_5in_5out_s', d: 2, unit: 's', lower: true },
                    { label: '5m In / 15m Out', key: 'time_5in_15out_s', d: 2, unit: 's', lower: true },
                    { label: '15m pre Split', derived: true, a: rpPre.pre15, b: rcPre.pre15, d: 2, unit: 's', lower: true },
                    { label: '5m pre Split', derived: true, a: rpPre.pre5, b: rcPre.pre5, d: 2, unit: 's', lower: true },
                    { label: 'Vel 5-0m pre', derived: true, a: rpPre.vel_5_0, b: rcPre.vel_5_0, d: 2, unit: 'm/s', lower: false },
                    ...(rpPre.hasThreeZones ? [
                        { label: 'Vel 15-10m pre', derived: true, a: rpPre.vel_15_10, b: rcPre.vel_15_10, d: 2, unit: 'm/s', lower: false },
                        { label: 'Vel 10-5m pre', derived: true, a: rpPre.vel_10_5, b: rcPre.vel_10_5, d: 2, unit: 'm/s', lower: false },
                    ] : []),
                    ...(!isNaN(rpPre.strokeRatePre) ? [
                        { label: 'Stroke Rate (pre)', derived: true, a: rpPre.strokeRatePre, b: rcPre.strokeRatePre, d: 1, unit: '/min', lower: false },
                    ] : []),
                    { label: 'Adaption Time', key: 'adaption_time_s', d: 3, unit: 's', lower: true },
                    { label: 'Rotation Time', key: 'rotation_time_s', d: 3, unit: 's', lower: true },
                    { label: 'Hand Contact', key: 'hand_contact_time_s', d: 3, unit: 's', lower: true },
                    { label: 'Push-Off Time', key: 'push_off_time_s', d: 3, unit: 's', lower: true },
                    { label: 'Push-Off Velocity', key: 'push_off_velocity', d: 2, unit: 'm/s', lower: false },
                    { label: 'Kick Rate', key: 'kick_rate', d: 1, unit: '/min', lower: false },
                    { label: 'Surface Break', key: 'surface_break_s', d: 2, unit: 's', lower: true },
                    { label: 'Stroke Rate (post)', key: 'stroke_rate_post_turn', d: 1, unit: '/min', lower: false },
                    { label: 'Vel 0-5m post', key: 'avg_vel_0_5', d: 2, unit: 'm/s', lower: false },
                    { label: 'Vel 5-10m post', key: 'avg_vel_5_10', d: 2, unit: 'm/s', lower: false },
                    { label: 'Vel 10-15m post', key: 'avg_vel_10_15', d: 2, unit: 'm/s', lower: false },
                ];

                let html = `<div style="margin-bottom:16px;">
                    <h3 style="font-size:15px; font-weight:600; color:var(--text-primary); margin-bottom:4px;">Side-by-Side Comparison</h3>
                </div>
                <div style="overflow-x:auto;">
                <table class="data-table"><thead><tr>
                    <th>Metric</th>
                    <th style="color:var(--accent-purple);">${turnLabel(rp)}</th>
                    <th style="color:var(--accent-cyan);">${turnLabel(rc)}</th>
                    <th>Delta</th>
                </tr></thead><tbody>`;
                metrics.forEach(m => {
                    let a, b;
                    if (m.derived) {
                        a = m.a; b = m.b;
                    } else {
                        a = parseFloat(rp[m.key]);
                        b = parseFloat(rc[m.key]);
                    }
                    const aStr = isNaN(a) ? '--' : a.toFixed(m.d) + m.unit;
                    const bStr = isNaN(b) ? '--' : b.toFixed(m.d) + m.unit;
                    html += `<tr><td>${m.label}</td><td class="mono">${aStr}</td><td class="mono">${bStr}</td><td>${turnDelta(a, b, m.lower)}</td></tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }
        }


        // ============================================
        // DATA LOADING - RACES (v01.21 Race Analysis Module)
        // ============================================
        let raceModuleState = {
            allRaces: [],
            filteredRaces: [],
            primaryIdx: null,    // index into filteredRaces
            compareIdx: null,    // index into filteredRaces
            splitChartMode: 'cumulative',
            activeTab: 'splits',
            _groupUuids: null,   // array of UUIDs when group selected
            _multiAthlete: false,
            _nameMap: {},
            _genderFilter: '',    // 'male', 'female', or ''
            _sampleMode: false
        };

        // Convenience getters
        function getPrimaryRace() { return raceModuleState.primaryIdx !== null ? raceModuleState.filteredRaces[raceModuleState.primaryIdx] : null; }
        function getCompareRace() { return raceModuleState.compareIdx !== null ? raceModuleState.filteredRaces[raceModuleState.compareIdx] : null; }
        function hasSelection() { return raceModuleState.primaryIdx !== null; }
        function hasComparison() { return raceModuleState.compareIdx !== null; }
        function courseUnit(r) { const c = (r.course || r.mj?.course || '').toUpperCase(); return c === 'SCY' ? 'Yds' : 'm'; }
        function courseBadge(r) { const c = (r.course || r.mj?.course || '').toUpperCase(); return c || 'SCY'; }
        function raceLabel(r) { const d = r.mj.Distance||r.mj.distance||''; const s = r.mj.Style||r.mj.style||''; const u = courseUnit(r); return `${d}${d ? ' '+u+' ' : ''}${s}`; }
        function raceFullLabel(r) { return `${formatDate(r.source_date)} - ${raceLabel(r)}`; }

        async function loadRaceData() {
            setupRaceTabs();
            setupRaceChartToggle();
            await initRaceCoachBar();
            if (raceModuleState._sampleMode) {
                // Already in sample mode - just re-render
                populateRaceFilters();
                renderRaceSelectorCards();
                renderAllRaceVisuals();
                return;
            }
            await loadRaceRawData();
            applyRaceFilters();
        }

        // "" RACE COACH BAR ""
        async function initRaceCoachBar() {
            const scopeRow = document.querySelector('#raceFilterBar .rfb-coach-only');
            if (appState.role !== 'coach' || !appState.teamUuid) {
                if (scopeRow) scopeRow.style.display = 'none';
                return;
            }
            if (scopeRow) scopeRow.style.display = 'flex';

            // Populate athlete dropdown
            const athletes = _allTeamAthletes || await (async () => {
                const { data } = await supabaseClient.from('athletes')
                    .select('athlete_uuid, first_name, last_name, athlete_code, gender')
                    .eq('team_uuid', appState.teamUuid).eq('membership_status', 'active');
                _allTeamAthletes = data || [];
                return _allTeamAthletes;
            })();
            const athSelect = document.getElementById('raceAthleteFilter');
            const current = appState.selectedAthleteUuid || '';
            athSelect.innerHTML = '<option value="">All Team</option>' +
                athletes.sort((a,b)=>(a.last_name||'').localeCompare(b.last_name||''))
                .map(a => `<option value="${a.athlete_uuid}" ${a.athlete_uuid===current?'selected':''}>${a.first_name} ${a.last_name}</option>`).join('');

            // Populate group dropdown
            const groups = _teamGroups || [];
            const grpSelect = document.getElementById('raceGroupFilter');
            grpSelect.innerHTML = '<option value="">No Group</option>' +
                groups.map(g => `<option value="${g.group_uuid}">${g.group_name}</option>`).join('');

            // Gender stays static (HTML already has Male/Female)
        }

        async function onRaceAthleteChange() {
            const val = document.getElementById('raceAthleteFilter').value;
            if (val) {
                document.getElementById('raceGroupFilter').value = '';
                document.getElementById('raceGenderFilter').value = '';
            }
            appState.selectedAthleteUuid = val || null;
            raceModuleState._groupUuids = null;
            raceModuleState._genderFilter = '';
            await loadRaceRawData();
            applyRaceFilters();
        }

        async function onRaceGroupChange() {
            const groupUuid = document.getElementById('raceGroupFilter').value;
            if (groupUuid) {
                document.getElementById('raceAthleteFilter').value = '';
                appState.selectedAthleteUuid = null;
                const { data } = await supabaseClient.from('athlete_group_members')
                    .select('athlete_uuid').eq('group_uuid', groupUuid);
                raceModuleState._groupUuids = (data||[]).map(m => m.athlete_uuid);
            } else {
                raceModuleState._groupUuids = null;
            }
            await loadRaceRawData();
            applyRaceFilters();
        }

        async function onRaceGenderChange() {
            const gender = document.getElementById('raceGenderFilter').value;
            raceModuleState._genderFilter = gender;
            if (gender) {
                // Clear individual athlete when filtering by gender
                document.getElementById('raceAthleteFilter').value = '';
                appState.selectedAthleteUuid = null;
            }
            await loadRaceRawData();
            applyRaceFilters();
        }

        function setupRaceTabs() {
            document.querySelectorAll('#raceTabBar .race-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('#raceTabBar .race-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.race-tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    raceModuleState.activeTab = tab.dataset.tab;
                    const content = document.getElementById('raceTab-' + tab.dataset.tab);
                    if (content) content.classList.add('active');
                };
            });
        }

        function setupRaceChartToggle() {
            document.querySelectorAll('#splitChartToggle .chart-toggle-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('#splitChartToggle .chart-toggle-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    raceModuleState.splitChartMode = btn.dataset.mode;
                    renderSplitsChart();
                };
            });
        }

        async function loadRaceRawData() {
            try {
                const athleteUuid = appState.selectedAthleteUuid || appState.athleteUuid;
                const groupUuids = raceModuleState._groupUuids;
                const genderFilter = raceModuleState._genderFilter || '';
                let query = supabaseClient.from('v_race_trials').select('*').order('source_date', { ascending: false });

                // Build list of athlete UUIDs to query based on scope
                let scopeUuids = null;
                let clientFilterSet = null;
                if (groupUuids && groupUuids.length) {
                    scopeUuids = groupUuids;
                    raceModuleState._multiAthlete = true;
                } else if (athleteUuid) {
                    query = query.eq('athlete_uuid', athleteUuid);
                    raceModuleState._multiAthlete = false;
                } else if (appState.role === 'coach' && appState.teamUuid) {
                    scopeUuids = (_allTeamAthletes || []).map(a => a.athlete_uuid);
                    raceModuleState._multiAthlete = true;
                } else {
                    raceModuleState._multiAthlete = false;
                }

                // Apply gender filter - narrow scopeUuids to matching athletes
                if (genderFilter && appState.role === 'coach' && _allTeamAthletes) {
                    const genderUuids = new Set(_allTeamAthletes
                        .filter(a => a.gender === genderFilter)
                        .map(a => a.athlete_uuid));
                    if (scopeUuids) {
                        scopeUuids = scopeUuids.filter(u => genderUuids.has(u));
                    } else {
                        scopeUuids = [...genderUuids];
                    }
                    raceModuleState._multiAthlete = true;
                }

                if (scopeUuids) {
                    if (!scopeUuids.length) {
                        raceModuleState.allRaces = [];
                        updateRaceInfoBadge();
                        populateRaceFilters();
                        return;
                    }
                    if (scopeUuids.length <= SUPABASE_IN_LIMIT) {
                        query = query.in('athlete_uuid', scopeUuids);
                    } else {
                        clientFilterSet = new Set(scopeUuids);
                    }
                }

                const { data, error } = await query;
                if (error) throw error;

                // Client-side filter if needed
                let rows = data || [];
                if (clientFilterSet) {
                    rows = rows.filter(r => clientFilterSet.has(r.athlete_uuid));
                }

                // Build name map
                const nameMap = {};
                if (_allTeamAthletes) {
                    _allTeamAthletes.forEach(a => { nameMap[a.athlete_uuid] = a.first_name + ' ' + a.last_name.charAt(0) + '.'; });
                }
                raceModuleState._nameMap = nameMap;

                // Deduplicate races: multi-level dedup strategy
                const seen = new Set();
                const dedupedRaces = [];
                rows.forEach(r => {
                    const mj = r.metrics_json || {};

                    // Level 1: trial_uuid (strongest - exact row identity)
                    if (r.trial_uuid) {
                        if (seen.has('t:' + r.trial_uuid)) return;
                        seen.add('t:' + r.trial_uuid);
                        dedupedRaces.push({ ...r, mj });
                        return;
                    }

                    // Level 2: Fingerprint using normalized fields
                    // Normalize strings: trim, lowercase, collapse whitespace
                    const norm = v => String(v||'').trim().toLowerCase().replace(/\s+/g,' ');
                    const dist = norm(mj.Distance || mj.distance);
                    const style = norm(mj.Style || mj.style);
                    const runtime = norm(mj.Runtime || mj.runtime);
                    const raceTime = parseRaceTime(mj);

                    // Build fingerprint from athlete + date + event identity + time
                    const key = [
                        r.athlete_uuid || '',
                        r.source_date || '',
                        dist,
                        style,
                        runtime,
                        raceTime != null ? raceTime.toFixed(2) : '',
                        r.analysis_session_uuid || ''
                    ].join('|');

                    if (!seen.has('f:' + key)) {
                        seen.add('f:' + key);

                        // Level 3: Also check without session UUID (catches same race imported twice)
                        const looseKey = [r.athlete_uuid||'', r.source_date||'', dist, style,
                            raceTime != null ? raceTime.toFixed(2) : ''].join('|');
                        if (seen.has('l:' + looseKey)) return;
                        seen.add('l:' + looseKey);

                        dedupedRaces.push({ ...r, mj });
                    }
                });
                raceModuleState.allRaces = dedupedRaces;

                updateRaceInfoBadge();
                populateRaceFilters();
                setupFilterListeners();
            } catch (e) {
                console.error('Error loading race data:', e);
                raceModuleState.allRaces = [];
            }
        }

        function updateRaceInfoBadge() {
            const infoEl = document.getElementById('raceCoachInfo');
            if (!infoEl || appState.role !== 'coach') return;
            const races = raceModuleState.allRaces;
            const uniqueAthletes = new Set(races.map(r => r.athlete_uuid)).size;
            const parts = [];
            parts.push(`${races.length} race${races.length!==1?'s':''}`);
            if (raceModuleState._multiAthlete) parts.push(`from ${uniqueAthletes} athlete${uniqueAthletes!==1?'s':''}`);
            const gf = raceModuleState._genderFilter;
            if (gf) parts.push(`(${gf})`);
            infoEl.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg> ${parts.join(' ')}`;
            infoEl.style.display = 'flex';
        }

        function populateRaceFilters() {
            const races = raceModuleState.allRaces;
            const events = new Set(), styles = new Set(), courses = new Set();
            races.forEach(r => {
                const d = r.mj.Distance || r.mj.distance; const s = r.mj.Style || r.mj.style;
                const c = (r.course || '').toUpperCase();
                if (d) events.add(String(d)); if (s) styles.add(s); if (c) courses.add(c);
            });
            // Course filter
            const courseEl = document.getElementById('raceCourseFilter');
            const currentCourse = courseEl.value;
            courseEl.innerHTML = '<option value="">All Courses</option>' +
                [...courses].sort().map(c => `<option value="${c}">${c}</option>`).join('');
            if (currentCourse && courses.has(currentCourse)) courseEl.value = currentCourse;
            // Event filter - label uses unit from dominant course or generic
            const activeCourse = courseEl.value || ([...courses].length === 1 ? [...courses][0] : '');
            const unit = activeCourse === 'SCY' ? 'Yds' : (activeCourse === 'SCM' || activeCourse === 'LCM') ? 'm' : '';
            document.getElementById('raceEventFilter').innerHTML = '<option value="">All Distances</option>' +
                [...events].sort((a,b)=>Number(a)-Number(b)).map(e=>`<option value="${e}">${e}${unit ? ' '+unit : ''}</option>`).join('');
            document.getElementById('raceStyleFilter').innerHTML = '<option value="">All Strokes</option>' +
                [...styles].sort().map(s=>`<option value="${s}">${s.charAt(0).toUpperCase()+s.slice(1)}</option>`).join('');
        }

        function setupFilterListeners() {
            ['raceCourseFilter','raceEventFilter','raceStyleFilter','raceDateFilter'].forEach(id => {
                document.getElementById(id).onchange = () => {
                    clearRaceSelection();
                    // When course changes, re-populate event labels with correct units
                    if (id === 'raceCourseFilter') populateRaceFilters();
                    applyRaceFilters();
                };
            });
        }

        function applyRaceFilters() {
            const co = document.getElementById('raceCourseFilter').value;
            const ev = document.getElementById('raceEventFilter').value;
            const st = document.getElementById('raceStyleFilter').value;
            const dt = document.getElementById('raceDateFilter').value;
            let f = [...raceModuleState.allRaces];
            if (co) f = f.filter(r => (r.course || '').toUpperCase() === co);
            if (ev) f = f.filter(r => String(r.mj.Distance||r.mj.distance) === ev);
            if (st) f = f.filter(r => (r.mj.Style||r.mj.style) === st);
            if (dt) { const c = new Date(); c.setDate(c.getDate()-parseInt(dt)); f = f.filter(r => new Date(r.source_date) >= c); }
            raceModuleState.filteredRaces = f;
            renderRaceSelectorCards();
            renderAllRaceVisuals();
        }

        function renderAllRaceVisuals() {
            renderRaceKPIs();
            renderRaceTrials();
            renderSplitsChart();
            renderSplitBars();
            renderRaceVelocityChart();
            renderRaceStartPhase();
            renderStrokeRateChart();
            renderStrokeCountGrid();
            renderRaceSummary();
        }

        // ============================================
        // RACE SELECTOR CARDS
        // ============================================
        function renderRaceSelectorCards() {
            const list = document.getElementById('raceSelectorList');
            const races = raceModuleState.filteredRaces;
            const isSample = raceModuleState._sampleMode;

            if (!races.length) {
                list.innerHTML = sampleBannerHTML('race');
                const clearBtn = document.getElementById('raceSelectorClear');
                if (clearBtn) clearBtn.style.display = 'none';
                const hint = document.getElementById('raceSelectorHint');
                if (hint) hint.textContent = '';
                return;
            }

            const multi = raceModuleState._multiAthlete;
            const nameMap = raceModuleState._nameMap || {};

            let topHtml = '';
            if (isSample) topHtml = sampleActiveBannerHTML('race');

            list.innerHTML = topHtml + races.map((r, i) => {
                const time = parseRaceTime(r.mj);
                const ev = raceLabel(r);
                let cls = 'race-card-pick';
                let badge = '';
                if (raceModuleState.primaryIdx === i) { cls += ' selected-primary'; badge = '<span class="rc-badge">Primary</span>'; }
                else if (raceModuleState.compareIdx === i) { cls += ' selected-compare'; badge = '<span class="rc-badge">Compare</span>'; }
                const athName = multi ? `<div class="rc-athlete">${nameMap[r.athlete_uuid]||'Unknown'}</div>` : '';
                const cBadge = r.course ? `<span class="rc-course-tag">${r.course}</span>` : '';
                const sBadge = isSample ? sampleBadgeHTML() : '';
                return `<div class="${cls}" onclick="selectRaceCard(${i})">${badge}${athName}<div class="rc-event">${ev} ${cBadge}${sBadge}</div><div class="rc-time">${time ? formatTime(time) : '--'}</div><div class="rc-date">${formatDate(r.source_date)}</div></div>`;
            }).join('');

            const clearBtn = document.getElementById('raceSelectorClear');
            clearBtn.style.display = hasSelection() ? 'inline' : 'none';
            const hint = document.getElementById('raceSelectorHint');
            if (!hasSelection()) hint.textContent = 'Click a race to view details. Click a second to compare.';
            else if (!hasComparison()) hint.textContent = 'Race selected. Click another to compare, or click same to deselect.';
            else hint.textContent = 'Comparing two races. All tabs show both.';
        }

        function selectRaceCard(idx) {
            const st = raceModuleState;
            if (st.primaryIdx === idx) {
                // Deselect primary -- shift compare up if any
                st.primaryIdx = st.compareIdx; st.compareIdx = null;
            } else if (st.compareIdx === idx) {
                st.compareIdx = null;
            } else if (st.primaryIdx === null) {
                st.primaryIdx = idx;
            } else if (st.compareIdx === null) {
                st.compareIdx = idx;
            } else {
                // Already have 2 -- replace compare
                st.compareIdx = idx;
            }
            renderRaceSelectorCards();
            renderAllRaceVisuals();
        }

        function clearRaceSelection() {
            raceModuleState.primaryIdx = null;
            raceModuleState.compareIdx = null;
            renderRaceSelectorCards();
            renderAllRaceVisuals();
        }

        // ============================================
        // HELPERS
        // ============================================
        function extractSplits(mj, interval) {
            interval = interval || 25;
            const splits = [];
            for (let d = interval; d <= 1500; d += interval) {
                const v = mj[`Split ${d} m`];
                if (v !== undefined && v !== null && v !== '' && !isNaN(parseFloat(v))) splits.push({ distance: d, cumTime: parseFloat(v) });
            }
            if (!splits.length) {
                for (let d = 5; d <= 1500; d += 5) {
                    const v = mj[`Split ${d} m`];
                    if (v !== undefined && v !== null && v !== '' && !isNaN(parseFloat(v))) splits.push({ distance: d, cumTime: parseFloat(v) });
                }
            }
            return splits;
        }

        function extractStrokeRates(mj) {
            const r = [];
            for (let d = 5; d <= 1500; d += 5) { const v = mj[`Stroke rate ${d} m`]; if (v && !isNaN(parseFloat(v)) && parseFloat(v) > 0) r.push({ distance: d, rate: parseFloat(v) }); }
            return r;
        }

        function extractStrokeCounts(mj) {
            const c = [];
            for (let l = 1; l <= 60; l++) { const v = mj[`Stroke count lap ${l}`]; if (v && parseInt(v) > 0) c.push({ lap: l, count: parseInt(v) }); }
            return c;
        }

        function parseRaceTime(mj) {
            const rt = mj.Runtime || mj.runtime;
            if (rt && typeof rt === 'string') {
                const p = rt.replace(/^0+:/, '').split(':');
                if (p.length === 1) return parseFloat(p[0]);
                if (p.length === 2) return parseFloat(p[0]) * 60 + parseFloat(p[1]);
            }
            const sp = extractSplits(mj);
            return sp.length ? sp[sp.length - 1].cumTime : null;
        }

        function splitsToSegments(splits) {
            return splits.map((s, i) => {
                const prev = i > 0 ? splits[i-1] : { distance: 0, cumTime: 0 };
                return { label: `${prev.distance}-${s.distance}m`, segTime: parseFloat((s.cumTime - prev.cumTime).toFixed(2)), cumTime: s.cumTime, distStart: prev.distance, distEnd: s.distance };
            });
        }

        function deltaStr(a, b) {
            if (a == null || b == null) return '';
            const d = a - b;
            const sign = d > 0 ? '+' : '';
            const cls = d < 0 ? 'positive' : d > 0 ? 'negative' : 'neutral';
            return `<span class="delta-badge ${cls}">${sign}${d.toFixed(2)}s</span>`;
        }

        // Chart.js data label plugin (lightweight inline)
        const dataLabelsPlugin = {
            id: 'customDataLabels',
            afterDatasetsDraw(chart) {
                const ctx = chart.ctx;
                chart.data.datasets.forEach((ds, di) => {
                    if (ds._hideLabels) return;
                    const meta = chart.getDatasetMeta(di);
                    meta.data.forEach((el, i) => {
                        const val = ds.data[i];
                        if (val == null) return;
                        ctx.save();
                        ctx.font = '600 11px JetBrains Mono, monospace';
                        ctx.fillStyle = ds.borderColor || getThemeColors().textSec;
                        ctx.textAlign = 'center';
                        const yOff = chart.config.type === 'bar' ? -8 : -12;
                        ctx.fillText(typeof val === 'number' ? val.toFixed(2) : val, el.x, el.y + yOff);
                        ctx.restore();
                    });
                });
            }
        };

        // ============================================
        // RACE KPIs (context-aware)
        // ============================================
        function renderRaceKPIs() {
            const container = document.getElementById('raceKpis');
            const races = raceModuleState.filteredRaces;
            if (!races.length) { container.innerHTML = '<div class="empty-state"><h3>No race data available</h3></div>'; return; }

            const primary = getPrimaryRace();
            const compare = getCompareRace();
            const isSingle = hasSelection() && !hasComparison();
            const isCompare = hasComparison();

            // Always compute PB and avg across all filtered
            const allTimes = races.map(r => parseRaceTime(r.mj)).filter(t => t > 0);
            const bestTime = allTimes.length ? Math.min(...allTimes) : null;
            const avgTime = allTimes.length ? allTimes.reduce((s,t) => s+t, 0) / allTimes.length : null;

            let raceTime = avgTime, blockTime = null, strokeTotal = null, label = 'average', eventLabel = 'All Distances';

            if (isSingle && primary) {
                raceTime = parseRaceTime(primary.mj);
                blockTime = parseFloat(primary.mj['Leaving block']) || null;
                const sc = extractStrokeCounts(primary.mj);
                strokeTotal = sc.length ? sc.reduce((s,c) => s + c.count, 0) : null;
                label = 'selected';
                eventLabel = raceLabel(primary);
            } else if (!hasSelection()) {
                // Averages
                const bt = races.map(r => parseFloat(r.mj['Leaving block'])).filter(t => !isNaN(t) && t > 0);
                blockTime = bt.length ? bt.reduce((s,t)=>s+t,0)/bt.length : null;
                const sc = races.map(r => { const c = extractStrokeCounts(r.mj); return c.reduce((s,x)=>s+x.count,0); }).filter(c=>c>0);
                strokeTotal = sc.length ? Math.round(sc.reduce((s,c)=>s+c,0)/sc.length) : null;
            }

            if (isCompare && primary && compare) {
                // Show primary race KPIs with delta badges
                const pTime = parseRaceTime(primary.mj);
                const cTime = parseRaceTime(compare.mj);
                const pBlock = parseFloat(primary.mj['Leaving block']) || null;
                const cBlock = parseFloat(compare.mj['Leaving block']) || null;
                const pSC = extractStrokeCounts(primary.mj); const pTotal = pSC.reduce((s,c)=>s+c.count,0) || null;
                const cSC = extractStrokeCounts(compare.mj); const cTotal = cSC.reduce((s,c)=>s+c.count,0) || null;

                container.innerHTML = `
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon green"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div></div>
                        <div class="kpi-value">${bestTime ? formatTime(bestTime) : '--'}</div>
                        <div class="kpi-label">Personal Best</div>
                        <span class="kpi-context-badge average">All Races</span>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon blue"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div></div>
                        <div class="kpi-value">${avgTime ? formatTime(avgTime) : '--'}</div>
                        <div class="kpi-label">Average Time</div>
                        <span class="kpi-context-badge average">All Races</span>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon blue"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg></div></div>
                        <div class="kpi-value">${pTime ? formatTime(pTime) : '--'}</div>
                        <div class="kpi-label">Primary Time ${pTime && cTime ? deltaStr(pTime, cTime) : ''}</div>
                        <span class="kpi-context-badge single">Primary</span>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon cyan"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg></div></div>
                        <div class="kpi-value">${cTime ? formatTime(cTime) : '--'}</div>
                        <div class="kpi-label">Compare Time</div>
                        <span class="kpi-context-badge single" style="background:rgba(167,139,250,0.15);color:var(--accent-purple);">Compare</span>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon orange"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg></div></div>
                        <div class="kpi-value">${pBlock ? pBlock.toFixed(2)+'s' : '--'}</div>
                        <div class="kpi-label">Block Time ${pBlock && cBlock ? deltaStr(pBlock, cBlock) : ''}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-header"><div class="kpi-icon purple"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div></div>
                        <div class="kpi-value">${pTotal || '--'}</div>
                        <div class="kpi-label">Strokes ${pTotal && cTotal ? deltaStr(pTotal, cTotal) : ''}</div>
                    </div>`;
                return;
            }

            // Single or aggregate view
            const ctxBadge = isSingle ? `<span class="kpi-context-badge single">${eventLabel}</span>` : `<span class="kpi-context-badge average">Average</span>`;

            container.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-header"><div class="kpi-icon blue"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg></div></div>
                    <div class="kpi-value">${races.length}</div>
                    <div class="kpi-label">Total Races</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header"><div class="kpi-icon green"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div></div>
                    <div class="kpi-value">${bestTime ? formatTime(bestTime) : '--'}</div>
                    <div class="kpi-label">Personal Best</div>
                    <span class="kpi-context-badge average">All Races</span>
                </div>
                <div class="kpi-card">
                    <div class="kpi-header"><div class="kpi-icon cyan"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div></div>
                    <div class="kpi-value">${isSingle && raceTime ? formatTime(raceTime) : avgTime ? formatTime(avgTime) : '--'}</div>
                    <div class="kpi-label">${isSingle ? 'Race Time' : 'Average Time'}</div>
                    ${ctxBadge}
                </div>
                <div class="kpi-card">
                    <div class="kpi-header"><div class="kpi-icon orange"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg></div></div>
                    <div class="kpi-value">${blockTime ? blockTime.toFixed(2)+'s' : '--'}</div>
                    <div class="kpi-label">${isSingle ? 'Block Time' : 'Avg Block Time'}</div>
                    ${ctxBadge}
                </div>
                <div class="kpi-card">
                    <div class="kpi-header"><div class="kpi-icon purple"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div></div>
                    <div class="kpi-value">${strokeTotal || '--'}</div>
                    <div class="kpi-label">${isSingle ? 'Total Strokes' : 'Avg Strokes'}</div>
                    ${ctxBadge}
                </div>`;
        }

        // ============================================
        // RACE HISTORY TABLE
        // ============================================
        function renderRaceTrials() {
            const container = document.getElementById('raceTrialsTable');
            const races = raceModuleState.filteredRaces;
            if (!races.length) { container.innerHTML = '<div class="empty-state"><h3>No races found</h3></div>'; return; }
            const multi = raceModuleState._multiAthlete;
            const nameMap = raceModuleState._nameMap || {};

            const lapLen = 25;
            const allDists = new Set();
            races.forEach(r => extractSplits(r.mj, lapLen).forEach(s => allDists.add(s.distance)));
            const sortedDists = [...allDists].sort((a,b)=>a-b).slice(0, 8);
            const extraCols = multi ? 1 : 0;

            container.innerHTML = `<div style="overflow-x:auto;"><table class="data-table"><thead><tr>
                ${multi ? '<th>Athlete</th>' : ''}
                <th>Date</th><th>Event</th><th>Time</th>
                ${sortedDists.map(d=>`<th>${d}m</th>`).join('')}
                <th style="width:40px;"></th>
            </tr></thead><tbody>
                ${races.map((race, idx) => {
                    const mj = race.mj;
                    const raceTime = parseRaceTime(mj);
                    const splits = extractSplits(mj, lapLen);
                    const splitMap = {}; splits.forEach(s => splitMap[s.distance] = s.cumTime);
                    const strokeCounts = extractStrokeCounts(mj);
                    const leavingBlock = parseFloat(mj['Leaving block'])||null;
                    const surfaceBreak = parseFloat(mj['Surface break'])||null;
                    const underwaterPhase = parseFloat(mj['Underwater phase'])||null;
                    const flightPhase = parseFloat(mj['Flight phase'])||null;
                    const isPri = raceModuleState.primaryIdx === idx;
                    const isCmp = raceModuleState.compareIdx === idx;
                    const rowStyle = isPri ? 'background:rgba(0,194,255,0.06);' : isCmp ? 'background:rgba(167,139,250,0.06);' : '';

                    return `<tr class="race-row-expandable" style="${rowStyle}" onclick="toggleRaceDetail(${idx})">
                        ${multi ? `<td style="font-size:12px;font-weight:500;color:var(--accent-blue);">${nameMap[race.athlete_uuid]||'--'}</td>` : ''}
                        <td>${formatDate(race.source_date)}</td>
                        <td>${raceLabel(race)}</td>
                        <td class="mono" style="font-weight:600;">${raceTime ? formatTime(raceTime) : '--'}</td>
                        ${sortedDists.map(d=>`<td class="mono">${splitMap[d]?formatTime(splitMap[d]):'--'}</td>`).join('')}
                        <td><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--text-muted);"><polyline points="6 9 12 15 18 9"></polyline></svg></td>
                    </tr>
                    <tr class="race-detail-row" id="raceDetail-${idx}">
                        <td colspan="${sortedDists.length + 4 + extraCols}" class="race-detail-cell"><div class="race-detail-grid">
                            <div class="race-detail-section"><h4>Start Phase</h4><div class="race-detail-metrics">
                                <div class="race-metric-item"><span class="race-metric-label">Leaving Block</span><span class="race-metric-value">${leavingBlock?leavingBlock.toFixed(2)+'s':'--'}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Flight Phase</span><span class="race-metric-value">${flightPhase?flightPhase.toFixed(2)+'s':'--'}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Underwater</span><span class="race-metric-value">${underwaterPhase?underwaterPhase.toFixed(2)+'s':'--'}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Surface Break</span><span class="race-metric-value">${surfaceBreak?surfaceBreak.toFixed(2)+'s':'--'}</span></div>
                            </div></div>
                            <div class="race-detail-section"><h4>Stroke Counts</h4><div class="race-detail-metrics">
                                ${strokeCounts.length ? strokeCounts.map(sc=>`<div class="race-metric-item"><span class="race-metric-label">Lap ${sc.lap}</span><span class="race-metric-value">${sc.count}</span></div>`).join('') : '<div class="race-metric-item"><span class="race-metric-label">No data</span><span class="race-metric-value">--</span></div>'}
                            </div></div>
                            <div class="race-detail-section"><h4>Segment Splits</h4><div class="race-detail-metrics">
                                ${splits.length > 1 ? splitsToSegments(splits).map(s=>`<div class="race-metric-item"><span class="race-metric-label">${s.label}</span><span class="race-metric-value">${s.segTime}s</span></div>`).join('') : '<div class="race-metric-item"><span class="race-metric-label">--</span><span class="race-metric-value">--</span></div>'}
                            </div></div>
                        </div></td>
                    </tr>`;
                }).join('')}
            </tbody></table></div>`;
        }

        function toggleRaceDetail(idx) { const r = document.getElementById('raceDetail-'+idx); if (r) r.classList.toggle('open'); }

        // ============================================
        // SPLITS CHART (respects selection + comparison, data labels)
        // ============================================
        function renderSplitsChart() {
            const canvas = document.getElementById('splitsChart');
            if (!canvas) return;
            const races = raceModuleState.filteredRaces;
            if (!races.length) return;
            // Robustly destroy any existing chart on this canvas
            if (appState.charts.splits) { try { appState.charts.splits.destroy(); } catch(e) {} appState.charts.splits = null; }
            const existingChart = Chart.getChart(canvas);
            if (existingChart) { try { existingChart.destroy(); } catch(e) {} }

            const primary = getPrimaryRace();
            const compare = getCompareRace();
            const toChart = primary ? (compare ? [primary, compare] : [primary]) : races.slice(0, Math.min(3, races.length));
            const colors = primary ? [getThemeColors().accent, getThemeColors().purple] : [getThemeColors().accent, getThemeColors().purple, getThemeColors().orange];

            const allDists = new Set();
            toChart.forEach(r => extractSplits(r.mj).forEach(s => allDists.add(s.distance)));
            const sortedDists = [...allDists].sort((a,b)=>a-b);

            const isSeg = raceModuleState.splitChartMode === 'segment';
            const datasets = toChart.map((r, i) => {
                const splits = extractSplits(r.mj);
                const sm = {}; splits.forEach(s => sm[s.distance] = s.cumTime);
                const data = isSeg
                    ? sortedDists.map((d,j) => { const c = sm[d]; if(!c) return null; const pD = j>0?sortedDists[j-1]:0; return parseFloat((c-(sm[pD]||0)).toFixed(2)); })
                    : sortedDists.map(d => sm[d] || null);
                return {
                    label: raceFullLabel(r), data, borderColor: colors[i], backgroundColor: colors[i] + (isSeg ? '90' : '15'),
                    fill: !isSeg && i===0, tension: 0.3, spanGaps: true, pointRadius: 4, pointBackgroundColor: colors[i],
                    borderWidth: 2
                };
            });

            appState.charts.splits = new Chart(canvas, {
                type: isSeg ? 'bar' : 'line',
                data: { labels: sortedDists.map(d=>d+'m'), datasets },
                plugins: [dataLabelsPlugin],
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec } },
                        y: { grid: { color: 'rgba(128,140,160,0.10)' }, ticks: { color: getThemeColors().textSec }, title: { display:true, text: isSeg?'Segment Time (s)':'Cumulative Time (s)', color:getThemeColors().textSec } }
                    },
                    plugins: { legend: { position:'bottom', labels: { color:getThemeColors().textSec, usePointStyle:true } } }
                }
            });
        }

        // ============================================
        // SPLIT BARS
        // ============================================
        function renderSplitBars() {
            const container = document.getElementById('splitBarsContainer');
            const primary = getPrimaryRace();
            const race = primary || raceModuleState.filteredRaces[0];
            if (!race) { container.innerHTML = '<div class="empty-state"><h3>No split data</h3></div>'; return; }

            const splits = extractSplits(race.mj);
            if (splits.length < 2) { container.innerHTML = '<div class="empty-state"><h3>Not enough split data</h3></div>'; return; }

            const segments = splitsToSegments(splits);
            const maxSeg = Math.max(...segments.map(s=>s.segTime));
            const minSeg = Math.min(...segments.map(s=>s.segTime));
            const range = maxSeg - minSeg || 1;
            const raceTime = parseRaceTime(race.mj);

            // Compare race segments if available
            const compare = getCompareRace();
            let cmpSegMap = {};
            if (compare) {
                const cSplits = extractSplits(compare.mj);
                if (cSplits.length >= 2) splitsToSegments(cSplits).forEach(s => { cmpSegMap[s.label] = s.segTime; });
            }

            container.innerHTML = `
                <div style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
                    <span style="font-size:13px;color:var(--text-secondary);">${formatDate(race.source_date)}  -  ${raceLabel(race)}</span>
                    <span class="mono" style="font-size:14px;font-weight:600;">${raceTime ? formatTime(raceTime) : '--'}</span>
                </div>
                <div class="split-bars">
                    ${segments.map(s => {
                        const pct = Math.max(20, (s.segTime / maxSeg) * 100);
                        const norm = (s.segTime - minSeg) / range;
                        let barClass = norm <= 0.25 ? 'fastest' : norm <= 0.5 ? 'fast' : norm <= 0.75 ? 'medium' : 'slow';
                        const cmpTime = cmpSegMap[s.label];
                        const delta = cmpTime != null ? deltaStr(s.segTime, cmpTime) : '';
                        return `<div class="split-bar-row">
                            <div class="split-bar-label">${s.label}</div>
                            <div class="split-bar-track"><div class="split-bar-fill ${barClass}" style="width:${pct.toFixed(1)}%">${s.segTime}s</div></div>
                            <div class="split-bar-time">${formatTime(s.cumTime)} ${delta}</div>
                        </div>`;
                    }).join('')}
                </div>`;
        }

        // ============================================
        // VELOCITY CHART (respects selection + comparison)
        // ============================================
        function renderRaceVelocityChart() {
            const canvas = document.getElementById('raceVelocityChart');
            if (!canvas) return;
            if (appState.charts.raceVelocity) { try { appState.charts.raceVelocity.destroy(); } catch(e){} appState.charts.raceVelocity = null; }
            const ec1 = Chart.getChart(canvas); if (ec1) { try { ec1.destroy(); } catch(e){} }

            const primary = getPrimaryRace();
            const compare = getCompareRace();
            const race = primary || raceModuleState.filteredRaces[0];
            if (!race) return;

            function buildVelData(r) {
                const sp = extractSplits(r.mj);
                if (sp.length < 2) return [];
                return splitsToSegments(sp).map(s => ({ label: s.label, velocity: s.segTime > 0 ? parseFloat(((s.distEnd - s.distStart) / s.segTime).toFixed(2)) : 0 }));
            }

            const segs = buildVelData(race);
            if (!segs.length) { appState.charts.raceVelocity = null; return; }
            const avgVel = segs.reduce((s,x)=>s+x.velocity,0)/segs.length;

            const datasets = [{
                label: `Velocity - ${raceFullLabel(race)}`, data: segs.map(s=>s.velocity),
                backgroundColor: segs.map(s=> s.velocity >= avgVel ? 'rgba(0,230,138,0.85)' : 'rgba(245,166,35,0.85)'),
                borderRadius: 4
            }, {
                label: 'Average', data: segs.map(()=>avgVel), type:'line',
                borderColor:'rgba(255,107,107,0.8)', borderDash:[5,5], pointRadius:0, fill:false, _hideLabels: true
            }];

            if (compare) {
                const cSegs = buildVelData(compare);
                if (cSegs.length) {
                    datasets.push({
                        label: `Velocity - ${raceFullLabel(compare)}`, data: cSegs.map(s=>s.velocity),
                        backgroundColor: 'rgba(167,139,250,0.65)', borderRadius: 4
                    });
                }
            }

            appState.charts.raceVelocity = new Chart(canvas, {
                type: 'bar', data: { labels: segs.map(s=>s.label), datasets },
                plugins: [dataLabelsPlugin],
                options: {
                    responsive:true, maintainAspectRatio:false,
                    scales: {
                        x: { grid:{color:'rgba(148,163,184,0.1)'}, ticks:{color:getThemeColors().textSec} },
                        y: { grid:{color:'rgba(148,163,184,0.1)'}, ticks:{color:getThemeColors().textSec}, title:{display:true,text:'m/s',color:getThemeColors().textSec} }
                    },
                    plugins: { legend:{position:'bottom',labels:{color:getThemeColors().textSec}} }
                }
            });
        }

        // ============================================
        // START PHASE (respects selection)
        // ============================================
        function renderRaceStartPhase() {
            const container = document.getElementById('raceStartPhase');
            const primary = getPrimaryRace();
            const compare = getCompareRace();
            const race = primary || raceModuleState.filteredRaces[0];
            if (!race) { container.innerHTML = '<div class="empty-state"><h3>No race data</h3></div>'; return; }

            function getPhaseMetrics(mj) {
                return [
                    { label:'On-Block Phase', value:parseFloat(mj['On-block phase'])||null },
                    { label:'Leaving Block', value:parseFloat(mj['Leaving block'])||null },
                    { label:'Flight Phase', value:parseFloat(mj['Flight phase'])||null },
                    { label:'Dip', value:parseFloat(mj['Dip'])||null },
                    { label:'Underwater Phase', value:parseFloat(mj['Underwater phase'])||null },
                    { label:'Surface Break', value:parseFloat(mj['Surface break'])||null },
                ].filter(m => m.value !== null);
            }

            const metrics = getPhaseMetrics(race.mj);
            let cmpMap = {};
            if (compare) getPhaseMetrics(compare.mj).forEach(m => { cmpMap[m.label] = m.value; });

            container.innerHTML = `
                <div style="margin-bottom:12px;"><span style="font-size:13px;color:var(--text-secondary);">${formatDate(race.source_date)}  -  ${raceLabel(race)}</span></div>
                ${metrics.length ? `<div class="race-detail-metrics">
                    ${metrics.map(m => `<div class="race-metric-item"><span class="race-metric-label">${m.label}</span><span class="race-metric-value">${m.value.toFixed(2)}s ${cmpMap[m.label] != null ? deltaStr(m.value, cmpMap[m.label]) : ''}</span></div>`).join('')}
                </div>` : '<div class="empty-state"><h3>No start phase data</h3></div>'}
            `;
        }

        // ============================================
        // STROKE RATE CHART (respects selection + comparison)
        // ============================================
        function renderStrokeRateChart() {
            const canvas = document.getElementById('strokeRateChart');
            if (!canvas) return;
            if (appState.charts.strokeRate) { try { appState.charts.strokeRate.destroy(); } catch(e){} appState.charts.strokeRate = null; }
            const ec2 = Chart.getChart(canvas); if (ec2) { try { ec2.destroy(); } catch(e){} }

            const primary = getPrimaryRace();
            const compare = getCompareRace();
            let race = primary;
            if (!race) { for (const r of raceModuleState.filteredRaces) { if (extractStrokeRates(r.mj).length) { race = r; break; } } }
            if (!race) { appState.charts.strokeRate = null; return; }

            const rates = extractStrokeRates(race.mj);
            if (!rates.length) { appState.charts.strokeRate = null; return; }

            const datasets = [{
                label: `Stroke Rate - ${raceFullLabel(race)}`, data: rates.map(r=>r.rate),
                borderColor:getThemeColors().accent, backgroundColor:'rgba(0,194,255,0.12)', fill:true, tension:0.3,
                pointRadius:4, pointBackgroundColor:getThemeColors().accent, borderWidth: 2
            }];

            if (compare) {
                const cRates = extractStrokeRates(compare.mj);
                if (cRates.length) {
                    datasets.push({
                        label: `Stroke Rate - ${raceFullLabel(compare)}`, data: cRates.map(r=>r.rate),
                        borderColor:getThemeColors().purple, backgroundColor:'rgba(167,139,250,0.08)', fill:false, tension:0.3,
                        pointRadius:4, pointBackgroundColor:getThemeColors().purple, borderWidth:2, borderDash:[4,4]
                    });
                }
            }

            appState.charts.strokeRate = new Chart(canvas, {
                type:'line', data: { labels: rates.map(r=>r.distance+'m'), datasets },
                plugins: [dataLabelsPlugin],
                options: {
                    responsive:true, maintainAspectRatio:false,
                    scales: {
                        x: { grid:{color:'rgba(148,163,184,0.1)'}, ticks:{color:getThemeColors().textSec,maxTicksLimit:12} },
                        y: { grid:{color:'rgba(148,163,184,0.1)'}, ticks:{color:getThemeColors().textSec}, title:{display:true,text:'Strokes/min',color:getThemeColors().textSec} }
                    },
                    plugins: { legend:{position:'bottom',labels:{color:getThemeColors().textSec,usePointStyle:true}} }
                }
            });
        }

        // ============================================
        // STROKE COUNT GRID
        // ============================================
        function renderStrokeCountGrid() {
            const container = document.getElementById('strokeCountGrid');
            const races = raceModuleState.filteredRaces;
            if (!races.length) { container.innerHTML = '<div class="empty-state"><h3>No stroke data</h3></div>'; return; }

            const primary = getPrimaryRace();
            const compare = getCompareRace();
            const multi = raceModuleState._multiAthlete;
            const nameMap = raceModuleState._nameMap || {};

            // Determine which races to display
            let racesToShow;
            let showingMode = '';
            if (primary) {
                // Selection mode: show only selected races
                racesToShow = compare ? [primary, compare] : [primary];
                racesToShow = racesToShow.filter(r => extractStrokeCounts(r.mj).length > 0);
                showingMode = 'selected';
            } else {
                // No selection: show all filtered races with stroke data
                racesToShow = races.filter(r => extractStrokeCounts(r.mj).length > 0);
                showingMode = 'all';
            }

            if (!racesToShow.length) {
                container.innerHTML = '<div class="empty-state"><h3>No stroke count data</h3>' +
                    (primary ? '<p style="font-size:12px;color:var(--text-muted);">The selected race has no stroke count data.</p>'
                     : '<p style="font-size:12px;color:var(--text-muted);">No races in current filters have stroke count data.</p>') + '</div>';
                return;
            }

            const maxLaps = Math.max(...racesToShow.map(r=>extractStrokeCounts(r.mj).length));
            const allCounts = racesToShow.flatMap(r=>extractStrokeCounts(r.mj).map(c=>c.count));
            const minC = Math.min(...allCounts), maxC = Math.max(...allCounts), range = maxC - minC || 1;

            container.innerHTML = `<div class="stroke-grid" style="grid-template-columns:${multi?'160px':'140px'} repeat(${maxLaps},minmax(50px,1fr));">
                <div class="stroke-cell header"></div>
                ${Array.from({length:maxLaps},(_,i)=>`<div class="stroke-cell header">Lap ${i+1}</div>`).join('')}
                ${racesToShow.map(r => {
                    const counts = extractStrokeCounts(r.mj);
                    const isPri = getPrimaryRace() === r;
                    const isCmp = getCompareRace() === r;
                    const highlight = isPri ? 'border-left:3px solid var(--accent-blue);' : isCmp ? 'border-left:3px solid var(--accent-purple);' : '';
                    const athTag = multi ? `<span style="font-size:9px;font-weight:600;color:var(--accent-blue);">${nameMap[r.athlete_uuid]||''}</span><br>` : '';
                    return `<div class="stroke-cell label" style="${highlight}">${athTag}${formatDate(r.source_date)}<br><span style="font-size:10px;opacity:0.7;">${raceLabel(r)}</span></div>
                        ${Array.from({length:maxLaps},(_,i) => {
                            const c = counts[i];
                            if (!c) return '<div class="stroke-cell" style="opacity:0.3;">-</div>';
                            const norm = (c.count - minC) / range;
                            const cls = norm > 0.75 ? 'very-high' : norm > 0.5 ? 'high' : norm > 0.25 ? 'mid' : 'low';
                            return `<div class="stroke-cell ${cls}">${c.count}</div>`;
                        }).join('')}`;
                }).join('')}
            </div>` +
            (showingMode === 'all' ?
                `<div style="text-align:center;padding:6px 0 2px;font-size:11px;color:var(--text-muted);">Showing all ${racesToShow.length} races with stroke data. Select a race above to focus.</div>` :
                `<div style="text-align:center;padding:6px 0 2px;font-size:11px;color:var(--text-muted);">Showing ${racesToShow.length} selected race${racesToShow.length>1?'s':''}.</div>`);
        }

        // ============================================
        // RACE SUMMARY TAB (consolidated digest)
        // ============================================
        function renderRaceSummary() {
            const container = document.getElementById('raceSummaryContent');
            const titleEl = document.getElementById('summaryTitle');
            const primary = getPrimaryRace();
            const compare = getCompareRace();

            if (!primary) {
                titleEl.textContent = 'Race Summary';
                container.innerHTML = `<div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l4.58-4.58c.94-.94.94-2.48 0-3.42L9 5z"></path><circle cx="6" cy="9" r="1"></circle></svg>
                    <h3>Select a race above</h3>
                    <p>Click on a race card to see a full summary here. Select two to see a comparison digest.</p>
                </div>`;
                return;
            }

            const pTime = parseRaceTime(primary.mj);
            const pSplits = extractSplits(primary.mj);
            const pSegs = pSplits.length >= 2 ? splitsToSegments(pSplits) : [];
            const pSR = extractStrokeRates(primary.mj);
            const pSC = extractStrokeCounts(primary.mj);
            const pBlock = parseFloat(primary.mj['Leaving block']) || null;
            const pFlight = parseFloat(primary.mj['Flight phase']) || null;
            const pUW = parseFloat(primary.mj['Underwater phase']) || null;
            const pSB = parseFloat(primary.mj['Surface break']) || null;
            const fastestSeg = pSegs.length ? pSegs.reduce((a,b) => a.segTime < b.segTime ? a : b) : null;
            const slowestSeg = pSegs.length ? pSegs.reduce((a,b) => a.segTime > b.segTime ? a : b) : null;

            if (!compare) {
                titleEl.textContent = `Race Summary - ${raceLabel(primary)}`;
                container.innerHTML = `
                <div class="compare-summary-grid">
                    <div>
                        <div class="compare-mini-section">
                            <h4><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> Overview</h4>
                            <div class="race-detail-metrics">
                                <div class="race-metric-item"><span class="race-metric-label">Event</span><span class="race-metric-value">${raceLabel(primary)}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Date</span><span class="race-metric-value">${formatDate(primary.source_date)}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Final Time</span><span class="race-metric-value">${pTime ? formatTime(pTime) : '--'}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Total Strokes</span><span class="race-metric-value">${pSC.length ? pSC.reduce((s,c)=>s+c.count,0) : '--'}</span></div>
                            </div>
                        </div>
                        <div class="compare-mini-section">
                            <h4><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg> Start Phase</h4>
                            <div class="race-detail-metrics">
                                <div class="race-metric-item"><span class="race-metric-label">Block Time</span><span class="race-metric-value">${pBlock?pBlock.toFixed(2)+'s':'--'}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Flight</span><span class="race-metric-value">${pFlight?pFlight.toFixed(2)+'s':'--'}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Underwater</span><span class="race-metric-value">${pUW?pUW.toFixed(2)+'s':'--'}</span></div>
                                <div class="race-metric-item"><span class="race-metric-label">Surface Break</span><span class="race-metric-value">${pSB?pSB.toFixed(2)+'s':'--'}</span></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="compare-mini-section">
                            <h4><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg> Pacing</h4>
                            <div class="race-detail-metrics">
                                ${fastestSeg ? `<div class="race-metric-item"><span class="race-metric-label">Fastest Segment</span><span class="race-metric-value">${fastestSeg.label} (${fastestSeg.segTime}s)</span></div>` : ''}
                                ${slowestSeg ? `<div class="race-metric-item"><span class="race-metric-label">Slowest Segment</span><span class="race-metric-value">${slowestSeg.label} (${slowestSeg.segTime}s)</span></div>` : ''}
                                ${fastestSeg && slowestSeg ? `<div class="race-metric-item"><span class="race-metric-label">Split Variance</span><span class="race-metric-value">${(slowestSeg.segTime - fastestSeg.segTime).toFixed(2)}s</span></div>` : ''}
                                ${pSegs.length ? `<div class="race-metric-item"><span class="race-metric-label">Avg Seg Time</span><span class="race-metric-value">${(pSegs.reduce((s,x)=>s+x.segTime,0)/pSegs.length).toFixed(2)}s</span></div>` : ''}
                            </div>
                        </div>
                        <div class="compare-mini-section">
                            <h4><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg> Stroke Data</h4>
                            <div class="race-detail-metrics">
                                ${pSC.map(sc=>`<div class="race-metric-item"><span class="race-metric-label">Lap ${sc.lap} Count</span><span class="race-metric-value">${sc.count}</span></div>`).join('') || '<div class="race-metric-item"><span class="race-metric-label">No data</span><span class="race-metric-value">--</span></div>'}
                            </div>
                        </div>
                    </div>
                </div>`;
                return;
            }

            // COMPARISON DIGEST
            titleEl.textContent = 'Comparison Summary';
            const cTime = parseRaceTime(compare.mj);
            const cSplits = extractSplits(compare.mj);
            const cSegs = cSplits.length >= 2 ? splitsToSegments(cSplits) : [];
            const cBlock = parseFloat(compare.mj['Leaving block']) || null;
            const cFlight = parseFloat(compare.mj['Flight phase']) || null;
            const cUW = parseFloat(compare.mj['Underwater phase']) || null;
            const cSB = parseFloat(compare.mj['Surface break']) || null;
            const cSC = extractStrokeCounts(compare.mj);

            function metricRow(label, pVal, cVal, unit) {
                const pStr = pVal != null ? pVal.toFixed(2)+unit : '--';
                const cStr = cVal != null ? cVal.toFixed(2)+unit : '--';
                const d = pVal != null && cVal != null ? deltaStr(pVal, cVal) : '';
                return `<tr><td style="padding:6px 10px;font-size:13px;">${label}</td><td class="mono" style="padding:6px 10px;font-weight:600;">${pStr}</td><td class="mono" style="padding:6px 10px;font-weight:600;">${cStr}</td><td style="padding:6px 10px;">${d}</td></tr>`;
            }

            container.innerHTML = `
            <div style="overflow-x:auto;">
                <table class="data-table" style="margin-bottom:20px;">
                    <thead><tr>
                        <th>Metric</th>
                        <th><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent-blue);margin-right:6px;"></span>Primary</th>
                        <th><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent-purple);margin-right:6px;"></span>Compare</th>
                        <th>Delta</th>
                    </tr></thead>
                    <tbody>
                        <tr><td colspan="4" style="padding:8px 10px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;background:var(--bg-secondary);">Overview</td></tr>
                        ${metricRow('Final Time', pTime, cTime, 's')}
                        ${metricRow('Block Time', pBlock, cBlock, 's')}
                        ${metricRow('Flight Phase', pFlight, cFlight, 's')}
                        ${metricRow('Underwater', pUW, cUW, 's')}
                        ${metricRow('Surface Break', pSB, cSB, 's')}
                        <tr><td colspan="4" style="padding:8px 10px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;background:var(--bg-secondary);">Segment Splits</td></tr>
                        ${pSegs.map((s,i) => {
                            const cSeg = cSegs[i];
                            return metricRow(s.label, s.segTime, cSeg ? cSeg.segTime : null, 's');
                        }).join('')}
                        <tr><td colspan="4" style="padding:8px 10px;font-size:11px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;background:var(--bg-secondary);">Stroke Counts</td></tr>
                        ${pSC.map((sc,i) => {
                            const cC = cSC[i];
                            return metricRow('Lap '+(i+1), sc.count, cC?cC.count:null, '');
                        }).join('')}
                    </tbody>
                </table>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <span style="font-size:12px;color:var(--text-muted);"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent-blue);margin-right:4px;"></span>${raceFullLabel(primary)}</span>
                <span style="font-size:12px;color:var(--text-muted);"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent-purple);margin-right:4px;"></span>${raceFullLabel(compare)}</span>
            </div>`;
        }

        // ============================================
        // TEAM DATA (COACH ONLY)
        // ============================================
        async function loadTeamAthletes() {
            try {
                const { data, error } = await supabaseClient
                    .from('athletes')
                    .select('athlete_uuid, athlete_code, first_name, last_name, membership_status')
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'active')
                    .order('last_name');

                if (error) throw error;

                const dropdown = document.getElementById('athleteDropdown');
                const previousValue = dropdown.value;
                dropdown.innerHTML = '<option value="">All Athletes</option>' +
                    (data || []).map(a => `<option value="${a.athlete_uuid}">${a.first_name} ${a.last_name} (${a.athlete_code})</option>`).join('');

                // Restore previous selection if still valid
                if (previousValue && data?.some(a => a.athlete_uuid === previousValue)) {
                    dropdown.value = previousValue;
                } else {
                    dropdown.value = '';
                    appState.selectedAthleteUuid = null;
                }

                // Only attach listener once
                if (!dropdown._listenerAttached) {
                    dropdown.addEventListener('change', (e) => {
                        appState.selectedAthleteUuid = e.target.value || null;
                        reloadActivePage();
                    });
                    dropdown._listenerAttached = true;
                }
            } catch (e) {
                console.error('Error loading team athletes:', e);
            }
        }

        async function loadTeamData() {
            await Promise.all([
                loadTeamInfoBar(),
                loadPendingMembers(),
                loadActiveAthletes(),
                loadTeamCoaches()
            ]);
        }

        async function loadTeamInfoBar() {
            const container = document.getElementById('teamInfoBar');
            try {
                const { data: team } = await supabaseClient
                    .from('teams')
                    .select('team_name, team_code')
                    .eq('team_uuid', appState.teamUuid)
                    .single();

                if (!team) { container.innerHTML = ''; return; }

                const displayCode = (team.team_code || '').replace(/^T_/i, '');
                container.innerHTML = `
                    <div class="team-info-bar">
                        <div>
                            <div class="team-name">${team.team_name}</div>
                            <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Share this code with athletes and coaches to join</div>
                        </div>
                        <div class="team-code">${displayCode}</div>
                    </div>
                `;
            } catch (e) {
                console.error('Error loading team info:', e);
                container.innerHTML = '';
            }
        }

        async function loadPendingMembers() {
            const section = document.getElementById('pendingMembersSection');
            const container = document.getElementById('pendingMembers');

            // Only ACTIVE coaches can see and manage pending members
            // A pending coach must not see this section (prevents self-approval)
            if (appState.role !== 'coach' || appState.membershipStatus !== 'active') {
                section.style.display = 'none';
                return;
            }

            try {
                // Fetch pending athletes
                const { data: pendingAthletes } = await supabaseClient
                    .from('athletes')
                    .select('athlete_uuid, first_name, last_name, athlete_code, created_at')
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'pending')
                    .order('created_at', { ascending: false });

                // Fetch pending coaches (exclude self by coach_uuid)
                const { data: pendingCoaches } = await supabaseClient
                    .from('coaches')
                    .select('coach_uuid, coach_name, auth_user_id, created_at')
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'pending')
                    .order('created_at', { ascending: false });

                // Filter out the current user from the pending coaches list
                const myAuthId = appState.user?.id;
                const filteredCoaches = (pendingCoaches || []).filter(c => c.auth_user_id !== myAuthId);

                const allPending = [
                    ...(pendingAthletes || []).map(a => ({ ...a, type: 'athlete', name: a.first_name + ' ' + a.last_name, id: a.athlete_uuid })),
                    ...filteredCoaches.map(c => ({ ...c, type: 'coach', name: c.coach_name, id: c.coach_uuid }))
                ];

                if (!allPending.length) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';
                container.innerHTML = allPending.map(m => `
                    <div class="member-card">
                        <div class="member-info">
                            <div class="member-avatar">${getInitials(m.name.split(' ')[0], m.name.split(' ')[1])}</div>
                            <div>
                                <div class="member-name">${m.name}</div>
                                <div class="member-meta">${m.type === 'athlete' ? 'Athlete' : 'Coach'} | Requested ${formatDate(m.created_at)}</div>
                            </div>
                        </div>
                        <div class="member-actions">
                            <button class="member-btn approve" onclick="approveMember('${m.id}', '${m.type}')">Approve</button>
                            <button class="member-btn reject" onclick="rejectMember('${m.id}', '${m.type}')">Reject</button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading pending members:', e);
                section.style.display = 'none';
            }
        }

        async function loadActiveAthletes() {
            const container = document.getElementById('teamAthletes');

            try {
                const { data, error } = await supabaseClient
                    .from('athletes')
                    .select('athlete_uuid, athlete_code, first_name, last_name, email, created_at, membership_status')
                    .eq('team_uuid', appState.teamUuid)
                    .eq('membership_status', 'active')
                    .order('last_name');

                if (error) throw error;

                if (!data?.length) {
                    container.innerHTML = '<div class="empty-state"><h3>No active athletes</h3><p>Athletes will appear here once approved.</p></div>';
                    return;
                }

                container.innerHTML = data.map(a => {
                    const isMe = a.athlete_uuid === appState.athleteUuid;
                    return `
                    <div class="member-card">
                        <div class="member-info">
                            <div class="member-avatar">${getInitials(a.first_name, a.last_name)}</div>
                            <div>
                                <div class="member-name">${a.first_name} ${a.last_name}${isMe ? ' (You)' : ''}</div>
                                <div class="member-meta">${a.athlete_code} | Joined ${formatDate(a.created_at)}</div>
                            </div>
                        </div>
                        <div class="member-actions">
                            <span class="status-badge active">Active</span>
                            ${isMe ? '<button class="member-btn leave" onclick="leaveTeam()">Leave Team</button>' : ''}
                            ${appState.isTeamOwner && !isMe ? '<button class="member-btn remove" onclick="removeMember(\'' + a.athlete_uuid + '\', \'athlete\', \'' + a.first_name + ' ' + a.last_name + '\')">Remove</button>' : ''}
                        </div>
                    </div>
                `}).join('');
            } catch (e) {
                console.error('Error loading active athletes:', e);
                container.innerHTML = '<div class="empty-state"><h3>Error loading athletes</h3></div>';
            }
        }

        async function loadTeamCoaches() {
            const container = document.getElementById('teamCoaches');

            try {
                const { data, error } = await supabaseClient
                    .from('coaches')
                    .select('coach_uuid, coach_name, auth_user_id, created_at, membership_status')
                    .eq('team_uuid', appState.teamUuid)
                    .in('membership_status', ['active', 'pending'])
                    .order('coach_name');

                if (error) throw error;

                if (!data?.length) {
                    container.innerHTML = '<div class="empty-state"><h3>No coaches</h3></div>';
                    return;
                }

                const myAuthUuid = appState.user?.id;

                container.innerHTML = data.map(c => {
                    const isMe = c.auth_user_id === myAuthUuid;
                    const statusClass = c.membership_status || 'active';
                    const isOwner = appState.isTeamOwner && isMe;
                    const canRemoveOther = appState.isTeamOwner && !isMe && statusClass === 'active';
                    return `
                    <div class="member-card">
                        <div class="member-info">
                            <div class="member-avatar">${(c.coach_name || 'C')[0].toUpperCase()}</div>
                            <div>
                                <div class="member-name">${c.coach_name}${isMe ? ' (You)' : ''}${isOwner ? ' <span style="font-size:11px;color:var(--accent-blue);font-weight:500;">&middot; Admin</span>' : ''}</div>
                                <div class="member-meta">Coach | Since ${formatDate(c.created_at)}</div>
                            </div>
                        </div>
                        <div class="member-actions">
                            <span class="status-badge ${statusClass}">${statusClass}</span>
                            ${isMe && (statusClass === 'active' || statusClass === 'pending') ? '<button class="member-btn leave" onclick="leaveTeam()">' + (statusClass === 'pending' ? 'Cancel Request' : 'Leave Team') + '</button>' : ''}
                            ${canRemoveOther ? '<button class="member-btn remove" onclick="removeMember(\'' + c.coach_uuid + '\', \'coach\', \'' + (c.coach_name || 'Coach').replace(/'/g, "\\'") + '\')">Remove</button>' : ''}
                        </div>
                    </div>
                `}).join('');
            } catch (e) {
                console.error('Error loading coaches:', e);
                container.innerHTML = '<div class="empty-state"><h3>Error loading coaches</h3></div>';
            }
        }

        async function approveMember(id, type) {
            if (appState.role !== 'coach') { showToast('Only coaches can approve members', 'error'); return; }
            if (appState.membershipStatus !== 'active') { showToast('Your own membership must be active to approve others', 'error'); return; }
            // Prevent self-approval
            if (type === 'coach' && id === appState.coachUuid) { showToast('You cannot approve your own membership', 'error'); return; }
            if (!(await showConfirm('Approve this member to join the team?', 'Approve Member'))) return;
            try {
                const table = type === 'athlete' ? 'athletes' : 'coaches';
                const idCol = type === 'athlete' ? 'athlete_uuid' : 'coach_uuid';
                const { error } = await supabaseClient
                    .from(table)
                    .update({ membership_status: 'active' })
                    .eq(idCol, id);
                if (error) throw error;
                await loadTeamData();
                await checkPendingApprovals();
                await loadTeamAthletes();
            } catch (e) {
                console.error('Error approving member:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function rejectMember(id, type) {
            if (appState.role !== 'coach') { showToast('Only coaches can reject members', 'error'); return; }
            if (appState.membershipStatus !== 'active') { showToast('Your own membership must be active to reject others', 'error'); return; }
            if (type === 'coach' && id === appState.coachUuid) { showToast('You cannot reject your own membership', 'error'); return; }
            if (!(await showConfirm('Reject this membership request? They will need to sign up again.', 'Reject Member', true))) return;
            try {
                const table = type === 'athlete' ? 'athletes' : 'coaches';
                const idCol = type === 'athlete' ? 'athlete_uuid' : 'coach_uuid';
                const { error } = await supabaseClient
                    .from(table)
                    .update({ membership_status: 'inactive', team_uuid: null })
                    .eq(idCol, id);
                if (error) throw error;
                await loadTeamData();
                await checkPendingApprovals();
                await loadTeamAthletes();
            } catch (e) {
                console.error('Error rejecting member:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // Remove an active team member (team owner/admin only)
        async function removeMember(id, type, displayName) {
            if (!appState.isTeamOwner) { showToast('Only the team admin can remove members', 'error'); return; }
            // Prevent removing self
            if (type === 'coach' && id === appState.coachUuid) { showToast('You cannot remove yourself. Use "Leave Team" instead.', 'error'); return; }

            const confirmMsg = 'Remove ' + displayName + ' from the team? They will lose team access and need to rejoin.';
            if (!(await showConfirm(confirmMsg, 'Remove Member', true))) return;

            try {
                const table = type === 'athlete' ? 'athletes' : 'coaches';
                const idCol = type === 'athlete' ? 'athlete_uuid' : 'coach_uuid';
                const { error } = await supabaseClient
                    .from(table)
                    .update({ membership_status: 'inactive', team_uuid: null })
                    .eq(idCol, id);
                if (error) throw error;

                showToast(displayName + ' has been removed from the team.', 'success');
                await loadTeamData();
                await loadTeamAthletes();
            } catch (e) {
                console.error('Error removing member:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        async function leaveTeam() {
            const role = appState.role;
            const isPending = appState.membershipStatus === 'pending';
            
            const confirmMsg = isPending
                ? 'Cancel your request to join this team?'
                : role === 'coach'
                    ? 'Leave this team? You will lose access to all team data.'
                    : 'Leave this team? You will keep your personal data but lose team access.';
            
            const confirmTitle = isPending ? 'Cancel Request' : 'Leave Team';

            if (!(await showConfirm(confirmMsg, confirmTitle, true))) return;

            try {
                if (role === 'athlete') {
                    const { error } = await supabaseClient
                        .from('athletes')
                        .update({ team_uuid: null, membership_status: 'inactive' })
                        .eq('athlete_uuid', appState.athleteUuid);
                    if (error) throw error;
                } else {
                    const { data: myCoach } = await supabaseClient
                        .from('v_my_coach')
                        .select('coach_uuid')
                        .single();
                    if (myCoach) {
                        const { error } = await supabaseClient
                            .from('coaches')
                            .update({ team_uuid: null, membership_status: 'inactive' })
                            .eq('coach_uuid', myCoach.coach_uuid);
                        if (error) throw error;
                    }
                }

                // Show success message
                showToast(isPending ? 'Request cancelled' : 'You have left the team', 'success');

                // Clear team state
                appState.teamUuid = null;
                appState.membershipStatus = 'inactive';
                appState.selectedAthleteUuid = null;

                // Hide coach-only UI elements
                document.getElementById('coachSection').style.display = 'none';
                document.getElementById('athleteSelector').style.display = 'none';
                const lbSecLogout = document.getElementById('leaderboardSection');
                if (lbSecLogout) lbSecLogout.style.display = 'none';
                lbState._loaded = false;
                lbState.athletes = [];
                lbState.rankings = [];
                compState.optedIn = false;
                compState.entries = {};
                compState.athletes = [];
                compState.rankings = {};
                compState.myRanks = {};
                compState._loaded = false;
                const dropdown = document.getElementById('athleteDropdown');
                if (dropdown) dropdown.innerHTML = '<option value="">All Athletes</option>';

                // Hide pending badge
                const badge = document.getElementById('pendingBadge');
                if (badge) badge.style.display = 'none';

                // Remove approval alert if present
                const approvalAlert = document.getElementById('approvalAlert');
                if (approvalAlert) approvalAlert.remove();

                // Navigate to home - will show "No Team" banner
                navigateTo('home');
                showToast('You have left the team.', 'success');
            } catch (e) {
                console.error('Error leaving team:', e);
                showToast('Error: ' + e.message, 'error');
            }
        }

        // ============================================
        // TEAM MODAL - JOIN / CREATE TEAM (post-login)
        // ============================================
        let teamModalMode = 'join'; // 'join' or 'create'

        function openTeamModal(mode) {
            teamModalMode = mode || 'join';
            const modal = document.getElementById('teamModal');
            const title = document.getElementById('teamModalTitle');
            const submitBtn = document.getElementById('teamModalSubmitBtn');
            const joinFields = document.getElementById('teamJoinFields');
            const createFields = document.getElementById('teamCreateFields');
            const errorEl = document.getElementById('teamModalError');
            const preview = document.getElementById('joinTeamPreview');

            errorEl.style.display = 'none';
            preview.style.display = 'none';

            if (mode === 'create') {
                title.textContent = 'Create New Team';
                submitBtn.textContent = 'Create Team';
                submitBtn.style.background = 'linear-gradient(135deg,var(--accent-green),#00B86B)';
                joinFields.style.display = 'none';
                createFields.style.display = 'block';
                document.getElementById('newTeamName').value = '';
                document.getElementById('newTeamCode').value = '';
            } else {
                title.textContent = 'Join Team';
                submitBtn.textContent = 'Join Team';
                submitBtn.style.background = '';
                joinFields.style.display = 'block';
                createFields.style.display = 'none';
                document.getElementById('joinTeamCode').value = '';
            }

            modal.classList.add('active');
        }

        function closeTeamModal() {
            document.getElementById('teamModal').classList.remove('active');
        }

        // Live team code lookup for preview
        let teamLookupTimer = null;
        function setupTeamCodeLookup() {
            const input = document.getElementById('joinTeamCode');
            if (!input) return;
            input.addEventListener('input', () => {
                clearTimeout(teamLookupTimer);
                const code = input.value.trim().toUpperCase();
                const preview = document.getElementById('joinTeamPreview');
                if (code.length < 2) {
                    preview.style.display = 'none';
                    return;
                }
                teamLookupTimer = setTimeout(async () => {
                    try {
                        // Try with T_ prefix first (existing format), then without
                        let { data } = await supabaseClient
                            .from('teams').select('team_name, team_code')
                            .eq('team_code', 'T_' + code).maybeSingle();
                        if (!data) {
                            ({ data } = await supabaseClient
                                .from('teams').select('team_name, team_code')
                                .eq('team_code', code).maybeSingle());
                        }
                        if (data) {
                            preview.style.display = 'block';
                            preview.innerHTML = '<div style="display:flex;align-items:center;gap:8px;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg><span style="color:var(--text-primary);font-weight:600;">' + data.team_name + '</span></div>';
                        } else {
                            preview.style.display = 'block';
                            preview.style.background = 'rgba(255,107,107,0.08)';
                            preview.style.borderColor = 'rgba(255,107,107,0.2)';
                            preview.innerHTML = '<span style="color:var(--accent-red);font-size:13px;">No team found with code "' + code + '"</span>';
                        }
                    } catch (e) {
                        preview.style.display = 'none';
                    }
                }, 400);
            });
        }

        async function submitTeamAction() {
            const errorEl = document.getElementById('teamModalError');
            const submitBtn = document.getElementById('teamModalSubmitBtn');
            errorEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = teamModalMode === 'create' ? 'Creating...' : 'Joining...';

            try {
                if (teamModalMode === 'join') {
                    await joinTeam();
                } else {
                    await createTeam();
                }
            } catch (e) {
                errorEl.textContent = sanitizeForDisplay(e.message) || 'An error occurred';
                errorEl.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = teamModalMode === 'create' ? 'Create Team' : 'Join Team';
            }
        }

        async function joinTeam() {
            const code = document.getElementById('joinTeamCode').value.trim().toUpperCase();
            if (!code) throw new Error('Please enter a team code');

            // Look up team - try T_ prefix first, then without
            let { data: teamData } = await supabaseClient
                .from('teams').select('team_uuid, team_name')
                .eq('team_code', 'T_' + code).maybeSingle();
            if (!teamData) {
                ({ data: teamData } = await supabaseClient
                    .from('teams').select('team_uuid, team_name')
                    .eq('team_code', code).maybeSingle());
            }
            if (!teamData) {
                throw new Error('Team code "' + code + '" not found. Check with your coach or admin.');
            }

            // Update user's team_uuid and set pending status
            const table = appState.role === 'athlete' ? 'athletes' : 'coaches';
            const idCol = appState.role === 'athlete' ? 'athlete_uuid' : 'coach_uuid';
            const idVal = appState.role === 'athlete' ? appState.athleteUuid : appState.userProfile?.coach_uuid;

            const { error } = await supabaseClient
                .from(table)
                .update({ team_uuid: teamData.team_uuid, membership_status: 'pending' })
                .eq(idCol, idVal);

            if (error) throw new Error('Could not join team: ' + error.message);

            // Refresh
            closeTeamModal();
            await loadUserProfile();
            appState.teamUuid = teamData.team_uuid;
            appState.membershipStatus = 'pending';
            showDashboard();
            showToast('Request sent to join ' + teamData.team_name + '. A coach will approve your membership.', 'success', 6000);
        }

        async function createTeam() {
            if (appState.role !== 'coach') throw new Error('Only coaches can create teams');

            const name = document.getElementById('newTeamName').value.trim();
            const code = document.getElementById('newTeamCode').value.trim().toUpperCase();

            if (!name) throw new Error('Team name is required');
            if (!code || code.length < 2 || code.length > 10) throw new Error('Team code must be 2-10 characters');

            // Check if code exists
            const { data: existing } = await supabaseClient
                .from('teams').select('team_uuid')
                .or('team_code.eq.' + code + ',team_code.eq.T_' + code)
                .maybeSingle();
            if (existing) throw new Error('Team code "' + code + '" is already taken.');

            // Create team - include created_by_uuid for ownership tracking
            const insertPayload = { team_name: name, team_code: code };
            // Try to include created_by_uuid (may fail if column doesn't exist yet - that's OK)
            try { insertPayload.created_by_uuid = appState.user.id; } catch(_) {}
            const { data: newTeam, error: teamErr } = await supabaseClient
                .from('teams')
                .insert(insertPayload)
                .select('team_uuid')
                .single();
            if (teamErr) throw new Error('Could not create team: ' + teamErr.message);

            // Assign coach to team
            const { data: myCoach } = await supabaseClient
                .from('v_my_coach').select('coach_uuid').single();
            if (myCoach) {
                await supabaseClient
                    .from('coaches')
                    .update({ team_uuid: newTeam.team_uuid, membership_status: 'active' })
                    .eq('coach_uuid', myCoach.coach_uuid);
            }

            // Refresh
            closeTeamModal();
            await loadUserProfile();
            appState.teamUuid = newTeam.team_uuid;
            appState.membershipStatus = 'active';
            appState.isTeamOwner = true; // Creator is always the team admin
            showDashboard();
            showToast('Team "' + name + '" created! Share code "' + code + '" with your athletes.', 'success', 8000);
        }

        // ============================================
        // LEADERBOARD MODULE (v02.08)
        // ============================================
        const lbState = {
            mode: 'team',       // 'team' | 'competition'
            category: 'race',   // team mode: 'race' | 'start' | 'turn'
            metric: '',
            athletes: [],       // team athletes cache
            groups: [],         // team groups cache (for coaches)
            rankings: [],
            _loaded: false
        };

        const compState = {
            optedIn: false,
            entries: {},        // { fastest_start_15m: true, ... }
            board: 'fastest_start_15m',
            athletes: [],       // competition athletes cache (cross-team)
            rankings: [],
            myRanks: {},        // { comp_key: { rank, total, percentile } }
            _loaded: false
        };

        const LB_METRICS = {
            race: [
                { key: 'race_time_s', label: 'Race Time', unit: 's', lower: true, format: 'time' }
            ],
            start: [
                { key: 'reaction_time_s', label: 'Reaction Time', unit: 's', lower: true, format: 'fixed3' },
                { key: 'split_15m_s', label: 'Split 15m', unit: 's', lower: true, format: 'fixed2' },
                { key: 'avg_vel_0_5', label: 'Velocity 0-5m', unit: 'm/s', lower: false, format: 'fixed2' },
                { key: 'flight_phase_s', label: 'Flight Phase', unit: 's', lower: true, format: 'fixed2' }
            ],
            turn: [
                { key: 'time_15in_15out_s', label: '15m In/Out', unit: 's', lower: true, format: 'fixed2' },
                { key: 'time_5in_5out_s', label: '5m In/Out', unit: 's', lower: true, format: 'fixed2' },
                { key: 'push_off_velocity', label: 'Push-off Velocity', unit: 'm/s', lower: false, format: 'fixed2' },
                { key: 'kick_rate', label: 'Kick Rate', unit: 'k/min', lower: false, format: 'fixed1' }
            ]
        };

        const COMP_BOARDS = {
            fastest_start_15m:  { label: 'Fastest Start', key: 'split_15m_s', view: 'v_competition_start_kpis', lower: true, format: 'fixed2', unit: 's', cols: 'athlete_uuid, split_15m_s, style, source_date' },
            best_reaction:      { label: 'Best Reaction', key: 'reaction_time_s', view: 'v_competition_start_kpis', lower: true, format: 'fixed3', unit: 's', cols: 'athlete_uuid, reaction_time_s, style, source_date' },
            fastest_turn_15_15: { label: 'Fastest Turn', key: 'time_15in_15out_s', view: 'v_competition_turn_kpis', lower: true, format: 'fixed2', unit: 's', cols: 'athlete_uuid, time_15in_15out_s, style, source_date' },
            best_race_pb:       { label: 'Best Race PB', key: 'race_time_s', view: 'v_competition_race_kpis', lower: true, format: 'time', unit: 's', cols: 'athlete_uuid, race_time_s, style, distance_m, source_date, course' }
        };

        function lbFormatValue(val, fmt) {
            if (val === null || val === undefined || val === '') return '--';
            const v = parseFloat(val);
            if (isNaN(v)) return '--';
            if (fmt === 'time') return formatTime(v);
            if (fmt === 'fixed3') return v.toFixed(3);
            if (fmt === 'fixed2') return v.toFixed(2);
            if (fmt === 'fixed1') return v.toFixed(1);
            return v.toFixed(2);
        }

        // ---- MODE TABS ----
        document.getElementById('lbModeBar')?.addEventListener('click', (e) => {
            const tab = e.target.closest('.lb-mode-tab');
            if (!tab) return;
            const mode = tab.dataset.lbmode;
            if (mode === lbState.mode) return;
            document.querySelectorAll('.lb-mode-tab').forEach(t => t.classList.toggle('active', t === tab));
            lbState.mode = mode;
            document.getElementById('lbPanelTeam').classList.toggle('active', mode === 'team');
            document.getElementById('lbPanelCompetition').classList.toggle('active', mode === 'competition');
            if (mode === 'team') loadTeamLeaderboard();
            else loadCompetitionPanel();
        });

        // ---- TEAM LEADERBOARD (CATEGORY TABS) ----
        document.getElementById('lbCategoryBar')?.addEventListener('click', (e) => {
            const tab = e.target.closest('.lb-cat-tab');
            if (!tab) return;
            const cat = tab.dataset.lbcat;
            if (cat === lbState.category) return;
            document.querySelectorAll('.lb-cat-tab').forEach(t => t.classList.toggle('active', t === tab));
            lbState.category = cat;
            populateLbMetricFilter();
            updateLbFilterVisibility();
            loadTeamLeaderboard();
        });

        function populateLbMetricFilter() {
            const sel = document.getElementById('lbMetricFilter');
            if (!sel) return;
            const metrics = LB_METRICS[lbState.category] || [];
            sel.innerHTML = metrics.map((m, i) =>
                '<option value="' + m.key + '"' + (i === 0 ? ' selected' : '') + '>' + m.label + '</option>'
            ).join('');
            lbState.metric = metrics.length ? metrics[0].key : '';
        }

        function updateLbFilterVisibility() {
            const cat = lbState.category;
            const eventWrap = document.getElementById('lbDistanceFilterWrap');
            const courseWrap = document.getElementById('lbCourseFilterWrap');
            if (eventWrap) eventWrap.style.display = cat === 'race' ? '' : 'none';
            if (courseWrap) courseWrap.style.display = cat === 'race' ? '' : 'none';
        }

        // ---- MAIN ENTRY POINT ----
        async function loadLeaderboardData() {
            if (lbState.mode === 'competition') {
                await loadCompetitionPanel();
            } else {
                await loadTeamLeaderboard();
            }
        }

        // ---- POPULATE GROUP FILTER (coaches only) ----
        async function populateLbGroupFilter() {
            const wrap = document.getElementById('lbGroupFilterWrap');
            const sel = document.getElementById('lbGroupFilter');
            if (!wrap || !sel) return;

            // Only show for coaches
            if (appState.role !== 'coach' || !appState.teamUuid) {
                wrap.style.display = 'none';
                return;
            }

            try {
                const { data: groups } = await supabaseClient
                    .from('athlete_groups')
                    .select('group_uuid, group_name, group_color')
                    .eq('team_uuid', appState.teamUuid)
                    .order('group_name');

                if (!groups || groups.length === 0) {
                    wrap.style.display = 'none';
                    return;
                }

                wrap.style.display = '';
                const prev = sel.value;
                sel.innerHTML = '<option value="">All Athletes</option>' +
                    groups.map(g => {
                        const colorDot = g.group_color ? '<span style="color:' + g.group_color + '"> </span>' : '';
                        return '<option value="' + g.group_uuid + '"' + (g.group_uuid === prev ? ' selected' : '') + ' data-color="' + (g.group_color || '') + '">' + g.group_name + '</option>';
                    }).join('');

                // Store groups for filtering
                lbState.groups = groups;
            } catch (e) {
                console.warn('[LB] group filter load error:', e);
                wrap.style.display = 'none';
            }
        }

        // ---- GET GROUP MEMBER UUIDS ----
        async function getLbGroupAthleteUuids(groupUuid) {
            if (!groupUuid) return null; // No filter
            try {
                const { data } = await supabaseClient
                    .from('athlete_group_members')
                    .select('athlete_uuid')
                    .eq('group_uuid', groupUuid);
                return (data || []).map(d => d.athlete_uuid);
            } catch (e) {
                console.warn('[LB] group members load error:', e);
                return null;
            }
        }

        // ---- TEAM LEADERBOARD (FIXED  uses getTeamAthleteList) ----
        async function loadTeamLeaderboard() {
            if (!appState.teamUuid) {
                renderLbEmpty('No team assigned', 'Join or create a team to see team rankings.');
                return;
            }

            // Populate group filter for coaches
            await populateLbGroupFilter();

            try {
                // Use the established, working athlete list loader
                const athletes = await getTeamAthleteList(false);
                lbState.athletes = athletes;
            } catch (e) {
                console.error('[LB-Team] athlete load error', e);
                lbState.athletes = [];
            }

            if (!lbState.metric) populateLbMetricFilter();
            updateLbFilterVisibility();

            const cat = lbState.category;
            const metric = document.getElementById('lbMetricFilter')?.value || lbState.metric;
            lbState.metric = metric;
            const metricDef = (LB_METRICS[cat] || []).find(m => m.key === metric) || (LB_METRICS[cat] || [])[0];
            if (!metricDef) { renderLbEmpty('No metrics available', ''); return; }

            // Apply gender filter
            const genderFilter = document.getElementById('lbGenderFilter')?.value || '';
            let athleteList = lbState.athletes;
            if (genderFilter) athleteList = athleteList.filter(a => a.gender === genderFilter);

            // Apply group filter (coaches only)
            const groupFilter = document.getElementById('lbGroupFilter')?.value || '';
            if (groupFilter && appState.role === 'coach') {
                const groupMemberUuids = await getLbGroupAthleteUuids(groupFilter);
                if (groupMemberUuids && groupMemberUuids.length > 0) {
                    athleteList = athleteList.filter(a => groupMemberUuids.includes(a.athlete_uuid));
                } else if (groupMemberUuids && groupMemberUuids.length === 0) {
                    // Group exists but has no members
                    renderLbEmpty('No athletes in group', 'This group has no members yet.');
                    return;
                }
            }

            let athleteUuids = athleteList.map(a => a.athlete_uuid);
            if (!athleteUuids.length) {
                renderLbEmpty('No athletes found', 'No active athletes match the current filters.');
                return;
            }

            try {
                let rankings = [];
                if (cat === 'race') rankings = await loadLbRaceRankings(metricDef, athleteUuids);
                else if (cat === 'start') rankings = await loadLbStartRankings(metricDef, athleteUuids);
                else if (cat === 'turn') rankings = await loadLbTurnRankings(metricDef, athleteUuids);
                lbState.rankings = rankings;
                renderLbPodium(rankings, metricDef, 'lbPodium', lbState.athletes, false);
                renderLbTable(rankings, metricDef, 'lbTableBody', 'lbRecordCount', 'lbTableTitle', lbState.athletes, false);
                document.getElementById('lbFilterInfo').textContent = rankings.length + ' ranked';
            } catch (e) {
                console.error('[LB-Team] load error', e);
                renderLbEmpty('Error loading leaderboard', e.message || 'Please try again.');
            }
        }

        async function loadLbRaceRankings(metricDef, athleteUuids) {
            const strokeFilter = document.getElementById('lbStrokeFilter')?.value || '';
            const courseFilter = document.getElementById('lbCourseFilter')?.value || '';
            const distanceFilter = document.getElementById('lbDistanceFilter')?.value || '';
            let query = supabaseClient.from('v_race_kpis').select('athlete_uuid, race_time_s, style, distance_m, source_date, course');
            const { query: q1, clientFilter: cf1 } = safeInFilter(query, 'athlete_uuid', athleteUuids);
            query = q1;
            if (strokeFilter) query = query.eq('style', strokeFilter);
            if (courseFilter) query = query.eq('course', courseFilter);
            if (distanceFilter) query = query.eq('distance_m', parseInt(distanceFilter));
            query = query.not('race_time_s', 'is', null);
            const { data, error } = await query;
            if (error) throw error;
            let rows = cf1(data || []);
            populateLbDistanceOptions(rows);
            populateLbStrokeOptions(rows);
            const bestMap = {};
            rows.forEach(r => {
                const ek = r.distance_m + '_' + (r.style || 'unknown');
                const uk = r.athlete_uuid + '__' + ((distanceFilter && strokeFilter) ? '' : ek);
                if (!bestMap[uk] || r.race_time_s < bestMap[uk].race_time_s) bestMap[uk] = r;
            });
            let best = Object.values(bestMap);
            best.sort((a, b) => a.race_time_s - b.race_time_s);
            return best.map((r, i) => ({ rank: i + 1, athlete_uuid: r.athlete_uuid, value: r.race_time_s, style: r.style, distance: r.distance_m, course: r.course, date: r.source_date, raw: r }));
        }

        async function loadLbStartRankings(metricDef, athleteUuids) {
            const styleFilter = document.getElementById('lbStrokeFilter')?.value || '';
            const key = metricDef.key;
            let query = supabaseClient.from('v_start_kpis').select('athlete_uuid, ' + key + ', style, source_date').not(key, 'is', null);
            const { query: q1, clientFilter: cf1 } = safeInFilter(query, 'athlete_uuid', athleteUuids);
            query = q1;
            if (styleFilter) query = query.eq('style', styleFilter);
            const { data, error } = await query;
            if (error) throw error;
            let rows = cf1(data || []);
            populateLbStrokeOptions(rows);
            const bestMap = {};
            rows.forEach(r => {
                const val = parseFloat(r[key]); if (isNaN(val)) return;
                const prev = bestMap[r.athlete_uuid];
                if (!prev || (metricDef.lower ? val < prev.value : val > prev.value)) bestMap[r.athlete_uuid] = { ...r, value: val };
            });
            let best = Object.values(bestMap);
            best.sort((a, b) => metricDef.lower ? a.value - b.value : b.value - a.value);
            return best.map((r, i) => ({ rank: i + 1, athlete_uuid: r.athlete_uuid, value: r.value, style: r.style, date: r.source_date, raw: r }));
        }

        async function loadLbTurnRankings(metricDef, athleteUuids) {
            const styleFilter = document.getElementById('lbStrokeFilter')?.value || '';
            const key = metricDef.key;
            let query = supabaseClient.from('v_turn_kpis').select('athlete_uuid, ' + key + ', style, source_date').not(key, 'is', null);
            const { query: q1, clientFilter: cf1 } = safeInFilter(query, 'athlete_uuid', athleteUuids);
            query = q1;
            if (styleFilter) query = query.eq('style', styleFilter);
            const { data, error } = await query;
            if (error) throw error;
            let rows = cf1(data || []);
            populateLbStrokeOptions(rows);
            const bestMap = {};
            rows.forEach(r => {
                const val = parseFloat(r[key]); if (isNaN(val)) return;
                const prev = bestMap[r.athlete_uuid];
                if (!prev || (metricDef.lower ? val < prev.value : val > prev.value)) bestMap[r.athlete_uuid] = { ...r, value: val };
            });
            let best = Object.values(bestMap);
            best.sort((a, b) => metricDef.lower ? a.value - b.value : b.value - a.value);
            return best.map((r, i) => ({ rank: i + 1, athlete_uuid: r.athlete_uuid, value: r.value, style: r.style, date: r.source_date, raw: r }));
        }

        function populateLbDistanceOptions(rows) {
            const sel = document.getElementById('lbDistanceFilter'); if (!sel) return;
            const prev = sel.value;
            const distances = new Map();
            (rows || []).forEach(r => { 
                if (r.distance_m) { 
                    const c = (r.course || 'SCY').toUpperCase(); 
                    const u = c === 'SCY' ? 'Yds' : 'm'; 
                    distances.set(r.distance_m, r.distance_m + ' ' + u); 
                }
            });
            const sorted = [...distances.entries()].sort((a, b) => a[0] - b[0]);
            sel.innerHTML = '<option value="">All Distances</option>' + sorted.map(([k, v]) => '<option value="' + k + '"' + (k == prev ? ' selected' : '') + '>' + v + '</option>').join('');
        }

        function populateLbStrokeOptions(rows) {
            const sel = document.getElementById('lbStrokeFilter'); if (!sel) return;
            const prev = sel.value;
            const strokes = new Set(); (rows || []).forEach(r => { if (r.style) strokes.add(r.style); });
            sel.innerHTML = '<option value="">All Strokes</option>' + [...strokes].sort().map(s => '<option value="' + s + '"' + (s === prev ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>').join('');
        }

        function applyLbFilters() {
            lbState.metric = document.getElementById('lbMetricFilter')?.value || lbState.metric;
            loadTeamLeaderboard();
        }

        // ---- SHARED RENDER FUNCTIONS ----
        function getAthleteFromList(uuid, list) {
            return list.find(x => x.athlete_uuid === uuid);
        }
        function renderLbPodium(rankings, metricDef, containerId, athleteList, showTeam) {
            const wrap = document.getElementById(containerId); if (!wrap) return;
            if (rankings.length < 1) { wrap.innerHTML = ''; return; }
            const top = rankings.slice(0, 3);
            const order = top.length >= 3 ? [top[1], top[0], top[2]] : top.length === 2 ? [top[1], top[0]] : [top[0]];
            wrap.innerHTML = order.map(r => {
                const a = getAthleteFromList(r.athlete_uuid, athleteList);
                const name = a ? ((a.first_name || '') + ' ' + (a.last_name || '')).trim() : 'Unknown';
                const initials = a ? ((a.first_name || '')[0] + (a.last_name || '')[0]).toUpperCase() : '??';
                const isSelf = r.athlete_uuid === appState.athleteUuid;
                const teamLabel = showTeam && a?.team_name ? '<div class="lb-podium-meta" style="margin-top:2px;">' + sanitizeForDisplay(a.team_name) + '</div>' : '';
                const metaInfo = r.distance ? ((r.distance || '') + (r.course === 'SCY' ? ' Yds ' : 'm ') + (r.style || '')).trim() : (r.style || '');
                const dateStr = r.date ? formatDate(r.date) : '';
                return '<div class="lb-podium-item rank-' + r.rank + '"><div class="lb-podium-avatar">' + initials + '<div class="lb-podium-medal">' + r.rank + '</div></div><div class="lb-podium-name">' + sanitizeForDisplay(name) + (isSelf ? '<span class="lb-self-indicator">YOU</span>' : '') + '</div><div class="lb-podium-value">' + lbFormatValue(r.value, metricDef.format) + '</div><div class="lb-podium-meta">' + metaInfo + (dateStr ? ' &middot; ' + dateStr : '') + '</div>' + teamLabel + '<div class="lb-podium-bar"><span class="lb-podium-rank-num">' + r.rank + '</span></div></div>';
            }).join('');
        }

        function renderLbTable(rankings, metricDef, containerId, countElId, titleElId, athleteList, showTeam) {
            const container = document.getElementById(containerId);
            const countEl = document.getElementById(countElId);
            const titleEl = document.getElementById(titleElId);
            if (!container) return;
            if (!rankings.length) {
                container.innerHTML = '<div class="lb-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="6" width="4" height="15" rx="1"/><rect x="17" y="2" width="4" height="19" rx="1"/></svg><h3>No data found</h3><p>Adjust filters or wait for data to be uploaded.</p></div>';
                if (countEl) countEl.textContent = '';
                return;
            }
            if (titleEl) titleEl.textContent = (showTeam ? 'Competition: ' : '') + metricDef.label;
            if (countEl) countEl.textContent = rankings.length + ' athlete' + (rankings.length !== 1 ? 's' : '');
            const isRace = !!rankings[0]?.distance;
            const teamCol = showTeam ? '<th>Team</th>' : '';
            const extraHeaders = isRace ? '<th>Event</th><th>Course</th>' : '<th>Style</th>';
            let html = '<table class="lb-table"><thead><tr><th class="lb-rank-cell">Rank</th><th>Athlete</th>' + teamCol + '<th>' + metricDef.label + '</th>' + extraHeaders + '<th>Date</th></tr></thead><tbody>';
            rankings.forEach(r => {
                const a = getAthleteFromList(r.athlete_uuid, athleteList);
                const name = a ? ((a.first_name || '') + ' ' + (a.last_name || '')).trim() : 'Unknown';
                const initials = a ? ((a.first_name || '')[0] + (a.last_name || '')[0]).toUpperCase() : '??';
                const isSelf = r.athlete_uuid === appState.athleteUuid;
                const rankClass = r.rank === 1 ? 'gold' : r.rank === 2 ? 'silver' : r.rank === 3 ? 'bronze' : 'normal';
                const styleLower = (r.style || '').toLowerCase();
                const pillClass = ['freestyle','backstroke','breaststroke','butterfly','im'].includes(styleLower) ? styleLower : '';
                const teamCell = showTeam ? '<td><span class="lb-team-pill">' + sanitizeForDisplay(a?.team_name || '--') + '</span></td>' : '';
                let extraCells = '';
                if (isRace) { const c = (r.course || 'SCY').toUpperCase(); const u = c === 'SCY' ? 'Yds' : 'm'; extraCells = '<td>' + (r.distance || '') + ' ' + u + ' <span class="lb-style-pill ' + pillClass + '">' + (r.style || '') + '</span></td><td>' + c + '</td>'; }
                else { extraCells = '<td><span class="lb-style-pill ' + pillClass + '">' + (r.style || '--') + '</span></td>'; }
                html += '<tr class="' + (isSelf ? 'lb-self-row' : '') + '"><td class="lb-rank-cell"><span class="lb-rank-badge ' + rankClass + '">' + r.rank + '</span></td><td><div class="lb-athlete-cell"><div class="lb-athlete-avatar">' + initials + '</div><span class="lb-athlete-name">' + sanitizeForDisplay(name) + (isSelf ? '<span class="lb-self-indicator">YOU</span>' : '') + '</span></div></td>' + teamCell + '<td class="lb-value-cell">' + lbFormatValue(r.value, metricDef.format) + '</td>' + extraCells + '<td class="lb-date-cell">' + (r.date ? formatDate(r.date) : '--') + '</td></tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderLbEmpty(title, msg) {
            const container = document.getElementById('lbTableBody');
            const podium = document.getElementById('lbPodium');
            const countEl = document.getElementById('lbRecordCount');
            if (podium) podium.innerHTML = '';
            if (countEl) countEl.textContent = '';
            if (container) container.innerHTML = '<div class="lb-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="12" width="4" height="9" rx="1"/><rect x="10" y="6" width="4" height="15" rx="1"/><rect x="17" y="2" width="4" height="19" rx="1"/></svg><h3>' + sanitizeForDisplay(title) + '</h3><p>' + sanitizeForDisplay(msg) + '</p></div>';
        }

        // ============================================
        // COMPETITION LEADERBOARD (v02.08)
        // ============================================

        // ---- Load competition panel state ----
        async function loadCompetitionPanel() {
            // Only athletes can opt in (coaches see read-only)
            const isAthlete = appState.role === 'athlete';

            // Load opt-in status
            if (isAthlete && appState.athleteUuid) {
                try {
                    const { data } = await supabaseClient
                        .from('competition_opt_ins')
                        .select('opted_in')
                        .eq('athlete_uuid', appState.athleteUuid)
                        .maybeSingle();
                    compState.optedIn = data?.opted_in === true;
                } catch (e) {
                    console.warn('[Comp] opt-in check failed (table may not exist yet):', e.message);
                    compState.optedIn = false;
                }

                // Load per-comp entries
                try {
                    const { data } = await supabaseClient
                        .from('competition_entries')
                        .select('competition_key, enrolled')
                        .eq('athlete_uuid', appState.athleteUuid);
                    compState.entries = {};
                    (data || []).forEach(d => { compState.entries[d.competition_key] = d.enrolled; });
                } catch (e) {
                    console.warn('[Comp] entries check failed:', e.message);
                    compState.entries = {};
                }
            }

            updateCompOptinUI();

            if (compState.optedIn || appState.role === 'coach') {
                await loadCompetitionBoard();
            }
        }

        function updateCompOptinUI() {
            const toggle = document.getElementById('compMasterToggle');
            const statusEl = document.getElementById('compOptinStatus');
            const eventsGrid = document.getElementById('compEventsGrid');
            const boardBar = document.getElementById('compBoardBar');
            const filterRow = document.getElementById('compFilterRow');
            const podiumWrap = document.getElementById('compPodiumWrap');
            const tableCard = document.getElementById('compTableCard');
            const isAthlete = appState.role === 'athlete';

            if (toggle) toggle.classList.toggle('active', compState.optedIn);
            if (statusEl) statusEl.textContent = compState.optedIn ? 'Enrolled' : 'Not Enrolled';

            // Coaches see boards but not opt-in controls
            if (!isAthlete) {
                const optinCard = document.getElementById('compOptinCard');
                if (optinCard) optinCard.style.display = 'none';
                if (boardBar) boardBar.style.display = '';
                if (filterRow) filterRow.style.display = '';
                if (podiumWrap) podiumWrap.style.display = '';
                if (tableCard) tableCard.style.display = '';
                return;
            }

            if (eventsGrid) eventsGrid.style.display = compState.optedIn ? '' : 'none';
            const showBoards = compState.optedIn;
            if (boardBar) boardBar.style.display = showBoards ? '' : 'none';
            if (filterRow) filterRow.style.display = showBoards ? '' : 'none';
            if (podiumWrap) podiumWrap.style.display = showBoards ? '' : 'none';
            if (tableCard) tableCard.style.display = showBoards ? '' : 'none';

            // Update checkboxes
            Object.keys(COMP_BOARDS).forEach(key => {
                const cb = document.getElementById('compCheck_' + key);
                if (cb) cb.checked = compState.entries[key] === true;
            });
        }

        async function toggleCompetitionOptIn() {
            if (appState.role !== 'athlete' || !appState.athleteUuid) return;
            const newVal = !compState.optedIn;

            try {
                const { error } = await supabaseClient
                    .from('competition_opt_ins')
                    .upsert({
                        athlete_uuid: appState.athleteUuid,
                        auth_user_id: appState.user.id,
                        opted_in: newVal,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'athlete_uuid' });

                if (error) throw error;
                compState.optedIn = newVal;

                // If opting in for first time, auto-enroll in all competitions
                if (newVal && Object.keys(compState.entries).length === 0) {
                    const keys = Object.keys(COMP_BOARDS);
                    const rows = keys.map(k => ({
                        athlete_uuid: appState.athleteUuid,
                        auth_user_id: appState.user.id,
                        competition_key: k,
                        enrolled: true
                    }));
                    await supabaseClient.from('competition_entries').upsert(rows, { onConflict: 'athlete_uuid,competition_key' });
                    keys.forEach(k => { compState.entries[k] = true; });
                }

                updateCompOptinUI();
                if (newVal) {
                    showToast('You are now competing in the Universal Leaderboard!', 'success');
                    await loadCompetitionBoard();
                } else {
                    showToast('You have been removed from the competition.', 'info');
                }
            } catch (e) {
                console.error('[Comp] opt-in toggle error:', e);
                showToast('Could not update competition status. The database table may not exist yet  please run the SQL migration first.', 'error', 8000);
            }
        }

        async function toggleCompetitionEntry(compKey, enrolled) {
            if (appState.role !== 'athlete' || !appState.athleteUuid) return;
            try {
                await supabaseClient.from('competition_entries').upsert({
                    athlete_uuid: appState.athleteUuid,
                    auth_user_id: appState.user.id,
                    competition_key: compKey,
                    enrolled: enrolled,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'athlete_uuid,competition_key' });
                compState.entries[compKey] = enrolled;
            } catch (e) {
                console.error('[Comp] entry toggle error:', e);
                showToast('Could not update competition entry.', 'error');
            }
        }

        // ---- Competition board tabs ----
        document.getElementById('compBoardBar')?.addEventListener('click', (e) => {
            const tab = e.target.closest('.comp-board-tab');
            if (!tab) return;
            const board = tab.dataset.compboard;
            if (board === compState.board) return;
            document.querySelectorAll('.comp-board-tab').forEach(t => t.classList.toggle('active', t === tab));
            compState.board = board;
            updateCompFilterVisibility();
            loadCompetitionBoard();
        });

        function updateCompFilterVisibility() {
            const isRace = compState.board === 'best_race_pb';
            const ew = document.getElementById('compDistanceFilterWrap');
            const sw = document.getElementById('compStrokeFilterWrap');
            if (ew) ew.style.display = isRace ? '' : 'none';
            if (sw) sw.style.display = isRace ? '' : 'none';
        }

        // ---- Load competition board data ----
        async function loadCompetitionBoard() {
            const boardDef = COMP_BOARDS[compState.board];
            if (!boardDef) return;

            updateCompFilterVisibility();

            // Load competition athletes
            try {
                const { data } = await supabaseClient
                    .from('v_competition_athletes')
                    .select('athlete_uuid, first_name, last_name, team_name');

                const genderFilter = document.getElementById('compGenderFilter')?.value || '';
                let athletes = data || [];
                
                // If gender filter, get gender from athletes table
                if (genderFilter && athletes.length) {
                    const compUuids = athletes.map(a => a.athlete_uuid);
                    const { data: athGenders } = await supabaseClient
                        .from('athletes')
                        .select('athlete_uuid, gender')
                        .in('athlete_uuid', compUuids)
                        .eq('gender', genderFilter);
                    
                    if (athGenders?.length) {
                        const genderUuids = new Set(athGenders.map(a => a.athlete_uuid));
                        athletes = athletes.filter(a => genderUuids.has(a.athlete_uuid));
                    } else {
                        athletes = [];
                    }
                }
                
                compState.athletes = athletes;
            } catch (e) {
                console.warn('[Comp] athlete load failed (view may not exist yet):', e.message);
                compState.athletes = [];
                document.getElementById('compTableBody').innerHTML = '<div class="lb-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg><h3>Competition not available yet</h3><p>The database tables for competition may not be set up yet. Please run the SQL migration in Supabase.</p></div>';
                return;
            }

            if (!compState.athletes.length) {
                document.getElementById('compPodium').innerHTML = '';
                document.getElementById('compTableBody').innerHTML = '<div class="lb-empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"/></svg><h3>No participants yet</h3><p>Be the first to opt in and compete!</p></div>';
                document.getElementById('compParticipantCount').textContent = '0 participants';
                return;
            }

            const athleteUuids = compState.athletes.map(a => a.athlete_uuid);

            try {
                let query = supabaseClient.from(boardDef.view).select(boardDef.cols).not(boardDef.key, 'is', null);
                const { query: q1, clientFilter: cf1 } = safeInFilter(query, 'athlete_uuid', athleteUuids);
                query = q1;

                // Extra filters for race PB
                if (compState.board === 'best_race_pb') {
                    const distFilter = document.getElementById('compDistanceFilter')?.value || '';
                    const strokeFilter = document.getElementById('compStrokeFilter')?.value || '';
                    if (distFilter) query = query.eq('distance_m', parseInt(distFilter));
                    if (strokeFilter) query = query.eq('style', strokeFilter);
                }

                const { data, error } = await query;
                if (error) throw error;
                let rows = cf1(data || []);

                // Populate race-specific filters
                if (compState.board === 'best_race_pb') {
                    // Populate distance filter
                    const distSel = document.getElementById('compDistanceFilter');
                    if (distSel) {
                        const prev = distSel.value;
                        const dists = new Map();
                        rows.forEach(r => { 
                            if (r.distance_m) { 
                                const c = (r.course || 'SCY').toUpperCase(); 
                                dists.set(r.distance_m, r.distance_m + (c === 'SCY' ? ' Yds' : 'm')); 
                            }
                        });
                        distSel.innerHTML = '<option value="">All Distances</option>' + [...dists.entries()].sort((a,b) => a[0] - b[0]).map(([k,v]) => '<option value="' + k + '"' + (k == prev ? ' selected' : '') + '>' + v + '</option>').join('');
                    }
                    // Populate stroke filter
                    const strokeSel = document.getElementById('compStrokeFilter');
                    if (strokeSel) {
                        const prev = strokeSel.value;
                        const strokes = new Set();
                        rows.forEach(r => { if (r.style) strokes.add(r.style); });
                        strokeSel.innerHTML = '<option value="">All Strokes</option>' + [...strokes].sort().map(s => '<option value="' + s + '"' + (s === prev ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>').join('');
                    }
                }

                // Best per athlete
                const bestMap = {};
                rows.forEach(r => {
                    const val = parseFloat(r[boardDef.key]); if (isNaN(val)) return;
                    const ek = r.distance_m ? r.athlete_uuid + '__' + r.distance_m + '_' + r.style : r.athlete_uuid;
                    const prev = bestMap[ek];
                    if (!prev || (boardDef.lower ? val < prev.value : val > prev.value)) {
                        bestMap[ek] = { ...r, value: val };
                    }
                });

                let best = Object.values(bestMap);
                best.sort((a, b) => boardDef.lower ? a.value - b.value : b.value - a.value);
                const rankings = best.map((r, i) => ({
                    rank: i + 1,
                    athlete_uuid: r.athlete_uuid,
                    value: r.value,
                    style: r.style,
                    distance: r.distance_m,
                    course: r.course,
                    date: r.source_date,
                    raw: r
                }));

                compState.rankings = rankings;
                renderLbPodium(rankings, boardDef, 'compPodium', compState.athletes, true);
                renderLbTable(rankings, boardDef, 'compTableBody', 'compRecordCount', 'compTableTitle', compState.athletes, true);
                document.getElementById('compParticipantCount').textContent = compState.athletes.length + ' participant' + (compState.athletes.length !== 1 ? 's' : '');

                // Cache rank for badges
                if (appState.athleteUuid) {
                    const myEntry = rankings.find(r => r.athlete_uuid === appState.athleteUuid);
                    if (myEntry) {
                        compState.myRanks[compState.board] = {
                            rank: myEntry.rank,
                            total: rankings.length,
                            percentile: (myEntry.rank / rankings.length) * 100,
                            value: myEntry.value
                        };
                    }
                }
            } catch (e) {
                console.error('[Comp] board load error:', e);
                document.getElementById('compTableBody').innerHTML = '<div class="lb-empty"><h3>Error loading competition data</h3><p>' + sanitizeForDisplay(e.message) + '</p></div>';
            }
        }

        // ============================================
        // HOME PAGE BADGES (v02.08)
        // ============================================
        async function loadCompBadges() {
            const section = document.getElementById('compBadgesSection');
            const grid = document.getElementById('compBadgesGrid');
            if (!section || !grid) return;
            if (appState.role !== 'athlete' || !appState.athleteUuid) { section.style.display = 'none'; return; }

            // Check if opted in
            let optedIn = false;
            try {
                const { data } = await supabaseClient.from('competition_opt_ins').select('opted_in').eq('athlete_uuid', appState.athleteUuid).maybeSingle();
                optedIn = data?.opted_in === true;
            } catch (e) { section.style.display = 'none'; return; }

            if (!optedIn) { section.style.display = 'none'; return; }

            // Load ranks for each competition
            const badges = [];
            for (const [compKey, boardDef] of Object.entries(COMP_BOARDS)) {
                try {
                    // Check enrollment
                    const { data: entryData } = await supabaseClient.from('competition_entries').select('enrolled').eq('athlete_uuid', appState.athleteUuid).eq('competition_key', compKey).maybeSingle();
                    if (!entryData?.enrolled) continue;

                    const { data: allData } = await supabaseClient.from(boardDef.view).select(boardDef.cols).not(boardDef.key, 'is', null);
                    if (!allData?.length) continue;

                    // Best per athlete
                    const bestMap = {};
                    allData.forEach(r => {
                        const val = parseFloat(r[boardDef.key]); if (isNaN(val)) return;
                        const prev = bestMap[r.athlete_uuid];
                        if (!prev || (boardDef.lower ? val < prev : val > prev)) bestMap[r.athlete_uuid] = val;
                    });

                    const sorted = Object.entries(bestMap).sort((a, b) => boardDef.lower ? a[1] - b[1] : b[1] - a[1]);
                    const myIdx = sorted.findIndex(([uuid]) => uuid === appState.athleteUuid);
                    if (myIdx === -1) continue;

                    const rank = myIdx + 1;
                    const total = sorted.length;
                    const pct = (rank / total) * 100;

                    let tier = null;
                    if (pct <= 1) tier = { name: 'Elite', cls: 'elite', icon: 'E' };
                    else if (pct <= 10) tier = { name: 'Contender', cls: 'contender', icon: 'C' };
                    else if (pct <= 25) tier = { name: 'Ranked', cls: 'ranked', icon: 'R' };

                    if (tier) {
                        badges.push({
                            tier, compKey, label: boardDef.label,
                            rank, total, value: bestMap[appState.athleteUuid],
                            format: boardDef.format
                        });
                    }
                } catch (e) { continue; }
            }

            if (!badges.length) { section.style.display = 'none'; return; }

            section.style.display = '';
            grid.innerHTML = badges.map(b =>
                '<div class="comp-badge" onclick="navigateTo(\'leaderboards\')">' +
                    '<div class="comp-badge-icon ' + b.tier.cls + '">' + b.tier.icon + '</div>' +
                    '<div class="comp-badge-text">' +
                        '<div class="comp-badge-tier ' + b.tier.cls + '">Top ' + (b.tier.cls === 'elite' ? '1%' : b.tier.cls === 'contender' ? '10%' : '25%') + '  ' + b.tier.name + '</div>' +
                        '<div class="comp-badge-comp">' + b.label + '</div>' +
                    '</div>' +
                    '<div class="comp-badge-right">' +
                        '<div class="comp-badge-rank">#' + b.rank + '</div>' +
                        '<div class="comp-badge-detail">of ' + b.total + '</div>' +
                    '</div>' +
                '</div>'
            ).join('');
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            await handleLogin(email, password);
        });

        document.getElementById('signupForm').addEventListener('submit', handleSignup);

        document.getElementById('logoutBtn').addEventListener('click', handleLogout);

        // Goal modal event listeners
        document.getElementById('addGoalBtn')?.addEventListener('click', openGoalModal);
        document.getElementById('closeGoalModal')?.addEventListener('click', closeGoalModal);
        document.getElementById('cancelGoalBtn')?.addEventListener('click', closeGoalModal);
        document.getElementById('saveGoalBtn')?.addEventListener('click', saveGoal);
        document.getElementById('goalModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'goalModal') closeGoalModal();
        });

        // Team goal modal: close on overlay click
        document.getElementById('teamGoalModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'teamGoalModal') closeTeamGoalModal();
        });

        // Groups modal: close on overlay click
        document.getElementById('groupsModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'groupsModal') closeGroupsModal();
        });

        // Team modal: close on overlay click + setup live code lookup
        document.getElementById('teamModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'teamModal') closeTeamModal();
        });
        setupTeamCodeLookup();

        // Subscription modal: close on overlay click
        document.getElementById('subscriptionModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'subscriptionModal') closeSubscriptionModal();
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            await testConnection();
            await checkSession();
            checkCheckoutStatus(); // Check for Stripe redirect
        }

        init();
    </script>
</body>
</html>
